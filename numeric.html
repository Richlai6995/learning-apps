<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½æ•¸é—–é—œç‹ 2.3 (é‡å¡«åŠŸèƒ½ç‰ˆ)</title>
    <style>
        :root {
            --primary: #16a085;
            --secondary: #1abc9c;
            --light: #e8f8f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --cell-size: 55px; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 10px 0; text-align: center; font-size: 1.8rem;}

        /* --- å­¸å“¡åç‰Œ & çå‹µ --- */
        .user-profile {
            background-color: #fff3cd;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: #d35400;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            justify-content: center;
        }
        .user-profile:active { transform: scale(0.98); }
        
        .stats-badge {
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px;
            color: #2c3e50;
        }

        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 6px; padding: 8px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 2px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-accent { background-color: #f39c12; }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; }
        
        /* æç¤ºæŒ‰éˆ•å°ˆç”¨æ¨£å¼ */
        .btn-hint {
            background-color: #f1c40f; color: #7f8c8d; 
            border-bottom: 4px solid #f39c12;
            margin-top: 10px;
        }
        .btn-hint:active { transform: translateY(4px); border-bottom: 0; }
        .hint-box {
            display: none;
            background-color: #fff9c4;
            border: 2px solid #fbc02d;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            color: #e65100;
            font-weight: bold;
            animation: fadeIn 0.5s;
        }

        .btn-next-level {
            background-color: #27ae60; color: white; font-size: 1.5rem; padding: 15px 30px;
            border-radius: 50px; box-shadow: 0 6px #1e8449; margin-top: 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none; 
        }
        .btn-next-level:active { transform: translateY(6px); box-shadow: 0 0 #1e8449; }
        @keyframes popIn { from {transform: scale(0);} to {transform: scale(1);} }

        .list-item {
            background: #e8f6f3; border: 1px solid #a2d9ce; padding: 10px; margin-bottom: 8px;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
        }
        .gem-tag { color: #2980b9; font-weight: bold; background: #d6eaf8; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}
        .score-tag { color: #d35400; font-weight: bold; background: #fdebd0; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}

        /* --- ç·¨è¼¯å™¨ç›¸é—œ --- */
        .gen-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; background: #e8f8f5; padding: 10px; border-radius: 8px;}
        .gen-controls input { padding: 5px; width: 60px; text-align: center; border: 1px solid #ccc; border-radius: 4px;}
        .edit-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; background: #fff; padding: 5px; border-radius: 5px; border:1px solid #eee; flex-wrap: wrap;}
        .edit-row input { padding: 5px; text-align: left; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;}
        
        .cn-keypad { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; background: #eee; padding: 5px; border-radius: 5px; }
        .cn-keypad button { background: #fff; color: #333; border: 1px solid #ccc; font-size: 0.9rem; padding: 5px 10px; box-shadow: 0 2px #ddd; }
        .cn-keypad button:active { transform: translateY(2px); box-shadow: none; }

        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 6px; }
        
        /* --- ä½æ•¸ç·´ç¿’å°ˆç”¨ CSS --- */
        .pv-question-box {
            text-align: center; margin: 20px 0 10px 0; padding: 20px;
            background: #fff; border: 2px solid var(--primary); border-radius: 10px;
            font-size: 2rem; font-weight: bold; color: var(--dark);
            min-height: 80px; display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }

        .pv-board {
            display: flex; 
            flex-direction: row; 
            justify-content: flex-start;
            overflow-x: auto;
            padding: 10px;
            gap: 2px; 
        }
        .pv-board::-webkit-scrollbar { height: 8px; }
        .pv-board::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 4px; }
        .pv-board::-webkit-scrollbar-track { background: #f1f1f1; }

        @media (min-width: 600px) {
            .pv-board { justify-content: center; } 
        }

        .pv-col {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            min-width: var(--cell-size); 
        }

        .pv-header {
            width: var(--cell-size); height: 40px;
            background: #34495e; 
            color: white;
            display: flex; justify-content: center; align-items: center;
            border-radius: 5px; font-weight: bold; font-size: 0.9rem;
            white-space: nowrap;
        }

        .pv-input {
            width: var(--cell-size); height: 60px;
            font-size: 1.8rem; text-align: center;
            border: 2px solid #ccc; border-radius: 8px;
            font-weight: bold; outline: none;
            background: white; transition: 0.2s;
            padding: 0; 
        }
        .pv-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(22, 160, 133, 0.3); background: #e8f8f5; }
        .pv-input.correct { border-color: #27ae60; background-color: #d5f5e3; color: #27ae60; }
        .pv-input.wrong { border-color: #c0392b; background-color: #fadbd8; animation: shake 0.4s; }

        .decimal-point {
            width: 20px;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            font-size: 3rem; font-weight: bold; color: var(--dark); padding-bottom: 10px;
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .quiz-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .quiz-actions button {
            flex: 1;
            max-width: 150px;
            padding: 12px;
        }

        /* --- çå‹µèˆ‡å…±ç”¨ --- */
        .shop-balance {
            background: linear-gradient(135deg, #16a085 0%, #2ecc71 100%);
            color: white; padding: 20px; border-radius: 15px; text-align: center;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .shop-balance h3 { color: white; margin: 0 0 10px 0; font-weight: normal; font-size: 1rem; opacity: 0.9; }
        .balance-row { display: flex; justify-content: center; gap: 20px; font-size: 1.5rem; font-weight: bold; }
        
        .exchange-form { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .exchange-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .exchange-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; text-align: center; }
        .exchange-select { padding: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; background: white; }
        
        .log-list { max-height: 200px; overflow-y: auto; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 0.9rem; color: #666; }
        .log-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }

        .reward-popup {
            background: #fff8e1; border: 3px solid #f1c40f; padding: 20px;
            border-radius: 15px; margin-top: 20px; font-weight: bold; color: #d35400;
            font-size: 1.5rem; text-align: center;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
            animation: bounceIn 0.8s;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        #particle-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden; display: none;
        }
        .particle {
            position: absolute; font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .version-tag {
            margin-top: 30px; color: #16a085; font-size: 1rem; text-align: center;
            font-family: monospace; border-top: 1px dashed #eee; padding-top: 10px; font-weight: bold;
        }
        
        .hint-text { color: #e67e22; font-weight: bold; margin-bottom: 5px; display: block; font-size: 0.9rem;}
    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>ğŸ”¢ ä½æ•¸é—–é—œç‹ 2.3</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <button class="btn-accent btn-block" style="margin-bottom:15px; box-shadow:0 4px #d35400;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px; display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv2.3 (æ–°å¢é‡å¡«åŠŸèƒ½)</div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        <div class="shop-balance">
            <h3>ç›®å‰æŒæœ‰</h3>
            <div class="balance-row">
                <span>ğŸ‘‘ <span id="shop-crowns">0</span></span>
                <span>ğŸ’ <span id="shop-gems">0</span></span>
            </div>
        </div>
        <div class="exchange-form">
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">æˆ‘è¦å…Œæ›...</div>
            <div class="exchange-row">
                <input type="text" id="gift-name" class="exchange-input" placeholder="è¼¸å…¥çå“åç¨± (å¦‚: çœ‹é›»è¦–10åˆ†é˜)">
            </div>
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">éœ€è¦èŠ±è²»</div>
            <div class="exchange-row">
                <input type="number" id="gift-cost" class="exchange-input" placeholder="æ•¸é‡" min="1">
                <select id="gift-currency" class="exchange-select">
                    <option value="gems">ğŸ’ å¯¶çŸ³</option>
                    <option value="crowns">ğŸ‘‘ çš‡å† </option>
                </select>
            </div>
            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>
        <div style="margin-top:20px;">
            <h4>ğŸ“œ å…Œæ›ç´€éŒ„</h4>
            <div id="exchange-log" class="log-list"></div>
        </div>
        <button class="btn-gray btn-block" style="margin-top:20px;" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯ä½æ•¸é¡Œåº«</h2>
        <div style="margin-bottom:15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background:#eee; padding:15px; border-radius:10px;">
            <div style="flex:100%">åç¨±: <input type="text" id="list-name" style="padding:5px; width:70%;"></div>
            <div>ğŸ’ ç·´ç¿’å¯¶çŸ³: <input type="number" id="list-gems" placeholder="5" style="padding:5px; width:60px;" value="5"></div>
            <div>ğŸ¯ ç²çåˆ†æ•¸: <input type="number" id="list-pass-score" placeholder="100" style="padding:5px; width:60px;" value="100"></div>
        </div>

        <div class="gen-controls">
            <span><strong>è‡ªå‹•ç”Ÿæˆ:</strong></span>
            é¡Œæ•¸<input type="number" id="gen-count" value="5">
            <span style="font-size:0.9rem">æ•´æ•¸ä½</span><input type="number" id="gen-int-digits" value="2" max="6" min="1" placeholder="æ•´æ•¸">
            <span style="font-size:0.9rem">å°æ•¸ä½</span><input type="number" id="gen-dec-digits" value="0" max="3" min="0" placeholder="å°æ•¸">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>
        
        <div style="margin: 10px 0;">
            <span class="hint-text">å°å·¥å…·ï¼šé»æ“ŠæŒ‰éˆ•å¿«é€Ÿè¼¸å…¥åœ‹å­—</span>
            <div class="cn-keypad">
                <button onclick="insertChar('è¬')">è¬</button>
                <button onclick="insertChar('åƒ')">åƒ</button>
                <button onclick="insertChar('ç™¾')">ç™¾</button>
                <button onclick="insertChar('å')">å</button>
                <button onclick="insertChar('å€‹')">å€‹</button>
                <button onclick="insertChar('é»')">é»</button>
                <button onclick="insertChar('é›¶')">é›¶</button>
                <button onclick="insertChar('å…¬å°º')">å…¬å°º</button>
                <button onclick="insertChar('å…¬åˆ†')">å…¬åˆ†</button>
            </div>
        </div>

        <div style="max-height: 300px; overflow-y: auto;">
            <div id="editor-rows"></div>
        </div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ  (æ”¯æ´å°æ•¸èˆ‡æç¤º)</button>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-mode">ä½æ•¸ç·´ç¿’</span>
        </div>

        <div class="pv-question-box">
            <span id="pv-q-text">é¡Œç›®æ–‡å­—</span>
            <button id="btn-show-hint" class="btn-hint" onclick="showHint()" style="display:none;">ğŸ’¡ çœ‹æç¤º</button>
            <div id="pv-hint-box" class="hint-box"></div>
        </div>
        
        <div style="text-align:center; color:#777; margin-bottom:5px;">è«‹å°‡æ•¸å­—å¡«å…¥æ­£ç¢ºçš„ä½ç½® (æŒ‰ Enter é€å‡º)ï¼š</div>

        <div class="pv-board" id="pv-board">
            </div>

        <div style="text-align: center; margin-top:20px;">
            <div id="quiz-msg" style="height:24px; color:#e67e22; font-weight:bold; margin-bottom:10px;"></div>
            
            <div class="quiz-actions" id="quiz-actions">
                <button id="btn-reset" class="btn-gray" onclick="resetInput()">ğŸ”„ é‡å¡«</button>
                <button id="btn-check" class="btn-success" onclick="checkAnswer()">æäº¤ç­”æ¡ˆ</button>
            </div>
            
            <button id="btn-next-q" class="btn-next-level" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡</button>
        </div>
        
        <button class="btn-danger" style="float:right; margin-top:20px;" onclick="quitQuiz()">é€€å‡º</button>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 3rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-detail" style="font-size: 1.2rem; margin: 10px;">ç­”å° 5 / 5 é¡Œ</div>
            <div id="res-time" style="color:#777;">è€—æ™‚ 01:20</div>
            
            <div id="reward-area"></div>

            <div style="margin-top:20px;">
                ä½ çš„åå­—: <input type="text" id="player-name" style="padding:5px; font-size:1.2rem; text-align:center;" readonly>
                <button class="btn-warning" onclick="saveRank()">ç™»è¨˜æ¦œå–®</button>
            </div>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    // --- å…±ç”¨å…¨åŸŸè®Šæ•¸ ---
    let studentName = "å°å°å­¸å“¡"; 
    let totalGems = 0;
    
    // é¡Œåº«èˆ‡ç‹€æ…‹
    let allLists = [], currentList = null, quizData = [], currentQIdx = 0;
    let timerInt, startTime, rankData = [], exchangeLog = [];

    const STORAGE_KEY_LISTS = 'pv_game_lists_v2';
    const STORAGE_KEY_RANK = 'pv_game_rank_v2';
    const STORAGE_KEY_USER = 'pv_game_user_v2';
    const STORAGE_KEY_GEMS = 'pv_game_gems_v2';
    const STORAGE_KEY_EXCHANGE = 'pv_game_exchange_v2';
    
    // ä½æ•¸å®šç¾©æ˜ å°„ï¼šPower of 10 -> Name
    const PLACE_NAMES = {
        6: 'ç™¾è¬', 5: 'åè¬', 4: 'è¬',
        3: 'åƒ', 2: 'ç™¾', 1: 'å', 0: 'å€‹',
        '-1': 'ååˆ†', '-2': 'ç™¾åˆ†', '-3': 'åƒåˆ†', '-4': 'è¬åˆ†'
    };

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let cleanText = text.replace(/<[^>]*>/g, '');
            cleanText = cleanText.replace(/\./g, 'é»').replace(/=/g, 'ç­‰æ–¼');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'zh-TW'; utterance.rate = 1.0; 
            window.speechSynthesis.speak(utterance);
        }
    }

    window.onload = function() {
        if(localStorage.getItem(STORAGE_KEY_LISTS)) {
            allLists = JSON.parse(localStorage.getItem(STORAGE_KEY_LISTS));
        } else {
            allLists = [
                {name: "åŸºç¤æ•´æ•¸", gems: 5, passScore: 100, qs: [{t:"2500", v:"2500", h:""}, {t:"ä¸‰åƒé›¶äº”", v:"3005", h:""}]},
                {name: "å–®ä½æ›ç®—ç·´ç¿’", gems: 10, passScore: 100, qs: [{t:"25å…¬å°º7å…¬åˆ† = ?å…¬åˆ†", v:"2507", h:"1å…¬å°º=100å…¬åˆ†"}]},
                {name: "å°æ•¸ç·´ç¿’", gems: 8, passScore: 100, qs: [{t:"3.5", v:"3.5", h:""}]}
            ];
            saveData();
        }
        if(localStorage.getItem(STORAGE_KEY_RANK)) rankData = JSON.parse(localStorage.getItem(STORAGE_KEY_RANK));
        if(localStorage.getItem(STORAGE_KEY_USER)) studentName = localStorage.getItem(STORAGE_KEY_USER);
        if(localStorage.getItem(STORAGE_KEY_GEMS)) totalGems = parseInt(localStorage.getItem(STORAGE_KEY_GEMS)) || 0;
        if(localStorage.getItem(STORAGE_KEY_EXCHANGE)) exchangeLog = JSON.parse(localStorage.getItem(STORAGE_KEY_EXCHANGE));

        updateProfile();
        renderLists();
        renderExchangeLog();
    };

    function saveData() { localStorage.setItem(STORAGE_KEY_LISTS, JSON.stringify(allLists)); }
    function saveStudentData() {
        localStorage.setItem(STORAGE_KEY_USER, studentName);
        localStorage.setItem(STORAGE_KEY_GEMS, totalGems);
        localStorage.setItem(STORAGE_KEY_EXCHANGE, JSON.stringify(exchangeLog));
        updateProfile();
    }

    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) { studentName = n.trim(); saveStudentData(); }
    }
    function updateProfile() {
        document.getElementById('display-name').innerText = studentName;
        document.getElementById('player-name').value = studentName; 
        
        let crowns = Math.floor(totalGems / 100);
        let remainGems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remainGems;

        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = crowns;
            document.getElementById('shop-gems').innerText = remainGems;
        }
    }

    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
        if(pid === 'page-result') updateProfile(); 
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- çå‹µå…Œæ›é‚è¼¯ ---
    function processExchange() {
        const giftName = document.getElementById('gift-name').value.trim();
        const costVal = parseInt(document.getElementById('gift-cost').value);
        const currency = document.getElementById('gift-currency').value;

        if (!giftName) { alert("è«‹è¼¸å…¥çå“åç¨±"); return; }
        if (isNaN(costVal) || costVal <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡"); return; }

        let costInGems = costVal;
        if (currency === 'crowns') { costInGems = costVal * 100; }

        if (totalGems >= costInGems) {
            if(confirm(`ç¢ºå®šè¦èŠ±è²» ${costVal} ${currency === 'crowns' ? 'çš‡å† ' : 'å¯¶çŸ³'} å…Œæ›ã€Œ${giftName}ã€å—ï¼Ÿ`)) {
                totalGems -= costInGems;
                const logItem = {
                    date: new Date().toLocaleString(),
                    item: giftName,
                    cost: `${costVal} ${currency === 'crowns' ? 'ğŸ‘‘' : 'ğŸ’'}`
                };
                exchangeLog.unshift(logItem);
                saveStudentData();
                renderExchangeLog();
                document.getElementById('gift-name').value = '';
                document.getElementById('gift-cost').value = '';
                triggerRewardAnimation(currency === 'crowns' ? 'crown' : 'gem');
                speak(`å…Œæ›æˆåŠŸï¼`);
            }
        } else {
            alert("é¤˜é¡ä¸è¶³å–”ï¼å†å¤šç·´ç¿’è³ºå–å¯¶çŸ³å§ï¼");
        }
    }
    function renderExchangeLog() {
        const div = document.getElementById('exchange-log');
        if(!div) return;
        div.innerHTML = '';
        exchangeLog.forEach(log => {
            const row = document.createElement('div');
            row.className = 'log-item';
            row.innerHTML = `<span>ğŸ“… ${log.date} - å…Œæ› <strong>${log.item}</strong></span> <span>-${log.cost}</span>`;
            div.appendChild(row);
        });
    }

    // --- é¡Œåº«åˆ—è¡¨ç®¡ç† ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        if(allLists.length===0) c.innerHTML='<p style="text-align:center">ç›®å‰æ²’æœ‰é¡Œåº«ï¼Œè«‹æ–°å¢ã€‚</p>';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            let gemVal = l.gems ? l.gems : 5; 
            let passVal = l.passScore ? l.passScore : 100;
            
            d.innerHTML = `
                <div>
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                    <span class="gem-tag">ğŸ’ +${gemVal}</span>
                    <span class="score-tag">ğŸ¯ ${passVal}åˆ†</span>
                </div>
                <div>
                    <button class="btn-primary" onclick="startQuizInit(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                </div>`;
            c.appendChild(d);
        });
    }

    // --- ç·¨è¼¯å™¨é‚è¼¯ ---
    let editingId = null;
    function createNewList() {
        editingId = null;
        document.getElementById('list-name').value = "æ–°é¡Œåº«";
        document.getElementById('list-gems').value = 5;
        document.getElementById('list-pass-score').value = 100;
        document.getElementById('editor-rows').innerHTML = '';
        showPage('page-editor');
    }

    function editList(i) {
        editingId = i; const l = allLists[i];
        document.getElementById('list-name').value = l.name;
        document.getElementById('list-gems').value = l.gems || 5;
        document.getElementById('list-pass-score').value = l.passScore || 100;
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        l.qs.forEach(q => addEditRow(q.t, q.v, q.h));
        showPage('page-editor');
    }

    function addEditRow(txt='', val='', hint='') {
        const div = document.createElement('div'); div.className='edit-row';
        div.innerHTML = `
            <span style="font-weight:bold; color:#555; width:30px;">é¡Œ:</span>
            <input type="text" class="inp-txt" placeholder="é¡Œç›®" value="${txt}" style="flex:2; min-width:120px;">
            <span style="font-weight:bold; color:#555; width:30px;">å€¼:</span>
            <input type="text" class="inp-val" placeholder="æ•¸å€¼" value="${val}" style="flex:1; min-width:60px;">
            <span style="font-weight:bold; color:#555; width:40px;">æç¤º:</span>
            <input type="text" class="inp-hint" placeholder="æç¤º(å¯ç©º)" value="${hint || ''}" style="flex:1; min-width:80px;">
            <button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('editor-rows').appendChild(div);
    }
    
    function insertChar(char) {
        let activeEl = document.activeElement;
        // å…è¨±æ’å…¥åˆ° é¡Œç›®(inp-txt) æˆ– æç¤º(inp-hint)
        if(activeEl && (activeEl.classList.contains('inp-txt') || activeEl.classList.contains('inp-hint'))) {
            let start = activeEl.selectionStart;
            let end = activeEl.selectionEnd;
            let val = activeEl.value;
            activeEl.value = val.substring(0, start) + char + val.substring(end);
            activeEl.focus();
            activeEl.selectionStart = activeEl.selectionEnd = start + char.length;
        } else {
            // é è¨­åŠ åˆ°æœ€å¾Œä¸€åˆ—çš„é¡Œç›®
            let rows = document.querySelectorAll('.inp-txt');
            if(rows.length > 0) {
                let last = rows[rows.length-1];
                last.value += char;
                last.focus();
            }
        }
    }

    function autoGenerate() {
        const count = parseInt(document.getElementById('gen-count').value);
        const intDigits = parseInt(document.getElementById('gen-int-digits').value) || 2;
        const decDigits = parseInt(document.getElementById('gen-dec-digits').value) || 0;
        
        const minInt = Math.pow(10, intDigits-1);
        const maxInt = Math.pow(10, intDigits) - 1;
        
        for(let i=0; i<count; i++) {
            let intPart = Math.floor(Math.random()*(maxInt-minInt+1)) + minInt;
            let valStr = intPart.toString();
            
            if(decDigits > 0) {
                let decPart = "";
                for(let j=0; j<decDigits; j++) decPart += Math.floor(Math.random()*10);
                valStr += "." + decPart;
            }
            addEditRow(valStr, valStr, "");
        }
    }

    function saveList() {
        const name = document.getElementById('list-name').value;
        const gems = parseInt(document.getElementById('list-gems').value) || 5;
        const passScore = parseInt(document.getElementById('list-pass-score').value) || 100;
        
        const rows = document.querySelectorAll('.edit-row');
        const qs = [];
        rows.forEach(r => {
            const t = r.querySelector('.inp-txt').value.trim();
            const v = r.querySelector('.inp-val').value.trim(); 
            const h = r.querySelector('.inp-hint').value.trim();
            if(t && v) qs.push({t, v, h});
        });

        if(qs.length===0) return alert("è«‹è‡³å°‘æ–°å¢ä¸€é¡Œ");
        
        const data = {name, gems, passScore, qs};
        if(editingId === null) allLists.push(data); else allLists[editingId] = data;
        saveData(); showPage('page-home');
    }
    function delList(i) { if(confirm("åˆªé™¤æ­¤é¡Œåº«?")) { allLists.splice(i,1); saveData(); renderLists(); } }

    // --- è³‡æ–™åŒ¯å…¥åŒ¯å‡º ---
    function exportData() {
        const now = new Date();
        const dateStr = `${now.getFullYear()}${now.getMonth()+1}${now.getDate()}`;
        const exportObj = { version: "2.3", student: { name: studentName, totalGems: totalGems }, lists: allLists, exchangeLog: exchangeLog };
        const blob = new Blob([JSON.stringify(exportObj)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `placevalue_v2.3_backup_${dateStr}.json`; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function handleImport(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(d.lists) allLists = d.lists; 
                if(d.student) { studentName = d.student.name; totalGems = d.student.totalGems; }
                if(d.exchangeLog) exchangeLog = d.exchangeLog;
                saveData(); saveStudentData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ");
            } catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f);
    }

    // --- æ¸¬é©—æ ¸å¿ƒé‚è¼¯ ---
    function startQuizInit(i) {
        currentList = allLists[i];
        quizData = currentList.qs.map(q => ({
            text: q.t,
            val: q.v.toString(), 
            hint: q.h || "",
            isCorrect: false
        }));
        currentQIdx = 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        showPage('page-quiz');
        speak(`é–‹å§‹ç·´ç¿’ ${currentList.name}ï¼ŒåŠ æ²¹ï¼`);
        loadQuestion();
    }
    
    function updTime() {
        const s = Math.floor((Date.now()-startTime)/1000);
        document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡º?")) { clearInterval(timerInt); showPage('page-home'); } }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('pv-q-text').innerText = q.text;
        document.getElementById('quiz-msg').innerText = "";
        
        // æç¤ºè™•ç†
        const btnHint = document.getElementById('btn-show-hint');
        const hintBox = document.getElementById('pv-hint-box');
        hintBox.style.display = 'none';
        hintBox.innerText = "";
        
        if(q.hint && q.hint.length > 0) {
            btnHint.style.display = 'inline-block';
            hintBox.innerText = q.hint;
        } else {
            btnHint.style.display = 'none';
        }
        
        // é¡¯ç¤ºæäº¤å€ï¼Œéš±è—ä¸‹ä¸€é¡Œ
        document.getElementById('quiz-actions').style.display = 'flex';
        document.getElementById('btn-next-q').style.display = 'none';

        renderBoard(q.val);
        // Focus first input (ç™¾è¬ä½)
        setTimeout(() => {
            let inputs = document.querySelectorAll('.pv-input');
            if(inputs.length > 0) inputs[0].focus();
        }, 300);
    }

    function showHint() {
        const hintBox = document.getElementById('pv-hint-box');
        hintBox.style.display = 'block';
        speak("æç¤ºï¼š" + hintBox.innerText);
    }
    
    function resetInput() {
        const inputs = document.querySelectorAll('.pv-input');
        inputs.forEach(inp => {
            if(!inp.disabled) {
                inp.value = '';
                inp.classList.remove('wrong');
                inp.classList.remove('correct');
            }
        });
        document.getElementById('quiz-msg').innerText = "";
        if(inputs.length > 0) inputs[0].focus();
    }

    function handleEnter(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            checkAnswer();
        }
    }

    function moveToNext(elm) {
        elm.value = elm.value.replace(/[^0-9]/g, ''); // åªèƒ½æ•¸å­—
        if(elm.value.length === 1) {
            let nextId = parseInt(elm.id.split('-')[1]) + 1;
            let nextElm = document.getElementById(`inp-${nextId}`);
            if(nextElm) {
                nextElm.focus();
            }
        }
    }

    function renderBoard(valStr) {
        const board = document.getElementById('pv-board');
        board.innerHTML = '';
        
        let parts = valStr.split('.');
        let decPart = parts.length > 1 ? parts[1] : "";

        // ä¿®æ”¹ï¼šæ•´æ•¸éƒ¨åˆ†å›ºå®šå¾ç™¾è¬ä½ (power 6) é–‹å§‹
        let maxPower = 6; 
        
        // å°æ•¸éƒ¨åˆ†ï¼šè¦–æƒ…æ³å»¶ä¼¸
        let minPower = decPart.length > 0 ? -decPart.length : 0;
        
        let globalIndex = 0;

        for(let p = maxPower; p >= minPower; p--) {
            // å°æ•¸é»è™•ç†
            if(p === -1) {
                let dotCol = document.createElement('div');
                dotCol.className = 'decimal-point';
                dotCol.innerText = 'â€¢';
                board.appendChild(dotCol);
            }

            let col = document.createElement('div'); 
            col.className = 'pv-col';
            let placeName = PLACE_NAMES[p] || '?';
            
            // åŠ å…¥ onkeydown="handleEnter(event)"
            col.innerHTML = `
                <div class="pv-header">${placeName}</div>
                <input type="tel" class="pv-input" id="inp-${globalIndex}" data-power="${p}" maxlength="1" oninput="moveToNext(this)" onkeydown="handleEnter(event)">
            `;
            board.appendChild(col);
            globalIndex++;
        }
    }

    function checkAnswer() {
        const q = quizData[currentQIdx];
        const valStr = q.val;
        let parts = valStr.split('.');
        let intPart = parts[0];
        let decPart = parts.length > 1 ? parts[1] : "";
        
        let isAllCorrect = true;
        
        const inputs = document.querySelectorAll('.pv-input');
        
        inputs.forEach(inp => {
            let power = parseInt(inp.getAttribute('data-power'));
            let userVal = inp.value;
            let correctVal = "";

            if(power >= 0) {
                // æ•´æ•¸éƒ¨åˆ†ï¼šå°é½Šè™•ç†
                let charIndex = intPart.length - 1 - power;
                if(charIndex >= 0 && charIndex < intPart.length) correctVal = intPart[charIndex];
                else correctVal = "0"; 
            } else {
                // å°æ•¸éƒ¨åˆ†
                let charIndex = -power - 1;
                if(charIndex >= 0 && charIndex < decPart.length) correctVal = decPart[charIndex];
                else correctVal = "0"; 
            }

            // ç©ºç™½è¦–ç‚º 0
            if(userVal === "") userVal = "0";
            if(correctVal === "") correctVal = "0";

            if(userVal === correctVal) {
                inp.classList.remove('wrong');
                inp.classList.add('correct');
                inp.disabled = true;
            } else {
                inp.classList.add('wrong');
                isAllCorrect = false;
            }
        });

        if(isAllCorrect) {
            quizData[currentQIdx].isCorrect = true;
            document.getElementById('quiz-msg').innerText = "å¤ªæ£’äº†ï¼å…¨å°ï¼";
            speak("ç­”å°äº†ï¼");
            document.getElementById('quiz-actions').style.display = 'none';
            document.getElementById('btn-next-q').style.display = 'inline-block';
            if(currentQIdx === quizData.length - 1) {
                 document.getElementById('btn-next-q').innerText = "æŸ¥çœ‹æˆç¸¾ ğŸ†";
            } else {
                 document.getElementById('btn-next-q').innerText = "ä¸‹ä¸€é¡Œ â¡";
            }
        } else {
            document.getElementById('quiz-msg').innerText = "æœ‰éŒ¯èª¤å–”ï¼Œå†æª¢æŸ¥ä¸€ä¸‹ç´…è‰²çš„æ ¼å­ã€‚";
            speak("æœ‰åœ°æ–¹ç®—éŒ¯å›‰");
        }
    }

    function nextQuestion() {
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        clearInterval(timerInt);
        let correct = quizData.filter(x => x.isCorrect).length;
        let score = Math.round((correct / quizData.length) * 100);
        
        showPage('page-result');
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-detail').innerText = `ç­”å° ${correct} / ${quizData.length} é¡Œ`;
        document.getElementById('res-time').innerText = `è€—æ™‚ ${document.getElementById('q-timer').innerText}`;
        
        const rewardArea = document.getElementById('reward-area');
        rewardArea.innerHTML = '';
        
        let passScore = currentList.passScore || 100;
        let gemsReward = currentList.gems || 5;

        if (score >= passScore) {
            let oldGems = totalGems; 
            let oldCrowns = Math.floor(oldGems / 100);
            
            totalGems += gemsReward; 
            saveStudentData(); 
            
            let newCrowns = Math.floor(totalGems / 100); 
            let earnedCrowns = newCrowns - oldCrowns;

            if (earnedCrowns > 0) {
                triggerRewardAnimation('crown');
                rewardArea.innerHTML = `<div class="reward-popup" style="border-color:#e67e22; color:#e67e22;">ğŸ‘‘ æ­å–œå‡ç´šï¼ç²å¾— ${earnedCrowns} é ‚çš‡å† ï¼<br>(åŒæ™‚ç²å¾— ${gemsReward} é¡†å¯¶çŸ³)</div>`;
                speak(`å¤ªå²å®³äº†ï¼æ­å–œä½ ç²å¾—äº† ${earnedCrowns} é ‚çš‡å† ï¼`);
            } else {
                triggerRewardAnimation('gem');
                rewardArea.innerHTML = `<div class="reward-popup">ğŸ‰ æ­å–œé”æ¨™ï¼ç²å¾— ${gemsReward} é¡†å¯¶çŸ³ ğŸ’<br>ç›®å‰ç´¯ç©: ${totalGems} é¡†</div>`;
                speak(`å¤ªæ£’äº†ï¼ä½ ç²å¾—äº† ${gemsReward} é¡†å¯¶çŸ³ï¼`);
            }
        } else {
            speak(`æ¸¬é©—çµæŸï¼Œå†åŠ æ²¹ï¼`);
        }
    }

    // --- æ’è¡Œæ¦œ ---
    function saveRank() {
        let score = parseInt(document.getElementById('res-score').innerText);
        rankData.push({name: studentName, score: score, list: currentList.name, date: new Date().toLocaleDateString()});
        rankData.sort((a,b) => b.score - a.score);
        rankData = rankData.slice(0, 20); 
        localStorage.setItem(STORAGE_KEY_RANK, JSON.stringify(rankData));
        alert("å·²ç™»è¨˜ï¼"); switchTab('rank'); showPage('page-home');
    }
    function renderRank() {
        const box = document.getElementById('rank-container'); box.innerHTML = '';
        if(rankData.length===0) { box.innerHTML='<div style="padding:20px; text-align:center;">æš«ç„¡è³‡æ–™</div>'; return; }
        rankData.forEach((r, i) => {
            const row = document.createElement('div'); 
            row.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;";
            if(i===0) row.style.color = '#f39c12';
            row.innerHTML = `<span>#${i+1} ${r.name}</span> <span style="font-size:0.8rem; color:#888;">${r.list}</span> <span>${r.score}åˆ†</span>`;
            box.appendChild(row);
        });
    }
    function clearRank() { if(confirm("æ¸…ç©ºæ¦œå–®?")) { rankData=[]; localStorage.removeItem(STORAGE_KEY_RANK); renderRank(); } }

    function triggerRewardAnimation(type) {
        const container = document.getElementById('particle-container');
        container.style.display = 'block'; container.innerHTML = ''; 
        let symbol = type === 'crown' ? 'ğŸ‘‘' : 'ğŸ’';
        for (let i = 0; i < 30; i++) {
            let p = document.createElement('div'); p.innerText = symbol; p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw'; p.style.animationDuration = (Math.random() * 2 + 1) + 's'; 
            p.style.fontSize = (Math.random() * 2 + 1) + 'rem'; container.appendChild(p);
        }
        setTimeout(() => { container.style.display = 'none'; container.innerHTML = ''; }, 3000);
    }
</script>

</body>
</html>
