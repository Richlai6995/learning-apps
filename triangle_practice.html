<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰è§’å½¢æ¢éšªå®¶ v1.1</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --bg-color: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --input-bg: #e1f5fe;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem; }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .status-bar {
            display: flex; justify-content: space-between; width: 100%; max-width: 600px;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px;
            align-items: center;
        }
        .user-info { font-weight: bold; font-size: 1.1rem; cursor: pointer; color: var(--primary); }
        .currency { font-size: 1rem; display: flex; gap: 10px; }

        /* --- ç•«å¸ƒå€åŸŸ --- */
        .canvas-container {
            position: relative;
            margin-bottom: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            cursor: crosshair;
            overflow: hidden;
        }
        canvas { display: block; touch-action: none; }

        /* --- æ‰‹å‹•è¼¸å…¥é¢æ¿ (æ”¹è‰¯ç‰ˆ) --- */
        .manual-panel {
            width: 100%; max-width: 600px;
            background: #fff; border: 2px solid #3498db;
            padding: 15px; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .input-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .input-title { font-weight: bold; color: #2980b9; font-size: 1.1rem; }
        
        .radio-group { display: flex; gap: 15px; font-size: 0.95rem; }
        .input-row { display: flex; gap: 10px; justify-content: space-around; align-items: flex-end; margin-top: 10px; }
        .input-item { display: flex; flex-direction: column; align-items: center; width: 30%; }
        .input-item label { font-size: 0.9rem; font-weight: bold; margin-bottom: 3px; }
        .input-item input { 
            width: 100%; padding: 8px; text-align: center; border-radius: 8px; 
            border: 1px solid #ccc; font-size: 1.1rem; font-weight: bold; color: #333;
        }
        .input-item input:focus { border-color: var(--primary); outline: none; background: #fdf2ff; }

        /* --- è³‡è¨Šé¡¯ç¤º --- */
        .info-panel {
            width: 100%; max-width: 600px;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px; text-align: center;
        }
        .triangle-type {
            font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; min-height: 1.5em;
        }
        
        /* --- æŒ‰éˆ• --- */
        .controls { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 600px; margin-bottom: 20px; }
        button {
            border: none; border-radius: 25px; padding: 10px 15px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
            color: white; transition: 0.2s; box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-teach { background-color: var(--success); }
        .btn-quiz { background-color: var(--warning); }
        .btn-build { background-color: var(--danger); }
        .btn-shop { background-color: #3498db; width: 100%; max-width: 600px; margin-top: 10px; padding: 12px;}
        .btn-apply { background-color: var(--primary); width: 100%; margin-top: 15px; border-radius: 10px;}
        .btn-action { background-color: var(--primary); display: none; margin-top: 10px; width: 100%; padding: 12px; animation: pulse 1s infinite;}

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .mode-badge {
            background: var(--dark); color: white; padding: 4px 12px;
            border-radius: 15px; font-size: 0.9rem; position: absolute;
            top: 10px; left: 10px; pointer-events: none; opacity: 0.8;
        }
        
        .version-tag {
            position: fixed; bottom: 5px; left: 5px; font-size: 0.8rem; color: #aaa; font-family: monospace;
        }

        /* å•†åº—å½ˆçª— */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; position: relative; animation: popIn 0.3s; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .close-btn { position: absolute; top: 10px; right: 10px; background: #ccc; width: 30px; height: 30px; border-radius: 50%; border: none; font-weight: bold; color: white; cursor: pointer; }

        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        .particle { position: absolute; font-size: 1.5rem; animation: fall 2s linear forwards; }
        @keyframes fall { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(100vh); } }

        .quiz-feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; text-shadow: 0 0 10px white; display: none; pointer-events: none; z-index: 10; }
        .correct-txt { color: var(--success); }
        .wrong-txt { color: var(--danger); }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div class="status-bar">
        <div class="user-info" onclick="changeName()">ğŸ“ <span id="u-name">å­¸å“¡</span></div>
        <div class="currency">
            <span>ğŸ‘‘ <span id="u-crowns">0</span></span>
            <span>ğŸ’ <span id="u-gems">0</span></span>
        </div>
    </div>

    <h1>ğŸ“ ä¸‰è§’å½¢æ¢éšªå®¶</h1>

    <div class="canvas-container">
        <div id="mode-label" class="mode-badge">æ•™å­¸æ¨¡å¼</div>
        <div id="feedback-text" class="quiz-feedback">O</div>
        <canvas id="geoCanvas" width="600" height="400"></canvas>
    </div>

    <div id="manual-panel" class="manual-panel">
        <div class="input-header">
            <span class="input-title">ğŸ› ï¸ åƒæ•¸å¯¦é©—å®¤</span>
            <div class="radio-group">
                <label><input type="radio" name="inputMode" value="sss" checked onchange="toggleInputMode()"> èª¿æ•´ä¸‰é‚Š (SSS)</label>
                <label><input type="radio" name="inputMode" value="sas" onchange="toggleInputMode()"> èª¿æ•´å¤¾è§’ (SAS)</label>
            </div>
        </div>
        
        <div id="inputs-sss" class="input-row">
            <div class="input-item">
                <label style="color:#e74c3c">é‚Š a (å°BC)</label>
                <input type="number" id="in-a" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
            </div>
            <div class="input-item">
                <label style="color:#27ae60">é‚Š b (å°AC)</label>
                <input type="number" id="in-b" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
            </div>
            <div class="input-item">
                <label style="color:#2980b9">é‚Š c (å°AB)</label>
                <input type="number" id="in-c" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
            </div>
        </div>

        <div id="inputs-sas" class="input-row" style="display:none;">
            <div class="input-item">
                <label style="color:#2980b9">é‚Š c (AB)</label>
                <input type="number" id="in-sas-c" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
            </div>
            <div class="input-item">
                <label style="color:#e67e22">âˆ A (å¤¾è§’)</label>
                <input type="number" id="in-sas-A" step="1" onkeydown="if(event.key==='Enter') applyManualInput()">
            </div>
            <div class="input-item">
                <label style="color:#27ae60">é‚Š b (AC)</label>
                <input type="number" id="in-sas-b" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
            </div>
        </div>

        <button class="btn-apply" onclick="applyManualInput()">ğŸ”„ è®Šæ›´å½¢ç‹€</button>
    </div>

    <div class="info-panel">
        <div id="tri-type-display" class="triangle-type">ä»»æ„ä¸‰è§’å½¢</div>
        <div id="angle-info" style="font-size:1.1rem; color:#555; margin-top:5px;">
            âˆ A: 0Â° | âˆ B: 0Â° | âˆ C: 0Â°
        </div>
        <div id="quiz-question" style="display:none; margin-top:10px; font-weight:bold; font-size:1.2rem; color:#d35400;"></div>
    </div>

    <div class="controls">
        <button class="btn-teach" onclick="setMode('teach')">ğŸ“– è‡ªç”±æ¢ç´¢</button>
        <button class="btn-quiz" onclick="setMode('quiz_select')">â“ å±¬æ€§æ¸¬é©—</button>
        <button class="btn-build" onclick="setMode('quiz_build')">ğŸ”¨ å»ºæ§‹æŒ‘æˆ°</button>
    </div>
    
    <div style="width: 100%; max-width: 600px; text-align: center;">
        <button id="btn-submit" class="btn-action" onclick="checkAnswer()">âœ… é€å‡ºç­”æ¡ˆ</button>
        <button class="btn-shop" onclick="openShop()">ğŸ çå‹µå•†åº—</button>
    </div>

    <div class="version-tag">Version 1.1</div>

    <div id="shop-modal" class="overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeShop()">Ã—</button>
            <h2>ğŸ çå‹µå…Œæ›</h2>
            <p>ä½ æœ‰ ğŸ’ <span id="shop-gems">0</span> | ğŸ‘‘ <span id="shop-crowns">0</span></p>
            <input type="text" id="gift-name" placeholder="çå“åç¨± (å¦‚: çœ‹å¡é€š)" style="padding:10px; width:80%; margin-bottom:10px;">
            <div style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;">
                <input type="number" id="gift-cost" placeholder="èŠ±è²»" style="padding:10px; width:60px;">
                <select id="gift-currency" style="padding:10px;">
                    <option value="gems">ğŸ’</option>
                    <option value="crowns">ğŸ‘‘</option>
                </select>
            </div>
            <button class="btn-shop" onclick="buyItem()">ç¢ºèªå…Œæ›</button>
            <div id="shop-log" style="text-align:left; margin-top:15px; font-size:0.9rem; max-height:100px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px;"></div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('geoCanvas');
    const ctx = canvas.getContext('2d');
    
    // å®šç¾©é ‚é» A, B, C (Aåœ¨ä¸Šæ–¹, Bå·¦ä¸‹, Cå³ä¸‹)
    let points = [
        {x: 300, y: 100, label: 'A', color: '#e74c3c'},
        {x: 100, y: 300, label: 'B', color: '#27ae60'},
        {x: 500, y: 300, label: 'C', color: '#2980b9'}
    ];
    let dragIdx = -1;
    let currentMode = 'teach'; 
    let currentTarget = null; 
    let user = { name: "å°å°å¹¾ä½•å­¸å®¶", gems: 0, crowns: 0, log: [] };
    const STORAGE_KEY = "tri_explorer_v1.1";
    const SCALE_FACTOR = 40; // 40px = 1 unit

    function init() {
        resizeCanvas();
        loadUser();
        updateUI();
        draw();
        
        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('mousemove', onMove);
        canvas.addEventListener('mouseup', onUp);
        canvas.addEventListener('touchstart', onDown, {passive: false});
        canvas.addEventListener('touchmove', onMove, {passive: false});
        canvas.addEventListener('touchend', onUp);
        window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
        let container = document.querySelector('.canvas-container');
        canvas.width = container.clientWidth;
        canvas.height = Math.min(400, window.innerHeight * 0.5);
        // ç°¡å–®é™åˆ¶é»ä¸è·‘å‡ºç•«é¢
        points.forEach(p => {
            p.x = Math.max(10, Math.min(canvas.width - 10, p.x));
            p.y = Math.max(10, Math.min(canvas.height - 10, p.y));
        });
        draw();
    }

    // --- æ ¸å¿ƒç¹ªåœ–èˆ‡è¨ˆç®— ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid();

        // ç•«ä¸‰è§’å½¢
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.lineTo(points[2].x, points[2].y);
        ctx.closePath();
        ctx.fillStyle = 'rgba(142, 68, 173, 0.1)';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#34495e';
        ctx.stroke();

        let sides = getSides(); 
        let angles = getAngles(sides);

        // ç•«é»
        points.forEach((p, i) => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(p.label, p.x - 5, p.y - 15);
        });

        // åªæœ‰åœ¨éæ‹–æ›³ç‹€æ…‹æˆ–æ‹–æ›³çµæŸæ™‚æ›´æ–°è¼¸å…¥æ¡†ï¼Œé¿å…æ‰“å­—è¡çª
        // ä½†ç‚ºäº†å³æ™‚æ€§ï¼Œæˆ‘å€‘æª¢æŸ¥æ˜¯å¦æ­£åœ¨èšç„¦è¼¸å…¥æ¡†
        if (document.activeElement.tagName !== 'INPUT') {
            updateStatsAndInputs(sides, angles);
        } else {
            // åƒ…æ›´æ–°æ–‡å­—é¡¯ç¤ºï¼Œä¸æ›´æ–° Input value ä»¥å…å¹²æ“¾è¼¸å…¥
            updateTextDisplay(sides, angles);
        }
    }

    function drawGrid() {
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        const step = 40;
        for(let x=0; x<canvas.width; x+=step) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y=0; y<canvas.height; y+=step) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    }

    function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }

    function getSides() {
        // a=BC, b=AC, c=AB
        let a = dist(points[1], points[2]) / SCALE_FACTOR;
        let b = dist(points[0], points[2]) / SCALE_FACTOR;
        let c = dist(points[0], points[1]) / SCALE_FACTOR;
        return [a, b, c];
    }

    function getAngles(sides) {
        let a = sides[0], b = sides[1], c = sides[2];
        let A = Math.acos((b*b + c*c - a*a) / (2*b*c)) * (180 / Math.PI);
        let B = Math.acos((a*a + c*c - b*b) / (2*a*c)) * (180 / Math.PI);
        let C = 180 - A - B;
        if(isNaN(A)) A=0; if(isNaN(B)) B=0; if(isNaN(C)) C=0;
        return [A, B, C];
    }

    function updateStatsAndInputs(sides, angles) {
        updateTextDisplay(sides, angles);

        // åŒæ­¥æ›´æ–°è¼¸å…¥æ¡†æ•¸å€¼
        document.getElementById('in-a').value = sides[0].toFixed(1);
        document.getElementById('in-b').value = sides[1].toFixed(1);
        document.getElementById('in-c').value = sides[2].toFixed(1);
        
        document.getElementById('in-sas-c').value = sides[2].toFixed(1);
        document.getElementById('in-sas-b').value = sides[1].toFixed(1);
        document.getElementById('in-sas-A').value = Math.round(angles[0]);
    }

    function updateTextDisplay(sides, angles) {
        let typeText = analyzeTriangle(sides, angles);
        if (currentMode === 'teach') {
            document.getElementById('tri-type-display').innerText = typeText;
            document.getElementById('tri-type-display').style.color = '#8e44ad';
        } else if (currentMode === 'quiz_build') {
            document.getElementById('tri-type-display').innerText = "å»ºæ§‹ä¸­..."; 
            document.getElementById('tri-type-display').style.color = '#95a5a6';
        } else {
            document.getElementById('tri-type-display').innerText = "??? ä¸‰è§’å½¢";
        }

        document.getElementById('angle-info').innerText = 
            `âˆ A: ${Math.round(angles[0])}Â° | âˆ B: ${Math.round(angles[1])}Â° | âˆ C: ${Math.round(angles[2])}Â°`;
    }

    function analyzeTriangle(sides, angles) {
        let [A, B, C] = angles;
        let [a, b, c] = sides;
        let maxAngle = Math.max(A, B, C);
        let labels = [];

        if (Math.abs(maxAngle - 90) < 2) labels.push("ç›´è§’");
        else if (maxAngle > 90) labels.push("éˆè§’");
        else labels.push("éŠ³è§’");

        let isEquilateral = (Math.abs(a-b)<0.1 && Math.abs(b-c)<0.1);
        let isIsosceles = (Math.abs(a-b)<0.1 || Math.abs(b-c)<0.1 || Math.abs(a-c)<0.1);

        if (isEquilateral) labels.push("æ­£");
        else if (isIsosceles) labels.push("ç­‰è…°");
        
        return labels.join(" ") + "ä¸‰è§’å½¢";
    }

    // --- æ‰‹å‹•è¼¸å…¥è®Šå½¢é‚è¼¯ (é‡é»ä¿®æ­£) ---
    function toggleInputMode() {
        const mode = document.querySelector('input[name="inputMode"]:checked').value;
        document.getElementById('inputs-sss').style.display = mode === 'sss' ? 'flex' : 'none';
        document.getElementById('inputs-sas').style.display = mode === 'sas' ? 'flex' : 'none';
    }

    function applyManualInput() {
        const mode = document.querySelector('input[name="inputMode"]:checked').value;
        let a, b, c, angA;

        // 1. å–å¾—ç›®æ¨™é‚Šé•·èˆ‡è§’åº¦
        if (mode === 'sss') {
            a = parseFloat(document.getElementById('in-a').value);
            b = parseFloat(document.getElementById('in-b').value);
            c = parseFloat(document.getElementById('in-c').value);
            
            // ä¸‰è§’å½¢ä¸ç­‰å¼æª¢æŸ¥
            if (a + b <= c || a + c <= b || b + c <= a) {
                alert("âŒ ç„¡æ³•æ§‹æˆä¸‰è§’å½¢ï¼\næç¤ºï¼šä»»å…©é‚Šä¹‹å’Œå¿…é ˆå¤§æ–¼ç¬¬ä¸‰é‚Šã€‚");
                return;
            }
            // è¨ˆç®—è§’ A
            angA = Math.acos((b*b + c*c - a*a) / (2*b*c)); // å¼§åº¦
        } else {
            c = parseFloat(document.getElementById('in-sas-c').value); // AB
            b = parseFloat(document.getElementById('in-sas-b').value); // AC
            let degA = parseFloat(document.getElementById('in-sas-A').value);
            if (degA >= 180 || degA <= 0) { alert("è§’åº¦å¿…é ˆåœ¨ 0~180 ä¹‹é–“"); return; }
            angA = degA * (Math.PI / 180);
        }

        // 2. é€²è¡Œè®Šå½¢ (ä¿æŒ A é»ä¸å‹•ï¼Œä¿æŒ AB é‚Šçš„æ–¹å‘ä¸å‹•)
        const pA = points[0]; 
        const pB = points[1]; 
        const pC = points[2];

        // è¨ˆç®—ç›®å‰ AB çš„æ–¹å‘å‘é‡è§’åº¦
        const currentAngleAB = Math.atan2(pB.y - pA.y, pB.x - pA.x);
        
        // æ›´æ–° B é»ï¼šæ²¿è‘—ç›®å‰ AB æ–¹å‘å»¶ä¼¸ c é•·åº¦
        // æ³¨æ„ï¼šè¼¸å…¥å–®ä½è¦è½‰å›åƒç´ å–®ä½
        const pixelC = c * SCALE_FACTOR;
        pB.x = pA.x + pixelC * Math.cos(currentAngleAB);
        pB.y = pA.y + pixelC * Math.sin(currentAngleAB);

        // æ›´æ–° C é»ï¼š
        // æˆ‘å€‘éœ€è¦çŸ¥é“ç›®å‰ C æ˜¯åœ¨ AB çš„é †æ™‚é‡é‚„æ˜¯é€†æ™‚é‡å´ï¼Œä»¥ä¿æŒå½¢ç‹€ç¿»è½‰çš„ä¸€è‡´æ€§
        // ä½¿ç”¨å‰ç© (Cross Product) åˆ¤æ–·æ–¹å‘
        // Vector AB = (Bx-Ax, By-Ay), Vector AC = (Cx-Ax, Cy-Ay)
        // Cross = (Bx-Ax)*(Cy-Ay) - (By-Ay)*(Cx-Ax)
        const crossProduct = (pB.x - pA.x)*(pC.y - pA.y) - (pB.y - pA.y)*(pC.x - pA.x);
        
        // æ±ºå®š C çš„æ—‹è½‰æ–¹å‘ (+angA æˆ– -angA)
        // å¦‚æœ crossProduct > 0ï¼ŒC åœ¨ AB é †æ™‚é‡(è¦–åº§æ¨™ç³»è€Œå®š)
        // ç°¡å–®ä¾†èªªï¼Œæˆ‘å€‘è®“æ–°è§’åº¦ç›¸å°æ–¼ AB çš„åè½‰æ–¹å‘èˆ‡åŸæœ¬ä¸€è‡´
        let direction = crossProduct >= 0 ? 1 : -1;
        
        const pixelB = b * SCALE_FACTOR; // ACé•·åº¦
        const newAngleAC = currentAngleAB + (direction * angA);
        
        pC.x = pA.x + pixelB * Math.cos(newAngleAC);
        pC.y = pA.y + pixelB * Math.sin(newAngleAC);

        // 3. é‡ç¹ª
        draw();
        speak("è®Šå½¢å®Œæˆï¼");
    }

    // --- æ‹–æ›³äº’å‹• ---
    function getPointerPos(e) {
        let rect = canvas.getBoundingClientRect();
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function onDown(e) {
        if(e.type === 'touchstart') e.preventDefault();
        let pos = getPointerPos(e);
        points.forEach((p, i) => { if (dist(pos, p) < 30) dragIdx = i; });
    }

    function onMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        if (dragIdx !== -1) {
            let pos = getPointerPos(e);
            pos.x = Math.max(10, Math.min(canvas.width - 10, pos.x));
            pos.y = Math.max(10, Math.min(canvas.height - 10, pos.y));
            points[dragIdx].x = pos.x;
            points[dragIdx].y = pos.y;
            draw();
        }
    }

    function onUp(e) { dragIdx = -1; }

    // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    function setMode(mode) {
        currentMode = mode;
        let label = document.getElementById('mode-label');
        let qBox = document.getElementById('quiz-question');
        let subBtn = document.getElementById('btn-submit');
        
        qBox.style.display = 'none';
        subBtn.style.display = 'none';
        
        if (mode === 'teach') {
            label.innerText = "æ•™å­¸æ¨¡å¼";
            label.style.background = "#2c3e50";
            speak("é€²å…¥è‡ªç”±æ¢ç´¢æ¨¡å¼");
        } else if (mode === 'quiz_select') {
            label.innerText = "å±¬æ€§æ¸¬é©—";
            label.style.background = "#f39c12";
            startQuizSelect();
        } else if (mode === 'quiz_build') {
            label.innerText = "å»ºæ§‹æŒ‘æˆ°";
            label.style.background = "#c0392b";
            startQuizBuild();
        }
        draw();
    }

    // --- æ¸¬é©—åŠŸèƒ½ ---
    function startQuizSelect() {
        randomizeTriangle();
        draw();
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        let types = ["éŠ³è§’", "ç›´è§’", "éˆè§’", "ç­‰è…°"];
        let target = types[Math.floor(Math.random() * types.length)];
        currentTarget = { type: 'select', target: target };
        qBox.innerHTML = `é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong> å—ï¼Ÿ`;
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "ğŸ¤” é»æ­¤æŸ¥çœ‹ç­”æ¡ˆ";
        subBtn.style.display = 'inline-block';
        subBtn.onclick = checkAnswerSelect;
        speak(`é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹${target}ä¸‰è§’å½¢å—ï¼Ÿ`);
    }

    function checkAnswerSelect() {
        let sides = getSides();
        let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let isCorrect = typeStr.includes(currentTarget.target);
        let feedback = document.getElementById('quiz-question');
        if (isCorrect) {
            feedback.innerHTML += `<br><span style="color:green">â­• æ˜¯çš„ï¼é€™æ˜¯ ${typeStr}</span>`;
            addReward(1);
            showFeedback(true);
        } else {
            feedback.innerHTML += `<br><span style="color:red">âŒ ä¸æ˜¯å–”ï¼Œé€™æ˜¯ ${typeStr}</span>`;
            showFeedback(false);
        }
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "â¡ ä¸‹ä¸€é¡Œ";
        subBtn.onclick = startQuizSelect;
    }

    function startQuizBuild() {
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        let subBtn = document.getElementById('btn-submit');
        subBtn.style.display = 'inline-block';
        subBtn.innerText = "âœ… æˆ‘åšå¥½äº†ï¼";
        subBtn.onclick = checkAnswerBuild;
        let missions = ["ç›´è§’", "éˆè§’", "ç­‰è…°", "æ­£", "ç­‰è…°ç›´è§’"];
        let target = missions[Math.floor(Math.random() * missions.length)];
        currentTarget = { type: 'build', target: target };
        qBox.innerHTML = `ä»»å‹™ï¼šè«‹åšå‡ºä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong>`;
        speak(`ä»»å‹™é–‹å§‹ï¼šè«‹åšå‡ºä¸€å€‹${target}ä¸‰è§’å½¢`);
    }

    function checkAnswerBuild() {
        let sides = getSides();
        let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let target = currentTarget.target;
        let isCorrect = false;
        if (target === "ç­‰è…°ç›´è§’") isCorrect = typeStr.includes("ç­‰è…°") && typeStr.includes("ç›´è§’");
        else isCorrect = typeStr.includes(target);

        if (isCorrect) {
            alert(`å¤ªæ£’äº†ï¼ä½ æˆåŠŸåšå‡ºäº† ${typeStr}ï¼ç²å¾— 3 é¡†å¯¶çŸ³ğŸ’`);
            addReward(3);
            showFeedback(true);
            triggerParticles();
            setTimeout(startQuizBuild, 1500); 
        } else {
            alert(`é‚„å·®ä¸€é»é»å–”ï¼ç›®å‰æ˜¯ï¼š${typeStr}ã€‚\nè«‹å†è©¦è©¦çœ‹ï¼`);
            showFeedback(false);
        }
    }

    function randomizeTriangle() {
        points[0].x = 100 + Math.random() * 400;
        points[0].y = 50 + Math.random() * 100;
        points[1].x = 50 + Math.random() * 200;
        points[1].y = 250 + Math.random() * 100;
        points[2].x = 350 + Math.random() * 200;
        points[2].y = 250 + Math.random() * 100;
    }

    // --- ç³»çµ±åŠŸèƒ½ ---
    function addReward(gems) {
        user.gems += gems;
        if (user.gems >= 100) { user.gems -= 100; user.crowns += 1; alert("æ­å–œå‡ç´šï¼ç²å¾— 1 é ‚çš‡å†  ğŸ‘‘"); }
        saveUser(); updateUI();
    }
    function updateUI() {
        document.getElementById('u-name').innerText = user.name;
        document.getElementById('u-gems').innerText = user.gems;
        document.getElementById('u-crowns').innerText = user.crowns;
        if(document.getElementById('shop-gems')) {
            document.getElementById('shop-gems').innerText = user.gems;
            document.getElementById('shop-crowns').innerText = user.crowns;
        }
    }
    function loadUser() { let data = localStorage.getItem(STORAGE_KEY); if (data) user = JSON.parse(data); }
    function saveUser() { localStorage.setItem(STORAGE_KEY, JSON.stringify(user)); }
    function changeName() { let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", user.name); if (n) { user.name = n; saveUser(); updateUI(); } }
    
    function openShop() { document.getElementById('shop-modal').style.display = 'flex'; renderShopLog(); updateUI(); }
    function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }
    function buyItem() {
        let name = document.getElementById('gift-name').value;
        let cost = parseInt(document.getElementById('gift-cost').value);
        let type = document.getElementById('gift-currency').value;
        if(!name || !cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        if (type === 'gems') { if(user.gems >= cost) { user.gems -= cost; successBuy(name, cost, 'ğŸ’'); } else alert("å¯¶çŸ³ä¸è¶³ï¼"); } 
        else { if(user.crowns >= cost) { user.crowns -= cost; successBuy(name, cost, 'ğŸ‘‘'); } else alert("çš‡å† ä¸è¶³ï¼"); }
    }
    function successBuy(item, cost, icon) { user.log.unshift(`å…Œæ› ${item} (-${cost}${icon})`); saveUser(); updateUI(); renderShopLog(); alert("å…Œæ›æˆåŠŸï¼"); }
    function renderShopLog() { document.getElementById('shop-log').innerHTML = user.log.map(l => `<div>${l}</div>`).join(''); }

    function speak(txt) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(txt); u.lang = 'zh-TW'; window.speechSynthesis.speak(u); } }
    function showFeedback(isCorrect) {
        let el = document.getElementById('feedback-text');
        el.innerText = isCorrect ? "O" : "X";
        el.className = "quiz-feedback " + (isCorrect ? "correct-txt" : "wrong-txt");
        el.style.display = "block";
        setTimeout(() => el.style.display = "none", 1000);
    }
    function triggerParticles() {
        const container = document.getElementById('particle-container');
        for(let i=0; i<20; i++) {
            let p = document.createElement('div');
            p.innerText = Math.random() > 0.5 ? 'ğŸ’' : 'âœ¨';
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (1 + Math.random()) + 's';
            container.appendChild(p);
        }
        setTimeout(() => container.innerHTML = '', 2000);
    }

    init();
</script>
</body>
</html>
