<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰è§’å½¢æ¢éšªå®¶ 6.0 (æ•¸å€¼è¼¸å…¥ç‰ˆ)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --bg-color: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --input-bg: #e1f5fe;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem; }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .status-bar {
            display: flex; justify-content: space-between; width: 100%; max-width: 600px;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px;
            align-items: center;
        }
        .user-info { font-weight: bold; font-size: 1.1rem; cursor: pointer; color: var(--primary); }
        .currency { font-size: 1rem; display: flex; gap: 10px; }

        /* --- ç•«å¸ƒå€åŸŸ --- */
        .canvas-container {
            position: relative;
            margin-bottom: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            cursor: crosshair;
            overflow: hidden;
        }
        canvas { display: block; touch-action: none; }

        /* --- æ‰‹å‹•è¼¸å…¥é¢æ¿ (æ–°åŠŸèƒ½) --- */
        .manual-panel {
            width: 100%; max-width: 600px;
            background: var(--input-bg); border: 2px solid #2980b9;
            padding: 15px; border-radius: 12px; margin-bottom: 15px;
            display: none; /* é è¨­éš±è— */
            animation: slideDown 0.3s;
        }
        @keyframes slideDown { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }
        
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: center; margin-bottom: 10px;}
        .input-item { display: flex; flex-direction: column; align-items: center; }
        .input-item label { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 3px; }
        .input-item input { width: 60px; padding: 5px; text-align: center; border-radius: 5px; border: 1px solid #aaa; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; justify-content: center; font-weight: bold;}

        /* --- è³‡è¨Šé¢æ¿ --- */
        .info-panel {
            width: 100%; max-width: 600px;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px; text-align: center;
        }
        .triangle-type {
            font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 5px;
            min-height: 1.5em;
        }
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            font-size: 1rem; text-align: left;
        }
        .stat-item { background: #f9f9f9; padding: 8px; border-radius: 8px; border-left: 4px solid #ccc;}
        .stat-angle { border-color: #e67e22; }
        .stat-side { border-color: #2980b9; }

        /* --- æ§åˆ¶æŒ‰éˆ•å€ --- */
        .controls {
            display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
            width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        button {
            border: none; border-radius: 25px; padding: 10px 15px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
            color: white; transition: 0.2s; box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-teach { background-color: var(--success); }
        .btn-quiz { background-color: var(--warning); }
        .btn-build { background-color: var(--danger); }
        .btn-input { background-color: #2980b9; } /* æ–°æŒ‰éˆ• */
        
        .btn-shop { background-color: #3498db; width: 100%; max-width: 600px; margin-top: 10px; padding: 12px;}
        .btn-action { background-color: var(--primary); display: none; margin-top: 10px; width: 100%; padding: 12px; animation: pulse 1s infinite;}
        .btn-apply { background-color: #27ae60; width: 100%; margin-top:5px; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- æ¨¡å¼æç¤º --- */
        .mode-badge {
            background: var(--dark); color: white; padding: 4px 12px;
            border-radius: 15px; font-size: 0.9rem; position: absolute;
            top: 10px; left: 10px; pointer-events: none; opacity: 0.8;
        }

        /* --- å•†åº—èˆ‡å½ˆçª— --- */
        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
        }
        .modal {
            background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px;
            text-align: center; position: relative; animation: popIn 0.3s;
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .close-btn {
            position: absolute; top: 10px; right: 10px; background: #ccc;
            width: 30px; height: 30px; border-radius: 50%; border: none;
            font-weight: bold; color: white; cursor: pointer;
        }

        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        .particle { position: absolute; font-size: 1.5rem; animation: fall 2s linear forwards; }
        @keyframes fall { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(100vh); } }

        .quiz-feedback { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; font-weight: bold; text-shadow: 0 0 10px white;
            display: none; pointer-events: none; z-index: 10;
        }
        .correct-txt { color: var(--success); }
        .wrong-txt { color: var(--danger); }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div class="status-bar">
        <div class="user-info" onclick="changeName()">ğŸ“ <span id="u-name">å­¸å“¡</span></div>
        <div class="currency">
            <span>ğŸ‘‘ <span id="u-crowns">0</span></span>
            <span>ğŸ’ <span id="u-gems">0</span></span>
        </div>
    </div>

    <h1>ğŸ“ ä¸‰è§’å½¢æ¢éšªå®¶</h1>

    <div class="canvas-container">
        <div id="mode-label" class="mode-badge">æ•™å­¸æ¨¡å¼</div>
        <div id="feedback-text" class="quiz-feedback">O</div>
        <canvas id="geoCanvas" width="600" height="400"></canvas>
    </div>

    <div id="input-panel" class="manual-panel">
        <div class="radio-group">
            <label><input type="radio" name="inputMode" value="sss" checked onchange="toggleInputMode()"> å·²çŸ¥ä¸‰é‚Š (SSS)</label>
            <label><input type="radio" name="inputMode" value="sas" onchange="toggleInputMode()"> å…©é‚Šä¸€å¤¾è§’ (SAS)</label>
        </div>
        
        <div id="inputs-sss" class="input-group">
            <div class="input-item"><label style="color:#e74c3c">é‚Š a</label><input type="number" id="in-a" value="10" min="1"></div>
            <div class="input-item"><label style="color:#27ae60">é‚Š b</label><input type="number" id="in-b" value="10" min="1"></div>
            <div class="input-item"><label style="color:#2980b9">é‚Š c</label><input type="number" id="in-c" value="10" min="1"></div>
        </div>

        <div id="inputs-sas" class="input-group" style="display:none;">
            <div class="input-item"><label style="color:#27ae60">é‚Š b</label><input type="number" id="in-sas-b" value="10" min="1"></div>
            <div class="input-item"><label style="color:#e67e22">âˆ A (åº¦)</label><input type="number" id="in-sas-A" value="60" min="1" max="179"></div>
            <div class="input-item"><label style="color:#2980b9">é‚Š c</label><input type="number" id="in-sas-c" value="10" min="1"></div>
        </div>

        <button class="btn-apply" onclick="applyManualInput()">âœ¨ ç¹ªè£½ä¸‰è§’å½¢</button>
        <div style="text-align:center; font-size:0.8rem; color:#7f8c8d; margin-top:5px;">(ç³»çµ±æœƒè‡ªå‹•ç¸®æ”¾ä»¥ç¬¦åˆç•«é¢)</div>
    </div>

    <div class="info-panel">
        <div id="tri-type-display" class="triangle-type">ä»»æ„ä¸‰è§’å½¢</div>
        <div class="stats-grid">
            <div class="stat-item stat-side">
                <strong>é‚Šé•· (å…¬åˆ†)</strong><br>
                <span style="color:#e74c3c">a (å°BC)</span> = <span id="val-a">0</span><br>
                <span style="color:#27ae60">b (å°AC)</span> = <span id="val-b">0</span><br>
                <span style="color:#2980b9">c (å°AB)</span> = <span id="val-c">0</span>
            </div>
            <div class="stat-item stat-angle">
                <strong>è§’åº¦ (åº¦)</strong><br>
                âˆ A = <span id="deg-A">0</span>Â°<br>
                âˆ B = <span id="deg-B">0</span>Â°<br>
                âˆ C = <span id="deg-C">0</span>Â°
            </div>
        </div>
        <div id="quiz-question" style="display:none; margin-top:10px; font-weight:bold; font-size:1.2rem; color:#d35400;"></div>
    </div>

    <div class="controls">
        <button class="btn-teach" onclick="setMode('teach')">ğŸ“– è‡ªç”±æ¢ç´¢</button>
        <button class="btn-input" onclick="toggleInputPanel()">âœï¸ è¼¸å…¥æ•¸å€¼</button>
        <button class="btn-quiz" onclick="setMode('quiz_select')">â“ å±¬æ€§æ¸¬é©—</button>
        <button class="btn-build" onclick="setMode('quiz_build')">ğŸ”¨ å»ºæ§‹æŒ‘æˆ°</button>
    </div>
    
    <div style="width: 100%; max-width: 600px; text-align: center;">
        <button id="btn-submit" class="btn-action" onclick="checkAnswer()">âœ… é€å‡ºç­”æ¡ˆ</button>
        <button class="btn-shop" onclick="openShop()">ğŸ çå‹µå•†åº—</button>
    </div>

    <div id="shop-modal" class="overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeShop()">Ã—</button>
            <h2>ğŸ çå‹µå…Œæ›</h2>
            <p>ä½ æœ‰ ğŸ’ <span id="shop-gems">0</span> | ğŸ‘‘ <span id="shop-crowns">0</span></p>
            <input type="text" id="gift-name" placeholder="çå“åç¨± (å¦‚: çœ‹å¡é€š)" style="padding:10px; width:80%; margin-bottom:10px;">
            <div style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;">
                <input type="number" id="gift-cost" placeholder="èŠ±è²»" style="padding:10px; width:60px;">
                <select id="gift-currency" style="padding:10px;">
                    <option value="gems">ğŸ’</option>
                    <option value="crowns">ğŸ‘‘</option>
                </select>
            </div>
            <button class="btn-shop" onclick="buyItem()">ç¢ºèªå…Œæ›</button>
            <div id="shop-log" style="text-align:left; margin-top:15px; font-size:0.9rem; max-height:100px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px;"></div>
        </div>
    </div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const canvas = document.getElementById('geoCanvas');
    const ctx = canvas.getContext('2d');
    
    // A: ä¸Šæ–¹ç´…é», B: å·¦ä¸‹ç¶ é», C: å³ä¸‹è—é»
    // é‚Šé•·å®šç¾©: a(BCé•·), b(ACé•·), c(ABé•·)
    let points = [
        {x: 300, y: 100, label: 'A', color: '#e74c3c'},
        {x: 100, y: 300, label: 'B', color: '#27ae60'},
        {x: 500, y: 300, label: 'C', color: '#2980b9'}
    ];
    let dragIdx = -1;
    let currentMode = 'teach'; 
    let currentTarget = null; 
    let user = { name: "å°å°å¹¾ä½•å­¸å®¶", gems: 0, crowns: 0, log: [] };
    const STORAGE_KEY = "tri_explorer_v6";

    // --- åˆå§‹åŒ– ---
    function init() {
        resizeCanvas();
        loadUser();
        updateUI();
        draw();
        
        // ç•«å¸ƒäº‹ä»¶
        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('mousemove', onMove);
        canvas.addEventListener('mouseup', onUp);
        canvas.addEventListener('touchstart', onDown, {passive: false});
        canvas.addEventListener('touchmove', onMove, {passive: false});
        canvas.addEventListener('touchend', onUp);
        window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
        let container = document.querySelector('.canvas-container');
        canvas.width = container.clientWidth;
        canvas.height = Math.min(400, window.innerHeight * 0.5);
        draw();
    }

    // --- æ‰‹å‹•è¼¸å…¥é‚è¼¯ (æ–°åŠŸèƒ½) ---
    function toggleInputPanel() {
        const panel = document.getElementById('input-panel');
        if(panel.style.display === 'block') panel.style.display = 'none';
        else {
            panel.style.display = 'block';
            // å¦‚æœåœ¨æ¸¬é©—æ¨¡å¼ï¼Œæç¤ºæœƒåˆ‡å›æ•™å­¸æ¨¡å¼
            if(currentMode !== 'teach') {
                if(confirm("åˆ‡æ›åˆ°è¼¸å…¥æ¨¡å¼æœƒå›åˆ°ã€Œè‡ªç”±æ¢ç´¢ã€ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                    setMode('teach');
                } else {
                    panel.style.display = 'none';
                }
            }
        }
    }

    function toggleInputMode() {
        const mode = document.querySelector('input[name="inputMode"]:checked').value;
        document.getElementById('inputs-sss').style.display = mode === 'sss' ? 'flex' : 'none';
        document.getElementById('inputs-sas').style.display = mode === 'sas' ? 'flex' : 'none';
    }

    function applyManualInput() {
        const mode = document.querySelector('input[name="inputMode"]:checked').value;
        let newA, newB, newC; // åº§æ¨™

        if (mode === 'sss') {
            const a = parseFloat(document.getElementById('in-a').value);
            const b = parseFloat(document.getElementById('in-b').value);
            const c = parseFloat(document.getElementById('in-c').value);

            if (a + b <= c || a + c <= b || b + c <= a) {
                alert("é€™ä¸‰é‚Šç„¡æ³•æ§‹æˆä¸‰è§’å½¢ï¼\n(æç¤ºï¼šå…©é‚Šä¹‹å’Œå¿…é ˆå¤§æ–¼ç¬¬ä¸‰é‚Š)");
                return;
            }

            // è¨ˆç®—åº§æ¨™ (ä½¿ç”¨é¤˜å¼¦å®šç†æ±‚è§’ A)
            // Cos A = (b^2 + c^2 - a^2) / 2bc
            const cosA = (b*b + c*c - a*a) / (2*b*c);
            const angA = Math.acos(cosA); // å¼§åº¦

            // è¨­å®š B åœ¨ (0, 0)ï¼ŒC åœ¨ (c, 0) -> é€™æ˜¯æ¨™æº–ABé‚Š
            // ä½†ç‚ºäº†é…åˆæˆ‘å€‘çš„ç•«å¸ƒç¿’æ…£ (Aåœ¨ä¸Šæ–¹)ï¼Œæˆ‘å€‘é‡æ–°å®šç¾©ï¼š
            // A ç‚ºåŸé»(0,0)ï¼ŒB åœ¨ (c, 0)ï¼ŒC æ ¹æ“šè§’Aè¨ˆç®—
            // é€™è£¡ç‚ºäº†æ–¹ä¾¿ï¼Œè¨ˆç®—ç›¸å°åº§æ¨™å¾Œå†ç½®ä¸­
            
            // è®“ A ä½æ–¼åŸé»
            const Ax = 0, Ay = 0;
            // è®“ C ä½æ–¼ X è»¸ä¸Š (ACé•·åº¦ç‚º b) -> ä¸å°ï¼Œé€™æ¨£è§’Aæ˜¯åœ¨åŸé»
            // æˆ‘å€‘ç¿’æ…£ï¼šcé‚Šæ˜¯ABã€‚è®“A(0,0), B(c,0)ã€‚Cé»å–æ±ºæ–¼bé‚Šå’Œè§’A
            // é€™æ¨£ a é‚Šå°±æ˜¯ BC è·é›¢
            
            // é‡æ–°å°æ‡‰è¼¸å…¥çš„ a,b,c åˆ°æˆ‘å€‘çš„é ‚é»
            // è¼¸å…¥ a = BC, b = AC, c = AB
            // è¨­ A = (0, 0)
            // è¨­ C = (b, 0)  <- AC åœ¨Xè»¸ä¸Š
            // B çš„åº§æ¨™ï¼šéœ€è¦è§’Aã€‚Cos A = (b^2 + c^2 - a^2) / 2bc
            // Bx = c * cosA, By = c * sinA
            
            const Bx = c * cosA;
            const By = c * Math.sin(angA);
            
            // åŸå§‹åº§æ¨™ (æœªç¸®æ”¾)
            newA = {x: 0, y: 0};
            newC = {x: b, y: 0};  // AC = b
            newB = {x: Bx, y: By}; // AB = c, BC æœƒè‡ªå‹•æ˜¯ a
            
        } else { // SAS
            const b = parseFloat(document.getElementById('in-sas-b').value);
            const degA = parseFloat(document.getElementById('in-sas-A').value);
            const c = parseFloat(document.getElementById('in-sas-c').value);
            
            if (degA >= 180 || degA <= 0) { alert("è§’åº¦å¿…é ˆåœ¨ 0~180 ä¹‹é–“"); return; }

            const radA = degA * (Math.PI / 180);
            
            // A åœ¨åŸé»
            newA = {x: 0, y: 0};
            // C åœ¨ X è»¸ (AC = b)
            newC = {x: b, y: 0};
            // B æ ¹æ“šè§’åº¦ (AB = c)
            newB = {x: c * Math.cos(radA), y: c * Math.sin(radA)};
        }

        // --- è‡ªå‹•ç¸®æ”¾èˆ‡ç½®ä¸­ ---
        const coords = [newA, newB, newC];
        const minX = Math.min(...coords.map(p=>p.x));
        const maxX = Math.max(...coords.map(p=>p.x));
        const minY = Math.min(...coords.map(p=>p.y));
        const maxY = Math.max(...coords.map(p=>p.y));
        
        const w = maxX - minX;
        const h = maxY - minY;
        
        // ç•«å¸ƒå¯ç”¨å€åŸŸ (ç•™é‚Šè· 100px)
        const availW = canvas.width - 100;
        const availH = canvas.height - 100;
        
        const scale = Math.min(availW / w, availH / h);
        
        // ç•«å¸ƒä¸­å¿ƒ
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        
        // åœ–å½¢ä¸­å¿ƒ
        const figCx = (minX + maxX) / 2;
        const figCy = (minY + maxY) / 2;

        // æ›´æ–°å…¨åŸŸé»ä½ (å¥—ç”¨ç¸®æ”¾èˆ‡å¹³ç§»)
        // æ³¨æ„ Canvas Y è»¸æ˜¯å‘ä¸‹çš„ï¼Œç‚ºäº†è®“ä¸‰è§’å½¢é ‚é»æœä¸Šè‡ªç„¶ä¸€é»ï¼Œæˆ‘å€‘å¯èƒ½éœ€è¦ç¿»è½‰æˆ–ç›´æ¥è¨ˆç®—
        // é€™è£¡ç›´æ¥å¥—ç”¨ï¼Œå¦‚æœç®—å‡º By æ˜¯æ­£çš„ï¼Œåœ¨ Canvas æœƒå¾€ä¸‹ç•«ï¼Œé€™ç¬¦åˆç›´è§’åº§æ¨™ç³»è¦–è¦º
        
        points[0].x = cx + (newA.x - figCx) * scale;
        points[0].y = cy + (newA.y - figCy) * scale; // é€™è£¡ä¸åè½‰Yï¼Œå› ç‚ºè¼¸å…¥è¨ˆç®—é€šå¸¸ç”¨æ­£å€¼
        
        points[1].x = cx + (newB.x - figCx) * scale;
        points[1].y = cy + (newB.y - figCy) * scale;
        
        points[2].x = cx + (newC.x - figCx) * scale;
        points[2].y = cy + (newC.y - figCy) * scale;

        draw();
        
        // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º (è®“ä½¿ç”¨è€…çŸ¥é“å¦‚æœæ˜¯ SSS æ¨¡å¼ç®—å‡ºäº†ä»€éº¼è§’åº¦)
        if(mode === 'sss') {
            // è¨ˆç®—å®Œå¾Œå†èªª
        }
        
        // éš±è—é¢æ¿
        if(window.innerWidth < 600) document.getElementById('input-panel').style.display = 'none';
        speak("ä¸‰è§’å½¢ç¹ªè£½å®Œæˆï¼");
    }

    // --- ç¹ªåœ–é‚è¼¯ ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid();

        // ç•«ä¸‰è§’å½¢
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.lineTo(points[2].x, points[2].y);
        ctx.closePath();
        
        ctx.fillStyle = 'rgba(142, 68, 173, 0.1)';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#34495e';
        ctx.stroke();

        let sides = getSides(); 
        let angles = getAngles(sides);

        // ç•«é ‚é»
        points.forEach((p, i) => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(p.label, p.x - 5, p.y - 15);
        });

        updateStats(sides, angles);
    }

    function drawGrid() {
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        const step = 40;
        for(let x=0; x<canvas.width; x+=step) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y=0; y<canvas.height; y+=step) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    }

    // --- æ•¸å­¸è¨ˆç®— ---
    function dist(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function getSides() {
        // æˆ‘å€‘é€™è£¡åšä¸€å€‹"ç›¸å°æ¯”ä¾‹"çš„æ›ç®—ï¼Œè®“é¡¯ç¤ºçš„æ•¸å€¼å¥½çœ‹ä¸€é»
        // å‡è¨­è¢å¹•ä¸Šæœ€é•·é‚Šå°æ‡‰åˆ°å¤§ç´„ 10~20 çš„å–®ä½ï¼Œæˆ–è€…ä¾æ“šè¼¸å…¥æ¨¡å¼çš„æ¯”ä¾‹
        // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ä»¥ 40px = 1å–®ä½
        let scale = 40;
        let a = dist(points[1], points[2]) / scale; // BC
        let b = dist(points[0], points[2]) / scale; // AC
        let c = dist(points[0], points[1]) / scale; // AB
        return [a, b, c];
    }

    function getAngles(sides) {
        let a = sides[0], b = sides[1], c = sides[2];
        let A = Math.acos((b*b + c*c - a*a) / (2*b*c)) * (180 / Math.PI);
        let B = Math.acos((a*a + c*c - b*b) / (2*a*c)) * (180 / Math.PI);
        let C = 180 - A - B;
        // é¿å… NaN (é»é‡åˆæ™‚)
        if(isNaN(A)) A=0; if(isNaN(B)) B=0; if(isNaN(C)) C=0;
        return [A, B, C];
    }

    function analyzeTriangle(sides, angles) {
        let [a, b, c] = sides;
        let [A, B, C] = angles;
        let maxAngle = Math.max(A, B, C);
        let labels = [];

        if (Math.abs(maxAngle - 90) < 2) labels.push("ç›´è§’");
        else if (maxAngle > 90) labels.push("éˆè§’");
        else labels.push("éŠ³è§’");

        let isEquilateral = (Math.abs(a-b)<0.1 && Math.abs(b-c)<0.1);
        let isIsosceles = (Math.abs(a-b)<0.1 || Math.abs(b-c)<0.1 || Math.abs(a-c)<0.1);

        if (isEquilateral) labels.push("æ­£");
        else if (isIsosceles) labels.push("ç­‰è…°");
        
        return labels.join(" ") + "ä¸‰è§’å½¢";
    }

    function updateStats(sides, angles) {
        document.getElementById('val-a').innerText = sides[0].toFixed(1);
        document.getElementById('val-b').innerText = sides[1].toFixed(1);
        document.getElementById('val-c').innerText = sides[2].toFixed(1);
        
        document.getElementById('deg-A').innerText = Math.round(angles[0]);
        document.getElementById('deg-B').innerText = Math.round(angles[1]);
        document.getElementById('deg-C').innerText = Math.round(angles[2]);

        let typeText = analyzeTriangle(sides, angles);
        
        if (currentMode === 'teach') {
            document.getElementById('tri-type-display').innerText = typeText;
            document.getElementById('tri-type-display').style.color = '#8e44ad';
        } else if (currentMode === 'quiz_build') {
            document.getElementById('tri-type-display').innerText = "å»ºæ§‹ä¸­..."; 
            document.getElementById('tri-type-display').style.color = '#95a5a6';
        } else {
            document.getElementById('tri-type-display').innerText = "??? ä¸‰è§’å½¢";
        }
    }

    // --- æ‹–æ›³äº’å‹• ---
    function getPointerPos(e) {
        let rect = canvas.getBoundingClientRect();
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function onDown(e) {
        if(e.type === 'touchstart') e.preventDefault();
        let pos = getPointerPos(e);
        points.forEach((p, i) => {
            if (dist(pos, p) < 30) dragIdx = i;
        });
    }

    function onMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        if (dragIdx !== -1) {
            let pos = getPointerPos(e);
            pos.x = Math.max(10, Math.min(canvas.width - 10, pos.x));
            pos.y = Math.max(10, Math.min(canvas.height - 10, pos.y));
            
            points[dragIdx].x = pos.x;
            points[dragIdx].y = pos.y;
            draw();
        }
    }

    function onUp(e) { dragIdx = -1; }

    // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    function setMode(mode) {
        currentMode = mode;
        let label = document.getElementById('mode-label');
        let qBox = document.getElementById('quiz-question');
        let subBtn = document.getElementById('btn-submit');
        
        qBox.style.display = 'none';
        subBtn.style.display = 'none';
        
        // éš±è—è¼¸å…¥é¢æ¿
        document.getElementById('input-panel').style.display = 'none';
        
        if (mode === 'teach') {
            label.innerText = "æ•™å­¸æ¨¡å¼";
            label.style.background = "#2c3e50";
            speak("é€²å…¥è‡ªç”±æ¢ç´¢æ¨¡å¼");
        } else if (mode === 'quiz_select') {
            label.innerText = "å±¬æ€§æ¸¬é©—";
            label.style.background = "#f39c12";
            startQuizSelect();
        } else if (mode === 'quiz_build') {
            label.innerText = "å»ºæ§‹æŒ‘æˆ°";
            label.style.background = "#c0392b";
            startQuizBuild();
        }
        draw();
    }

    // --- æ¸¬é©—é‚è¼¯ ---
    function startQuizSelect() {
        randomizeTriangle();
        draw();
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        
        let types = ["éŠ³è§’", "ç›´è§’", "éˆè§’", "ç­‰è…°"];
        let target = types[Math.floor(Math.random() * types.length)];
        currentTarget = { type: 'select', target: target };
        
        qBox.innerHTML = `é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong> å—ï¼Ÿ`;
        
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "ğŸ¤” é»æ­¤æŸ¥çœ‹ç­”æ¡ˆ";
        subBtn.style.display = 'inline-block';
        subBtn.onclick = checkAnswerSelect;
        
        speak(`é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹${target}ä¸‰è§’å½¢å—ï¼Ÿ`);
    }

    function checkAnswerSelect() {
        let sides = getSides();
        let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let isCorrect = typeStr.includes(currentTarget.target);
        
        let feedback = document.getElementById('quiz-question');
        if (isCorrect) {
            feedback.innerHTML += `<br><span style="color:green">â­• æ˜¯çš„ï¼é€™æ˜¯ ${typeStr}</span>`;
            addReward(1);
            showFeedback(true);
        } else {
            feedback.innerHTML += `<br><span style="color:red">âŒ ä¸æ˜¯å–”ï¼Œé€™æ˜¯ ${typeStr}</span>`;
            showFeedback(false);
        }
        
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "â¡ ä¸‹ä¸€é¡Œ";
        subBtn.onclick = startQuizSelect;
    }

    function startQuizBuild() {
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        let subBtn = document.getElementById('btn-submit');
        subBtn.style.display = 'inline-block';
        subBtn.innerText = "âœ… æˆ‘åšå¥½äº†ï¼";
        subBtn.onclick = checkAnswerBuild;

        let missions = ["ç›´è§’", "éˆè§’", "ç­‰è…°", "æ­£", "ç­‰è…°ç›´è§’"];
        let target = missions[Math.floor(Math.random() * missions.length)];
        currentTarget = { type: 'build', target: target };
        
        qBox.innerHTML = `ä»»å‹™ï¼šè«‹åšå‡ºä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong><br><span style='font-size:0.9rem'>(å¯æ‰‹å‹•æ‹‰å‹•æˆ–è¼¸å…¥æ•¸å€¼)</span>`;
        speak(`ä»»å‹™é–‹å§‹ï¼šè«‹åšå‡ºä¸€å€‹${target}ä¸‰è§’å½¢`);
    }

    function checkAnswerBuild() {
        let sides = getSides();
        let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let target = currentTarget.target;
        let isCorrect = false;

        if (target === "ç­‰è…°ç›´è§’") {
            isCorrect = typeStr.includes("ç­‰è…°") && typeStr.includes("ç›´è§’");
        } else {
            isCorrect = typeStr.includes(target);
        }

        if (isCorrect) {
            alert(`å¤ªæ£’äº†ï¼ä½ æˆåŠŸåšå‡ºäº† ${typeStr}ï¼ç²å¾— 3 é¡†å¯¶çŸ³ğŸ’`);
            addReward(3);
            showFeedback(true);
            triggerParticles();
            setTimeout(startQuizBuild, 1500); 
        } else {
            alert(`é‚„å·®ä¸€é»é»å–”ï¼ç›®å‰æ˜¯ï¼š${typeStr}ã€‚\nè«‹å†è©¦è©¦çœ‹ï¼`);
            showFeedback(false);
        }
    }

    function randomizeTriangle() {
        points[0].x = 100 + Math.random() * 400;
        points[0].y = 50 + Math.random() * 100;
        points[1].x = 50 + Math.random() * 200;
        points[1].y = 250 + Math.random() * 100;
        points[2].x = 350 + Math.random() * 200;
        points[2].y = 250 + Math.random() * 100;
    }

    // --- çå‹µèˆ‡ä½¿ç”¨è€… ---
    function addReward(gems) {
        user.gems += gems;
        if (user.gems >= 100) {
            user.gems -= 100;
            user.crowns += 1;
            alert("æ­å–œå‡ç´šï¼ç²å¾— 1 é ‚çš‡å†  ğŸ‘‘");
        }
        saveUser();
        updateUI();
    }

    function updateUI() {
        document.getElementById('u-name').innerText = user.name;
        document.getElementById('u-gems').innerText = user.gems;
        document.getElementById('u-crowns').innerText = user.crowns;
        if(document.getElementById('shop-gems')) {
            document.getElementById('shop-gems').innerText = user.gems;
            document.getElementById('shop-crowns').innerText = user.crowns;
        }
    }

    function loadUser() {
        let data = localStorage.getItem(STORAGE_KEY);
        if (data) user = JSON.parse(data);
    }

    function saveUser() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
    }

    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", user.name);
        if (n) { user.name = n; saveUser(); updateUI(); }
    }

    // --- å•†åº—åŠŸèƒ½ ---
    function openShop() {
        document.getElementById('shop-modal').style.display = 'flex';
        renderShopLog();
        updateUI();
    }
    function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }
    
    function buyItem() {
        let name = document.getElementById('gift-name').value;
        let cost = parseInt(document.getElementById('gift-cost').value);
        let type = document.getElementById('gift-currency').value;
        
        if(!name || !cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        
        if (type === 'gems') {
            if(user.gems >= cost) { user.gems -= cost; successBuy(name, cost, 'ğŸ’'); } 
            else alert("å¯¶çŸ³ä¸è¶³ï¼");
        } else {
            if(user.crowns >= cost) { user.crowns -= cost; successBuy(name, cost, 'ğŸ‘‘'); } 
            else alert("çš‡å† ä¸è¶³ï¼");
        }
    }

    function successBuy(item, cost, icon) {
        user.log.unshift(`å…Œæ› ${item} (-${cost}${icon}) - ${new Date().toLocaleTimeString()}`);
        saveUser();
        updateUI();
        renderShopLog();
        alert("å…Œæ›æˆåŠŸï¼");
    }

    function renderShopLog() {
        let div = document.getElementById('shop-log');
        div.innerHTML = user.log.map(l => `<div>${l}</div>`).join('');
    }

    // --- ç‰¹æ•ˆèˆ‡èªéŸ³ ---
    function speak(txt) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(txt);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }
    }

    function showFeedback(isCorrect) {
        let el = document.getElementById('feedback-text');
        el.innerText = isCorrect ? "O" : "X";
        el.className = "quiz-feedback " + (isCorrect ? "correct-txt" : "wrong-txt");
        el.style.display = "block";
        setTimeout(() => el.style.display = "none", 1000);
    }

    function triggerParticles() {
        const container = document.getElementById('particle-container');
        for(let i=0; i<20; i++) {
            let p = document.createElement('div');
            p.innerText = Math.random() > 0.5 ? 'ğŸ’' : 'âœ¨';
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (1 + Math.random()) + 's';
            container.appendChild(p);
        }
        setTimeout(() => container.innerHTML = '', 2000);
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>
