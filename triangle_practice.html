<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰è§’å½¢æ¢éšªå®¶ 5.0 (å¹¾ä½•å¤§å¸«ç‰ˆ)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --bg-color: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•é é¢ï¼Œå°ˆæ³¨æ–¼ç•«å¸ƒ */
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem; }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .status-bar {
            display: flex; justify-content: space-between; width: 100%; max-width: 600px;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px;
            align-items: center;
        }
        .user-info { font-weight: bold; font-size: 1.1rem; cursor: pointer; color: var(--primary); }
        .currency { font-size: 1rem; display: flex; gap: 10px; }

        /* --- ç•«å¸ƒå€åŸŸ --- */
        .canvas-container {
            position: relative;
            margin-bottom: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            cursor: crosshair;
            overflow: hidden;
        }
        canvas { display: block; touch-action: none; }

        /* --- è³‡è¨Šé¢æ¿ --- */
        .info-panel {
            width: 100%; max-width: 600px;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px; text-align: center;
        }
        .triangle-type {
            font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 5px;
            min-height: 1.5em;
        }
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            font-size: 1rem; text-align: left;
        }
        .stat-item { background: #f9f9f9; padding: 8px; border-radius: 8px; border-left: 4px solid #ccc;}
        .stat-angle { border-color: #e67e22; }
        .stat-side { border-color: #2980b9; }

        /* --- æ§åˆ¶æŒ‰éˆ•å€ --- */
        .controls {
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
            width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        button {
            border: none; border-radius: 25px; padding: 10px 20px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            color: white; transition: 0.2s; box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-teach { background-color: var(--success); }
        .btn-quiz { background-color: var(--warning); }
        .btn-build { background-color: var(--danger); }
        .btn-shop { background-color: #3498db; width: 100%; max-width: 600px; margin-top: 10px;}
        .btn-action { background-color: var(--primary); display: none; margin-top: 10px; width: 100%; animation: pulse 1s infinite;}

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- æ¨¡å¼æç¤º --- */
        .mode-badge {
            background: var(--dark); color: white; padding: 4px 12px;
            border-radius: 15px; font-size: 0.9rem; position: absolute;
            top: 10px; left: 10px; pointer-events: none; opacity: 0.8;
        }

        /* --- å•†åº—èˆ‡å½ˆçª— --- */
        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
        }
        .modal {
            background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px;
            text-align: center; position: relative; animation: popIn 0.3s;
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .close-btn {
            position: absolute; top: 10px; right: 10px; background: #ccc;
            width: 30px; height: 30px; border-radius: 50%; border: none;
            font-weight: bold; color: white; cursor: pointer;
        }

        /* å‹•ç•«ç‰¹æ•ˆ */
        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        .particle { position: absolute; font-size: 1.5rem; animation: fall 2s linear forwards; }
        @keyframes fall { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(100vh); } }

        /* çµæœæç¤º */
        .quiz-feedback { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; font-weight: bold; text-shadow: 0 0 10px white;
            display: none; pointer-events: none; z-index: 10;
        }
        .correct-txt { color: var(--success); }
        .wrong-txt { color: var(--danger); }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div class="status-bar">
        <div class="user-info" onclick="changeName()">ğŸ“ <span id="u-name">å­¸å“¡</span></div>
        <div class="currency">
            <span>ğŸ‘‘ <span id="u-crowns">0</span></span>
            <span>ğŸ’ <span id="u-gems">0</span></span>
        </div>
    </div>

    <h1>ğŸ“ ä¸‰è§’å½¢æ¢éšªå®¶</h1>

    <div class="canvas-container">
        <div id="mode-label" class="mode-badge">æ•™å­¸æ¨¡å¼</div>
        <div id="feedback-text" class="quiz-feedback">O</div>
        <canvas id="geoCanvas" width="600" height="400"></canvas>
    </div>

    <div class="info-panel">
        <div id="tri-type-display" class="triangle-type">ä»»æ„ä¸‰è§’å½¢</div>
        <div class="stats-grid">
            <div class="stat-item stat-side">
                <strong>é‚Šé•· (å…¬åˆ†)</strong><br>
                <span style="color:#e74c3c">a</span> = <span id="val-a">0</span><br>
                <span style="color:#27ae60">b</span> = <span id="val-b">0</span><br>
                <span style="color:#2980b9">c</span> = <span id="val-c">0</span>
            </div>
            <div class="stat-item stat-angle">
                <strong>è§’åº¦ (åº¦)</strong><br>
                âˆ A = <span id="deg-A">0</span>Â°<br>
                âˆ B = <span id="deg-B">0</span>Â°<br>
                âˆ C = <span id="deg-C">0</span>Â°
            </div>
        </div>
        <div id="quiz-question" style="display:none; margin-top:10px; font-weight:bold; font-size:1.2rem; color:#d35400;">
            é¡Œç›®ï¼šè«‹åšå‡ºä¸€å€‹ç›´è§’ä¸‰è§’å½¢
        </div>
    </div>

    <div class="controls">
        <button class="btn-teach" onclick="setMode('teach')">ğŸ“– è‡ªç”±æ¢ç´¢</button>
        <button class="btn-quiz" onclick="setMode('quiz_select')">â“ å±¬æ€§æ¸¬é©—</button>
        <button class="btn-build" onclick="setMode('quiz_build')">ğŸ”¨ å»ºæ§‹æŒ‘æˆ°</button>
    </div>
    
    <div style="width: 100%; max-width: 600px; text-align: center;">
        <button id="btn-submit" class="btn-action" onclick="checkAnswer()">âœ… é€å‡ºç­”æ¡ˆ</button>
        <button class="btn-shop" onclick="openShop()">ğŸ çå‹µå•†åº—</button>
    </div>

    <div id="shop-modal" class="overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeShop()">Ã—</button>
            <h2>ğŸ çå‹µå…Œæ›</h2>
            <p>ä½ æœ‰ ğŸ’ <span id="shop-gems">0</span> | ğŸ‘‘ <span id="shop-crowns">0</span></p>
            <input type="text" id="gift-name" placeholder="çå“åç¨± (å¦‚: çœ‹å¡é€š)" style="padding:10px; width:80%; margin-bottom:10px;">
            <div style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;">
                <input type="number" id="gift-cost" placeholder="èŠ±è²»" style="padding:10px; width:60px;">
                <select id="gift-currency" style="padding:10px;">
                    <option value="gems">ğŸ’</option>
                    <option value="crowns">ğŸ‘‘</option>
                </select>
            </div>
            <button class="btn-shop" onclick="buyItem()">ç¢ºèªå…Œæ›</button>
            <div id="shop-log" style="text-align:left; margin-top:15px; font-size:0.9rem; max-height:100px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px;"></div>
        </div>
    </div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const canvas = document.getElementById('geoCanvas');
    const ctx = canvas.getContext('2d');
    let points = [
        {x: 300, y: 100, label: 'A', color: '#e74c3c'},
        {x: 100, y: 300, label: 'B', color: '#27ae60'},
        {x: 500, y: 300, label: 'C', color: '#2980b9'}
    ];
    let dragIdx = -1;
    let currentMode = 'teach'; // teach, quiz_select, quiz_build
    let currentTarget = null; // ç•¶å‰é¡Œç›®ç›®æ¨™
    
    // ç”¨æˆ¶è³‡æ–™
    let user = { name: "å°å°å¹¾ä½•å­¸å®¶", gems: 0, crowns: 0, log: [] };
    const STORAGE_KEY = "tri_explorer_v5";

    // --- åˆå§‹åŒ– ---
    function init() {
        resizeCanvas();
        loadUser();
        updateUI();
        draw();
        
        // äº‹ä»¶ç›£è½
        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('mousemove', onMove);
        canvas.addEventListener('mouseup', onUp);
        canvas.addEventListener('touchstart', onDown, {passive: false});
        canvas.addEventListener('touchmove', onMove, {passive: false});
        canvas.addEventListener('touchend', onUp);
        window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
        // éŸ¿æ‡‰å¼ç•«å¸ƒ
        let container = document.querySelector('.canvas-container');
        canvas.width = container.clientWidth;
        canvas.height = Math.min(400, window.innerHeight * 0.5);
        // ç¢ºä¿é»ä¸è·‘å‡ºå»
        points.forEach(p => {
            p.x = Math.min(Math.max(p.x, 20), canvas.width - 20);
            p.y = Math.min(Math.max(p.y, 20), canvas.height - 20);
        });
        draw();
    }

    // --- ç¹ªåœ–é‚è¼¯ ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. ç•«ç¶²æ ¼èƒŒæ™¯ (è®“å®ƒçœ‹èµ·ä¾†åƒä½œæ¥­ç°¿)
        drawGrid();

        // 2. ç•«ä¸‰è§’å½¢
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.lineTo(points[2].x, points[2].y);
        ctx.closePath();
        
        // å¡«å……é¡è‰²
        ctx.fillStyle = 'rgba(142, 68, 173, 0.1)';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#34495e';
        ctx.stroke();

        // 3. è¨ˆç®—æ•¸æ“š
        let sides = getSides(); // [a, b, c] å°æ‡‰ BC, AC, AB
        let angles = getAngles(sides); // [A, B, C]

        // 4. ç•«è§’æ¨™ç¤ºèˆ‡é ‚é»
        drawAngleArcs(angles);
        points.forEach((p, i) => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // æ–‡å­—æ¨™ç±¤
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(p.label, p.x - 5, p.y - 15);
        });

        // 5. æ›´æ–°æ•¸æ“šé¢æ¿
        updateStats(sides, angles);
    }

    function drawGrid() {
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        const step = 40;
        for(let x=0; x<canvas.width; x+=step) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y=0; y<canvas.height; y+=step) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    }

    function drawAngleArcs(angles) {
        // ç°¡å–®ç•«å¼§ç·šï¼Œç¨å¾®è¤‡é›œçš„æ•¸å­¸
        // é€™è£¡ç°¡åŒ–è™•ç†ï¼šåªåœ¨é ‚é»ç•«å€‹å°åœˆåœˆè¡¨ç¤º
    }

    // --- æ•¸å­¸è¨ˆç®— ---
    function dist(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function getSides() {
        // aå°A(p0) -> BC(p1,p2)
        // bå°B(p1) -> AC(p0,p2)
        // cå°C(p2) -> AB(p0,p1)
        // å–®ä½æ›ç®—ï¼šåƒç´  / 40 = å…¬åˆ† (å‡è¨­)
        let scale = 40;
        let a = dist(points[1], points[2]) / scale;
        let b = dist(points[0], points[2]) / scale;
        let c = dist(points[0], points[1]) / scale;
        return [a, b, c];
    }

    function getAngles(sides) {
        let a = sides[0], b = sides[1], c = sides[2];
        // é¤˜å¼¦å®šç†
        let A = Math.acos((b*b + c*c - a*a) / (2*b*c)) * (180 / Math.PI);
        let B = Math.acos((a*a + c*c - b*b) / (2*a*c)) * (180 / Math.PI);
        let C = 180 - A - B;
        return [A, B, C];
    }

    function analyzeTriangle(sides, angles) {
        let [a, b, c] = sides;
        let [A, B, C] = angles;
        let maxAngle = Math.max(A, B, C);
        let labels = [];

        // è§’çš„æ€§è³ª
        if (Math.abs(maxAngle - 90) < 2) labels.push("ç›´è§’");
        else if (maxAngle > 90) labels.push("éˆè§’");
        else labels.push("éŠ³è§’");

        // é‚Šçš„æ€§è³ª
        // å®¹è¨±èª¤å·® 0.1
        let isEquilateral = (Math.abs(a-b)<0.1 && Math.abs(b-c)<0.1);
        let isIsosceles = (Math.abs(a-b)<0.1 || Math.abs(b-c)<0.1 || Math.abs(a-c)<0.1);

        if (isEquilateral) labels.push("æ­£");
        else if (isIsosceles) labels.push("ç­‰è…°");
        
        return labels.join(" ") + "ä¸‰è§’å½¢";
    }

    function updateStats(sides, angles) {
        // æ•¸å€¼é¡¯ç¤º
        document.getElementById('val-a').innerText = sides[0].toFixed(1);
        document.getElementById('val-b').innerText = sides[1].toFixed(1);
        document.getElementById('val-c').innerText = sides[2].toFixed(1);
        
        document.getElementById('deg-A').innerText = Math.round(angles[0]);
        document.getElementById('deg-B').innerText = Math.round(angles[1]);
        document.getElementById('deg-C').innerText = Math.round(angles[2]);

        // é¡å‹åˆ¤æ–·
        let typeText = analyzeTriangle(sides, angles);
        
        if (currentMode === 'teach') {
            document.getElementById('tri-type-display').innerText = typeText;
            document.getElementById('tri-type-display').style.color = '#8e44ad';
        } else if (currentMode === 'quiz_build') {
            document.getElementById('tri-type-display').innerText = "å»ºæ§‹ä¸­..."; 
            document.getElementById('tri-type-display').style.color = '#95a5a6';
        } else {
            document.getElementById('tri-type-display').innerText = "??? ä¸‰è§’å½¢";
        }
    }

    // --- æ‹–æ›³äº’å‹• ---
    function getPointerPos(e) {
        let rect = canvas.getBoundingClientRect();
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function onDown(e) {
        if(e.type === 'touchstart') e.preventDefault();
        let pos = getPointerPos(e);
        // æ‰¾æœ€è¿‘çš„é»
        points.forEach((p, i) => {
            if (dist(pos, p) < 30) dragIdx = i;
        });
    }

    function onMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        if (dragIdx !== -1) {
            let pos = getPointerPos(e);
            // é‚Šç•Œé™åˆ¶
            pos.x = Math.max(10, Math.min(canvas.width - 10, pos.x));
            pos.y = Math.max(10, Math.min(canvas.height - 10, pos.y));
            
            points[dragIdx].x = pos.x;
            points[dragIdx].y = pos.y;
            draw();
        }
    }

    function onUp(e) {
        dragIdx = -1;
    }

    // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    function setMode(mode) {
        currentMode = mode;
        let label = document.getElementById('mode-label');
        let qBox = document.getElementById('quiz-question');
        let subBtn = document.getElementById('btn-submit');
        
        // é‡ç½®
        qBox.style.display = 'none';
        subBtn.style.display = 'none';
        
        if (mode === 'teach') {
            label.innerText = "æ•™å­¸æ¨¡å¼";
            label.style.background = "#2c3e50";
            speak("é€²å…¥è‡ªç”±æ¢ç´¢æ¨¡å¼ï¼Œè©¦è‘—æ‹‰å‹•é ‚é»çœ‹çœ‹ï¼");
        } else if (mode === 'quiz_select') {
            label.innerText = "å±¬æ€§æ¸¬é©—";
            label.style.background = "#f39c12";
            startQuizSelect();
        } else if (mode === 'quiz_build') {
            label.innerText = "å»ºæ§‹æŒ‘æˆ°";
            label.style.background = "#c0392b";
            startQuizBuild();
        }
        draw();
    }

    // --- æ¸¬é©—é‚è¼¯ ---
    function startQuizSelect() {
        // ç”Ÿæˆä¸€å€‹éš¨æ©Ÿä¸‰è§’å½¢
        randomizeTriangle();
        draw();
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        
        // éš¨æ©Ÿå‡ºé¡Œ
        let types = ["éŠ³è§’", "ç›´è§’", "éˆè§’", "ç­‰è…°"];
        let target = types[Math.floor(Math.random() * types.length)];
        currentTarget = { type: 'select', target: target };
        
        qBox.innerHTML = `é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong> å—ï¼Ÿ`;
        
        // é€™è£¡ç°¡åŒ–ï¼šé¸æ“‡é¡Œæ¨¡å¼æˆ‘å€‘æ”¹æˆã€Œåˆ¤æ–·é¡Œã€ï¼Œé¡¯ç¤ºæŒ‰éˆ•
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "ğŸ¤” é»æ­¤æŸ¥çœ‹ç­”æ¡ˆ";
        subBtn.style.display = 'inline-block';
        subBtn.onclick = checkAnswerSelect;
        
        speak(`é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹${target}ä¸‰è§’å½¢å—ï¼Ÿè«‹ä»”ç´°è§€å¯Ÿã€‚`);
    }

    function checkAnswerSelect() {
        let sides = getSides();
        let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let isCorrect = typeStr.includes(currentTarget.target);
        
        let feedback = document.getElementById('quiz-question');
        if (isCorrect) {
            feedback.innerHTML += `<br><span style="color:green">â­• æ˜¯çš„ï¼é€™æ˜¯ ${typeStr}</span>`;
            addReward(1);
            showFeedback(true);
        } else {
            feedback.innerHTML += `<br><span style="color:red">âŒ ä¸æ˜¯å–”ï¼Œé€™æ˜¯ ${typeStr}</span>`;
            showFeedback(false);
        }
        
        // ä¸‹ä¸€é¡ŒæŒ‰éˆ•
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "â¡ ä¸‹ä¸€é¡Œ";
        subBtn.onclick = startQuizSelect;
    }

    function startQuizBuild() {
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        let subBtn = document.getElementById('btn-submit');
        subBtn.style.display = 'inline-block';
        subBtn.innerText = "âœ… æˆ‘åšå¥½äº†ï¼";
        subBtn.onclick = checkAnswerBuild;

        let missions = ["ç›´è§’", "éˆè§’", "ç­‰è…°", "æ­£", "ç­‰è…°ç›´è§’"];
        let target = missions[Math.floor(Math.random() * missions.length)];
        currentTarget = { type: 'build', target: target };
        
        qBox.innerHTML = `ä»»å‹™ï¼šè«‹æ‹‰å‹•é ‚é»ï¼Œåšå‡ºä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong>`;
        speak(`ä»»å‹™é–‹å§‹ï¼šè«‹åšå‡ºä¸€å€‹${target}ä¸‰è§’å½¢`);
    }

    function checkAnswerBuild() {
        let sides = getSides();
        let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let target = currentTarget.target;
        let isCorrect = false;

        // å¯¬é¬†åˆ¤å®š
        if (target === "ç­‰è…°ç›´è§’") {
            isCorrect = typeStr.includes("ç­‰è…°") && typeStr.includes("ç›´è§’");
        } else {
            isCorrect = typeStr.includes(target);
        }

        if (isCorrect) {
            alert(`å¤ªæ£’äº†ï¼ä½ æˆåŠŸåšå‡ºäº† ${typeStr}ï¼ç²å¾— 3 é¡†å¯¶çŸ³ğŸ’`);
            addReward(3);
            showFeedback(true);
            triggerParticles();
            setTimeout(startQuizBuild, 1500); // è‡ªå‹•ä¸‹ä¸€é¡Œ
        } else {
            alert(`é‚„å·®ä¸€é»é»å–”ï¼ç›®å‰æ˜¯ï¼š${typeStr}ã€‚\nè«‹å†è©¦è©¦çœ‹ï¼`);
            showFeedback(false);
        }
    }

    function randomizeTriangle() {
        points[0].x = 100 + Math.random() * 400;
        points[0].y = 50 + Math.random() * 100;
        points[1].x = 50 + Math.random() * 200;
        points[1].y = 250 + Math.random() * 100;
        points[2].x = 350 + Math.random() * 200;
        points[2].y = 250 + Math.random() * 100;
    }

    // --- çå‹µèˆ‡ä½¿ç”¨è€… ---
    function addReward(gems) {
        user.gems += gems;
        if (user.gems >= 100) {
            user.gems -= 100;
            user.crowns += 1;
            alert("æ­å–œå‡ç´šï¼ç²å¾— 1 é ‚çš‡å†  ğŸ‘‘");
        }
        saveUser();
        updateUI();
    }

    function updateUI() {
        document.getElementById('u-name').innerText = user.name;
        document.getElementById('u-gems').innerText = user.gems;
        document.getElementById('u-crowns').innerText = user.crowns;
        if(document.getElementById('shop-gems')) {
            document.getElementById('shop-gems').innerText = user.gems;
            document.getElementById('shop-crowns').innerText = user.crowns;
        }
    }

    function loadUser() {
        let data = localStorage.getItem(STORAGE_KEY);
        if (data) user = JSON.parse(data);
    }

    function saveUser() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
    }

    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", user.name);
        if (n) { user.name = n; saveUser(); updateUI(); }
    }

    // --- å•†åº—åŠŸèƒ½ ---
    function openShop() {
        document.getElementById('shop-modal').style.display = 'flex';
        renderShopLog();
        updateUI();
    }
    function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }
    
    function buyItem() {
        let name = document.getElementById('gift-name').value;
        let cost = parseInt(document.getElementById('gift-cost').value);
        let type = document.getElementById('gift-currency').value;
        
        if(!name || !cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        
        let costGems = (type === 'crowns') ? cost * 100 : cost;
        let totalGems = user.gems + (user.crowns * 100); // ç°¡åŒ–é‚è¼¯ï¼šæˆ–æ˜¯åˆ†é–‹æ‰£
        
        // é€™è£¡æ¡ç”¨åˆ†é–‹æ‰£æ¬¾é‚è¼¯
        if (type === 'gems') {
            if(user.gems >= cost) {
                user.gems -= cost;
                successBuy(name, cost, 'ğŸ’');
            } else alert("å¯¶çŸ³ä¸è¶³ï¼");
        } else {
            if(user.crowns >= cost) {
                user.crowns -= cost;
                successBuy(name, cost, 'ğŸ‘‘');
            } else alert("çš‡å† ä¸è¶³ï¼");
        }
    }

    function successBuy(item, cost, icon) {
        user.log.unshift(`å…Œæ› ${item} (-${cost}${icon}) - ${new Date().toLocaleTimeString()}`);
        saveUser();
        updateUI();
        renderShopLog();
        alert("å…Œæ›æˆåŠŸï¼");
    }

    function renderShopLog() {
        let div = document.getElementById('shop-log');
        div.innerHTML = user.log.map(l => `<div>${l}</div>`).join('');
    }

    // --- ç‰¹æ•ˆèˆ‡èªéŸ³ ---
    function speak(txt) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(txt);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }
    }

    function showFeedback(isCorrect) {
        let el = document.getElementById('feedback-text');
        el.innerText = isCorrect ? "O" : "X";
        el.className = "quiz-feedback " + (isCorrect ? "correct-txt" : "wrong-txt");
        el.style.display = "block";
        setTimeout(() => el.style.display = "none", 1000);
    }

    function triggerParticles() {
        const container = document.getElementById('particle-container');
        for(let i=0; i<20; i++) {
            let p = document.createElement('div');
            p.innerText = Math.random() > 0.5 ? 'ğŸ’' : 'âœ¨';
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (1 + Math.random()) + 's';
            container.appendChild(p);
        }
        setTimeout(() => container.innerHTML = '', 2000);
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>