<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰è§’å½¢æ¢éšªå®¶ v1.8 (æ°´å¹³æ ¡æ­£ç‰ˆ)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --bg-color: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none;
            overflow-x: hidden;
            overflow-y: auto;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem; }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            display: flex; justify-content: space-between; width: 100%; max-width: 600px;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        .user-info { font-weight: bold; font-size: 1.1rem; cursor: pointer; color: var(--primary); }
        .currency { font-size: 1rem; display: flex; gap: 10px; }

        /* ç•«å¸ƒå€åŸŸ */
        .canvas-container {
            position: relative;
            margin-bottom: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            cursor: crosshair;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        canvas { display: block; touch-action: none; }
        
        .canvas-tip {
            position: absolute; bottom: 5px; left: 0; width: 100%;
            text-align: center; font-size: 0.85rem; color: #7f8c8d;
            pointer-events: none; user-select: none; background: rgba(255,255,255,0.6); padding: 2px 0;
        }

        /* æ—‹è½‰æ§åˆ¶å€ (æ–°åŠŸèƒ½) */
        .rotate-controls {
            width: 100%; max-width: 600px;
            display: flex; gap: 5px; justify-content: center; align-items: center;
            margin-bottom: 10px; background: #fff; padding: 8px; border-radius: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .rotate-select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9rem; }
        .btn-rotate { background-color: #34495e; padding: 5px 15px; font-size: 0.9rem; border-radius: 15px; }

        /* æ‰‹å‹•è¼¸å…¥é¢æ¿ */
        .manual-panel {
            width: 100%; max-width: 600px;
            background: #fff; border: 2px solid #3498db;
            padding: 15px; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        
        .input-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-wrap: wrap; gap:10px;
        }
        
        .mode-select { padding: 5px; border-radius: 5px; border: 1px solid #aaa; font-size: 1rem; }

        .target-select {
            width: 100%; margin-bottom: 10px; padding: 8px; 
            border-radius: 8px; border: 2px solid #ddd; 
            font-weight: bold; color: var(--dark); font-size: 1rem;
            background-color: #f9f9f9;
        }

        .input-row { display: flex; gap: 5px; justify-content: space-between; align-items: flex-end; }
        .input-item { display: flex; flex-direction: column; align-items: center; width: 32%; }
        .input-item label { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; white-space: nowrap; }
        .input-item input { 
            width: 100%; padding: 8px 2px; text-align: center; border-radius: 8px; 
            border: 2px solid #ddd; font-size: 1.1rem; font-weight: bold; color: #333;
            box-sizing: border-box;
        }
        .input-item input:focus { border-color: var(--primary); outline: none; background: #fdf2ff; }

        /* è³‡è¨Šé¢æ¿ */
        .info-panel {
            width: 100%; max-width: 600px;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px; text-align: center;
            box-sizing: border-box;
        }
        .triangle-type {
            font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; min-height: 1.5em;
        }
        
        .controls { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 600px; margin-bottom: 20px; }
        button {
            border: none; border-radius: 25px; padding: 10px 15px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
            color: white; transition: 0.2s; box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-teach { background-color: var(--success); }
        .btn-quiz { background-color: var(--warning); }
        .btn-build { background-color: var(--danger); }
        .btn-settings { background-color: #7f8c8d; } 
        .btn-shop { background-color: #3498db; width: 100%; max-width: 600px; margin-top: 10px; padding: 12px;}
        .btn-apply { background-color: var(--primary); width: 100%; margin-top: 15px; border-radius: 10px;}
        .btn-action { background-color: var(--primary); display: none; margin-top: 10px; width: 100%; padding: 12px; animation: pulse 1s infinite;}

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .mode-badge {
            background: var(--dark); color: white; padding: 4px 12px;
            border-radius: 15px; font-size: 0.9rem; position: absolute;
            top: 10px; left: 10px; pointer-events: none; opacity: 0.8;
        }
        
        .version-tag { 
            margin-top: 30px; margin-bottom: 20px; color: #bdc3c7; 
            font-size: 0.9rem; text-align: center; font-family: monospace; 
            width: 100%; border-top: 1px dashed #ccc; padding-top: 10px;
        }

        /* å•†åº—å½ˆçª— */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; position: relative; animation: popIn 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .close-btn { position: absolute; top: 10px; right: 10px; background: #ccc; width: 30px; height: 30px; border-radius: 50%; border: none; font-weight: bold; color: white; cursor: pointer; }

        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .settings-row input { width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 5px; }

        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        .particle { position: absolute; font-size: 1.5rem; animation: fall 2s linear forwards; }
        @keyframes fall { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(100vh); } }

        .quiz-feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; text-shadow: 0 0 10px white; display: none; pointer-events: none; z-index: 10; }
        .correct-txt { color: var(--success); }
        .wrong-txt { color: var(--danger); }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div class="status-bar">
        <div class="user-info" onclick="changeName()">ğŸ“ <span id="u-name">å­¸å“¡</span></div>
        <div class="currency">
            <span>ğŸ‘‘ <span id="u-crowns">0</span></span>
            <span>ğŸ’ <span id="u-gems">0</span></span>
        </div>
    </div>

    <h1>ğŸ“ ä¸‰è§’å½¢æ¢éšªå®¶</h1>

    <div class="canvas-container">
        <div id="mode-label" class="mode-badge">æ•™å­¸æ¨¡å¼</div>
        <div id="feedback-text" class="quiz-feedback">O</div>
        <canvas id="geoCanvas" width="600" height="600"></canvas>
        <div class="canvas-tip">ğŸ’¡ æç¤ºï¼šæ‹–æ›³é ‚é»å¯æ”¹è®Šå½¢ç‹€ï¼Œæ‹–æ›³ç©ºç™½è™•å¯ç§»å‹•æ•´å€‹ä¸‰è§’å½¢ã€‚</div>
    </div>

    <div class="rotate-controls">
        <span>ğŸ”„ è½‰æ­£ä¸‰è§’å½¢ï¼š</span>
        <select id="rotate-target" class="rotate-select">
            <option value="AB">è®“ AB é‚Š æ°´å¹³</option>
            <option value="BC">è®“ BC é‚Š æ°´å¹³</option>
            <option value="AC">è®“ AC é‚Š æ°´å¹³</option>
        </select>
        <button class="btn-rotate" onclick="alignTriangle()">åŸ·è¡Œ</button>
    </div>

    <div id="manual-panel" class="manual-panel">
        <div class="input-header">
            <span>ğŸ› ï¸ åƒæ•¸èª¿æ•´æ¨¡å¼ï¼š</span>
            <select id="inputModeSelect" class="mode-select" onchange="toggleInputMode()">
                <option value="sas">èª¿æ•´å¤¾è§’ (SAS)</option>
                <option value="asa">èª¿æ•´åº•é‚Š (ASA)</option>
                <option value="sss">èª¿æ•´ä¸‰é‚Š (SSS)</option>
            </select>
        </div>
        
        <div id="panel-sas" style="display:block;">
            <select id="sas-target" class="target-select" onchange="syncInputsWithCanvas()">
                <option value="A">é–å®šé ‚é» A (æ”¹è®Š âˆ A, é‚ŠAC, é‚ŠAB)</option>
                <option value="B">é–å®šé ‚é» B (æ”¹è®Š âˆ B, é‚ŠBC, é‚ŠAB)</option>
                <option value="C">é–å®šé ‚é» C (æ”¹è®Š âˆ C, é‚ŠBC, é‚ŠAC)</option>
            </select>
            <div class="input-row">
                <div class="input-item">
                    <label id="lbl-sas-side1" style="color:#2980b9">é‚Š 1</label>
                    <input type="number" id="in-sas-s1" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
                </div>
                <div class="input-item">
                    <label id="lbl-sas-angle" style="color:#e67e22">å¤¾è§’ (Â°)</label>
                    <input type="number" id="in-sas-a" step="1" onkeydown="if(event.key==='Enter') applyManualInput()">
                </div>
                <div class="input-item">
                    <label id="lbl-sas-side2" style="color:#27ae60">é‚Š 2</label>
                    <input type="number" id="in-sas-s2" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
                </div>
            </div>
        </div>

        <div id="panel-asa" style="display:none;">
            <select id="asa-target" class="target-select" onchange="syncInputsWithCanvas()">
                <option value="a">é–å®šåº•é‚Š BC (BCä¸­å¿ƒä¸è®Š)</option>
                <option value="b">é–å®šåº•é‚Š AC (ACä¸­å¿ƒä¸è®Š)</option>
                <option value="c">é–å®šåº•é‚Š AB (ABä¸­å¿ƒä¸è®Š)</option>
            </select>
            <div class="input-row">
                <div class="input-item">
                    <label id="lbl-asa-ang1" style="color:#e67e22">å·¦è§’</label>
                    <input type="number" id="in-asa-ang1" step="1" onkeydown="if(event.key==='Enter') applyManualInput()">
                </div>
                <div class="input-item">
                    <label id="lbl-asa-side" style="color:#2980b9">åº•é‚Šé•·</label>
                    <input type="number" id="in-asa-side" step="0.1" onkeydown="if(event.key==='Enter') applyManualInput()">
                </div>
                <div class="input-item">
                    <label id="lbl-asa-ang2" style="color:#e67e22">å³è§’</label>
                    <input type="number" id="in-asa-ang2" step="1" onkeydown="if(event.key==='Enter') applyManualInput()">
                </div>
            </div>
        </div>

        <div id="panel-sss" style="display:none;">
            <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">è¼¸å…¥ä¸‰é‚Šé•· (é–å®šå¹¾ä½•ä¸­å¿ƒ)</div>
            <div class="input-row">
                <div class="input-item"><label style="color:#e74c3c">é‚Š BC (a)</label><input type="number" id="in-sss-a" step="0.1"></div>
                <div class="input-item"><label style="color:#27ae60">é‚Š AC (b)</label><input type="number" id="in-sss-b" step="0.1"></div>
                <div class="input-item"><label style="color:#2980b9">é‚Š AB (c)</label><input type="number" id="in-sss-c" step="0.1"></div>
            </div>
        </div>

        <button class="btn-apply" onclick="applyManualInput()">ğŸ”„ è®Šæ›´å½¢ç‹€</button>
    </div>

    <div class="info-panel">
        <div id="tri-type-display" class="triangle-type">ä»»æ„ä¸‰è§’å½¢</div>
        <div id="angle-info" style="font-size:1.1rem; color:#555; margin-top:5px; font-weight:bold;">
            âˆ A: 0Â° | âˆ B: 0Â° | âˆ C: 0Â°
        </div>
        <div class="stats-grid" style="margin-top:10px; font-size:0.9rem;">
             <span style="color:#e74c3c">BC = <span id="info-len-a">0</span></span>
             <span style="color:#27ae60">AC = <span id="info-len-b">0</span></span>
             <span style="color:#2980b9">AB = <span id="info-len-c">0</span></span>
        </div>
        <div id="quiz-question" style="display:none; margin-top:10px; font-weight:bold; font-size:1.2rem; color:#d35400;"></div>
    </div>

    <div class="controls">
        <button class="btn-teach" onclick="setMode('teach')">ğŸ“– è‡ªç”±æ¢ç´¢</button>
        <button class="btn-quiz" onclick="setMode('quiz_select')">â“ å±¬æ€§æ¸¬é©—</button>
        <button class="btn-build" onclick="setMode('quiz_build')">ğŸ”¨ å»ºæ§‹æŒ‘æˆ°</button>
        <button class="btn-settings" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
    </div>
    
    <div style="width: 100%; max-width: 600px; text-align: center;">
        <button id="btn-submit" class="btn-action" onclick="checkAnswer()">âœ… é€å‡ºç­”æ¡ˆ</button>
        <button class="btn-shop" onclick="openShop()">ğŸ çå‹µå•†åº—</button>
    </div>

    <div class="version-tag">Version 1.8 (æ°´å¹³æ ¡æ­£ç‰ˆ)</div>

    <div id="shop-modal" class="overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeShop()">Ã—</button>
            <h2>ğŸ çå‹µå…Œæ›</h2>
            <p>ä½ æœ‰ ğŸ’ <span id="shop-gems">0</span> | ğŸ‘‘ <span id="shop-crowns">0</span></p>
            <input type="text" id="gift-name" placeholder="çå“åç¨± (å¦‚: çœ‹å¡é€š)" style="padding:10px; width:80%; margin-bottom:10px;">
            <div style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;">
                <input type="number" id="gift-cost" placeholder="èŠ±è²»" style="padding:10px; width:60px;">
                <select id="gift-currency" style="padding:10px;">
                    <option value="gems">ğŸ’</option>
                    <option value="crowns">ğŸ‘‘</option>
                </select>
            </div>
            <button class="btn-shop" onclick="buyItem()">ç¢ºèªå…Œæ›</button>
            <div id="shop-log" style="text-align:left; margin-top:15px; font-size:0.9rem; max-height:100px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px;"></div>
        </div>
    </div>

    <div id="settings-modal" class="overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeSettings()">Ã—</button>
            <h2>âš™ï¸ çå‹µåƒæ•¸è¨­å®š</h2>
            <div class="settings-row">
                <span>â“ å±¬æ€§æ¸¬é©— (ç­”å°ç²å¾—)</span>
                <div><input type="number" id="set-reward-select" min="1" value="1"> ğŸ’</div>
            </div>
            <div class="settings-row">
                <span>ğŸ”¨ å»ºæ§‹æŒ‘æˆ° (å®Œæˆç²å¾—)</span>
                <div><input type="number" id="set-reward-build" min="1" value="3"> ğŸ’</div>
            </div>
            <button class="btn-teach" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('geoCanvas');
    const ctx = canvas.getContext('2d');
    
    // A=0, B=1, C=2
    let points = [
        {x: 300, y: 100, label: 'A', color: '#e74c3c'}, // Red
        {x: 100, y: 500, label: 'B', color: '#27ae60'}, // Green
        {x: 500, y: 500, label: 'C', color: '#2980b9'}  // Blue
    ];
    let dragIdx = -1;
    let isPanning = false;
    let lastPanPos = { x: 0, y: 0 };
    let currentMode = 'teach'; 
    let currentTarget = null; 
    
    let user = { 
        name: "å°å°å¹¾ä½•å­¸å®¶", 
        gems: 0, 
        crowns: 0, 
        log: [],
        settings: { rewardSelect: 1, rewardBuild: 3 }
    };
    
    const STORAGE_KEY = "tri_explorer_v1.8";
    const SCALE_FACTOR = 40; // 40px = 1 unit

    function init() {
        resizeCanvas();
        loadUser();
        updateUI();
        toggleInputMode();
        draw();
        
        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('mousemove', onMove);
        canvas.addEventListener('mouseup', onUp);
        canvas.addEventListener('touchstart', onDown, {passive: false});
        canvas.addEventListener('touchmove', onMove, {passive: false});
        canvas.addEventListener('touchend', onUp);
        window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
        let container = document.querySelector('.canvas-container');
        canvas.width = container.clientWidth;
        canvas.height = Math.min(600, window.innerHeight * 0.8); 
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid();

        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.lineTo(points[2].x, points[2].y);
        ctx.closePath();
        ctx.fillStyle = 'rgba(142, 68, 173, 0.1)';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#34495e';
        ctx.stroke();

        let sides = getSides(); 
        let angles = getAngles(sides);

        points.forEach((p, i) => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(p.label, p.x - 5, p.y - 15);
        });

        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT') {
            syncInputsWithCanvas(sides, angles);
        }
        updateTextDisplay(sides, angles);
    }

    function drawGrid() {
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        const step = 40;
        for(let x=0; x<canvas.width; x+=step) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y=0; y<canvas.height; y+=step) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    }

    function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }

    function getSides() {
        let a = dist(points[1], points[2]) / SCALE_FACTOR; // BC
        let b = dist(points[0], points[2]) / SCALE_FACTOR; // AC
        let c = dist(points[0], points[1]) / SCALE_FACTOR; // AB
        return [a, b, c];
    }

    function getAngles(sides) {
        let a = sides[0], b = sides[1], c = sides[2];
        let A = Math.acos((b*b + c*c - a*a) / (2*b*c)) * (180 / Math.PI);
        let B = Math.acos((a*a + c*c - b*b) / (2*a*c)) * (180 / Math.PI);
        let C = 180 - A - B;
        if(isNaN(A)) A=0; if(isNaN(B)) B=0; if(isNaN(C)) C=0;
        return [A, B, C];
    }

    // --- æ–°å¢ï¼šæ°´å¹³æ ¡æ­£åŠŸèƒ½ ---
    function alignTriangle() {
        const targetSide = document.getElementById('rotate-target').value;
        let p1, p2; // p1->p2 å®šç¾©é‚Šå‘é‡

        if (targetSide === 'AB') { p1 = points[0]; p2 = points[1]; }
        else if (targetSide === 'BC') { p1 = points[1]; p2 = points[2]; }
        else { p1 = points[0]; p2 = points[2]; } // AC

        // è¨ˆç®—ç›®å‰è©²é‚Šçš„è§’åº¦
        const currentAngle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
        
        // æˆ‘å€‘è¦æŠŠé€™å€‹é‚Šè½‰æˆæ°´å¹³ (è§’åº¦ç‚º 0 æˆ– 180)
        // é€™è£¡è¨­å®šæ—‹è½‰è§’åº¦ç‚º -currentAngle
        const rotAngle = -currentAngle;

        // è¨ˆç®—æ—‹è½‰ä¸­å¿ƒ (å¹¾ä½•ä¸­å¿ƒ)
        const cx = (points[0].x + points[1].x + points[2].x) / 3;
        const cy = (points[0].y + points[1].y + points[2].y) / 3;

        // æ—‹è½‰æ‰€æœ‰é»
        points.forEach(p => {
            const dx = p.x - cx;
            const dy = p.y - cy;
            p.x = cx + dx * Math.cos(rotAngle) - dy * Math.sin(rotAngle);
            p.y = cy + dx * Math.sin(rotAngle) + dy * Math.cos(rotAngle);
        });

        // æ—‹è½‰å¾Œç½®ä¸­
        const minX = Math.min(...points.map(p=>p.x));
        const maxX = Math.max(...points.map(p=>p.x));
        const minY = Math.min(...points.map(p=>p.y));
        const maxY = Math.max(...points.map(p=>p.y));
        
        const figCx = (minX + maxX) / 2;
        const figCy = (minY + maxY) / 2;
        const canvasCx = canvas.width / 2;
        const canvasCy = canvas.height / 2;

        points.forEach(p => {
            p.x += (canvasCx - figCx);
            p.y += (canvasCy - figCy);
        });

        draw();
        speak(`å·²å°‡ ${targetSide} é‚Šè½‰ç‚ºæ°´å¹³`);
    }

    function syncInputsWithCanvas(sides, angles) {
        if(!sides) sides = getSides();
        if(!angles) angles = getAngles(sides);
        const [a, b, c] = sides; // a=BC, b=AC, c=AB
        const [A, B, C] = angles;

        const mode = document.getElementById('inputModeSelect').value;

        if (mode === 'sas') {
            const target = document.getElementById('sas-target').value;
            if (target === 'A') {
                setSasLabels('é‚Š AB', 'å¤¾è§’ A', 'é‚Š AC');
                setSasValues(c, A, b);
            } else if (target === 'B') {
                setSasLabels('é‚Š AB', 'å¤¾è§’ B', 'é‚Š BC');
                setSasValues(c, B, a);
            } else { 
                setSasLabels('é‚Š AC', 'å¤¾è§’ C', 'é‚Š BC');
                setSasValues(b, C, a);
            }
        } else if (mode === 'asa') {
            const target = document.getElementById('asa-target').value;
            if (target === 'a') {
                setAsaLabels('å·¦è§’ B', 'åº•é‚Š BC', 'å³è§’ C');
                setAsaValues(B, a, C);
            } else if (target === 'b') {
                setAsaLabels('å·¦è§’ A', 'åº•é‚Š AC', 'å³è§’ C');
                setAsaValues(A, b, C);
            } else { 
                setAsaLabels('å·¦è§’ A', 'åº•é‚Š AB', 'å³è§’ B');
                setAsaValues(A, c, B);
            }
        } else { // SSS
            document.getElementById('in-sss-a').value = a.toFixed(1);
            document.getElementById('in-sss-b').value = b.toFixed(1);
            document.getElementById('in-sss-c').value = c.toFixed(1);
        }
    }

    function setSasLabels(l1, l2, l3) {
        document.getElementById('lbl-sas-side1').innerText = l1;
        document.getElementById('lbl-sas-angle').innerText = l2;
        document.getElementById('lbl-sas-side2').innerText = l3;
    }
    function setSasValues(v1, v2, v3) {
        document.getElementById('in-sas-s1').value = v1.toFixed(1);
        document.getElementById('in-sas-a').value = Math.round(v2);
        document.getElementById('in-sas-s2').value = v3.toFixed(1);
    }
    function setAsaLabels(l1, l2, l3) {
        document.getElementById('lbl-asa-ang1').innerText = l1;
        document.getElementById('lbl-asa-side').innerText = l2;
        document.getElementById('lbl-asa-ang2').innerText = l3;
    }
    function setAsaValues(v1, v2, v3) {
        document.getElementById('in-asa-ang1').value = Math.round(v1);
        document.getElementById('in-asa-side').value = v2.toFixed(1);
        document.getElementById('in-asa-ang2').value = Math.round(v3);
    }

    function updateTextDisplay(sides, angles) {
        let typeText = analyzeTriangle(sides, angles);
        if (currentMode === 'teach') {
            document.getElementById('tri-type-display').innerText = typeText;
            document.getElementById('tri-type-display').style.color = '#8e44ad';
        } else if (currentMode === 'quiz_build') {
            document.getElementById('tri-type-display').innerText = "å»ºæ§‹ä¸­..."; 
            document.getElementById('tri-type-display').style.color = '#95a5a6';
        } else {
            document.getElementById('tri-type-display').innerText = "??? ä¸‰è§’å½¢";
        }
        document.getElementById('angle-info').innerText = 
            `âˆ A: ${Math.round(angles[0])}Â° | âˆ B: ${Math.round(angles[1])}Â° | âˆ C: ${Math.round(angles[2])}Â°`;
        
        document.getElementById('info-len-a').innerText = sides[0].toFixed(1);
        document.getElementById('info-len-b').innerText = sides[1].toFixed(1);
        document.getElementById('info-len-c').innerText = sides[2].toFixed(1);
    }

    function analyzeTriangle(sides, angles) {
        let [A, B, C] = angles;
        let [a, b, c] = sides;
        let maxAngle = Math.max(A, B, C);
        let labels = [];
        if (Math.abs(maxAngle - 90) < 2) labels.push("ç›´è§’");
        else if (maxAngle > 90) labels.push("éˆè§’");
        else labels.push("éŠ³è§’");
        let isEquilateral = (Math.abs(a-b)<0.1 && Math.abs(b-c)<0.1);
        let isIsosceles = (Math.abs(a-b)<0.1 || Math.abs(b-c)<0.1 || Math.abs(a-c)<0.1);
        if (isEquilateral) labels.push("æ­£");
        else if (isIsosceles) labels.push("ç­‰è…°");
        return labels.join(" ") + "ä¸‰è§’å½¢";
    }

    function toggleInputMode() {
        const mode = document.getElementById('inputModeSelect').value;
        document.getElementById('panel-sas').style.display = mode === 'sas' ? 'block' : 'none';
        document.getElementById('panel-asa').style.display = mode === 'asa' ? 'block' : 'none';
        document.getElementById('panel-sss').style.display = mode === 'sss' ? 'block' : 'none';
        syncInputsWithCanvas();
    }

    function applyManualInput() {
        const mode = document.getElementById('inputModeSelect').value;
        
        if (mode === 'sas') {
            const target = document.getElementById('sas-target').value;
            const s1 = parseFloat(document.getElementById('in-sas-s1').value);
            const angDeg = parseFloat(document.getElementById('in-sas-a').value);
            const s2 = parseFloat(document.getElementById('in-sas-s2').value);
            
            if (angDeg <= 0 || angDeg >= 180) return alert("è§’åº¦å¿…é ˆåœ¨ 0~180 ä¹‹é–“");

            let anchor, P1, P2;
            let idxAnchor, idxP1, idxP2;

            if (target === 'A') { idxAnchor=0; idxP1=1; idxP2=2; } 
            else if (target === 'B') { idxAnchor=1; idxP1=0; idxP2=2; } 
            else { idxAnchor=2; idxP1=0; idxP2=1; } 

            anchor = points[idxAnchor];
            P1 = points[idxP1];
            P2 = points[idxP2];

            const currentAngle1 = Math.atan2(P1.y - anchor.y, P1.x - anchor.x);
            const len1 = s1 * SCALE_FACTOR;
            points[idxP1].x = anchor.x + len1 * Math.cos(currentAngle1);
            points[idxP1].y = anchor.y + len1 * Math.sin(currentAngle1);

            const dx1 = P1.x - anchor.x; const dy1 = P1.y - anchor.y;
            const dx2 = P2.x - anchor.x; const dy2 = P2.y - anchor.y;
            const cross = dx1 * dy2 - dy1 * dx2;
            const direction = cross >= 0 ? 1 : -1; 

            const angRad = angDeg * (Math.PI / 180);
            const newAngle2 = currentAngle1 + (direction * angRad);
            const len2 = s2 * SCALE_FACTOR;
            points[idxP2].x = anchor.x + len2 * Math.cos(newAngle2);
            points[idxP2].y = anchor.y + len2 * Math.sin(newAngle2);

        } else if (mode === 'asa') {
            const target = document.getElementById('asa-target').value;
            const ang1Deg = parseFloat(document.getElementById('in-asa-ang1').value);
            const sideLen = parseFloat(document.getElementById('in-asa-side').value);
            const ang2Deg = parseFloat(document.getElementById('in-asa-ang2').value);

            if (ang1Deg + ang2Deg >= 180) return alert(`è§’åº¦å’Œ (${ang1Deg+ang2Deg}Â°) å¿…é ˆå°æ–¼ 180Â°`);

            let idxL, idxR, idxTop;
            if (target === 'a') { idxL=1; idxR=2; idxTop=0; } // BC
            else if (target === 'b') { idxL=0; idxR=2; idxTop=1; } // AC
            else { idxL=0; idxR=1; idxTop=2; } // AB

            const PL = points[idxL];
            const PR = points[idxR];
            
            const midX = (PL.x + PR.x) / 2;
            const midY = (PL.y + PR.y) / 2;
            const baseAngle = Math.atan2(PR.y - PL.y, PR.x - PL.x); 

            const halfLen = (sideLen * SCALE_FACTOR) / 2;
            points[idxL].x = midX - halfLen * Math.cos(baseAngle);
            points[idxL].y = midY - halfLen * Math.sin(baseAngle);
            points[idxR].x = midX + halfLen * Math.cos(baseAngle);
            points[idxR].y = midY + halfLen * Math.sin(baseAngle);

            const ang1Rad = ang1Deg * (Math.PI / 180);
            const ang2Rad = ang2Deg * (Math.PI / 180);
            const topAngRad = Math.PI - ang1Rad - ang2Rad;
            const lenL_Top = (sideLen * SCALE_FACTOR) * Math.sin(ang2Rad) / Math.sin(topAngRad);

            const oldTop = points[idxTop];
            const dxB = PR.x - PL.x; const dyB = PR.y - PL.y;
            const dxS = oldTop.x - PL.x; const dyS = oldTop.y - PL.y;
            const cross = dxB * dyS - dyB * dxS;
            const direction = cross >= 0 ? 1 : -1;

            const newAngleTop = baseAngle + (direction * ang1Rad);
            points[idxTop].x = points[idxL].x + lenL_Top * Math.cos(newAngleTop);
            points[idxTop].y = points[idxL].y + lenL_Top * Math.sin(newAngleTop);

        } else if (mode === 'sss') {
            const a = parseFloat(document.getElementById('in-sss-a').value);
            const b = parseFloat(document.getElementById('in-sss-b').value);
            const c = parseFloat(document.getElementById('in-sss-c').value);

            if (a + b <= c || a + c <= b || b + c <= a) return alert("ç„¡æ³•æ§‹æˆä¸‰è§’å½¢ (å…©é‚Šä¹‹å’Œéœ€å¤§æ–¼ç¬¬ä¸‰é‚Š)");

            const idxA = 0, idxB = 1, idxC = 2;
            const midX = (points[idxA].x + points[idxB].x) / 2;
            const midY = (points[idxA].y + points[idxB].y) / 2;
            const angleAB = Math.atan2(points[idxB].y - points[idxA].y, points[idxB].x - points[idxA].x);

            const halfC = (c * SCALE_FACTOR) / 2;
            points[idxA].x = midX - halfC * Math.cos(angleAB);
            points[idxA].y = midY - halfC * Math.sin(angleAB);
            points[idxB].x = midX + halfC * Math.cos(angleAB);
            points[idxB].y = midY + halfC * Math.sin(angleAB);

            const cosA = (b*b + c*c - a*a) / (2*b*c);
            const angA = Math.acos(cosA);
            
            const oldC = points[idxC];
            const dxAB = points[idxB].x - points[idxA].x;
            const dyAB = points[idxB].y - points[idxA].y;
            const dxAC = oldC.x - points[idxA].x;
            const dyAC = oldC.y - points[idxA].y;
            const cross = dxAB * dyAC - dyAB * dxAC;
            const direction = cross >= 0 ? 1 : -1;

            const lenb = b * SCALE_FACTOR;
            const newAngleAC = angleAB + (direction * angA);
            points[idxC].x = points[idxA].x + lenb * Math.cos(newAngleAC);
            points[idxC].y = points[idxA].y + lenb * Math.sin(newAngleAC);
        }

        draw();
        speak("è®Šå½¢å®Œæˆ");
    }

    function getPointerPos(e) {
        let rect = canvas.getBoundingClientRect();
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function onDown(e) {
        if(e.type === 'touchstart') e.preventDefault();
        let pos = getPointerPos(e);
        dragIdx = -1;
        points.forEach((p, i) => { if (dist(pos, p) < 30) dragIdx = i; });

        if (dragIdx === -1) {
            isPanning = true;
            lastPanPos = pos;
            canvas.style.cursor = 'grabbing'; 
        }
    }

    function onMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        let pos = getPointerPos(e);

        if (dragIdx !== -1) {
            pos.x = Math.max(10, Math.min(canvas.width - 10, pos.x));
            pos.y = Math.max(10, Math.min(canvas.height - 10, pos.y));
            points[dragIdx].x = pos.x;
            points[dragIdx].y = pos.y;
            draw();
        } else if (isPanning) {
            const dx = pos.x - lastPanPos.x;
            const dy = pos.y - lastPanPos.y;
            points.forEach(p => {
                p.x += dx;
                p.y += dy;
            });
            lastPanPos = pos;
            draw();
        }
    }

    function onUp(e) {
        dragIdx = -1;
        isPanning = false;
        canvas.style.cursor = 'crosshair';
    }

    function setMode(mode) {
        currentMode = mode;
        let label = document.getElementById('mode-label');
        let qBox = document.getElementById('quiz-question');
        let subBtn = document.getElementById('btn-submit');
        qBox.style.display = 'none'; subBtn.style.display = 'none';
        
        document.getElementById('manual-panel').style.display = (mode === 'teach' || mode === 'quiz_build') ? 'block' : 'none';

        if (mode === 'teach') {
            label.innerText = "æ•™å­¸æ¨¡å¼"; label.style.background = "#2c3e50";
            speak("é€²å…¥è‡ªç”±æ¢ç´¢æ¨¡å¼");
        } else if (mode === 'quiz_select') {
            label.innerText = "å±¬æ€§æ¸¬é©—"; label.style.background = "#f39c12";
            startQuizSelect();
        } else if (mode === 'quiz_build') {
            label.innerText = "å»ºæ§‹æŒ‘æˆ°"; label.style.background = "#c0392b";
            startQuizBuild();
        }
        draw();
    }

    function startQuizSelect() {
        randomizeTriangle(); draw();
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        let types = ["éŠ³è§’", "ç›´è§’", "éˆè§’", "ç­‰è…°"];
        let target = types[Math.floor(Math.random() * types.length)];
        currentTarget = { type: 'select', target: target };
        qBox.innerHTML = `é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong> å—ï¼Ÿ`;
        let subBtn = document.getElementById('btn-submit');
        subBtn.innerText = "ğŸ¤” é»æ­¤æŸ¥çœ‹ç­”æ¡ˆ"; subBtn.style.display = 'inline-block';
        subBtn.onclick = checkAnswerSelect;
        speak(`é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹${target}ä¸‰è§’å½¢å—ï¼Ÿ`);
    }
    function checkAnswerSelect() {
        let sides = getSides(); let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let isCorrect = typeStr.includes(currentTarget.target);
        let reward = user.settings && user.settings.rewardSelect ? parseInt(user.settings.rewardSelect) : 1;
        let feedback = document.getElementById('quiz-question');
        
        if (isCorrect) { 
            feedback.innerHTML += `<br><span style="color:green">â­• æ˜¯çš„ï¼é€™æ˜¯ ${typeStr}</span>`; 
            addReward(reward); 
            showFeedback(true); 
        } else { 
            feedback.innerHTML += `<br><span style="color:red">âŒ ä¸æ˜¯å–”ï¼Œé€™æ˜¯ ${typeStr}</span>`; 
            showFeedback(false); 
        }
        let subBtn = document.getElementById('btn-submit'); subBtn.innerText = "â¡ ä¸‹ä¸€é¡Œ"; subBtn.onclick = startQuizSelect;
    }
    
    function startQuizBuild() {
        let qBox = document.getElementById('quiz-question');
        qBox.style.display = 'block';
        let subBtn = document.getElementById('btn-submit');
        subBtn.style.display = 'inline-block'; subBtn.innerText = "âœ… æˆ‘åšå¥½äº†ï¼";
        subBtn.onclick = checkAnswerBuild;
        let missions = ["ç›´è§’", "éˆè§’", "ç­‰è…°", "æ­£", "ç­‰è…°ç›´è§’"];
        let target = missions[Math.floor(Math.random() * missions.length)];
        currentTarget = { type: 'build', target: target };
        qBox.innerHTML = `ä»»å‹™ï¼šè«‹åšå‡ºä¸€å€‹ <strong>${target}ä¸‰è§’å½¢</strong>`;
        speak(`ä»»å‹™é–‹å§‹ï¼šè«‹åšå‡ºä¸€å€‹${target}ä¸‰è§’å½¢`);
    }
    function checkAnswerBuild() {
        let sides = getSides(); let angles = getAngles(sides);
        let typeStr = analyzeTriangle(sides, angles);
        let target = currentTarget.target;
        let isCorrect = (target === "ç­‰è…°ç›´è§’") ? (typeStr.includes("ç­‰è…°") && typeStr.includes("ç›´è§’")) : typeStr.includes(target);
        let reward = user.settings && user.settings.rewardBuild ? parseInt(user.settings.rewardBuild) : 3;
        
        if (isCorrect) { 
            alert(`å¤ªæ£’äº†ï¼ç²å¾— ${reward} é¡†å¯¶çŸ³ğŸ’`); 
            addReward(reward); 
            showFeedback(true); 
            triggerParticles(); 
            setTimeout(startQuizBuild, 1500); 
        } else { 
            alert(`é‚„å·®ä¸€é»é»å–”ï¼ç›®å‰æ˜¯ï¼š${typeStr}`); 
            showFeedback(false); 
        }
    }
    function randomizeTriangle() {
        points[0].x = 100 + Math.random()*400; points[0].y = 50 + Math.random()*150;
        points[1].x = 50 + Math.random()*200; points[1].y = 300 + Math.random()*200;
        points[2].x = 350 + Math.random()*200; points[2].y = 300 + Math.random()*200;
    }
    function addReward(gems) { user.gems += gems; if (user.gems >= 100) { user.gems -= 100; user.crowns += 1; alert("æ­å–œå‡ç´šï¼ç²å¾— 1 é ‚çš‡å†  ğŸ‘‘"); } saveUser(); updateUI(); }
    function updateUI() {
        document.getElementById('u-name').innerText = user.name;
        document.getElementById('u-gems').innerText = user.gems;
        document.getElementById('u-crowns').innerText = user.crowns;
        if(document.getElementById('shop-gems')) { document.getElementById('shop-gems').innerText = user.gems; document.getElementById('shop-crowns').innerText = user.crowns; }
    }
    function loadUser() { 
        let data = localStorage.getItem(STORAGE_KEY); 
        if (data) {
            user = JSON.parse(data);
            if (!user.settings) user.settings = { rewardSelect: 1, rewardBuild: 3 };
        }
    }
    function saveUser() { localStorage.setItem(STORAGE_KEY, JSON.stringify(user)); }
    function changeName() { let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", user.name); if (n) { user.name = n; saveUser(); updateUI(); } }
    
    // --- è¨­å®šåŠŸèƒ½ ---
    function openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
        document.getElementById('set-reward-select').value = user.settings.rewardSelect;
        document.getElementById('set-reward-build').value = user.settings.rewardBuild;
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        user.settings.rewardSelect = parseInt(document.getElementById('set-reward-select').value);
        user.settings.rewardBuild = parseInt(document.getElementById('set-reward-build').value);
        saveUser();
        closeSettings();
        alert("è¨­å®šå·²å„²å­˜ï¼");
    }

    function openShop() { document.getElementById('shop-modal').style.display = 'flex'; renderShopLog(); updateUI(); }
    function closeShop() { document.getElementById('shop-modal').style.display = 'none'; }
    function buyItem() {
        let name = document.getElementById('gift-name').value; let cost = parseInt(document.getElementById('gift-cost').value); let type = document.getElementById('gift-currency').value;
        if(!name || !cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        if (type === 'gems') { if(user.gems >= cost) { user.gems -= cost; successBuy(name, cost, 'ğŸ’'); } else alert("å¯¶çŸ³ä¸è¶³ï¼"); } 
        else { if(user.crowns >= cost) { user.crowns -= cost; successBuy(name, cost, 'ğŸ‘‘'); } else alert("çš‡å† ä¸è¶³ï¼"); }
    }
    function successBuy(item, cost, icon) { user.log.unshift(`å…Œæ› ${item} (-${cost}${icon})`); saveUser(); updateUI(); renderShopLog(); alert("å…Œæ›æˆåŠŸï¼"); }
    function renderShopLog() { document.getElementById('shop-log').innerHTML = user.log.map(l => `<div>${l}</div>`).join(''); }

    function speak(txt) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(txt); u.lang = 'zh-TW'; window.speechSynthesis.speak(u); } }
    function showFeedback(isCorrect) {
        let el = document.getElementById('feedback-text'); el.innerText = isCorrect ? "O" : "X";
        el.className = "quiz-feedback " + (isCorrect ? "correct-txt" : "wrong-txt");
        el.style.display = "block"; setTimeout(() => el.style.display = "none", 1000);
    }
    function triggerParticles() {
        const container = document.getElementById('particle-container');
        for(let i=0; i<20; i++) {
            let p = document.createElement('div'); p.innerText = Math.random() > 0.5 ? 'ğŸ’' : 'âœ¨';
            p.className = 'particle'; p.style.left = Math.random() * 100 + 'vw'; p.style.animationDuration = (1 + Math.random()) + 's';
            container.appendChild(p);
        }
        setTimeout(() => container.innerHTML = '', 2000);
    }

    init();
</script>
</body>
</html>
