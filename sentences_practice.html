<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentence Builder å¥å­é—–é—œç‹ v3.2 (æµæš¢å°è©±ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4834d4;
            --secondary: #686de0;
            --dark: #130f40;
            --light: #fdfdfd;
            --accent: #f9ca24;
            --success: #2ed573;
            --danger: #eb4d4b;
            --bg-chat: #f1f2f6;
            --user-bubble: #dff9fb;
            --teacher-bubble: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #dff9fb;
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation; 
            overflow-x: hidden;
            overflow-y: auto; 
        }

        h1, h2 { margin: 5px 0; color: var(--dark); text-align: center; }

        /* --- é€šç”¨å®¹å™¨ --- */
        .container {
            width: 100%; max-width: 650px; background: white; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box;
            margin-bottom: 20px; display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- æŒ‰éˆ• --- */
        button {
            border: none; border-radius: 8px; padding: 8px 12px; font-size: 0.95rem;
            font-weight: bold; cursor: pointer; transition: transform 0.1s;
            color: white; margin: 2px; touch-action: manipulation;
        }
        button:active { transform: scale(0.95); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-accent { background-color: #f0932b; }
        .btn-gray { background-color: #95a5a6; }
        .btn-danger { background-color: var(--danger); }
        .btn-link { background-color: #22a6b3; }
        .btn-block { width: 100%; margin: 5px 0; padding: 12px; font-size: 1.1rem; }
        .btn-hint { background-color: #2ed573; color: white; } 

        /* --- åˆ—è¡¨é …ç›® --- */
        .list-item {
            background: #f8f9fa; border: 1px solid #e9ecef; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; display: flex; align-items: center; gap: 10px;
        }
        .list-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        /* --- æ¸¬é©—å€ (èŠå¤©å®¤é¢¨æ ¼) --- */
        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; color: #7f8c8d; margin-bottom: 10px; background: #f1f2f6; padding: 10px; border-radius: 8px; }
        .q-image-box { height: 120px; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; overflow: hidden;}
        .q-image-box img { max-height: 100%; max-width: 100%; border-radius: 8px; object-fit: contain; }
        .q-image-box span { font-size: 4rem; }

        /* å°è©±æ­·å²å®¹å™¨ */
        .dialogue-box {
            background: var(--bg-chat);
            border-radius: 12px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #e1e1e1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* å°è©±æ°£æ³¡ */
        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            animation: popIn 0.3s ease-out;
        }
        
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* ä½¿ç”¨è€… (å³å´) */
        .chat-bubble.user {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: #333;
            border-bottom-right-radius: 2px;
            border: 1px solid #c7ecee;
        }
        .chat-bubble.user.correct { background-color: #d1fae5; border-color: #a7f3d0; color: #065f46; }
        .chat-bubble.user.wrong { background-color: #fee2e2; border-color: #fecaca; color: #991b1b; text-decoration: line-through; opacity: 0.8;}

        /* è€å¸«/ç³»çµ±ä¿®æ­£ (å·¦å´) */
        .chat-bubble.teacher {
            align-self: flex-start;
            background-color: var(--teacher-bubble);
            color: #444;
            border-bottom-left-radius: 2px;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        .chat-bubble.teacher::before { content: "âœ… "; }

        .input-wrapper { margin-bottom: 10px; position: relative; }
        .sentence-input {
            width: 100%; font-size: 1.2rem; padding: 12px; border: 2px solid #ccc;
            border-radius: 25px; font-family: 'Segoe UI', sans-serif; box-sizing: border-box;
            outline: none; transition: border-color 0.3s; text-align: left; padding-left: 20px;
        }
        .sentence-input:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(72, 52, 212, 0.2); }

        .progress-indicator { text-align:center; font-size:0.8rem; color:#999; margin-bottom: 5px;}

        /* --- ç·¨è¼¯å€ --- */
        .edit-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: flex-start; background: #fff; padding: 8px; border: 1px solid #eee; border-radius: 8px; }
        .edit-row textarea { 
            padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; 
            font-family: inherit; font-size: 1rem; resize: vertical; min-height: 40px;
        }
        .thumb-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; background: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .file-input { display: none; }

        /* --- ç²’å­å‹•ç•« (çå‹µ) --- */
        #particle-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden; display: none;
        }
        .particle {
            position: absolute; font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        /* å…¶ä»–è¼”åŠ©æ¨£å¼ */
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #999; font-weight: bold; border-bottom: 2px solid #eee;}
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tabs { display: flex; margin-bottom: 15px; }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>ğŸ’¬ å¥å­å°è©±é—–é—œ v3.2</h1>
        
        <div style="background:#e056fd15; border:2px dashed #686de0; border-radius:10px; padding:10px; margin-bottom:15px; text-align:center;">
            <div style="font-size:1.2rem; font-weight:bold; color:#4834d4;">
                <span id="display-student-name">å­¸å“¡</span>
                <button class="btn-outline" style="padding:2px 6px; font-size:0.8rem;" onclick="changeStudentName()">âœ</button>
            </div>
            <div style="margin-top:5px;">
                ğŸ‘‘ <span id="stat-crowns">0</span> &nbsp;|&nbsp; ğŸ’ <span id="stat-gems">0</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¡Œåº«é¸æ“‡</div>
            <div class="tab" onclick="switchTab('history')">ç·´ç¿’ç´€éŒ„</div>
        </div>

        <div id="tab-quiz-content">
            <button class="btn-accent btn-block" style="margin-bottom:10px;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢è‡ªè¨‚é¡Œåº«</button>
            
            <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                <button class="btn-link" style="width:100%" onclick="exportSelectedData()">ğŸ“¤ å‚™ä»½è³‡æ–™</button>
                <input type="file" id="import-file" class="file-input" accept=".json" onchange="handleImportData(this)">
                <button class="btn-link" style="width:100%; margin-top:5px;" onclick="document.getElementById('import-file').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
            </div>
        </div>

        <div id="tab-history-content" style="display:none;">
            <div id="history-container"></div>
            <button class="btn-gray btn-block" onclick="clearAllHistory()">æ¸…ç©ºç´€éŒ„</button>
        </div>
        <div style="text-align:center; color:#ccc; margin-top:20px; font-size:0.8rem;">ç‰ˆæœ¬ v3.2 (æµæš¢å°è©±ç‰ˆ)</div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-progress">é¡Œè™Ÿ: 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-score">å¾—åˆ†: 0</span>
        </div>
        
        <div class="q-image-box" id="q-image-box"></div>
        
        <div id="dialogue-box" class="dialogue-box">
            </div>

        <div class="progress-indicator" id="sub-progress-indicator">ç­‰å¾…é–‹å§‹...</div>

        <div class="input-wrapper">
            <input type="text" id="user-input" class="sentence-input" placeholder="è«‹è¼¸å…¥è½åˆ°çš„å¥å­..." autocomplete="off" spellcheck="false">
        </div>

        <div style="display: flex; gap: 5px; margin-bottom:10px;">
            <button class="btn-secondary" style="flex:1" onclick="playTargetAudio()">ğŸ”Š é‡è½</button>
            <button class="btn-hint" style="flex:1" onclick="provideHint()">ğŸ’¡ æç¤º</button>
        </div>

        <button id="btn-submit" class="btn-primary btn-block" onclick="checkAnswer()">é€å‡º (Enter)</button>
        <button id="btn-next-q" class="btn-success btn-block" style="display:none;" onclick="finishCurrentQuestionAndNext()">ä¸‹ä¸€é¡Œ â”</button>
        <button class="btn-gray btn-block" onclick="quitQuiz()">é€€å‡ºç·´ç¿’</button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:10px;">
            <input type="text" id="list-name-input" placeholder="é¡Œåº«åç¨±" style="padding:8px; width:100%; box-sizing:border-box; margin-bottom:5px;">
            <div style="display:flex; gap:10px;">
                <input type="number" id="list-gems" placeholder="å¯¶çŸ³" style="padding:5px; width:60px;" value="5">
                <input type="number" id="list-pass-score" placeholder="åŠæ ¼åˆ†" style="padding:5px; width:60px;" value="100">
            </div>
        </div>
        <div style="background:#e8f0fe; padding:8px; font-size:0.9rem; margin-bottom:10px; color:#2c3e50; border-radius:5px;">
            ğŸ’¡ <strong>å¤šå¥æ¨¡å¼ï¼š</strong>è«‹åœ¨è¼¸å…¥æ¡†ä¸­<b>æ›è¡Œ</b>ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€å¥è©±ã€‚<br>
            æ¸¬é©—æ™‚å°‡æœƒä¾åºå‡ºç¾ï¼Œå½¢æˆå°è©±ã€‚
        </div>
        <div id="editor-rows"></div>
        <button class="btn-gray" onclick="addEditRow()">+ å¢åŠ é¡Œç›®</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align:center;">
            <h2>ğŸ‰ ç·´ç¿’å®Œæˆï¼</h2>
            <div style="font-size:4rem; color:var(--primary); font-weight:bold;" id="final-score">100</div>
            <div id="final-stats"></div>
            <div id="reward-area" style="margin:15px 0;"></div>
            
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; text-align:left; font-size:0.9rem;">
                <table style="width:100%; border-collapse:collapse;">
                    <tbody id="detail-tbody"></tbody>
                </table>
            </div>
            <button class="btn-primary btn-block" style="margin-top:15px;" onclick="showPage('page-home')">å›åˆ°é¦–é </button>
        </div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå•†åº—</h2>
        <div style="background:linear-gradient(135deg, #667eea, #764ba2); color:white; padding:15px; border-radius:10px; text-align:center; margin-bottom:15px;">
            æŒæœ‰: ğŸ‘‘ <span id="shop-crowns">0</span> | ğŸ’ <span id="shop-gems">0</span>
        </div>
        <input type="text" id="gift-name" class="sentence-input" placeholder="çå“åç¨±" style="margin-bottom:5px;">
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="number" id="gift-cost" class="sentence-input" placeholder="èŠ±è²»" style="flex:1">
            <select id="gift-currency" style="padding:5px; flex:1; border-radius:8px;">
                <option value="gems">ğŸ’ å¯¶çŸ³</option>
                <option value="crowns">ğŸ‘‘ çš‡å† </option>
            </select>
        </div>
        <button class="btn-primary btn-block" onclick="processExchange()">å…Œæ›</button>
        <div id="exchange-log" style="margin-top:15px; font-size:0.9rem; color:#666; max-height:150px; overflow-y:auto;"></div>
        <button class="btn-gray btn-block" style="margin-top:10px;" onclick="showPage('page-home')">è¿”å›</button>
    </div>

<script>
    // --- è³‡æ–™çµæ§‹ ---
    const DEFAULT_LIST = {
        id: 'default_conv',
        name: 'ç¯„ä¾‹ï¼šæ—¥å¸¸å°è©±',
        gems: 10,
        passScore: 80,
        words: [
            {sentences: ['Hello, how are you?', 'I am fine, thank you.'], img: 'ğŸ‘‹'}, 
            {sentences: ['What time is it?', 'It is three o\'clock.'], img: 'â°'}
        ]
    };

    let allLists = [];
    let studentName = "å­¸å“¡";
    let totalGems = 0;
    let historyLog = [];
    let exchangeLog = [];

    // æ¸¬é©—è®Šæ•¸
    let currentQuizList = [];
    let currentListId = null;
    let currentQIndex = 0; 
    let currentSubIndex = 0; 
    let currentTargetSentences = [];
    let score = 0;
    let timerInterval, startTime;
    let quizReport = [];

    window.onload = function() {
        loadData();
        renderLists();
        updateProfile();
        
        // ç¶å®š Enter éµ
        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                // å¦‚æœæŒ‰éˆ•æ˜¯é€å‡ºç‹€æ…‹
                if(document.getElementById('btn-submit').style.display !== 'none'){
                    checkAnswer();
                } else {
                    // å¦‚æœæŒ‰éˆ•æ˜¯ä¸‹ä¸€é¡Œç‹€æ…‹ (æœ€å¾Œä¸€é¡ŒçµæŸæ™‚)
                    finishCurrentQuestionAndNext();
                }
            }
        });
    };

    function loadData() {
        allLists = JSON.parse(localStorage.getItem('sb_lists_v32') || JSON.stringify([DEFAULT_LIST]));
        studentName = localStorage.getItem('sb_name_v32') || "å­¸å“¡";
        totalGems = parseInt(localStorage.getItem('sb_gems_v32') || 0);
        historyLog = JSON.parse(localStorage.getItem('sb_hist_v32') || '[]');
        exchangeLog = JSON.parse(localStorage.getItem('sb_ex_v32') || '[]');
    }

    function saveData() {
        localStorage.setItem('sb_lists_v32', JSON.stringify(allLists));
        localStorage.setItem('sb_name_v32', studentName);
        localStorage.setItem('sb_gems_v32', totalGems);
        localStorage.setItem('sb_hist_v32', JSON.stringify(historyLog));
        localStorage.setItem('sb_ex_v32', JSON.stringify(exchangeLog));
        updateProfile();
    }

    function updateProfile() {
        document.getElementById('display-student-name').innerText = studentName;
        document.getElementById('stat-crowns').innerText = Math.floor(totalGems / 100);
        document.getElementById('stat-gems').innerText = totalGems % 100;
        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = Math.floor(totalGems / 100);
            document.getElementById('shop-gems').innerText = totalGems % 100;
        }
    }
    
    function changeStudentName() {
        let n = prompt("è¼¸å…¥å§“å:", studentName);
        if(n && n.trim()){ studentName = n.trim(); saveData(); }
    }

    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') { renderLists(); renderHistory(); }
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
    }
    
    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-quiz-content').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-history-content').style.display = t==='history'?'block':'none';
    }

    // --- æ¸¬é©—æ ¸å¿ƒé‚è¼¯ (Chat Flow) ---
    function startQuizSetup(idx) {
        const list = allLists[idx];
        currentListId = list.id;
        
        let shuffled = [...list.words].sort(()=>0.5-Math.random());
        currentQuizList = shuffled.slice(0, 10); // æœ€å¤š10é¡Œ
        
        currentQIndex = 0;
        score = 0;
        quizReport = [];
        startTime = Date.now();
        timerInterval = setInterval(()=>{
            let s = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
        }, 1000);

        showPage('page-quiz');
        loadQuestion(true);
    }

    function loadQuestion(first) {
        let q = currentQuizList[currentQIndex];
        currentTargetSentences = q.sentences || [q.word];
        currentSubIndex = 0;
        
        document.getElementById('q-progress').innerText = `é¡Œè™Ÿ: ${currentQIndex+1}/${currentQuizList.length}`;
        document.getElementById('q-score').innerText = `å¾—åˆ†: ${score}`;
        
        // åœ–ç‰‡
        const ib = document.getElementById('q-image-box');
        ib.innerHTML = (q.img && q.img.length>10) ? `<img src="${q.img}">` : `<span>${q.img}</span>`;
        
        // é‡ç½®å°è©±æ¡†èˆ‡è¼¸å…¥å€
        document.getElementById('dialogue-box').innerHTML = ''; 
        document.getElementById('user-input').disabled = false;
        document.getElementById('user-input').focus();
        document.getElementById('btn-submit').style.display = 'block';
        document.getElementById('btn-next-q').style.display = 'none';

        updateSubInterface(first);
    }

    function updateSubInterface(first) {
        // æ›´æ–°é€²åº¦æç¤º
        document.getElementById('sub-progress-indicator').innerText = 
            `æ­£åœ¨è¼¸å…¥ç¬¬ ${currentSubIndex + 1} å¥ï¼Œå…± ${currentTargetSentences.length} å¥`;
        
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
        
        // è‡ªå‹•æ’­æ”¾è©²å¥èªéŸ³
        setTimeout(() => playTargetAudio(), first ? 1500 : 800);
    }

    function playTargetAudio() {
        if(currentSubIndex < currentTargetSentences.length) {
            speak(currentTargetSentences[currentSubIndex], 'en-US');
        }
    }

    // æ ¸å¿ƒå„ªåŒ–ï¼šæª¢æŸ¥ç­”æ¡ˆä¸¦æ¨é€²ï¼Œä¸å¡é—œ
    function checkAnswer() {
        const inputEl = document.getElementById('user-input');
        const val = inputEl.value.trim();
        if(!val) return; // ç©ºç™½ä¸é€å‡º

        const target = currentTargetSentences[currentSubIndex].trim();
        const isCorrect = val.toLowerCase().replace(/[.,?!]/g,'') === target.toLowerCase().replace(/[.,?!]/g,'');
        
        // 1. é¡¯ç¤ºä½¿ç”¨è€…æ°£æ³¡
        addBubble(val, 'user', isCorrect ? 'correct' : 'wrong');

        // 2. å¦‚æœéŒ¯èª¤ï¼Œé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ (è€å¸«æ°£æ³¡)
        if (!isCorrect) {
            addBubble(target, 'teacher');
            speak("Correct answer is " + target, 'en-US', 1.2); // å¿«é€Ÿå”¸å‡ºæ­£ç¢ºç­”æ¡ˆ
        } else {
            score += Math.round(100 / (currentQuizList.length * currentTargetSentences.length)); // ç°¡å–®è¨ˆåˆ†
            speak("Correct!", 'en-US', 1.5);
        }

        // ç´€éŒ„å ±è¡¨ (è©³ç´°åˆ°æ¯ä¸€å¥)
        quizReport.push({
            q: target,
            u: val,
            res: isCorrect
        });

        // 3. æ¨é€²ä¸‹ä¸€å¥ (ä¸ç®¡å°éŒ¯éƒ½ç¹¼çºŒ!)
        currentSubIndex++;

        // 4. åˆ¤æ–·è©²é¡Œæ˜¯å¦çµæŸ
        if(currentSubIndex < currentTargetSentences.length) {
            // é‚„æœ‰ä¸‹ä¸€å¥ -> ç¹¼çºŒ
            updateSubInterface(false);
        } else {
            // è©²é¡ŒçµæŸ
            inputEl.disabled = true;
            document.getElementById('btn-submit').style.display = 'none';
            document.getElementById('btn-next-q').style.display = 'block';
            document.getElementById('sub-progress-indicator').innerText = "âœ… æœ¬é¡Œå°è©±çµæŸ";
            
            // å¦‚æœé€™ä¸æ˜¯æœ€å¾Œä¸€é¡Œï¼Œè‡ªå‹•è·³ä¸‹ä¸€é¡Œ (å¯é¸ï¼Œé€™è£¡è¨­ç‚ºæ‰‹å‹•æŒ‰æˆ–è‡ªå‹•å»¶é²)
            setTimeout(() => {
                if(currentQIndex < currentQuizList.length - 1) {
                    finishCurrentQuestionAndNext();
                } else {
                    // æœ€å¾Œä¸€é¡Œï¼Œåœåœ¨ç•«é¢ä¸Šè®“ä½¿ç”¨è€…çœ‹çµæœï¼ŒæŒ‰æŒ‰éˆ•æ‰çµæŸ
                    document.getElementById('btn-next-q').innerText = "æŸ¥çœ‹æˆç¸¾ ğŸ";
                }
            }, 1500);
        }
    }

    function addBubble(text, type, status='') {
        const box = document.getElementById('dialogue-box');
        const div = document.createElement('div');
        div.className = `chat-bubble ${type} ${status}`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
    }

    function finishCurrentQuestionAndNext() {
        if(currentQIndex < currentQuizList.length - 1) {
            currentQIndex++;
            loadQuestion(false);
        } else {
            finishQuiz();
        }
    }

    function provideHint() {
        const t = currentTargetSentences[currentSubIndex];
        const inp = document.getElementById('user-input');
        let now = inp.value;
        if(t.toLowerCase().startsWith(now.toLowerCase())) {
            inp.value = t.substring(0, now.length + 1);
        } else {
            inp.value = t.substring(0, 1);
        }
        inp.focus();
    }

    // --- çµç®—èˆ‡å…¶ä»– ---
    function finishQuiz() {
        clearInterval(timerInterval);
        showPage('page-result');
        if(score > 100) score = 100;
        document.getElementById('final-score').innerText = score;
        
        let tStr = document.getElementById('q-timer').innerText;
        document.getElementById('final-stats').innerText = `è€—æ™‚: ${tStr}`;
        
        // çå‹µè¨ˆç®—
        const list = allLists.find(l=>l.id===currentListId);
        const pass = list.passScore || 80;
        const div = document.getElementById('reward-area');
        div.innerHTML = '';
        
        if(score >= pass) {
            let earn = list.gems || 5;
            totalGems += earn;
            saveData();
            div.innerHTML = `<div style="color:#e67e22; font-weight:bold; font-size:1.2rem;">ğŸ† æ­å–œé€šé—œï¼ç²å¾— ${earn} å¯¶çŸ³</div>`;
            triggerParticles();
        } else {
            div.innerHTML = `<div style="color:#7f8c8d;">æœªé”åŠæ ¼åˆ† (${pass})ï¼Œå†æ¥å†å²ï¼</div>`;
        }

        // è©³æƒ…è¡¨æ ¼
        const tb = document.getElementById('detail-tbody');
        tb.innerHTML = '';
        quizReport.forEach(r => {
            let row = `<tr>
                <td style="padding:5px; border-bottom:1px solid #eee; width:30px;">${r.res?'â­•':'âŒ'}</td>
                <td style="padding:5px; border-bottom:1px solid #eee;">
                    <div style="color:#555; font-size:0.85rem;">é¡Œç›®: ${r.q}</div>
                    <div style="font-weight:bold; color:${r.res?'green':'red'}">å›ç­”: ${r.u}</div>
                </td>
            </tr>`;
            tb.innerHTML += row;
        });

        // ç´€éŒ„æ­·å²
        historyLog.unshift({
            title: list.name,
            score: score,
            date: new Date().toLocaleString(),
            time: tStr
        });
        saveData();
    }

    // --- ç·¨è¼¯å™¨é‚è¼¯ ---
    function createNewList() {
        editingListId = null;
        document.getElementById('list-name-input').value = "";
        document.getElementById('editor-rows').innerHTML = "";
        addEditRow(); addEditRow();
        showPage('page-editor');
    }
    
    let editingListId = null;
    function editList(idx) {
        editingListId = idx;
        const l = allLists[idx];
        document.getElementById('list-name-input').value = l.name;
        document.getElementById('list-gems').value = l.gems;
        document.getElementById('list-pass-score').value = l.passScore;
        const con = document.getElementById('editor-rows');
        con.innerHTML = '';
        l.words.forEach(w => {
            let txt = (w.sentences || [w.word]).join('\n');
            addEditRow(txt, w.img);
        });
        showPage('page-editor');
    }

    function addEditRow(txt='', img='') {
        const d = document.createElement('div');
        d.className = 'edit-row';
        let imgDisplay = img ? (img.length>10 ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover;">` : img) : 'ğŸ“·';
        
        d.innerHTML = `
            <div class="thumb-preview" onclick="this.nextElementSibling.click()">${imgDisplay}</div>
            <input type="file" class="file-input" accept="image/*" onchange="handleFile(this)">
            <input type="hidden" class="img-val" value="${img}">
            <textarea class="txt-val" placeholder="è¼¸å…¥å¥å­ (æ›è¡Œå¯å»ºç«‹å¤šå¥å°è©±)">${txt}</textarea>
            <button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('editor-rows').appendChild(d);
    }
    
    function handleFile(inp) {
        if(inp.files && inp.files[0]){
            let fr = new FileReader();
            fr.onload = (e) => {
                // å£“ç¸®åœ–ç‰‡
                let img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    let cvs = document.createElement('canvas');
                    let ctx = cvs.getContext('2d');
                    let scale = 200/img.width;
                    cvs.width = 200; cvs.height = img.height*scale;
                    ctx.drawImage(img,0,0,cvs.width,cvs.height);
                    let base64 = cvs.toDataURL('image/jpeg', 0.6);
                    inp.previousElementSibling.innerHTML = `<img src="${base64}" style="width:100%;height:100%;object-fit:cover;">`;
                    inp.nextElementSibling.value = base64;
                }
            };
            fr.readAsDataURL(inp.files[0]);
        }
    }

    function saveList() {
        const name = document.getElementById('list-name-input').value;
        if(!name) return alert('è«‹è¼¸å…¥é¡Œåº«åç¨±');
        
        const rows = document.querySelectorAll('.edit-row');
        let words = [];
        rows.forEach(r => {
            let raw = r.querySelector('.txt-val').value;
            let img = r.querySelector('.img-val').value;
            let sents = raw.split('\n').map(s=>s.trim()).filter(s=>s);
            if(sents.length > 0) {
                words.push({ sentences: sents, img: img || 'â“' });
            }
        });
        
        if(words.length === 0) return alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é¡Œ');
        
        const newItem = {
            id: editingListId!==null ? allLists[editingListId].id : Date.now().toString(),
            name: name,
            gems: parseInt(document.getElementById('list-gems').value),
            passScore: parseInt(document.getElementById('list-pass-score').value),
            words: words
        };
        
        if(editingListId!==null) allLists[editingListId] = newItem;
        else allLists.push(newItem);
        
        saveData();
        showPage('page-home');
    }

    function renderLists() {
        const c = document.getElementById('lists-container');
        c.innerHTML = '';
        allLists.forEach((l, i) => {
            let div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:1.1rem;">${l.name}</div>
                    <div style="font-size:0.85rem; color:#666;">
                        é¡Œç›®: ${l.words.length} | ğŸ’ ${l.gems} | åŠæ ¼: ${l.passScore}
                    </div>
                </div>
                <div>
                    <button class="btn-primary" onclick="startQuizSetup(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="deleteList(${i})">åˆª</button>
                </div>
            `;
            c.appendChild(div);
        });
    }
    
    function deleteList(i) {
        if(confirm('ç¢ºå®šåˆªé™¤?')) { allLists.splice(i,1); saveData(); renderLists(); }
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function speak(txt, lang='en-US', rate=0.9) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(txt);
            u.lang = lang; u.rate = rate;
            window.speechSynthesis.speak(u);
        }
    }
    
    function triggerParticles() {
        const c = document.getElementById('particle-container');
        c.style.display = 'block'; c.innerHTML = '';
        for(let i=0; i<30; i++) {
            let p = document.createElement('div');
            p.innerText = Math.random()>0.5 ? 'ğŸ’' : 'ğŸ‘‘';
            p.className = 'particle';
            p.style.left = Math.random()*100+'vw';
            p.style.animationDuration = (1+Math.random()*2)+'s';
            c.appendChild(p);
        }
        setTimeout(()=>{c.style.display='none'}, 3000);
    }
    
    function renderHistory() {
        const c = document.getElementById('history-container');
        c.innerHTML = historyLog.map(h => 
            `<div class="list-item" style="justify-content:space-between">
                <div>
                    <div style="font-weight:bold">${h.title}</div>
                    <div style="font-size:0.8rem; color:#777">${h.date}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:1.2rem; font-weight:bold; color:var(--primary)">${h.score}åˆ†</div>
                    <div style="font-size:0.8rem;">${h.time}</div>
                </div>
            </div>`
        ).join('') || '<div style="text-align:center; padding:10px; color:#999">å°šç„¡ç´€éŒ„</div>';
    }
    
    function clearAllHistory() {
        if(confirm('æ¸…ç©ºæ‰€æœ‰ç´€éŒ„?')) { historyLog=[]; saveData(); renderHistory(); }
    }
    
    function quitQuiz() {
        clearInterval(timerInterval);
        if(confirm('ç¢ºå®šé€€å‡º?')) showPage('page-home');
        else timerInterval = setInterval(()=>{ /* resume timer */ }, 1000);
    }
    
    // åŒ¯å‡ºåŒ¯å…¥
    function exportSelectedData() {
        const data = JSON.stringify({lists:allLists, student:{name:studentName, gems:totalGems}});
        const blob = new Blob([data], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'sentence_backup.json';
        a.click();
    }
    function handleImportData(inp) {
        if(!inp.files[0]) return;
        let fr = new FileReader();
        fr.onload = (e) => {
            try {
                let d = JSON.parse(e.target.result);
                if(d.lists) {
                    allLists = d.lists;
                    if(d.student && confirm('æ˜¯å¦é‚„åŸå­¸å“¡è³‡æ–™(å§“å/å¯¶çŸ³)?')) {
                        studentName = d.student.name;
                        totalGems = d.student.gems;
                    }
                    saveData(); renderLists(); alert('åŒ¯å…¥æˆåŠŸ');
                }
            } catch(e) { alert('æ ¼å¼éŒ¯èª¤'); }
        };
        fr.readAsText(inp.files[0]);
    }
    
    // å•†åº—é‚è¼¯
    function processExchange() {
        let name = document.getElementById('gift-name').value;
        let cost = parseInt(document.getElementById('gift-cost').value);
        let cur = document.getElementById('gift-currency').value;
        let realCost = cur==='crowns' ? cost*100 : cost;
        
        if(!name || isNaN(cost)) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        if(totalGems < realCost) return alert('é¤˜é¡ä¸è¶³');
        
        if(confirm(`ç¢ºèªå…Œæ› ${name}?`)) {
            totalGems -= realCost;
            exchangeLog.unshift({item:name, cost:`${cost} ${cur==='crowns'?'ğŸ‘‘':'ğŸ’'}`, date:new Date().toLocaleString()});
            saveData();
            renderExchangeLog();
            alert('å…Œæ›æˆåŠŸ!');
        }
    }
    
    function renderExchangeLog() {
        document.getElementById('exchange-log').innerHTML = exchangeLog.map(l => 
            `<div style="border-bottom:1px solid #eee; padding:5px; display:flex; justify-content:space-between;">
                <span>${l.item}</span> <span style="font-weight:bold;">-${l.cost}</span>
             </div>`
        ).join('');
    }

</script>
</body>
</html>
