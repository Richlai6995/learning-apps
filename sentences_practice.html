<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentence Builder v5.2 (iPad å‹å–„ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4834d4;
            --secondary: #686de0;
            --dark: #130f40;
            --light: #fdfdfd;
            --bg-page: #dff9fb;
            --rank-1: #FFD700;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-page);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation; 
            overflow-x: hidden;
            overflow-y: auto; 
        }

        h1, h2 { margin: 5px 0; color: var(--dark); text-align: center; }

        .container {
            width: 100%; max-width: 650px; background: white; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box;
            margin-bottom: 20px; display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        button {
            border: none; border-radius: 8px; padding: 8px 12px; font-size: 0.95rem;
            font-weight: bold; cursor: pointer; transition: transform 0.1s;
            color: white; margin: 2px; touch-action: manipulation;
        }
        button:active { transform: scale(0.95); }
        
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-accent { background-color: #f0932b; }
        .btn-gray { background-color: #95a5a6; }
        .btn-danger { background-color: #eb4d4b; }
        .btn-success { background-color: #2ed573; }
        .btn-gold { background-color: #f1c40f; color: #333; }
        .btn-block { width: 100%; margin: 5px 0; padding: 12px; font-size: 1.1rem; }
        .btn-hint { background-color: #2ed573; color: white; } 

        .list-item {
            background: #f8f9fa; border: 1px solid #e9ecef; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; display: flex; align-items: center; gap: 10px;
        }

        .rank-item { display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
        .rank-num { font-size: 1.5rem; font-weight: 900; width: 40px; text-align: center; margin-right: 10px; color: #7f8c8d; }
        .rank-item.rank-1 { background: linear-gradient(to right, #fff, #fff9c4); border: 2px solid var(--rank-1); }
        .rank-item.rank-1 .rank-num { color: #d4ac0d; font-size: 2rem; }
        
        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; color: #7f8c8d; margin-bottom: 10px; background: #f1f2f6; padding: 10px; border-radius: 8px; }
        
        .q-image-box { 
            height: 220px; 
            display: flex; justify-content: center; align-items: center; margin-bottom: 15px; overflow: hidden;
            background: #fcfcfc; border: 1px dashed #ddd; border-radius: 8px;
            position: relative;
            cursor: zoom-in; 
        }
        .q-image-box img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .zoom-hint { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; pointer-events: none;}

        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s;
        }
        .modal-toolbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 10002;
            background: rgba(255,255,255,0.2); padding: 10px; border-radius: 30px;
            backdrop-filter: blur(5px);
        }
        .tool-btn {
            background: rgba(0,0,0,0.6); color: white; border: 1px solid #fff;
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .close-btn { position: fixed; top: 20px; right: 20px; z-index: 10002; background: rgba(255,0,0,0.6); width: 40px; height: 40px; }
        .modal-img-container { width: 100%; height: 100%; overflow: auto; display: flex; justify-content: center; align-items: center; }
        .modal-content { max-width: 90%; max-height: 90%; transition: transform 0.2s ease-out; transform-origin: center center; }

        .answer-stack { display: flex; flex-direction: column; gap: 8px; width: 100%; margin-bottom: 15px; }
        .history-block {
            padding: 12px 15px; border-radius: 10px; font-size: 1.1rem; position: relative;
            animation: slideUp 0.3s ease-out; border: 2px solid transparent;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .history-block.correct { background-color: #d1fae5; border-color: #a7f3d0; color: #065f46; }
        .history-block.correct::after { content: "âœ…"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; }
        .history-block.wrong { background-color: #fee2e2; border-color: #fecaca; color: #991b1b; }
        .history-block.wrong::after { content: "âŒ"; position: absolute; right: 10px; top: 12px; font-size: 1.2rem; }

        .correction-text { display: block; margin-top: 5px; font-size: 0.9rem; color: #666; background: rgba(255,255,255,0.6); padding: 4px 8px; border-radius: 6px; font-weight: bold; }

        .sentence-input {
            width: 100%; font-size: 1.2rem; padding: 12px; border: 2px solid #ccc;
            border-radius: 12px; font-family: 'Segoe UI', sans-serif; box-sizing: border-box;
            outline: none; transition: border-color 0.3s; text-align: left; padding-left: 15px;
        }
        .sentence-input:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(72, 52, 212, 0.3); }

        .edit-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 15px; background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .edit-top-row { display: flex; gap: 10px; align-items: flex-start; }
        .edit-row textarea { 
            padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; 
            font-family: inherit; font-size: 1rem; resize: vertical; min-height: 80px;
        }
        .thumb-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; background: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .file-input { display: none; }
        
        .editor-header-group { display: flex; gap: 10px; margin-top: 5px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; flex-wrap: wrap;}
        .editor-input-label { display: flex; flex-direction: column; flex: 1; min-width: 100px;}
        .editor-input-label span { font-size: 0.85rem; color: #666; font-weight: bold; margin-bottom: 3px; }
        .editor-input-label input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; text-align: center; }
        
        .toggle-switch-label { display: flex; align-items: center; justify-content: center; height: 100%; cursor: pointer;}
        .toggle-switch-label input { width: 20px; height: 20px; margin-right: 5px; }

        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; display: none; }
        .particle { position: absolute; font-size: 2rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #999; font-weight: bold; border-bottom: 2px solid #eee;}
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tabs { display: flex; margin-bottom: 15px; }

    </style>
</head>
<body>

    <div id="particle-container"></div>
    
    <div id="img-modal" class="modal">
        <button class="tool-btn close-btn" onclick="closeModal()">Ã—</button>
        <div class="modal-img-container" id="modal-container">
            <img class="modal-content" id="modal-img">
        </div>
        <div class="modal-toolbar">
            <button class="tool-btn" onclick="zoomImage(0.2)">â•</button>
            <button class="tool-btn" onclick="zoomImage(-0.2)">â–</button>
            <button class="tool-btn" onclick="resetZoom()">â†º</button>
        </div>
    </div>

    <div id="page-home" class="container active">
        <h1>ğŸ“ å¥å­é—–é—œç‹ v5.2</h1>
        
        <div style="background:#e056fd15; border:2px dashed #686de0; border-radius:10px; padding:10px; margin-bottom:15px; text-align:center;">
            <div style="font-size:1.2rem; font-weight:bold; color:#4834d4;">
                <span id="display-student-name">å­¸å“¡</span>
                <button class="btn-outline" style="border:1px solid #999; border-radius:4px; padding:2px 5px;" onclick="changeStudentName()">âœ</button>
            </div>
            <div style="margin-top:5px;">
                ğŸ‘‘ <span id="stat-crowns">0</span> &nbsp;|&nbsp; ğŸ’ <span id="stat-gems">0</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¡Œåº«é¸æ“‡</div>
            <div class="tab" onclick="switchTab('history')">ç·´ç¿’ç´€éŒ„</div>
        </div>

        <div id="tab-quiz-content">
            <button class="btn-accent btn-block" style="margin-bottom:10px;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢è‡ªè¨‚é¡Œåº«</button>
            
            <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                <button class="btn-link" style="width:100%" onclick="exportSelectedData()">ğŸ“¤ å‚™ä»½è³‡æ–™</button>
                <input type="file" id="import-file" class="file-input" accept=".json" onchange="handleImportData(this)">
                <button class="btn-link" style="width:100%; margin-top:5px;" onclick="document.getElementById('import-file').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
            </div>
        </div>

        <div id="tab-history-content" style="display:none;">
            <div id="history-container"></div>
            <button class="btn-gray btn-block" onclick="clearAllHistory()">æ¸…ç©ºç´€éŒ„</button>
        </div>
        <div style="text-align:center; color:#ccc; margin-top:20px; font-size:0.8rem;">ç‰ˆæœ¬ v5.2 (iPad å¼•è™Ÿä¿®æ­£ç‰ˆ)</div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-progress">é¡Œè™Ÿ: 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-score">å¾—åˆ†: 0</span>
        </div>
        
        <div class="q-image-box" id="q-image-box" onclick="openModal(this)"></div>
        
        <div id="answer-stack" class="answer-stack"></div>

        <div class="progress-indicator" id="sub-progress-indicator">ç­‰å¾…é–‹å§‹...</div>

        <div class="input-wrapper">
            <input type="text" id="user-input" class="sentence-input" 
                   placeholder="è«‹è¼¸å…¥è½åˆ°çš„å¥å­..." 
                   autocomplete="off" 
                   spellcheck="false" 
                   autocorrect="off" 
                   autocapitalize="off">
        </div>

        <div style="display: flex; gap: 5px; margin-bottom:10px; flex-wrap:wrap;">
            <button class="btn-secondary" style="flex:1" onclick="playTargetAudio()">ğŸ”Š é‡è½é¡Œç›®</button>
            <button class="btn-secondary" style="flex:1" onclick="speakUserInput()">ğŸ‘‚ æœ—è®€æˆ‘çš„è¼¸å…¥</button>
            <button id="btn-hint" class="btn-hint" style="flex:1" onclick="provideHint()">ğŸ’¡ æç¤º</button>
        </div>

        <button id="btn-submit" class="btn-primary btn-block" onclick="checkAnswer()">é€å‡º (Enter)</button>
        <button id="btn-next-q" class="btn-success btn-block" style="display:none;" onclick="finishCurrentQuestionAndNext()">ä¸‹ä¸€é¡Œ â”</button>
        
        <button class="btn-gray btn-block" style="margin-top:10px;" onclick="quitQuiz()">é€€å‡ºç·´ç¿’</button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:10px;">
            <label style="font-weight:bold; color:#555;">é¡Œåº«åç¨±</label>
            <input type="text" id="list-name-input" placeholder="ä¾‹å¦‚: ç¬¬ä¸‰èª² å–®å­—èˆ‡å°è©±" style="padding:10px; width:100%; box-sizing:border-box; margin-bottom:5px; border-radius:5px; border:1px solid #ccc;">
            
            <div class="editor-header-group">
                <div class="editor-input-label">
                    <span>ğŸ’ çå‹µå¯¶çŸ³</span>
                    <input type="number" id="list-gems" placeholder="5" value="5">
                </div>
                <div class="editor-input-label">
                    <span>ğŸ¯ åŠæ ¼åˆ†æ•¸</span>
                    <input type="number" id="list-pass-score" placeholder="100" value="100">
                </div>
                <div class="editor-input-label" style="background:#f0f9ff; border-radius:5px; border:1px solid #bae6fd;">
                    <label class="toggle-switch-label">
                        <input type="checkbox" id="list-allow-hints" checked>
                        <span style="color:#0284c7;">å…è¨±ä½¿ç”¨æç¤º</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div style="background:#e8f0fe; padding:8px; font-size:0.9rem; margin-bottom:10px; color:#2c3e50; border-radius:5px;">
            ğŸ’¡ <strong>èªªæ˜ï¼š</strong>æ¨™é»ç¬¦è™Ÿéœ€åš´æ ¼ä¸€è‡´ (ä¾‹å¦‚å¥è™Ÿ)ã€‚<br>
            ç³»çµ±æœƒè‡ªå‹•è™•ç† iPad çš„å½å¼•è™Ÿ (â€™) å•é¡Œã€‚
        </div>
        
        <div id="editor-rows"></div>
        <button class="btn-gray" onclick="addEditRow()">+ å¢åŠ é¡Œç›®</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align:center;">
            <h2>ğŸ‰ ç·´ç¿’å®Œæˆï¼</h2>
            <div style="font-size:4rem; color:var(--primary); font-weight:bold;" id="final-score">100</div>
            <div id="final-stats"></div>
            <div id="reward-area" style="margin:15px 0;"></div>
            
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; text-align:left; font-size:0.9rem;">
                <table style="width:100%; border-collapse:collapse;">
                    <tbody id="detail-tbody"></tbody>
                </table>
            </div>
            <button class="btn-primary btn-block" style="margin-top:15px;" onclick="showPage('page-home')">å›åˆ°é¦–é </button>
        </div>
    </div>

    <div id="page-leaderboard" class="container">
        <h2 id="lb-title">ğŸ† è‹±é›„æ¦œ</h2>
        <div id="lb-container" class="rank-list"></div>
        <button class="btn-primary btn-block" onclick="showPage('page-home')">é—œé–‰æ¦œå–®</button>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå•†åº—</h2>
        <div style="background:linear-gradient(135deg, #667eea, #764ba2); color:white; padding:15px; border-radius:10px; text-align:center; margin-bottom:15px;">
            æŒæœ‰: ğŸ‘‘ <span id="shop-crowns">0</span> | ğŸ’ <span id="shop-gems">0</span>
        </div>
        <input type="text" id="gift-name" class="sentence-input" placeholder="çå“åç¨±" style="margin-bottom:5px;">
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="number" id="gift-cost" class="sentence-input" placeholder="èŠ±è²»" style="flex:1">
            <select id="gift-currency" style="padding:5px; flex:1; border-radius:8px;">
                <option value="gems">ğŸ’ å¯¶çŸ³</option>
                <option value="crowns">ğŸ‘‘ çš‡å† </option>
            </select>
        </div>
        <button class="btn-primary btn-block" onclick="processExchange()">å…Œæ›</button>
        <div id="exchange-log" style="margin-top:15px; font-size:0.9rem; color:#666; max-height:150px; overflow-y:auto;"></div>
        <button class="btn-gray btn-block" style="margin-top:10px;" onclick="showPage('page-home')">è¿”å›</button>
    </div>

<script>
    // --- è³‡æ–™çµæ§‹ ---
    const DEFAULT_LIST = {
        id: 'default_conv',
        name: 'ç¯„ä¾‹ï¼šæ—¥å¸¸å°è©±',
        gems: 10,
        passScore: 80,
        allowHints: true, 
        words: [
            {sentences: ['You\'re a student.', 'Yes, I am.'], img: 'ğŸ‘‹'}, 
            {sentences: ['What time is it?', 'It is three o\'clock.'], img: 'â°'}
        ]
    };

    let allLists = [];
    let studentName = "å­¸å“¡";
    let totalGems = 0;
    let historyLog = [];
    let exchangeLog = [];

    // æ¸¬é©—è®Šæ•¸
    let currentQuizList = [];
    let currentListId = null;
    let currentQIndex = 0; 
    let currentSubIndex = 0; 
    let currentTargetSentences = [];
    let currentAllowHints = true; 
    let score = 0;
    let timerInterval, startTime;
    let quizReport = [];

    // ç¸®æ”¾è®Šæ•¸
    let currentZoom = 1;

    window.onload = function() {
        loadData();
        renderLists();
        updateProfile();
        
        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                if(document.getElementById('btn-submit').style.display !== 'none'){
                    checkAnswer();
                } else if(document.getElementById('btn-next-q').style.display !== 'none') {
                    finishCurrentQuestionAndNext();
                }
            }
        });

        const modalImg = document.getElementById('modal-img');
        modalImg.addEventListener('wheel', function(e) {
            e.preventDefault();
            if (e.deltaY < 0) zoomImage(0.1);
            else zoomImage(-0.1);
        });
    };

    // --- åœ–ç‰‡ç¸®æ”¾é‚è¼¯ ---
    function openModal(box) {
        const img = box.querySelector('img');
        if(!img) return; 
        const modal = document.getElementById('img-modal');
        const modalImg = document.getElementById('modal-img');
        modal.style.display = "block";
        modalImg.src = img.src;
        resetZoom();
    }
    
    function closeModal() {
        document.getElementById('img-modal').style.display = "none";
    }

    function zoomImage(delta) {
        currentZoom += delta;
        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 5) currentZoom = 5;
        updateZoomTransform();
    }

    function resetZoom() {
        currentZoom = 1;
        updateZoomTransform();
    }

    function updateZoomTransform() {
        const img = document.getElementById('modal-img');
        img.style.transform = `scale(${currentZoom})`;
        const container = document.getElementById('modal-container');
        if (currentZoom > 1) {
            container.style.overflow = 'auto';
            img.style.cursor = 'grab';
        } else {
            container.style.overflow = 'hidden';
            img.style.cursor = 'default';
        }
    }

    // --- åŸºç¤é‚è¼¯ ---
    function loadData() {
        allLists = JSON.parse(localStorage.getItem('sb_lists_v52') || JSON.stringify([DEFAULT_LIST]));
        studentName = localStorage.getItem('sb_name_v52') || "å­¸å“¡";
        totalGems = parseInt(localStorage.getItem('sb_gems_v52') || 0);
        historyLog = JSON.parse(localStorage.getItem('sb_hist_v52') || '[]');
        exchangeLog = JSON.parse(localStorage.getItem('sb_ex_v52') || '[]');
    }

    function saveData() {
        localStorage.setItem('sb_lists_v52', JSON.stringify(allLists));
        localStorage.setItem('sb_name_v52', studentName);
        localStorage.setItem('sb_gems_v52', totalGems);
        localStorage.setItem('sb_hist_v52', JSON.stringify(historyLog));
        localStorage.setItem('sb_ex_v52', JSON.stringify(exchangeLog));
        updateProfile();
    }

    function updateProfile() {
        document.getElementById('display-student-name').innerText = studentName;
        document.getElementById('stat-crowns').innerText = Math.floor(totalGems / 100);
        document.getElementById('stat-gems').innerText = totalGems % 100;
        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = Math.floor(totalGems / 100);
            document.getElementById('shop-gems').innerText = totalGems % 100;
        }
    }
    
    function changeStudentName() {
        let n = prompt("è¼¸å…¥å§“å:", studentName);
        if(n && n.trim()){ studentName = n.trim(); saveData(); }
    }

    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') { renderLists(); renderHistory(); }
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
    }
    
    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-quiz-content').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-history-content').style.display = t==='history'?'block':'none';
    }

    // --- æ¸¬é©—æ ¸å¿ƒé‚è¼¯ ---
    function startQuizSetup(idx) {
        const list = allLists[idx];
        currentListId = list.id;
        currentAllowHints = (list.allowHints !== undefined) ? list.allowHints : true;
        
        let shuffled = [...list.words].sort(()=>0.5-Math.random());
        currentQuizList = shuffled.slice(0, 10);
        
        currentQIndex = 0;
        score = 0;
        quizReport = [];
        startTime = Date.now();
        timerInterval = setInterval(()=>{
            let s = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
        }, 1000);

        showPage('page-quiz');
        loadQuestion(true);
    }

    function loadQuestion(first) {
        let q = currentQuizList[currentQIndex];
        currentTargetSentences = q.sentences || [q.word];
        currentSubIndex = 0;
        
        document.getElementById('q-progress').innerText = `é¡Œè™Ÿ: ${currentQIndex+1}/${currentQuizList.length}`;
        document.getElementById('q-score').innerText = `å¾—åˆ†: ${score}`;
        
        // åœ–ç‰‡
        const ib = document.getElementById('q-image-box');
        if (q.img && q.img.length > 10) {
            ib.innerHTML = `<img src="${q.img}"><div class="zoom-hint">ğŸ” é»æ“Šæ”¾å¤§/ç¸®æ”¾</div>`;
            ib.style.cursor = "zoom-in";
            ib.onclick = function() { openModal(this); };
        } else {
            ib.innerHTML = `<span>${q.img}</span>`;
            ib.style.cursor = "default";
            ib.onclick = null;
        }
        
        // æ§åˆ¶æç¤ºæŒ‰éˆ•é¡¯ç¤º
        const hintBtn = document.getElementById('btn-hint');
        if(currentAllowHints) {
            hintBtn.style.display = 'block';
        } else {
            hintBtn.style.display = 'none';
        }
        
        document.getElementById('answer-stack').innerHTML = ''; 
        document.getElementById('user-input').disabled = false;
        document.getElementById('user-input').focus();
        document.getElementById('btn-submit').style.display = 'block';
        document.getElementById('btn-next-q').style.display = 'none';

        updateSubInterface(first);
    }

    function updateSubInterface(first) {
        document.getElementById('sub-progress-indicator').innerText = 
            `å¥å­ ${currentSubIndex + 1} / ${currentTargetSentences.length}`;
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
        setTimeout(() => playTargetAudio(), first ? 1500 : 800);
    }

    function playTargetAudio() {
        if(currentSubIndex < currentTargetSentences.length) {
            speak(currentTargetSentences[currentSubIndex], 'en-US');
        }
    }
    
    function speakUserInput() {
        const val = document.getElementById('user-input').value;
        if(val) speak(val, 'en-US');
        else speak("Please input something", 'en-US');
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šæ¨™æº–åŒ–å¼•è™Ÿ ---
    function standardizeText(str) {
        // å°‡ Unicode å·¦/å³å–®å¼•è™Ÿã€é‡éŸ³ç¬¦è™Ÿç­‰å…¨éƒ¨è½‰ç‚º ASCII ç›´æ’‡è™Ÿ (')
        return str.replace(/[\u2018\u2019`]/g, "'");
    }

    function checkAnswer() {
        const inputEl = document.getElementById('user-input');
        const val = inputEl.value.trim();
        if(!val) return;

        const target = currentTargetSentences[currentSubIndex].trim();
        
        // å…ˆæ¨™æº–åŒ–å¼•è™Ÿï¼Œå†é€²è¡Œæ¯”å°
        const normVal = standardizeText(val).toLowerCase();
        const normTarget = standardizeText(target).toLowerCase();

        const isCorrect = normVal === normTarget;
        
        createHistoryBlock(val, target, isCorrect);

        if (!isCorrect) {
            speak("Correct answer is " + target, 'en-US', 1.2); 
        } else {
            score += Math.round(100 / (currentQuizList.length * currentTargetSentences.length));
            speak("Correct!", 'en-US', 1.5);
        }

        quizReport.push({ q: target, u: val, res: isCorrect });

        currentSubIndex++;

        if(currentSubIndex < currentTargetSentences.length) {
            updateSubInterface(false);
        } else {
            inputEl.disabled = true;
            document.getElementById('btn-submit').style.display = 'none';
            document.getElementById('btn-next-q').style.display = 'block';
            document.getElementById('sub-progress-indicator').innerText = "âœ… æœ¬é¡Œå®Œæˆï¼Œè«‹æŒ‰ä¸‹ä¸€é¡Œ";
            
            if(currentQIndex < currentQuizList.length - 1) {
                document.getElementById('btn-next-q').innerText = "ä¸‹ä¸€é¡Œ â”";
            } else {
                document.getElementById('btn-next-q').innerText = "æŸ¥çœ‹æˆç¸¾ ğŸ";
            }
        }
    }

    function createHistoryBlock(userText, correctText, isCorrect) {
        const stack = document.getElementById('answer-stack');
        const block = document.createElement('div');
        block.className = isCorrect ? 'history-block correct' : 'history-block wrong';
        
        const userDiv = document.createElement('div');
        userDiv.innerText = userText;
        block.appendChild(userDiv);

        if(!isCorrect) {
            const corrDiv = document.createElement('div');
            corrDiv.className = 'correction-text';
            corrDiv.innerText = "æ­£ç¢º: " + correctText;
            block.appendChild(corrDiv);
        }
        stack.appendChild(block);
        
        setTimeout(() => {
            document.getElementById('user-input').scrollIntoView({behavior: "smooth", block: "center"});
        }, 100);
    }

    function finishCurrentQuestionAndNext() {
        if(currentQIndex < currentQuizList.length - 1) {
            currentQIndex++;
            loadQuestion(false);
        } else {
            finishQuiz();
        }
    }

    function provideHint() {
        if(!currentAllowHints) return;
        
        // å–å¾—æ¨™æº–åŒ–å¾Œçš„ç›®æ¨™èˆ‡ç›®å‰è¼¸å…¥
        const t = standardizeText(currentTargetSentences[currentSubIndex]);
        const inp = document.getElementById('user-input');
        
        let now = standardizeText(inp.value);
        
        // æç¤ºé‚è¼¯ä¹Ÿéœ€è¦å°å¼•è™Ÿå¯¬å®¹
        if(t.toLowerCase().startsWith(now.toLowerCase())) {
            // å¾åŸå§‹ç›®æ¨™å­—ä¸²æ“·å–ï¼Œç¢ºä¿æç¤ºçš„æ˜¯æ­£ç¢ºçš„æ¨™é»
            inp.value = t.substring(0, now.length + 1);
        } else {
            inp.value = t.substring(0, 1);
        }
        inp.focus();
    }

    // --- çµç®— ---
    function finishQuiz() {
        clearInterval(timerInterval);
        showPage('page-result');
        if(score > 100) score = 100;
        document.getElementById('final-score').innerText = score;
        
        let tStr = document.getElementById('q-timer').innerText;
        document.getElementById('final-stats').innerText = `è€—æ™‚: ${tStr}`;
        
        const list = allLists.find(l=>l.id===currentListId);
        const pass = list.passScore || 80;
        const div = document.getElementById('reward-area');
        div.innerHTML = '';
        
        if(score >= pass) {
            let earn = list.gems || 5;
            totalGems += earn;
            saveData();
            div.innerHTML = `<div style="color:#e67e22; font-weight:bold; font-size:1.2rem;">ğŸ† æ­å–œé€šé—œï¼ç²å¾— ${earn} å¯¶çŸ³</div>`;
            triggerParticles();
        } else {
            div.innerHTML = `<div style="color:#7f8c8d;">æœªé”åŠæ ¼åˆ† (${pass})ï¼Œå†æ¥å†å²ï¼</div>`;
        }

        const tb = document.getElementById('detail-tbody');
        tb.innerHTML = '';
        quizReport.forEach(r => {
            let row = `<tr>
                <td style="padding:5px; border-bottom:1px solid #eee; width:30px;">${r.res?'â­•':'âŒ'}</td>
                <td style="padding:5px; border-bottom:1px solid #eee;">
                    <div style="color:#555; font-size:0.85rem;">é¡Œç›®: ${r.q}</div>
                    <div style="font-weight:bold; color:${r.res?'green':'red'}">å›ç­”: ${r.u}</div>
                </td>
            </tr>`;
            tb.innerHTML += row;
        });

        historyLog.unshift({ title: list.name, score: score, date: new Date().toLocaleString(), time: tStr, listId: currentListId, user: studentName });
        saveData();
    }

    // --- è‹±é›„æ¦œ ---
    function showLeaderboard(listId, listName) {
        document.getElementById('lb-title').innerText = `ğŸ† ${listName} - è‹±é›„æ¦œ`;
        const container = document.getElementById('lb-container');
        container.innerHTML = '';
        
        let listLogs = historyLog.filter(log => log.listId === listId);
        listLogs.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return a.time.localeCompare(b.time);
        });
        
        if (listLogs.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°ï¼</p>';
        } else {
            listLogs.forEach((log, index) => {
                const rank = index + 1;
                let rankClass = '';
                let rankDisplay = rank;
                if (rank === 1) { rankClass = 'rank-1'; rankDisplay = 'ğŸ†'; }
                
                const div = document.createElement('div');
                div.className = `rank-item ${rankClass}`;
                div.innerHTML = `<div class="rank-num">${rankDisplay}</div>
                    <div style="flex:1">
                        <span style="font-weight:bold">${log.user}</span><br>
                        <span style="font-size:0.8rem;color:#777">${log.date}</span>
                    </div>
                    <div style="text-align:right">
                        <span style="font-size:1.2rem;font-weight:bold;color:#4834d4">${log.score}åˆ†</span><br>
                        <span style="font-size:0.8rem;color:#666">${log.time}</span>
                    </div>`;
                container.appendChild(div);
            });
        }
        showPage('page-leaderboard');
    }

    // --- ç·¨è¼¯å™¨ ---
    function createNewList() {
        editingListId = null;
        document.getElementById('list-name-input').value = "";
        document.getElementById('editor-rows').innerHTML = "";
        document.getElementById('list-allow-hints').checked = true;
        addEditRow(); addEditRow();
        showPage('page-editor');
    }
    
    let editingListId = null;
    function editList(idx) {
        editingListId = idx;
        const l = allLists[idx];
        document.getElementById('list-name-input').value = l.name;
        document.getElementById('list-gems').value = l.gems;
        document.getElementById('list-pass-score').value = l.passScore;
        document.getElementById('list-allow-hints').checked = (l.allowHints !== undefined) ? l.allowHints : true;
        
        const con = document.getElementById('editor-rows');
        con.innerHTML = '';
        l.words.forEach(w => {
            let txt = (w.sentences || [w.word]).join('\n');
            addEditRow(txt, w.img);
        });
        showPage('page-editor');
    }

    function addEditRow(txt='', img='') {
        const d = document.createElement('div');
        d.className = 'edit-row';
        let imgDisplay = img ? (img.length>10 ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover;">` : img) : 'ğŸ“·';
        
        d.innerHTML = `
            <div class="edit-top-row">
                <div class="thumb-preview" onclick="this.nextElementSibling.click()">${imgDisplay}</div>
                <input type="file" class="file-input" accept="image/*" onchange="handleFile(this)">
                <input type="hidden" class="img-val" value="${img}">
                
                <div style="display:flex; flex-direction:column; flex:1;">
                    <textarea class="txt-val" placeholder="è¼¸å…¥å¥å­ (æ›è¡Œå¯å»ºç«‹å¤šå¥å°è©±)">${txt}</textarea>
                </div>
            </div>
            <button class="btn-danger" style="align-self:flex-end; padding:4px 10px; font-size:0.8rem;" onclick="this.parentElement.remove()">åˆªé™¤æ­¤é¡Œ</button>
        `;
        document.getElementById('editor-rows').appendChild(d);
    }
    
    function handleFile(inp) {
        if(inp.files && inp.files[0]){
            let fr = new FileReader();
            fr.onload = (e) => {
                let img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    let cvs = document.createElement('canvas');
                    let ctx = cvs.getContext('2d');
                    let scale = 300/img.width;
                    cvs.width = 300; cvs.height = img.height*scale;
                    ctx.drawImage(img,0,0,cvs.width,cvs.height);
                    let base64 = cvs.toDataURL('image/jpeg', 0.65);
                    inp.previousElementSibling.innerHTML = `<img src="${base64}" style="width:100%;height:100%;object-fit:cover;">`;
                    inp.nextElementSibling.value = base64;
                }
            };
            fr.readAsDataURL(inp.files[0]);
        }
    }

    function saveList() {
        const name = document.getElementById('list-name-input').value;
        if(!name) return alert('è«‹è¼¸å…¥é¡Œåº«åç¨±');
        
        const rows = document.querySelectorAll('.edit-row');
        let words = [];
        rows.forEach(r => {
            let raw = r.querySelector('.txt-val').value;
            let img = r.querySelector('.img-val').value;
            let sents = raw.split('\n').map(s=>s.trim()).filter(s=>s);
            if(sents.length > 0) {
                words.push({ sentences: sents, img: img || 'â“' });
            }
        });
        
        if(words.length === 0) return alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é¡Œ');
        
        const newItem = {
            id: editingListId!==null ? allLists[editingListId].id : Date.now().toString(),
            name: name,
            gems: parseInt(document.getElementById('list-gems').value),
            passScore: parseInt(document.getElementById('list-pass-score').value),
            allowHints: document.getElementById('list-allow-hints').checked, 
            words: words
        };
        
        if(editingListId!==null) allLists[editingListId] = newItem;
        else allLists.push(newItem);
        
        saveData();
        showPage('page-home');
    }

    function renderLists() {
        const c = document.getElementById('lists-container');
        c.innerHTML = '';
        allLists.forEach((l, i) => {
            let div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:1.1rem;">${l.name}</div>
                    <div style="font-size:0.85rem; color:#666;">
                        é¡Œç›®: ${l.words.length} | ğŸ’ ${l.gems} | åŠæ ¼: ${l.passScore}
                    </div>
                </div>
                <div>
                    <button class="btn-gold" onclick="showLeaderboard('${l.id}', '${l.name}')">æ¦œå–®</button>
                    <button class="btn-primary" onclick="startQuizSetup(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="deleteList(${i})">åˆª</button>
                </div>
            `;
            c.appendChild(div);
        });
    }
    
    function deleteList(i) {
        if(confirm('ç¢ºå®šåˆªé™¤?')) { allLists.splice(i,1); saveData(); renderLists(); }
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function speak(txt, lang='en-US', rate=0.9) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(txt);
            u.lang = lang; u.rate = rate;
            window.speechSynthesis.speak(u);
        }
    }
    
    function triggerParticles() {
        const c = document.getElementById('particle-container');
        c.style.display = 'block'; c.innerHTML = '';
        for(let i=0; i<30; i++) {
            let p = document.createElement('div');
            p.innerText = Math.random()>0.5 ? 'ğŸ’' : 'ğŸ‘‘';
            p.className = 'particle';
            p.style.left = Math.random()*100+'vw';
            p.style.animationDuration = (1+Math.random()*2)+'s';
            c.appendChild(p);
        }
        setTimeout(()=>{c.style.display='none'}, 3000);
    }
    
    function clearAllHistory() {
        if(confirm('æ¸…ç©ºæ‰€æœ‰ç´€éŒ„?')) { historyLog=[]; saveData(); renderHistory(); }
    }
    
    function quitQuiz() {
        clearInterval(timerInterval);
        if(confirm('ç¢ºå®šé€€å‡º?')) showPage('page-home');
        else timerInterval = setInterval(()=>{ /* resume timer */ }, 1000);
    }
    
    function exportSelectedData() {
        const data = JSON.stringify({lists:allLists, student:{name:studentName, gems:totalGems}});
        const blob = new Blob([data], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'sentence_backup.json';
        a.click();
    }
    function handleImportData(inp) {
        if(!inp.files[0]) return;
        let fr = new FileReader();
        fr.onload = (e) => {
            try {
                let d = JSON.parse(e.target.result);
                if(d.lists) {
                    allLists = d.lists;
                    if(d.student && confirm('æ˜¯å¦é‚„åŸå­¸å“¡è³‡æ–™(å§“å/å¯¶çŸ³)?')) {
                        studentName = d.student.name;
                        totalGems = d.student.gems;
                    }
                    saveData(); renderLists(); alert('åŒ¯å…¥æˆåŠŸ');
                }
            } catch(e) { alert('æ ¼å¼éŒ¯èª¤'); }
        };
        fr.readAsText(inp.files[0]);
    }
    
    function processExchange() {
        let name = document.getElementById('gift-name').value;
        let cost = parseInt(document.getElementById('gift-cost').value);
        let cur = document.getElementById('gift-currency').value;
        let realCost = cur==='crowns' ? cost*100 : cost;
        
        if(!name || isNaN(cost)) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        if(totalGems < realCost) return alert('é¤˜é¡ä¸è¶³');
        
        if(confirm(`ç¢ºèªå…Œæ› ${name}?`)) {
            totalGems -= realCost;
            exchangeLog.unshift({item:name, cost:`${cost} ${cur==='crowns'?'ğŸ‘‘':'ğŸ’'}`, date:new Date().toLocaleString()});
            saveData();
            renderExchangeLog();
            alert('å…Œæ›æˆåŠŸ!');
        }
    }
    
    function renderExchangeLog() {
        document.getElementById('exchange-log').innerHTML = exchangeLog.map(l => 
            `<div style="border-bottom:1px solid #eee; padding:5px; display:flex; justify-content:space-between;">
                <span>${l.item}</span> <span style="font-weight:bold;">-${l.cost}</span>
             </div>`
        ).join('');
    }

</script>
</body>
</html>
