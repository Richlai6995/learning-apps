<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å‰‡é‹ç®—æ‡‰ç”¨é¡Œç·´ç¿’ç³»çµ±</title>
    <style>
        :root {
            --primary: #2980b9;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --highlight: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0 0 0; text-align: center; font-size: 1.8rem;}
        .app-version { font-size: 0.8rem; color: #7f8c8d; margin-bottom: 15px; }

        /* --- å­¸å“¡åç‰Œ & çå‹µ --- */
        .user-profile {
            background-color: #fff3cd;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: #d35400;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            justify-content: center;
        }
        .user-profile:active { transform: scale(0.98); }
        
        .stats-badge {
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px;
            color: #2c3e50;
        }

        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 6px; padding: 8px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 2px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-accent { background-color: #f39c12; }
        .btn-info { background-color: #17a2b8; }
        .btn-help { background-color: #e67e22; box-shadow: 0 4px #d35400; }
        .btn-help:active { box-shadow: 0 0 #d35400; transform: translateY(4px); }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; }
        
        .btn-next-level {
            background-color: #27ae60; color: white; font-size: 1.5rem; padding: 15px 30px;
            border-radius: 50px; box-shadow: 0 6px #1e8449; margin-top: 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none; 
        }
        .btn-next-level:active { transform: translateY(6px); box-shadow: 0 0 #1e8449; }
        @keyframes popIn { from {transform: scale(0);} to {transform: scale(1);} }

        /* --- åˆ—è¡¨èˆ‡æ¨™ç±¤ --- */
        .list-item {
            background: #eafaf1; border: 1px solid #d5f5e3; padding: 10px; margin-bottom: 8px;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
        }
        .gem-tag { color: #2980b9; font-weight: bold; background: #d6eaf8; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}
        .teach-gem-tag { color: #27ae60; font-weight: bold; background: #d5f5e3; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}

        /* --- ç·¨è¼¯å™¨ç›¸é—œ --- */
        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .editor-layout { grid-template-columns: 1fr; }
        }

        .editor-input-area {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;
            background: #f4f6f7; padding: 15px; border-radius: 8px;
        }
        .pool-area {
            background: #fff8e1; padding: 15px; border-radius: 8px; border: 2px solid #f39c12;
            max-height: 600px; display: flex; flex-direction: column;
        }
        .pool-list { overflow-y: auto; flex: 1; }
        .pool-item {
            background: white; border-bottom: 1px solid #ddd; padding: 8px; margin-bottom: 5px; cursor: pointer;
            border-radius: 4px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;
        }
        .pool-item:hover { background: #fdf2e9; }

        .editor-label { font-weight: bold; color: #555; margin-bottom: 2px; }
        .editor-textarea { 
            width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; 
            font-size: 1rem; resize: vertical; min-height: 60px;
        }
        
        .keypad {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px;
        }
        .keypad button {
            background: #fff; border: 1px solid #bdc3c7; color: #2c3e50; font-size: 1.2rem; padding: 10px;
            border-radius: 5px; box-shadow: 0 2px #ecf0f1;
        }
        .keypad button:active { transform: translateY(2px); box-shadow: none; }
        .keypad button.op-key { background: #d6eaf8; color: #2980b9; font-weight: bold; }
        
        .eq-row { 
            display: flex; flex-direction: column; 
            background: #fff; padding: 8px; border:1px solid #eee; margin-bottom: 5px; border-radius: 4px;
        }
        .eq-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;}
        .eq-desc { font-size: 0.9rem; color: #666; margin-bottom: 2px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;}
        .eq-text { font-family: monospace; font-size: 1.1rem; color: var(--primary); font-weight: bold;}

        /* --- æ¸¬é©—å€åŸŸ --- */
        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 6px; }
        
        /* æ‡‰ç”¨é¡Œé¡¯ç¤ºå€ */
        .problem-display {
            background: #fff; border: 2px solid #3498db; border-radius: 8px; padding: 15px;
            margin-bottom: 20px; text-align: left;
        }
        .problem-text { font-size: 1.2rem; margin-bottom: 10px; line-height: 1.6; }
        
        /* è§£é¡Œæ€è·¯éš±è—å€ */
        .problem-logic-container {
            margin-top: 10px;
        }
        .logic-content { 
            background: #fff8e1; color: #d35400; padding: 10px; border-radius: 5px; 
            font-size: 1rem; border-left: 4px solid #f39c12; margin-top: 5px; display: none;
        }

        #history-container {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            margin: 10px 0;
            width: 100%;
        }

        /* ä¿®æ”¹å¾Œçš„ç®—å¼æ¨£å¼ */
        .calc-row {
            font-family: 'Courier New', monospace;
            font-size: 2.0rem; 
            color: #27ae60;     /* éå»æ­¥é©Ÿï¼šç¶ è‰² */
            font-weight: bold;
            margin: 5px 0;
            padding: 5px 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        /* ç•¶å‰æ­¥é©Ÿçš„æ¨£å¼ */
        .calc-row.active {
            color: #2c3e50;     /* ç•¶å‰æ­¥é©Ÿï¼šæ·±è—/é»‘è‰² */
            background: #f8f9fa; /* ç•¶å‰æ­¥é©Ÿä¿ç•™èƒŒæ™¯è‰² */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .step-highlight {
            color: #e74c3c;
            background-color: #fceceb;
            border-radius: 4px;
            padding: 0 4px;
            font-weight: bold;
            border-bottom: 3px solid #e74c3c;
            display: inline-block;
        }

        .step-input-container {
            text-align: center; margin: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .game-input { 
            width: 90%; max-width: 300px; height: 50px; font-size: 1.5rem; text-align: center; 
            border: 3px solid var(--primary); border-radius: 8px; background: #fff; outline: none; margin-bottom: 10px;
        }
        .game-input.correct { border-color: #27ae60; background-color: #d5f5e3; color: #27ae60; }
        .game-input.wrong { background: #fadbd8; border-color: var(--danger); animation: shake 0.4s; }
        .game-input:focus { border-color: #2ecc71; background: #e8f8f5; box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }

        .help-box {
            background: #fff8e1; border-left: 5px solid #ffc107; padding: 10px; margin: 10px auto;
            border-radius: 5px; display: none; font-size: 1.1rem; text-align: left; max-width: 80%;
        }

        /* --- å•†åº—èˆ‡çå‹µ --- */
        .settings-panel {
            background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;
        }
        .settings-panel label { display: block; margin-bottom: 8px; cursor: pointer; font-size: 1.1rem; }
        .settings-panel input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; }

        .shop-balance {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            color: white; padding: 20px; border-radius: 15px; text-align: center;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .exchange-form { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .exchange-input { padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;}

        .reward-popup {
            background: #fff8e1; border: 3px solid #f1c40f; padding: 20px;
            border-radius: 15px; margin-top: 20px; font-weight: bold; color: #d35400;
            font-size: 1.3rem; text-align: center;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
            animation: bounceIn 0.8s;
        }

        /* ç²’å­å‹•ç•« */
        #particle-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden; display: none;
        }
        .particle {
            position: absolute; font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>â— å››å‰‡é‹ç®—æ‡‰ç”¨é¡Œç·´ç¿’</h1>
        <div class="app-version">v4.0 (ç¸½é¡Œåº«å„ªåŒ–ç‰ˆ)</div>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active">é¸æ“‡é¡Œåº«</div>
        </div>

        <div id="tab-quiz">
            <button class="btn-accent btn-block" style="margin-bottom:15px; box-shadow:0 4px #d35400;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ‰‹å‹•å»ºç«‹æ–°æ¸¬é©—å·</button>
            
            <button class="btn-info btn-block" onclick="document.getElementById('import-json-pool').click()">ğŸ“¥ åŒ¯å…¥é¡Œç›®åˆ°ç¸½é¡Œåº« (AI JSON)</button>
            <input type="file" id="import-json-pool" style="display:none" accept=".json" onchange="handleImportToPool(this)">

            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px; display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥å‚™ä»½</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        <div class="shop-balance">
            <h3>ç›®å‰æŒæœ‰</h3>
            <div style="display:flex; justify-content:center; gap:20px; font-size:1.5rem; font-weight:bold;">
                <span>ğŸ‘‘ <span id="shop-crowns">0</span></span>
                <span>ğŸ’ <span id="shop-gems">0</span></span>
            </div>
        </div>
        <div class="exchange-form">
            <input type="text" id="gift-name" class="exchange-input" placeholder="è¼¸å…¥çå“åç¨± (å¦‚: çœ‹é›»è¦–10åˆ†é˜)">
            <input type="number" id="gift-cost" class="exchange-input" placeholder="èŠ±è²»æ•¸é‡" min="1">
            <select id="gift-currency" class="exchange-input">
                <option value="gems">ğŸ’ å¯¶çŸ³</option>
                <option value="crowns">ğŸ‘‘ çš‡å† </option>
            </select>
            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>
        <div style="margin-top:20px;">
            <h4>ğŸ“œ å…Œæ›ç´€éŒ„</h4>
            <div id="exchange-log" style="max-height:150px; overflow-y:auto; font-size:0.9rem; color:#666;"></div>
        </div>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-editor" class="container" style="max-width: 1000px;">
        <h2>âœï¸ ç·¨è¼¯æ¸¬é©—å·</h2>
        <div style="background:#eee; padding:10px; border-radius:8px; margin-bottom:15px;">
            åç¨±: <input type="text" id="list-name" style="padding:5px; width:70%; margin-bottom:5px;">
            <div style="display:flex; gap:10px; font-size:0.9rem;">
                <label>ğŸ’æ¸¬é©—: <input type="number" id="list-gems" value="5" style="width:40px;"></label>
                <label>ğŸ’æ•™å­¸: <input type="number" id="list-teach-gems" value="2" style="width:40px;"></label>
                <label>ğŸ¯éé—œåˆ†: <input type="number" id="list-pass-score" value="100" style="width:45px;"></label>
            </div>
        </div>

        <div class="editor-layout">
            <div class="editor-input-area">
                <h3 style="margin:0; color:#2c3e50;">ğŸ–ï¸ æ‰‹å‹•å‡ºé¡Œ</h3>
                <div class="editor-label">1. é¡Œç›®æ•˜è¿°:</div>
                <textarea id="editor-text" class="editor-textarea" placeholder="ä¾‹å¦‚: ä¸€ç›’å·§å…‹åŠ›æœ‰24é¡†..."></textarea>
                
                <div class="editor-label">2. è§£åœ–æ€è·¯:</div>
                <input type="text" id="editor-logic" class="exchange-input" placeholder="ä¾‹å¦‚: å…ˆç®—å‡ºå·§å…‹åŠ›ç¸½æ•¸ï¼Œå†é€²è¡Œå¹³åˆ†ã€‚">

                <div class="editor-label">3. å®Œæ•´ç®—å¼ (é©—è­‰ç”¨):</div>
                <input type="text" id="editor-formula" class="exchange-input" placeholder="ä¾‹å¦‚: (24*3)/8" readonly onclick="this.focus()">
                
                <div class="keypad">
                    <button onclick="keyPad('(')">(</button>
                    <button onclick="keyPad(')')">)</button>
                    <button onclick="keyPad('AC')" class="btn-danger">C</button>
                    <button onclick="keyPad('DEL')">â†</button>
                    <button onclick="keyPad('7')">7</button>
                    <button onclick="keyPad('8')">8</button>
                    <button onclick="keyPad('9')">9</button>
                    <button onclick="keyPad('/')" class="op-key">Ã·</button>
                    <button onclick="keyPad('4')">4</button>
                    <button onclick="keyPad('5')">5</button>
                    <button onclick="keyPad('6')">6</button>
                    <button onclick="keyPad('*')" class="op-key">Ã—</button>
                    <button onclick="keyPad('1')">1</button>
                    <button onclick="keyPad('2')">2</button>
                    <button onclick="keyPad('3')">3</button>
                    <button onclick="keyPad('-')" class="op-key">-</button>
                    <button onclick="keyPad('0')">0</button>
                    <button onclick="keyPad('.')">.</button>
                    <button onclick="addCurrentToList()" class="btn-success" style="grid-column: span 1;">ADD</button>
                    <button onclick="keyPad('+')" class="op-key">+</button>
                </div>
            </div>

            <div class="pool-area">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; color:#d35400;">ğŸ“š ç¸½é¡Œåº« (Master Pool)</h3>
                    <span style="font-size:0.8rem; color:#666;" id="pool-count">0é¡Œ</span>
                </div>
                <div style="margin-bottom:5px; font-size:0.9rem; color:#777;">é»æ“Šä¸‹æ–¹é¡Œç›®åŠ å…¥å·¦å´æ¸¬é©—å·:</div>
                <div id="pool-list-container" class="pool-list">
                    </div>
                <button class="btn-danger btn-block" style="margin-top:5px; font-size:0.8rem;" onclick="clearPool()">ğŸ—‘ï¸ æ¸…ç©ºç¸½é¡Œåº«</button>
            </div>
        </div>

        <div style="margin-top:10px; font-weight:bold;">å·²åŠ å…¥æœ¬å·çš„é¡Œç›®:</div>
        <div style="max-height: 250px; overflow-y: auto; border:1px solid #ddd; padding:5px; border-radius:5px;" id="editor-rows"></div>
        
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜æ¸¬é©—å·</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div class="settings-panel">
            <h3>ğŸ› ï¸ æ•™å­¸è¼”åŠ©è¨­å®š</h3>
            <label><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º</label>
            <label><input type="checkbox" id="opt-text" checked> ğŸ”¤ æ–‡å­—æç¤º</label>
            <label><input type="checkbox" id="opt-allow-help" checked> ğŸ’¡ å…è¨±æ±‚åŠ©æŒ‰éˆ•</label>
        </div>
        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– æ•™å­¸æ¨¡å¼ (å®Œæ•´åˆ—å¼å¼•å°)</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ æ¸¬é©—æ¨¡å¼ (ç›´æ¥è¨ˆç®—)</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:20px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-mode">æ¨¡å¼</span>
        </div>

        <div id="quiz-area">
            <div class="problem-display">
                <div id="problem-text" class="problem-text"></div>
                
                <div class="problem-logic-container">
                    <button id="btn-show-logic" class="btn-info" onclick="toggleLogic()">ğŸ’¡ é¡¯ç¤º/éš±è— è§£é¡Œæ€è·¯</button>
                    <div id="problem-logic" class="logic-content"></div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 10px; min-height: 1.5em;">
                <div id="teach-msg" style="color:#8e44ad; font-weight:bold; font-size:1.2rem;"></div>
            </div>

            <div id="history-container"></div>

            <div id="step-input-container" class="step-input-container" style="display:none;">
                <div style="font-size:1rem; color:#777; margin-bottom:5px;">
                    <span id="input-prompt-text"></span>
                    <span id="target-highlight-text" style="color:var(--danger); font-weight:bold;"></span>
                </div>
                <input type="text" id="step-input" class="game-input" placeholder="è«‹è¼¸å…¥...">
                
                <div id="quiz-keypad" class="keypad" style="display:none;">
                     </div>

                <div style="margin-top:10px;">
                    <button class="btn-warning" onclick="checkStepAnswer()">ç¢ºèª</button>
                    <button id="btn-help" class="btn-help" onclick="useHelp()">ğŸ’¡ æ±‚åŠ©</button>
                </div>
            </div>
            
            <div id="help-content" class="help-box"></div>

            <div style="text-align: center;">
                <button id="btn-next-q" class="btn-next-level" onclick="goToNextQuestion()">ğŸ‰ ä¸‹ä¸€é¡Œ â¡</button>
            </div>
        </div>

        <div class="quiz-nav" style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-gray" id="btn-prev" onclick="navQuestion(-1)" style="visibility:hidden">ä¸Šä¸€é¡Œ</button>
            <button class="btn-success" id="btn-submit" onclick="submitTest()" style="display:none;">äº¤å·</button>
        </div>
        
        <button class="btn-danger" style="float:right; margin-top:10px;" onclick="quitQuiz()">ä¸­é€”é€€å‡º</button>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 3rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-detail" style="font-size: 1.2rem; margin: 10px;">ç­”å° 5 / 5 é¡Œ</div>
            <div id="res-time" style="color:#777;">è€—æ™‚ 01:20</div>
            
            <div id="reward-area"></div>

            <div style="margin-top:20px;">
                ä½ çš„åå­—: <input type="text" id="player-name" style="padding:5px; font-size:1.2rem; text-align:center;" readonly>
            </div>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é  (çœ‹å¯¶çŸ³)</button>
        </div>
    </div>

<script>
    /* --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– --- */
    const APP_VERSION = "v4.0";
    let studentName = "å°å°å­¸å“¡";
    let totalGems = 0; 
    let allLists = [];
    let poolData = []; // ç¸½é¡Œåº«
    let exchangeLog = [];

    // éŠæˆ²ç‹€æ…‹
    let currentList = null;
    let quizData = []; 
    // Data Structure: { qStr: "10-2*3", text: "...", logic: "...", formula: "10-2*3", ans: 4, currentExp: "10-6", history: [], isDone: false, userAns: null }
    let currentQIdx = 0;
    let currentMode = '';
    let currentFormulaPhase = 0; // 0: åˆ—å¼éšæ®µ (ä¸€æ¬¡åˆ—å®Œ), 1: è¨ˆç®—éšæ®µ (é€æ­¥è¨ˆç®—)
    let editingId = null;
    let timerInt, startTime;
    let currentStepInfo = null; // æ•™å­¸æ¨¡å¼ç•¶å‰æ­¥é©Ÿè³‡è¨Š

    // LocalStorage Keys
    const SK_LISTS = 'fa_app_lists_v2'; 
    const SK_POOL = 'fa_app_pool_v1';   // ç¸½é¡Œåº«
    const SK_USER = 'fa_app_user_v1';
    const SK_GEMS = 'fa_app_gems_v1';
    const SK_LOG = 'fa_app_log_v1';

    window.onload = function() {
        loadData();
        updateProfile(); 
        renderLists();
        renderExchangeLog();
        initQuizKeypad(); 
    };

    function loadData() {
        if(localStorage.getItem(SK_LISTS)) {
            allLists = JSON.parse(localStorage.getItem(SK_LISTS));
        } else {
            // é è¨­é¡Œåº« (Lists)
            allLists = [
                {
                    name: "åŸºç¤æ‡‰ç”¨é¡Œ (ç¯„ä¾‹)", 
                    gems: 10, teachGems: 5, passScore: 100, 
                    qs: [
                        {
                            text: "ä¸€ç›’å·§å…‹åŠ›æœ‰24é¡†ã€‚å°æ˜æœ‰3ç›’ï¼Œä»–æŠŠæ‰€æœ‰çš„å·§å…‹åŠ›å¹³åˆ†çµ¦8ä½æœ‹å‹ï¼Œæ¯ä½æœ‹å‹å¯ä»¥åˆ†åˆ°å¤šå°‘é¡†å·§å…‹åŠ›ï¼Ÿ",
                            logic: "å…ˆç®—å‡ºå·§å…‹åŠ›ç¸½æ•¸(ä¹˜æ³•)ï¼Œå†é€²è¡Œå¹³åˆ†(é™¤æ³•)ã€‚éœ€è¦ç”¨æ‹¬è™Ÿç¢ºä¿å…ˆè¨ˆç®—ç¸½æ•¸ã€‚",
                            formula: "(24*3)/8"
                        }
                    ]
                }
            ];
            saveData();
        }

        // è¼‰å…¥ç¸½é¡Œåº«
        if(localStorage.getItem(SK_POOL)) {
            poolData = JSON.parse(localStorage.getItem(SK_POOL));
        } else {
            // é è¨­ç¸½é¡Œåº«æœ‰äº›é¡Œç›®
            poolData = [
                { text: "éŠæ¨‚åœ’é–€ç¥¨ä¸€å¼µ200å…ƒï¼Œå°è¯è²·äº†4å¼µï¼Œä»˜äº†1000å…ƒï¼Œè«‹å•æ‡‰è©²æ‰¾å›å¤šå°‘å…ƒï¼Ÿ", logic: "å…ˆç®—ç¸½åƒ¹ï¼Œå†ç›¸æ¸›ã€‚", formula: "1000-(200*4)" },
                { text: "è˜‹æœä¸€é¡†15å…ƒï¼Œæ©˜å­ä¸€é¡†10å…ƒï¼Œåª½åª½è²·äº†5é¡†è˜‹æœå’Œ3é¡†æ©˜å­ï¼Œå…±å¤šå°‘éŒ¢ï¼Ÿ", logic: "åˆ†åˆ¥ç®—å‡ºç¸½åƒ¹å†ç›¸åŠ ã€‚", formula: "(15*5)+(10*3)" }
            ];
            savePool();
        }

        if(localStorage.getItem(SK_USER)) studentName = localStorage.getItem(SK_USER);
        if(localStorage.getItem(SK_GEMS)) totalGems = parseInt(localStorage.getItem(SK_GEMS)) || 0;
        if(localStorage.getItem(SK_LOG)) exchangeLog = JSON.parse(localStorage.getItem(SK_LOG));
    }

    function saveData() { localStorage.setItem(SK_LISTS, JSON.stringify(allLists)); }
    function savePool() { localStorage.setItem(SK_POOL, JSON.stringify(poolData)); }
    
    function saveUser() { 
        localStorage.setItem(SK_USER, studentName); 
        localStorage.setItem(SK_GEMS, totalGems); 
        localStorage.setItem(SK_LOG, JSON.stringify(exchangeLog));
        updateProfile(); 
    }
    
    /* --- ä»‹é¢åˆ‡æ›èˆ‡å…±ç”¨åŠŸèƒ½ --- */
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid==='page-home') {
            renderLists();
            updateProfile(); 
        }
        if(pid==='page-shop') { updateProfile(); renderExchangeLog(); }
    }

    function updateProfile() {
        document.getElementById('display-name').innerText = studentName;
        let pNameInput = document.getElementById('player-name');
        if(pNameInput) pNameInput.value = studentName;
        
        let crowns = Math.floor(totalGems / 100);
        let remain = totalGems % 100;
        
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remain;
        
        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = crowns;
            document.getElementById('shop-gems').innerText = remain;
        }
    }

    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) { studentName = n.trim(); saveUser(); }
    }

    function speak(text) {
        if(currentMode === 'teach' && !document.getElementById('opt-voice').checked) return;
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let safeText = text.replace(/\*/g,'ä¹˜ä»¥').replace(/\//g,'é™¤ä»¥').replace(/\+/g,'åŠ ').replace(/\-/g,'æ¸›').replace(/=/g,'ç­‰æ–¼').replace(/\(/g,'æ‹¬è™Ÿ').replace(/\)/g,'');
            const u = new SpeechSynthesisUtterance(safeText);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }
    }

    /* --- é¡Œåº«åˆ—è¡¨èˆ‡ç·¨è¼¯å™¨ --- */
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            d.innerHTML = `
                <div>
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                    <br><span class="gem-tag">ğŸ’${l.gems}</span> <span class="teach-gem-tag">ğŸ“–${l.teachGems}</span>
                </div>
                <div>
                    <button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                </div>`;
            c.appendChild(d);
        });
    }

    function createNewList() {
        editingId = null;
        document.getElementById('list-name').value = "æ–°æ¸¬é©—å·";
        document.getElementById('editor-rows').innerHTML = '';
        clearEditorInputs();
        renderPoolInEditor();
        showPage('page-editor');
    }

    function clearEditorInputs() {
        document.getElementById('editor-text').value = '';
        document.getElementById('editor-logic').value = '';
        document.getElementById('editor-formula').value = '';
    }

    function editList(i) {
        editingId = i; const l = allLists[i];
        document.getElementById('list-name').value = l.name;
        document.getElementById('list-gems').value = l.gems;
        document.getElementById('list-teach-gems').value = l.teachGems;
        document.getElementById('list-pass-score').value = l.passScore;
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        l.qs.forEach(q => addEqRow(q));
        renderPoolInEditor();
        showPage('page-editor');
    }

    function keyPad(char) {
        const inp = document.getElementById('editor-formula');
        // å¦‚æœç›®å‰æ˜¯è¼¸å…¥æ­¥é©Ÿï¼Œä¹Ÿå¯ä»¥ç”¨
        const stepInp = document.getElementById('step-input');
        
        let target = document.getElementById('page-editor').classList.contains('active') ? inp : stepInp;

        if(char === 'AC') target.value = '';
        else if(char === 'DEL') target.value = target.value.slice(0, -1);
        else target.value += char;
        target.focus();
    }
    
    function initQuizKeypad() {
        const k = document.getElementById('quiz-keypad');
        const chars = ['(', ')', 'AC', 'DEL', '7', '8', '9', '/', '4', '5', '6', '*', '1', '2', '3', '-', '0', '.', 'Enter', '+'];
        k.innerHTML = '';
        chars.forEach(c => {
            let btn = document.createElement('button');
            btn.innerText = c==='Enter'?'OK':(c==='*'?'Ã—':(c==='/'?'Ã·':c));
            if(['+','-','*','/'].includes(c)) btn.className = 'op-key';
            if(c==='AC') btn.className = 'btn-danger';
            if(c==='Enter') { btn.className = 'btn-success'; btn.onclick = checkStepAnswer; }
            else { btn.onclick = () => keyPad(c); }
            k.appendChild(btn);
        });
    }

    function addCurrentToList() {
        let text = document.getElementById('editor-text').value.trim();
        let logic = document.getElementById('editor-logic').value.trim();
        let formula = document.getElementById('editor-formula').value.trim();
        
        if(!text || !formula) return alert("è«‹è¼¸å…¥é¡Œç›®æ•˜è¿°èˆ‡å®Œæ•´ç®—å¼");
        
        try {
            eval(formula); // æª¢æŸ¥ç®—å¼æ˜¯å¦åˆæ³•
            addEqRow({text, logic, formula});
            clearEditorInputs();
        } catch(e) {
            alert("ç®—å¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ï¼");
        }
    }

    function addEqRow(qObj) {
        const div = document.createElement('div'); div.className = 'eq-row';
        div.innerHTML = `
            <div class="eq-row-header">
                <span class="eq-text">${qObj.formula}</span>
                <button class="btn-danger" onclick="this.closest('.eq-row').remove()">Ã—</button>
            </div>
            <div class="eq-desc">é¡Œç›®: ${qObj.text}</div>
            <input type="hidden" class="data-obj" value='${JSON.stringify(qObj).replace(/'/g, "&#39;")}'>
        `;
        document.getElementById('editor-rows').appendChild(div);
    }

    function saveList() {
        const name = document.getElementById('list-name').value;
        const gems = parseInt(document.getElementById('list-gems').value) || 5;
        const teachGems = parseInt(document.getElementById('list-teach-gems').value) || 2;
        const passScore = parseInt(document.getElementById('list-pass-score').value) || 100;
        
        const qs = [];
        const rows = document.querySelectorAll('.eq-row');
        rows.forEach(row => {
            const val = row.querySelector('.data-obj').value;
            qs.push(JSON.parse(val));
        });
        
        if(qs.length===0) return alert("è«‹è‡³å°‘æ–°å¢ä¸€é¡Œ");
        const data = {name, gems, teachGems, passScore, qs};
        if(editingId === null) allLists.push(data); else allLists[editingId] = data;
        saveData(); showPage('page-home');
    }
    
    function delList(i) { if(confirm("ç¢ºå®šåˆªé™¤?")) { allLists.splice(i,1); saveData(); renderLists(); } }

    /* --- ç¸½é¡Œåº« (Master Pool) é‚è¼¯ --- */
    function renderPoolInEditor() {
        const container = document.getElementById('pool-list-container');
        container.innerHTML = '';
        document.getElementById('pool-count').innerText = `${poolData.length} é¡Œ`;
        
        poolData.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'pool-item';
            div.innerHTML = `
                <div style="flex:1; overflow:hidden;">
                    <div style="font-weight:bold; font-size:0.8rem; color:#d35400;">${q.formula}</div>
                    <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${q.text}</div>
                </div>
                <button class="btn-success" onclick="addFromPool(${idx})">â•</button>
            `;
            container.appendChild(div);
        });
    }

    function addFromPool(idx) {
        const q = poolData[idx];
        addEqRow(q); // ç›´æ¥åŠ å…¥å·¦å´åˆ—è¡¨
    }

    function clearPool() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºç¸½é¡Œåº«å—ï¼Ÿ")) {
            poolData = [];
            savePool();
            renderPoolInEditor();
        }
    }

    /* --- åŒ¯å…¥åŒ¯å‡º (å‚™ä»½) --- */
    function exportData() {
        const d = { version: "4.0", lists: allLists, pool: poolData, user: studentName, gems: totalGems, log: exchangeLog };
        const blob = new Blob([JSON.stringify(d)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = "four_arithmetic_full_backup.json"; a.click();
    }
    function handleImport(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(d.lists) allLists = allLists.concat(d.lists);
                if(d.pool) poolData = poolData.concat(d.pool); // åŒ¯å…¥ pool
                if(d.user && confirm(`ç™¼ç¾ä½¿ç”¨è€… ${d.user} (å¯¶çŸ³:${d.gems})ï¼Œè¦è¦†è“‹å—ï¼Ÿ`)) {
                    studentName = d.user; 
                    totalGems = d.gems; 
                    if(d.log) exchangeLog = d.log;
                    saveUser(); 
                }
                saveData(); savePool(); renderLists(); alert("åŒ¯å…¥å®Œæˆ");
            } catch(e) { alert("æª”æ¡ˆéŒ¯èª¤"); }
        };
        r.readAsText(f);
    }

    /* --- åŒ¯å…¥é¡Œç›®åˆ°ç¸½é¡Œåº« (JSON) --- */
    function handleImportToPool(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const questions = JSON.parse(e.target.result);
                if(!Array.isArray(questions)) return alert("æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯ Array");
                
                // æ ¼å¼æ¸…æ´—ï¼Œä¿ç•™æ ¸å¿ƒæ¬„ä½
                const newQs = questions.map(q => ({
                    text: q.text,
                    logic: q.logic,
                    formula: q.formula
                }));

                poolData = poolData.concat(newQs);
                savePool();
                renderLists(); // é›–ä¸å½±éŸ¿ list é¡¯ç¤ºï¼Œä½†åˆ·æ–°ç•«é¢
                alert(`æˆåŠŸåŒ¯å…¥ ${newQs.length} é¡Œåˆ°ç¸½é¡Œåº«ï¼è«‹é€²å…¥ç·¨è¼¯æ¨¡å¼æŸ¥çœ‹ã€‚`);
            } catch(e) {
                alert("JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚");
            }
        };
        r.readAsText(f);
        inp.value = ''; 
    }

    /* --- æ¸¬é©—é‚è¼¯ --- */
    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        currentQIdx = 0;
        // åˆå§‹åŒ–é¡Œç›®è³‡æ–™
        quizData = currentList.qs.map(q => {
            try {
                let qStr = q.formula; 
                return { 
                    qStr: qStr, 
                    text: q.text,
                    logic: q.logic,
                    ans: eval(qStr), 
                    currentExp: qStr, 
                    history: [qStr], 
                    isDone: false, 
                    userAns: null,
                    formula_input_done: (mode === 'test') // æ¸¬é©—æ¨¡å¼ä¸éœ€è¦åˆ—å¼
                };
            } catch(e) { return null; }
        }).filter(x => x!==null);

        if(quizData.length === 0) return alert("ç„¡æœ‰æ•ˆé¡Œç›®");

        // æ±‚åŠ©æŒ‰éˆ•è¨­å®š
        const allowHelp = document.getElementById('opt-allow-help').checked;
        document.getElementById('btn-help').style.display = allowHelp ? 'inline-block' : 'none';

        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updateTimer, 1000);
        document.getElementById('q-mode').innerText = mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼';
        document.getElementById('btn-submit').style.display = 'none';
        
        showPage('page-quiz');
        speak("æ¸¬é©—é–‹å§‹ï¼Œè«‹ä»”ç´°é–±è®€é¡Œç›®");
        loadQuestion();
    }

    function updateTimer() {
        let sec = Math.floor((Date.now() - startTime)/1000);
        let m = Math.floor(sec/60).toString().padStart(2,'0');
        let s = (sec%60).toString().padStart(2,'0');
        document.getElementById('q-timer').innerText = `${m}:${s}`;
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡ºï¼Ÿ")) showPage('page-home'); }

    function loadQuestion() {
        const d = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('teach-msg').innerText = "";
        document.getElementById('help-content').style.display = 'none';
        document.getElementById('btn-next-q').style.display = 'none';
        
        // é¡¯ç¤ºæ‡‰ç”¨é¡Œæ–‡æœ¬
        document.getElementById('problem-text').innerText = d.text;
        
        // é è¨­éš±è—è§£é¡Œæ€è·¯
        const logicContent = document.getElementById('problem-logic');
        logicContent.style.display = 'none';
        logicContent.innerHTML = d.logic ? `<strong>ğŸ’¡ æ€è·¯ï¼š</strong>${d.logic}` : "ç„¡è§£é¡Œæ€è·¯";
        document.getElementById('btn-show-logic').innerText = "ğŸ’¡ é¡¯ç¤ºè§£é¡Œæ€è·¯";
        document.querySelector('.problem-logic-container').style.display = d.logic ? 'block' : 'none';

        const historyContainer = document.getElementById('history-container');
        historyContainer.innerHTML = ''; 

        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('step-input').value = '';
        document.getElementById('step-input').className = 'game-input';

        // æ±‚åŠ©æŒ‰éˆ•çš„å¯è¦‹æ€§ (å†æ¬¡ç¢ºèªè¨­å®š)
        const allowHelp = document.getElementById('opt-allow-help').checked;
        document.getElementById('btn-help').style.display = allowHelp ? 'inline-block' : 'none';

        if(currentMode === 'test') {
            // --- æ¸¬é©—æ¨¡å¼ ---
            document.getElementById('quiz-keypad').style.display = 'none'; // éš±è—éµç›¤
            historyContainer.innerHTML = `<div class="calc-row active">${d.qStr} = ?</div>`;
            document.getElementById('step-input-container').style.display = 'flex';
            document.getElementById('input-prompt-text').innerText = "";
            document.getElementById('target-highlight-text').innerText = "ç­”æ¡ˆ";
            document.getElementById('step-input').type = "number"; // åªéœ€è¼¸å…¥æ•¸å­—
            document.getElementById('step-input').value = d.userAns !== null ? d.userAns : '';
            document.getElementById('step-input').focus();
            document.getElementById('btn-prev').style.visibility = currentQIdx>0?'visible':'hidden';
            
            if(currentQIdx === quizData.length-1) {
                document.getElementById('btn-submit').style.display = 'inline-block';
                document.querySelector('#step-input-container button').style.display = 'none';
            } else {
                document.getElementById('btn-submit').style.display = 'none';
                document.querySelector('#step-input-container button').style.display = 'none';
                document.getElementById('btn-next-q').innerText = "ä¸‹ä¸€é¡Œ â¡";
                document.getElementById('btn-next-q').style.display = 'inline-block';
            }
        } else {
            // --- æ•™å­¸æ¨¡å¼ ---
            document.getElementById('btn-prev').style.visibility = 'hidden';
            document.getElementById('btn-submit').style.display = 'none';
            document.querySelector('#step-input-container button').style.display = 'inline-block';
            document.getElementById('quiz-keypad').style.display = 'grid'; // é¡¯ç¤ºéµç›¤ä¾›è¼¸å…¥ç®—å¼

            if(!d.formula_input_done) {
                // éšæ®µä¸€ï¼šåˆ—å¼å¼•å° (æ”¹ç‚ºä¸€æ¬¡è¼¸å…¥å®Œæ•´ç®—å¼)
                currentFormulaPhase = 0;
                renderFormulaPhase();
            } else {
                // éšæ®µäºŒï¼šè¨ˆç®—å¼•å°
                currentFormulaPhase = 1;
                if(!d.isDone && d.history.length === 0) d.history = [d.qStr];
                renderCalculationStep();
            }
        }
    }

    function toggleLogic() {
        const div = document.getElementById('problem-logic');
        const btn = document.getElementById('btn-show-logic');
        if (div.style.display === 'none') {
            div.style.display = 'block';
            btn.innerText = "ğŸ™ˆ éš±è—è§£é¡Œæ€è·¯";
        } else {
            div.style.display = 'none';
            btn.innerText = "ğŸ’¡ é¡¯ç¤ºè§£é¡Œæ€è·¯";
        }
    }

    /* --- æ•™å­¸æ¨¡å¼ - éšæ®µä¸€ï¼šå®Œæ•´åˆ—å¼å¼•å° --- */
    function renderFormulaPhase() {
        document.getElementById('step-input-container').style.display = 'flex';
        document.getElementById('input-prompt-text').innerText = `è«‹åˆ—å‡ºå®Œæ•´ç®—å¼ï¼š`;
        document.getElementById('target-highlight-text').innerText = "";
        document.getElementById('step-input').type = "text"; // å…è¨±è¼¸å…¥ç¬¦è™Ÿ
        document.getElementById('step-input').value = "";
        document.getElementById('step-input').placeholder = "ä¾‹å¦‚: (24*3)/8";
        document.getElementById('step-input').focus();
        
        speak("è«‹æ ¹æ“šé¡Œç›®ï¼Œåˆ—å‡ºå®Œæ•´çš„ç®—å¼");
    }

    /* --- æ•™å­¸æ¨¡å¼ - éšæ®µäºŒï¼šè¨ˆç®—å¼•å° --- */
    function renderCalculationStep() {
        const d = quizData[currentQIdx];
        const currentExpState = d.history[d.history.length - 1];
        
        const step = findNextStep(currentExpState);
        currentStepInfo = step;

        const historyContainer = document.getElementById('history-container');
        const inputDiv = document.getElementById('step-input-container');
        const msgDiv = document.getElementById('teach-msg');
        const inp = document.getElementById('step-input');

        historyContainer.innerHTML = '';
        
        // æ¸²æŸ“æ­·å²æ­¥é©Ÿ
        d.history.forEach((exp, index) => {
            const div = document.createElement('div');
            const isLast = (index === d.history.length - 1);
            div.className = isLast ? 'calc-row active' : 'calc-row';
            
            if(isLast && step) {
                 let html = step.fullExp.substring(0, step.idxStart) + 
                   `<span class="step-highlight">${step.target}</span>` + 
                   step.fullExp.substring(0 + step.idxEnd);
                 div.innerHTML = html;
            } else {
                 div.innerText = exp;
            }
            historyContainer.appendChild(div);
        });

        if(!step) {
            inputDiv.style.display = 'none';
            document.getElementById('quiz-keypad').style.display = 'none';
            msgDiv.innerText = "å¤ªæ£’äº†ï¼æœ¬é¡Œå®Œæˆï¼";
            document.getElementById('btn-next-q').style.display = 'inline-block';
            document.getElementById('btn-next-q').innerText = (currentQIdx===quizData.length-1)?"å…¨éƒ¨å®Œæˆï¼çœ‹æˆç¸¾":"ä¸‹ä¸€é¡Œ â¡";
            speak("å®Œæˆï¼");
            d.isDone = true;
            d.userAns = parseFloat(currentExpState);
            return;
        }

        inputDiv.style.display = 'flex';
        document.getElementById('input-prompt-text').innerText = "è«‹è¼¸å…¥";
        document.getElementById('target-highlight-text').innerText = step.target + " çš„ç­”æ¡ˆ";
        inp.value = '';
        inp.type = "number"; // é€™è£¡åªè¼¸å…¥æ•¸å­—
        inp.className = 'game-input';
        inp.placeholder = "?";
        inp.focus();

        let hint = "";
        if(step.op === '*') hint = `è«‹å…ˆç®—ä¹˜æ³•ï¼š${step.target}`;
        else if(step.op === '/') hint = `è«‹å…ˆç®—é™¤æ³•ï¼š${step.target}`;
        else if(step.op === '+' || step.op === '-') hint = `ä¾åºè¨ˆç®—ï¼š${step.target}`;
        else hint = `è«‹è¨ˆç®—ï¼š${step.target}`;
        
        if(document.getElementById('opt-text').checked) msgDiv.innerText = hint;
        speak(hint);
    }

    function checkStepAnswer() {
        if(currentMode === 'test') { return; }
        const d = quizData[currentQIdx];
        const inp = document.getElementById('step-input');

        // åˆ¤æ–·ç›®å‰æ˜¯ã€Œåˆ—å¼éšæ®µã€é‚„æ˜¯ã€Œè¨ˆç®—éšæ®µã€
        if(currentFormulaPhase === 0) {
            // --- æª¢æŸ¥å®Œæ•´åˆ—å¼ ---
            let userFormula = inp.value.replace(/\s/g, ''); // å»é™¤ç©ºç™½
            let correctFormula = d.qStr.replace(/\s/g, '');
            
            if(userFormula === correctFormula) {
                inp.classList.add('correct');
                speak("åˆ—å¼æ­£ç¢º");
                d.formula_input_done = true;
                
                setTimeout(() => {
                    inp.classList.remove('correct');
                    loadQuestion(); // é€²å…¥ Phase 1 (è¨ˆç®—)
                }, 800);
            } else {
                inp.classList.add('wrong');
                speak("åˆ—å¼éŒ¯èª¤ï¼Œè«‹å†æª¢æŸ¥ä¸€ä¸‹");
                setTimeout(() => inp.classList.remove('wrong'), 500);
            }

        } else {
            // --- æª¢æŸ¥è¨ˆç®—æ•¸å€¼ (è¨ˆç®—éšæ®µ) ---
            const userVal = parseFloat(inp.value);
            if(Math.abs(userVal - currentStepInfo.val) < 0.0001) {
                inp.classList.add('correct');
                speak("ç­”å°äº†");
                document.getElementById('help-content').style.display = 'none';
                
                let newExp = currentStepInfo.fullExp.substring(0, currentStepInfo.idxStart) + 
                             currentStepInfo.val + 
                             currentStepInfo.fullExp.substring(currentStepInfo.idxEnd);
                
                while(/\(\d+(?:\.\d+)?\)/.test(newExp)) {
                    newExp = newExp.replace(/\((\d+(?:\.\d+)?)\)/g, '$1');
                }

                d.history.push(newExp);
                d.currentExp = newExp; 

                setTimeout(() => {
                    renderCalculationStep();
                }, 600);
            } else {
                inp.classList.add('wrong');
                speak("ç®—éŒ¯å›‰ï¼Œå†è©¦è©¦çœ‹");
                setTimeout(() => inp.classList.remove('wrong'), 500);
            }
        }
    }

    // å°‹æ‰¾ä¸‹ä¸€æ­¥é‹ç®—å„ªå…ˆç´šé‚è¼¯
    function findNextStep(expStr) {
        let openIdx = expStr.lastIndexOf('(');
        if(openIdx !== -1) {
            let closeIdx = expStr.indexOf(')', openIdx);
            if(closeIdx !== -1) {
                let inner = expStr.substring(openIdx + 1, closeIdx);
                if(isNaN(Number(inner))) {
                    let innerStep = findNextStepInFlat(inner);
                    if(innerStep) {
                        return {
                            fullExp: expStr,
                            target: innerStep.target,
                            val: innerStep.val,
                            idxStart: openIdx + 1 + innerStep.idxStart,
                            idxEnd: openIdx + 1 + innerStep.idxEnd,
                            op: innerStep.op
                        };
                    }
                } else {
                    return {
                        fullExp: expStr,
                        target: `(${inner})`,
                        val: parseFloat(inner),
                        idxStart: openIdx,
                        idxEnd: closeIdx + 1,
                        op: '()'
                    };
                }
            }
        }
        return findNextStepInFlat(expStr);
    }

    function findNextStepInFlat(str) {
        let reMulDiv = /(\d+(?:\.\d+)?)([\*\/])(\d+(?:\.\d+)?)/;
        let match = str.match(reMulDiv);
        if(match) {
            let n1 = parseFloat(match[1]);
            let n2 = parseFloat(match[3]);
            let op = match[2];
            let val = op==='*'?n1*n2 : n1/n2;
            val = Math.round(val * 10000) / 10000;
            return { fullExp: str, target: match[0], val: val, idxStart: match.index, idxEnd: match.index + match[0].length, op: op };
        }
        
        let reAddSub = /(\d+(?:\.\d+)?)([\+\-])(\d+(?:\.\d+)?)/;
        let match2 = str.match(reAddSub);
        if(match2) {
            let n1 = parseFloat(match2[1]);
            let n2 = parseFloat(match2[3]);
            let op = match2[2];
            let val = op==='+'?n1+n2 : n1-n2;
            val = Math.round(val * 10000) / 10000;
            return { fullExp: str, target: match2[0], val: val, idxStart: match2.index, idxEnd: match2.index + match2[0].length, op: op };
        }
        return null;
    }

    function useHelp() {
        const h = document.getElementById('help-content');
        if(h.style.display === 'block') { h.style.display='none'; return; }
        
        if(currentMode === 'teach') {
            if(currentFormulaPhase === 0) {
                 // åˆ—å¼éšæ®µçš„æç¤º
                 const d = quizData[currentQIdx];
                 h.innerHTML = `æç¤ºï¼šé€™é¡Œçš„ç®—å¼æ‡‰è©²æ˜¯ <strong>${d.qStr}</strong>`;
                 h.style.display = 'block';
            } else if(currentStepInfo) {
                 // è¨ˆç®—éšæ®µçš„æç¤º
                 h.innerHTML = `æç¤ºï¼š${currentStepInfo.target} ç­‰æ–¼ <strong>${currentStepInfo.val}</strong>`;
                 h.style.display = 'block';
            }
        }
    }

    function navQuestion(dir) {
        if(currentMode === 'test') {
            quizData[currentQIdx].userAns = document.getElementById('step-input').value;
        }
        currentQIdx += dir;
        loadQuestion();
    }

    function goToNextQuestion() {
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            submitTest();
        }
    }

    /* --- çµç®—èˆ‡çå‹µ --- */
    function submitTest() {
        clearInterval(timerInt);
        let correctCount = 0;
        quizData.forEach(d => {
            if(d.userAns != null && Math.abs(parseFloat(d.userAns) - d.ans) < 0.001) {
                correctCount++;
            }
        });
        
        let score = Math.round((correctCount / quizData.length) * 100);
        showResult(score, correctCount, quizData.length);
    }

    function showResult(score, correct, total) {
        showPage('page-result');
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-detail').innerText = `ç­”å° ${correct} / ${total} é¡Œ`;
        document.getElementById('res-time').innerText = `è€—æ™‚ ${document.getElementById('q-timer').innerText}`;

        const rArea = document.getElementById('reward-area'); rArea.innerHTML = '';
        let earned = 0;
        let target = currentList.passScore;
        
        if(currentMode === 'test' && score >= target) earned = currentList.gems;
        else if(currentMode === 'teach' && score === 100) earned = currentList.teachGems;

        if(earned > 0) {
            let oldCrowns = Math.floor(totalGems/100);
            totalGems += earned; 
            saveUser(); 
            let newCrowns = Math.floor(totalGems/100);
            
            if(newCrowns > oldCrowns) {
                rArea.innerHTML = `<div class="reward-popup" style="color:#e67e22; border-color:#e67e22;">
                    ğŸ‘‘ æ­å–œå‡ç´šï¼ç²å¾— ${newCrowns-oldCrowns} é ‚çš‡å† ï¼<br>
                    <span style="font-size:0.9rem; color:#666;">(ç›®å‰ç´¯ç©ç¸½æ•¸: ${totalGems} ğŸ’)</span>
                </div>`;
                spawnParticles('ğŸ‘‘');
                speak(`å¤ªæ£’äº†ï¼å‡ç´šç²å¾—çš‡å† ï¼`);
            } else {
                rArea.innerHTML = `<div class="reward-popup">
                    ğŸ‰ ç²å¾— ${earned} é¡†å¯¶çŸ³ï¼<br>
                    <span style="font-size:0.9rem; color:#666;">(ç›®å‰ç´¯ç©ç¸½æ•¸: ${totalGems} ğŸ’)</span>
                </div>`;
                spawnParticles('ğŸ’');
                speak(`æ­å–œç²å¾—${earned}é¡†å¯¶çŸ³ï¼`);
            }
        } else {
            speak(`æ¸¬é©—çµæŸï¼Œå†æ¥å†å²ï¼`);
        }
    }

    /* --- å•†åº— --- */
    function renderExchangeLog() {
        const c = document.getElementById('exchange-log'); c.innerHTML = '';
        exchangeLog.forEach(l => {
            const d = document.createElement('div'); d.style.borderBottom='1px solid #eee'; d.style.padding='5px';
            d.innerHTML = `${l.date} - å…Œæ› <b>${l.item}</b> (-${l.cost})`;
            c.appendChild(d);
        });
    }
    function processExchange() {
        const item = document.getElementById('gift-name').value;
        const cost = parseInt(document.getElementById('gift-cost').value);
        const curr = document.getElementById('gift-currency').value;
        if(!item || isNaN(cost) || cost<=0) return alert("è¼¸å…¥ä¸å®Œæ•´");
        
        let realCost = cost * (curr==='crowns' ? 100 : 1);
        if(totalGems < realCost) return alert("å¯¶çŸ³/é¤˜é¡ä¸è¶³");

        if(confirm(`ç¢ºèªå…Œæ› ${item}ï¼Ÿ`)) {
            totalGems -= realCost;
            exchangeLog.unshift({date: new Date().toLocaleString(), item, cost: `${cost}${curr==='crowns'?'çš‡å† ':'å¯¶çŸ³'}`});
            saveUser();
            updateProfile();
            renderExchangeLog();
            spawnParticles(curr==='crowns'?'ğŸ‘‘':'ğŸ’');
            speak("å…Œæ›æˆåŠŸ");
            document.getElementById('gift-name').value = '';
        }
    }

    function spawnParticles(char) {
        const con = document.getElementById('particle-container');
        con.style.display = 'block'; con.innerHTML = '';
        for(let i=0; i<30; i++) {
            let p = document.createElement('div'); p.className='particle'; p.innerText = char;
            p.style.left = Math.random()*100+'vw';
            p.style.animationDuration = (Math.random()*2+1)+'s';
            con.appendChild(p);
        }
        setTimeout(() => { con.style.display='none'; }, 3000);
    }
</script>
</body>
</html>
