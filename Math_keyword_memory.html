<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‡‰ç”¨é¡Œæ•¸å­—è¨˜æ†¶ç·´ç¿’ç³»çµ±</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --light: #f4ecf7;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --pool-bg: #fff8e1;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0 0 0; text-align: center; font-size: 1.8rem;}
        
        .app-version { font-size: 0.8rem; color: #95a5a6; margin-top: auto; padding: 20px; width: 100%; text-align: center; }

        /* --- å­¸å“¡åç‰Œ --- */
        .user-profile {
            background-color: #fff;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 10px 20px;
            margin: 20px 0;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark);
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            justify-content: center; flex-wrap: wrap;
        }
        .user-profile:active { transform: scale(0.98); }
        
        .stats-badge {
            background: #eee; padding: 5px 10px; border-radius: 15px;
            font-size: 1rem; display: flex; align-items: center; gap: 5px;
        }

        .container {
            width: 100%; max-width: 1100px;
            background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
            display: none; flex-direction: column; 
        }
        .container.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 6px; padding: 8px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 2px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-info { background-color: #2980b9; }
        .btn-help { background-color: #e67e22; box-shadow: 0 4px #d35400; }
        .btn-help:active { box-shadow: 0 0 #d35400; transform: translateY(4px); }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; }

        /* --- åˆ—è¡¨èˆ‡ç·¨è¼¯ --- */
        .list-item {
            background: #fdfefe; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px;
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .editor-layout {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        @media (max-width: 768px) {
            .editor-layout { grid-template-columns: 1fr; }
        }

        .editor-column { display: flex; flex-direction: column; gap: 10px; }
        .editor-input-area { background: #f4f6f7; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        
        .pool-area {
            background: var(--pool-bg); padding: 15px; border-radius: 8px; border: 2px solid #f39c12;
            max-height: 600px; display: flex; flex-direction: column;
        }
        .pool-list { overflow-y: auto; flex: 1; border-top: 1px solid #ddd; margin-top: 10px; }
        .pool-item {
            background: white; border-bottom: 1px solid #ddd; padding: 8px; margin-bottom: 5px; cursor: pointer;
            border-radius: 4px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .pool-item:hover { background: #fdf2e9; }

        .editor-label { font-weight: bold; color: #555; margin-bottom: 5px; display:block;}
        .editor-textarea { 
            width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; 
            font-size: 1.1rem; min-height: 80px; resize: vertical;
        }
        .editor-input {
            width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; font-size: 1rem;
        }
        .config-group {
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap; background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #ccc; flex: 1;
        }

        /* --- æ¸¬é©—å€åŸŸ --- */
        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 6px; }
        
        .problem-display {
            background: #fff; border: 2px solid var(--primary); border-radius: 8px; padding: 20px;
            margin-bottom: 20px; text-align: left; font-size: 1.5rem; line-height: 1.8;
            min-height: 150px; display: flex; flex-direction: column; justify-content: center; position: relative;
        }

        .countdown-timer {
            position: absolute; top: -15px; right: -10px;
            background: #e74c3c; color: white;
            font-weight: bold; padding: 5px 15px; border-radius: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            font-size: 1.2rem;
            animation: pulse 1s infinite;
            display: none;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .blank-input {
            border: none; border-bottom: 3px solid var(--primary);
            background: #f4ecf7; text-align: center; font-size: 1.5rem;
            width: 80px; margin: 0 5px; color: var(--primary); font-weight: bold;
            border-radius: 5px; padding: 5px; outline: none;
            transition: all 0.3s; cursor: pointer;
        }
        .blank-input.active { background: #fff; border-bottom: 3px solid #e74c3c; transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .blank-input.correct { background: #d5f5e3; border-bottom: 3px solid #27ae60; color: #27ae60; pointer-events: none; }
        .blank-input.wrong { background: #fadbd8; border-bottom: 3px solid #c0392b; animation: shake 0.4s; }

        .keypad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; max-width: 400px; margin-left: auto; margin-right: auto;
        }
        .keypad button {
            background: #fff; border: 1px solid #bdc3c7; color: #2c3e50; font-size: 1.5rem; padding: 15px;
            border-radius: 10px; box-shadow: 0 4px #bdc3c7;
        }
        .keypad button:active { transform: translateY(4px); box-shadow: none; }
        
        .shop-balance {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;
        }
        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; }
        .particle { position: absolute; font-size: 2rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .btn-start-phase { font-size: 1.5rem; padding: 20px; background: #27ae60; border-radius: 50px; box-shadow: 0 5px #1e8449; display: block; width: 100%; }
        .btn-start-phase:active { transform: translateY(5px); box-shadow: none; }

        .settings-panel {
            background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;
        }
        .settings-panel label { display: block; margin-bottom: 8px; cursor: pointer; font-size: 1.1rem; }
        .settings-panel input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; }
    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>ğŸ§  æ‡‰ç”¨é¡Œæ•¸å­—è¨˜æ†¶ç·´ç¿’</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå§“å</span></div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <button class="btn-warning btn-block" style="margin-bottom:15px;" onclick="showPage('page-shop')">ğŸ çå‹µå•†åº—</button>
        
        <h3>ğŸ“‚ é¸æ“‡ç·´ç¿’é¡Œåº«</h3>
        <div id="lists-container"></div>
        
        <button class="btn-primary btn-block" onclick="createNewList()">+ å»ºç«‹æ–°æ¸¬é©—å·</button>
        
        <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px; display:flex; flex-direction: column; gap:5px;">
            <div style="text-align:center; font-size:0.9rem; color:#666; margin-bottom:5px;">ğŸ‘‡ å…ˆåœ¨é€™è£¡åŒ¯å…¥ 100 é¡Œ JSON åˆ°ç¸½é¡Œåº«</div>
            <button class="btn-info btn-block" onclick="document.getElementById('import-json-pool').click()">ğŸ“¥ åŒ¯å…¥é¡Œç›®åˆ°ã€Œç¸½é¡Œåº«ã€(JSON)</button>
            <input type="file" id="import-json-pool" style="display:none" accept=".json" onchange="handleImportToPool(this)">
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥å‚™ä»½</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleBackupImport(this)">
            </div>
        </div>

        <div class="app-version">
            Math Keyword Memory v4.0 (Rewards & Timer)<br>
            <a href="#" onclick="hardReset()" style="color:#c0392b; text-decoration:underline;">âš ï¸ ç³»çµ±ç•°å¸¸? é»æ­¤å¼·åˆ¶é‡ç½®</a>
        </div>
    </div>

    <div id="page-editor" class="container" style="max-width: 1200px;">
        <h2>âœï¸ ç·¨è¼¯æ¸¬é©—å·</h2>
        
        <div style="margin-bottom:10px; background:#eee; padding:10px; border-radius:5px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="flex:2; min-width: 200px;">
                åç¨±: <input type="text" id="list-name" class="editor-input" style="width:70%;">
            </div>
            
            <div class="config-group">
                <span style="font-size:0.9rem;">â³é™æ™‚(ç§’):</span>
                <input type="number" id="list-timer" class="editor-input" style="width:60px; text-align:center;" placeholder="0" min="0">
            </div>
            
            <div class="config-group">
                <span style="font-size:0.9rem;">ğŸ’å®Œæˆçå‹µ:</span>
                <input type="number" id="list-reward" class="editor-input" style="width:60px; text-align:center;" value="10" min="1">
            </div>
        </div>

        <div class="editor-layout">
            <div class="editor-column">
                <div class="editor-input-area">
                    <h3 style="margin-top:0; color:#2c3e50;">ğŸ–ï¸ æ‰‹å‹•æ–°å¢</h3>
                    <div class="editor-label">é¡Œç›®å…§å®¹:</div>
                    <textarea id="editor-text" class="editor-textarea" placeholder="ä¾‹å¦‚ï¼šä¸€ç›’å·§å…‹åŠ›æœ‰24é¡†..."></textarea>
                    
                    <div class="editor-label" style="margin-top:10px;">éš±è—é—œéµå­— (æ•¸å­—):</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="editor-keywords" class="editor-input" placeholder="ä¾‹å¦‚: 24, 3, 8">
                        <button class="btn-info" onclick="autoDetectNumbers()">âš¡ è‡ªå‹•æŠ“</button>
                    </div>
                    
                    <button onclick="addCurrentToList()" class="btn-success btn-block" style="margin-top:15px;">â¬‡ï¸ åŠ å…¥æœ¬å·</button>
                </div>

                <div style="font-weight:bold;">å·²åŠ å…¥æœ¬å·çš„é¡Œç›® (<span id="count-current">0</span>é¡Œ):</div>
                <div id="editor-rows" style="flex:1; overflow-y: auto; border:1px solid #ddd; padding:5px; background:white; min-height:200px; max-height:400px; border-radius:5px;"></div>
            </div>

            <div class="editor-column">
                <div class="pool-area">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; color:#d35400;">ğŸ“š ç¸½é¡Œåº«ä¾†æº</h3>
                        <span style="font-size:0.8rem; color:#666;" id="pool-count">0é¡Œ</span>
                    </div>
                    <div style="margin-bottom:5px; font-size:0.8rem; color:#666;">é»æ“Š â• å°‡é¡Œç›®åŠ å…¥å·¦å´æ¸¬é©—å·</div>
                    
                    <div id="pool-list-container" class="pool-list">
                        </div>
                    
                    <button class="btn-danger btn-block" style="margin-top:10px; font-size:0.9rem;" onclick="clearPool()">ğŸ—‘ï¸ æ¸…ç©ºç¸½é¡Œåº«</button>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">ğŸ’¾ å„²å­˜æ¸¬é©—å·</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>âš™ï¸ ç·´ç¿’è¨­å®š</h2>
        <div class="settings-panel">
            <label><input type="checkbox" id="opt-voice" checked> ğŸ”Š é–‹å•ŸèªéŸ³å°å¼•</label>
            <label><input type="checkbox" id="opt-allow-help" checked> ğŸ†˜ é–‹å•Ÿæ±‚æ•‘æŒ‰éˆ• (æ±‚æ•‘æ™‚é‡å¿µé¡Œç›®)</label>
        </div>
        <button class="btn-success btn-block" onclick="startQuiz()">ğŸš€ é–‹å§‹ç·´ç¿’</button>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-mode-label" style="color:var(--primary);">é€²è¡Œä¸­...</span>
        </div>

        <div id="phase-read" style="text-align:center;">
            <h3>ğŸ‘ï¸ è«‹ä»”ç´°é–±è®€ä¸¦è¨˜ä½æ•¸å­—</h3>
            <div class="problem-display">
                <div id="read-timer" class="countdown-timer">10</div>
                <div id="read-text"></div>
            </div>
            <button class="btn-start-phase" onclick="goToAnswerPhase()">æˆ‘è¨˜ä½äº†ï¼é–‹å§‹ç­”é¡Œ â¡</button>
        </div>

        <div id="phase-answer" style="display:none; text-align:center;">
            <h3>ğŸ–Šï¸ è«‹å¡«å…¥æ¶ˆå¤±çš„æ•¸å­—</h3>
            <div class="problem-display" id="answer-area" style="background:#fff8e1;"></div>
            
            <div style="margin-bottom:10px; display:flex; justify-content:center; gap:10px;">
                <button id="btn-help" class="btn-help" onclick="useHelp()">ğŸ†˜ æ±‚æ•‘ (å†å¿µä¸€é)</button>
            </div>

            <div class="keypad">
                <button onclick="keyPad('1')">1</button>
                <button onclick="keyPad('2')">2</button>
                <button onclick="keyPad('3')">3</button>
                <button onclick="keyPad('4')">4</button>
                <button onclick="keyPad('5')">5</button>
                <button onclick="keyPad('6')">6</button>
                <button onclick="keyPad('7')">7</button>
                <button onclick="keyPad('8')">8</button>
                <button onclick="keyPad('9')">9</button>
                <button onclick="keyPad('0')">0</button>
                <button onclick="keyPad('.')">.</button>
                <button onclick="keyPad('DEL')" class="btn-danger">âŒ«</button>
            </div>
            
            <button class="btn-success btn-block" style="margin-top:15px; font-size:1.3rem;" onclick="checkAnswers()">âœ… ç¢ºèªç­”æ¡ˆ</button>
        </div>

        <button class="btn-gray" style="margin-top:20px; width:100px; align-self:center;" onclick="quitQuiz()">ä¸­é€”é€€å‡º</button>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>ğŸ‰ ç·´ç¿’å®Œæˆï¼</h2>
            <div id="result-msg" style="font-size: 1.5rem; margin: 20px 0;"></div>
            <div id="reward-area"></div>
            <button class="btn-primary btn-block" onclick="showPage('page-home')">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        <div class="shop-balance">
            <h3>ç›®å‰æŒæœ‰</h3>
            <div style="font-size:1.5rem; font-weight:bold;">
                <span>ğŸ‘‘ <span id="shop-crowns">0</span></span>
                <span style="margin-left:20px;">ğŸ’ <span id="shop-gems">0</span></span>
            </div>
        </div>
        <div class="settings-panel">
            <input type="text" id="gift-name" class="editor-input" placeholder="è¼¸å…¥çå“åç¨± (å¦‚: çœ‹é›»è¦–10åˆ†é˜)" style="margin-bottom:10px;">
            <input type="number" id="gift-cost" class="editor-input" placeholder="èŠ±è²»æ•¸é‡" min="1" style="margin-bottom:10px;">
            <select id="gift-currency" class="editor-input" style="margin-bottom:10px;">
                <option value="gems">ğŸ’ å¯¶çŸ³</option>
                <option value="crowns">ğŸ‘‘ çš‡å† </option>
            </select>
            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>
        <div style="max-height:150px; overflow-y:auto; color:#666;" id="exchange-log"></div>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›</button>
    </div>

<script>
    /* --- å…¨åŸŸè®Šæ•¸ --- */
    let studentName = "å°å°å­¸å“¡";
    let totalGems = 0;
    let lists = [];
    let poolData = []; 
    let exchangeLog = [];
    
    // ç·¨è¼¯å™¨æš«å­˜
    let editingId = null;
    let tempQs = [];

    // æ¸¬é©—ç‹€æ…‹
    let currentList = null; 
    let currentQuizList = [];
    let currentQIdx = 0;
    let activeInput = null;
    let earnedGemsInSession = 0; // æ”¹ç‚ºç´€éŒ„æœ€å¾Œæ˜¯å¦ç²å¾—çå‹µ
    let readTimerInterval = null; 

    const SK_LISTS = 'math_mem_lists_v4'; 
    const SK_USER = 'math_mem_user_v4';
    const SK_POOL = 'math_mem_pool_v4';

    window.onload = function() {
        loadData();
        updateUI();
        renderLists(); 
    };

    function loadData() {
        // å®‰å…¨è¼‰å…¥ Lists
        try {
            let rawLists = localStorage.getItem(SK_LISTS);
            if(rawLists) {
                let parsed = JSON.parse(rawLists);
                if(Array.isArray(parsed)) {
                    lists = parsed;
                } else {
                    lists = [];
                }
            } else {
                initDefaultList();
            }
        } catch(e) {
            console.error("Lists corrupt", e);
            lists = [];
            initDefaultList();
        }
        
        // å®‰å…¨è¼‰å…¥ Pool
        try {
            let rawPool = localStorage.getItem(SK_POOL);
            if(rawPool) {
                let parsed = JSON.parse(rawPool);
                if(Array.isArray(parsed)) poolData = parsed;
                else poolData = [];
            }
        } catch(e) {
            poolData = [];
        }

        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        try {
            let u = localStorage.getItem(SK_USER);
            if(u) {
                let data = JSON.parse(u);
                studentName = data.name || "å°å°å­¸å“¡";
                totalGems = data.gems || 0;
                exchangeLog = data.log || [];
            }
        } catch(e) {
            console.error("User data corrupt", e);
        }
    }

    function initDefaultList() {
        lists = [{
            name: "ç¯„ä¾‹ç·´ç¿’ (2é¡Œ)",
            timer: 0,
            reward: 10,
            qs: [
                { text: "ä¸€ç›’å·§å…‹åŠ›æœ‰24é¡†ã€‚å°æ˜æœ‰3ç›’ï¼Œä»–æŠŠæ‰€æœ‰çš„å·§å…‹åŠ›å¹³åˆ†çµ¦8ä½æœ‹å‹ï¼Œæ¯ä½æœ‹å‹å¯ä»¥åˆ†åˆ°å¤šå°‘é¡†å·§å…‹åŠ›ï¼Ÿ", keywords: ["24", "3", "8"] },
                { text: "éŠæ¨‚åœ’é–€ç¥¨ä¸€å¼µ200å…ƒï¼Œè€å¸«è²·äº†5å¼µï¼Œä»˜äº†1000å…ƒï¼Œè«‹å•æ‰¾å›å¤šå°‘å…ƒï¼Ÿ", keywords: ["200", "5", "1000"] }
            ]
        }];
        saveData();
    }

    function hardReset() {
        if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰é¡Œåº«å’Œå¯¶çŸ³ã€‚")) {
            localStorage.clear();
            location.reload();
        }
    }

    function saveData() { localStorage.setItem(SK_LISTS, JSON.stringify(lists)); }
    function savePool() { localStorage.setItem(SK_POOL, JSON.stringify(poolData)); }
    function saveUser() { 
        localStorage.setItem(SK_USER, JSON.stringify({name: studentName, gems: totalGems, log: exchangeLog}));
        updateUI();
    }

    /* --- ä»‹é¢å°èˆª --- */
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') { renderLists(); updateUI(); }
        if(pid === 'page-shop') { updateUI(); renderLog(); }
    }

    function updateUI() {
        document.getElementById('display-name').innerText = studentName;
        let c = Math.floor(totalGems/100);
        let g = totalGems % 100;
        document.getElementById('stat-crowns').innerText = c;
        document.getElementById('stat-gems').innerText = g;
        
        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = c;
            document.getElementById('shop-gems').innerText = g;
        }
    }

    function changeName() {
        let n = prompt("è¼¸å…¥ä½ çš„åå­—", studentName);
        if(n) { studentName = n; saveUser(); }
    }

    /* --- èªéŸ³åŠŸèƒ½ --- */
    function speak(text) {
        if(!document.getElementById('opt-voice').checked) return;
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    /* --- ç·¨è¼¯å™¨é‚è¼¯ --- */
    function createNewList() {
        editingId = null;
        tempQs = [];
        document.getElementById('list-name').value = "æ–°çš„ç·´ç¿’é¡Œåº«";
        document.getElementById('list-timer').value = ""; 
        document.getElementById('list-reward').value = "10"; // é è¨­ 10
        document.getElementById('editor-text').value = "";
        document.getElementById('editor-keywords').value = "";
        
        renderEditorRows();
        renderPoolInEditor();
        showPage('page-editor');
    }

    function editList(i) {
        editingId = i;
        tempQs = JSON.parse(JSON.stringify(lists[i].qs));
        document.getElementById('list-name').value = lists[i].name;
        document.getElementById('list-timer').value = lists[i].timer || "";
        document.getElementById('list-reward').value = lists[i].reward || 10;
        document.getElementById('editor-text').value = "";
        document.getElementById('editor-keywords').value = "";
        
        renderEditorRows();
        renderPoolInEditor();
        showPage('page-editor');
    }

    function autoDetectNumbers() {
        let txt = document.getElementById('editor-text').value;
        let nums = txt.match(/\d+/g);
        if(nums) {
            let unique = [...new Set(nums)];
            document.getElementById('editor-keywords').value = unique.join(", ");
        } else {
            alert("æ‰¾ä¸åˆ°æ•¸å­—ï¼");
        }
    }

    function addCurrentToList() {
        let txt = document.getElementById('editor-text').value.trim();
        let kStr = document.getElementById('editor-keywords').value.trim();
        if(!txt) return alert("è«‹è¼¸å…¥é¡Œç›®");
        if(!kStr) return alert("è«‹è¼¸å…¥è¦éš±è—çš„é—œéµå­—");

        let kArr = kStr.split(/[,ï¼Œ\s]+/).filter(k => k.length > 0);
        tempQs.push({ text: txt, keywords: kArr });
        
        document.getElementById('editor-text').value = "";
        document.getElementById('editor-keywords').value = "";
        renderEditorRows();
    }

    function addFromPool(poolIndex) {
        let q = poolData[poolIndex];
        tempQs.push(JSON.parse(JSON.stringify(q)));
        renderEditorRows();
    }

    function renderEditorRows() {
        let div = document.getElementById('editor-rows');
        document.getElementById('count-current').innerText = tempQs.length;
        div.innerHTML = "";
        tempQs.forEach((q, idx) => {
            let row = document.createElement('div');
            row.style.borderBottom = "1px solid #eee";
            row.style.padding = "8px";
            row.style.display = "flex"; row.style.justifyContent="space-between";
            row.innerHTML = `
                <div style="font-size:0.9rem; overflow:hidden; width:85%;">
                    ${q.text} <br> <span style="color:var(--primary); font-size:0.8rem;">éš±è—: ${q.keywords.join(", ")}</span>
                </div>
                <button class="btn-danger" style="padding:2px 8px;" onclick="tempQs.splice(${idx},1); renderEditorRows()">Ã—</button>
            `;
            div.appendChild(row);
        });
    }

    function renderPoolInEditor() {
        const container = document.getElementById('pool-list-container');
        container.innerHTML = '';
        document.getElementById('pool-count').innerText = `${poolData.length}é¡Œ`;
        
        if(poolData.length === 0) {
            container.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">é¡Œåº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåœ¨é¦–é åŒ¯å…¥ JSON</div>';
            return;
        }

        poolData.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'pool-item';
            div.innerHTML = `
                <div style="flex:1; padding-right: 5px;">
                    <div style="white-space: normal; line-height: 1.3;">${q.text}</div>
                    <div style="color:var(--primary); font-size:0.8rem; margin-top:2px;">[${q.keywords.join(",")}]</div>
                </div>
                <button class="btn-success" style="padding:2px 8px; font-size:1.2rem;" onclick="addFromPool(${idx})">ï¼‹</button>
            `;
            container.appendChild(div);
        });
    }
    
    function clearPool() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºç¸½é¡Œåº«å—ï¼Ÿ")) {
            poolData = [];
            savePool();
            renderPoolInEditor();
        }
    }

    function saveList() {
        let name = document.getElementById('list-name').value || "æœªå‘½å";
        let timer = parseInt(document.getElementById('list-timer').value);
        if(isNaN(timer) || timer < 0) timer = 0;
        
        let reward = parseInt(document.getElementById('list-reward').value);
        if(isNaN(reward) || reward < 0) reward = 10;

        if(tempQs.length === 0) return alert("è«‹è‡³å°‘åŠ å…¥ä¸€é¡Œ");
        
        let listObj = { name: name, timer: timer, reward: reward, qs: tempQs };
        
        if(editingId !== null) lists[editingId] = listObj;
        else lists.push(listObj);
        
        saveData();
        showPage('page-home');
    }

    function renderLists() {
        let c = document.getElementById('lists-container'); c.innerHTML = "";
        lists.forEach((l, i) => {
            let item = document.createElement('div');
            item.className = 'list-item';
            let timerBadge = l.timer > 0 ? `<span style="background:#e74c3c; color:white; border-radius:10px; padding:2px 6px; font-size:0.8rem;">â±ï¸${l.timer}s</span>` : '';
            // é¡¯ç¤ºçå‹µå¯¶çŸ³
            let reward = l.reward || 10;
            let gemBadge = `<span style="background:#2980b9; color:white; border-radius:10px; padding:2px 6px; font-size:0.8rem; margin-left:5px;">ğŸ’${reward}</span>`;
            
            item.innerHTML = `
                <div>
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ) ${timerBadge} ${gemBadge}
                </div>
                <div>
                    <button class="btn-success" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                    <button class="btn-info" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="deleteList(${i})">åˆªé™¤</button>
                </div>
            `;
            c.appendChild(item);
        });
    }

    function deleteList(i) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ¸¬é©—å·?")) { lists.splice(i,1); saveData(); renderLists(); }
    }

    /* --- ç·´ç¿’é‚è¼¯ --- */
    function prepareQuiz(idx) {
        currentList = lists[idx]; 
        currentQuizList = JSON.parse(JSON.stringify(currentList.qs));
        showPage('page-mode');
    }

    function startQuiz() {
        currentQIdx = 0;
        earnedGemsInSession = 0; // é‡ç½®
        let allowHelp = document.getElementById('opt-allow-help').checked;
        document.getElementById('btn-help').style.display = allowHelp ? 'inline-block' : 'none';
        showPage('page-quiz');
        loadQuestionPhase1();
    }

    function loadQuestionPhase1() {
        if(readTimerInterval) { clearInterval(readTimerInterval); readTimerInterval = null; }

        let q = currentQuizList[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${currentQuizList.length}`;
        
        document.getElementById('phase-read').style.display = 'block';
        document.getElementById('phase-answer').style.display = 'none';
        
        document.getElementById('read-text').innerText = q.text;
        speak(q.text);

        let timerDisplay = document.getElementById('read-timer');
        let setTime = currentList.timer || 0;

        if(setTime > 0) {
            timerDisplay.style.display = 'block';
            timerDisplay.innerText = setTime;
            
            readTimerInterval = setInterval(() => {
                setTime--;
                timerDisplay.innerText = setTime;
                if(setTime <= 0) {
                    clearInterval(readTimerInterval);
                    goToAnswerPhase(); 
                }
            }, 1000);
        } else {
            timerDisplay.style.display = 'none';
        }
    }

    function goToAnswerPhase() {
        if(readTimerInterval) { clearInterval(readTimerInterval); readTimerInterval = null; }
        
        window.speechSynthesis.cancel();
        document.getElementById('phase-read').style.display = 'none';
        document.getElementById('phase-answer').style.display = 'block';
        
        let q = currentQuizList[currentQIdx];
        let html = q.text;
        
        let sortedKeys = [...q.keywords].sort((a,b) => b.length - a.length);
        let index = 0;
        let map = {};
        
        sortedKeys.forEach(k => {
            let uuid = `__BLANK_${index}__`;
            map[uuid] = k;
            html = html.split(k).join(uuid); 
            index++;
        });

        Object.keys(map).forEach(uuid => {
            let ans = map[uuid];
            let inputHtml = `<input type="text" class="blank-input" readonly onclick="focusInput(this)" data-ans="${ans}">`;
            html = html.split(uuid).join(inputHtml);
        });

        document.getElementById('answer-area').innerHTML = html;
        let firstInput = document.querySelector('.blank-input');
        if(firstInput) focusInput(firstInput);
    }

    function focusInput(el) {
        if(el.classList.contains('correct')) return;
        document.querySelectorAll('.blank-input').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        activeInput = el;
    }

    function keyPad(char) {
        if(!activeInput) return;
        if(char === 'DEL') {
            activeInput.value = activeInput.value.slice(0, -1);
        } else {
            activeInput.value += char;
        }
    }

    function useHelp() {
        let q = currentQuizList[currentQIdx];
        speak("æç¤ºï¼š" + q.text);
    }

    function checkAnswers() {
        let inputs = document.querySelectorAll('.blank-input');
        let allCorrect = true;
        let hasError = false;

        inputs.forEach(inp => {
            if(inp.value === inp.dataset.ans) {
                inp.classList.add('correct');
                inp.classList.remove('wrong', 'active');
            } else {
                allCorrect = false;
                hasError = true;
                inp.classList.add('wrong');
                setTimeout(() => inp.classList.remove('wrong'), 500);
            }
        });

        if(hasError) {
            speak("æœ‰éŒ¯èª¤å–”ï¼Œè«‹å†æª¢æŸ¥ä¸€ä¸‹");
        } else if(allCorrect) {
            speak("å¤ªæ£’äº†ï¼ç­”å°äº†ï¼");
            // ç§»é™¤å–®é¡Œçµ¦åˆ†ï¼Œæ”¹ç‚ºæœ€å¾Œçµ¦ç¸½åˆ†
            // earnedGemsInSession += 5; 
            spawnParticles('ğŸ’');
            setTimeout(nextQuestion, 1500);
        }
    }

    function nextQuestion() {
        currentQIdx++;
        if(currentQIdx < currentQuizList.length) {
            loadQuestionPhase1();
        } else {
            finishQuiz();
        }
    }

    function quitQuiz() {
        if(confirm("ç¢ºå®šè¦ä¸­é€”é€€å‡ºå—ï¼Ÿ(å°‡ç„¡æ³•ç²å¾—çå‹µ)")) {
            if(readTimerInterval) { clearInterval(readTimerInterval); }
            showPage('page-home');
        }
    }

    function finishQuiz() {
        showPage('page-result');
        
        // çµç®—çå‹µï¼šæ ¹æ“šè¨­å®šçš„çå‹µå€¼çµ¦äºˆ
        let reward = currentList.reward !== undefined ? parseInt(currentList.reward) : 10;
        earnedGemsInSession = reward;

        totalGems += earnedGemsInSession;
        saveUser();
        
        document.getElementById('result-msg').innerHTML = `æ­å–œå®Œæˆç·´ç¿’ï¼<br>ç²å¾— <span style="color:#2980b9; font-weight:bold; font-size:2rem;">${earnedGemsInSession}</span> é¡†å¯¶çŸ³ ğŸ’`;
        if(earnedGemsInSession > 0) spawnParticles('ğŸ‘‘');
    }

    function spawnParticles(char) {
        const con = document.getElementById('particle-container');
        con.style.display = 'block'; con.innerHTML = '';
        for(let i=0; i<30; i++) {
            let p = document.createElement('div'); p.className='particle'; p.innerText = char;
            p.style.left = Math.random()*100+'vw';
            p.style.animationDuration = (Math.random()*2+1)+'s';
            con.appendChild(p);
        }
        setTimeout(() => { con.style.display='none'; }, 3000);
    }

    /* --- åŒ¯å…¥åŒ¯å‡ºèˆ‡å•†åº— --- */
    function processExchange() {
        let item = document.getElementById('gift-name').value;
        let cost = parseInt(document.getElementById('gift-cost').value);
        let curr = document.getElementById('gift-currency').value;
        if(!item || isNaN(cost)) return alert("è«‹è¼¸å…¥å®Œæ•´");
        
        let realCost = cost * (curr==='crowns'?100:1);
        if(totalGems < realCost) return alert("é¤˜é¡ä¸è¶³");

        if(confirm(`å…Œæ› ${item}?`)) {
            totalGems -= realCost;
            exchangeLog.unshift({date: new Date().toLocaleDateString(), item: item, cost: cost + (curr==='crowns'?'çš‡å† ':'å¯¶çŸ³')});
            saveUser();
            renderLog();
            alert("å…Œæ›æˆåŠŸ!");
        }
    }

    function renderLog() {
        let div = document.getElementById('exchange-log'); div.innerHTML="";
        exchangeLog.forEach(l => {
            div.innerHTML += `<div>${l.date} - ${l.item} (${l.cost})</div>`;
        });
    }

    function exportData() {
        let data = { lists: lists, pool: poolData, user: {name: studentName, gems: totalGems, log: exchangeLog} };
        downloadJson(data, "Math_Memory_Full_Backup.json");
    }

    function downloadJson(obj, fname) {
        let blob = new Blob([JSON.stringify(obj)], {type: "application/json"});
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = fname; a.click();
    }

    function handleImportToPool(input) {
        let f = input.files[0]; if(!f) return;
        let r = new FileReader();
        r.onload = e => {
            try {
                let json = JSON.parse(e.target.result);
                if(Array.isArray(json)) {
                    let validQs = json.filter(q => q.text && Array.isArray(q.keywords));
                    if(validQs.length > 0) {
                        poolData = poolData.concat(validQs);
                        savePool();
                        alert(`æˆåŠŸåŒ¯å…¥ ${validQs.length} é¡Œåˆ°ç¸½é¡Œåº«ï¼`);
                    } else {
                        alert("åŒ¯å…¥å¤±æ•—ï¼šæ²’æœ‰æœ‰æ•ˆçš„é¡Œç›®");
                    }
                } else {
                    alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤");
                }
            } catch(ex) { alert("æª”æ¡ˆè§£æéŒ¯èª¤"); }
        };
        r.readAsText(f);
        input.value = "";
    }
    
    function handleBackupImport(input) {
        let f = input.files[0]; if(!f) return;
        let r = new FileReader();
        r.onload = e => {
            try {
                let json = JSON.parse(e.target.result);
                if(json.lists) lists = json.lists;
                if(json.pool) poolData = json.pool; 
                if(json.user) {
                    studentName = json.user.name;
                    totalGems = json.user.gems;
                    exchangeLog = json.user.log || [];
                }
                saveData(); savePool(); saveUser(); renderLists();
                alert("å‚™ä»½é‚„åŸæˆåŠŸ");
            } catch(ex) { alert("æª”æ¡ˆè§£æéŒ¯èª¤"); }
        };
        r.readAsText(f);
        input.value = "";
    }

</script>
</body>
</html>
