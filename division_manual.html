<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>除法闖關大師 (精簡版)</title>
    <style>
        :root {
            --primary-color: #2980b9;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --highlight-bg: #f1c40f;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            /* 縮小方格尺寸以適應手機 */
            --cell-size: 30px; 
            --cell-font: 1.3rem;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px; /* 減少外圍留白 */
            margin: 0;
        }

        h1 { 
            color: var(--primary-color); 
            margin: 5px 0 10px 0; 
            font-size: 1.5rem; /* 縮小標題 */
        }

        /* --- Input Section (更緊湊) --- */
        .input-section {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            align-items: flex-end; /* 對齊底部 */
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 800px;
            box-sizing: border-box;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .input-group label { font-size: 0.8rem; color: #7f8c8d; margin-bottom: 2px; }

        .input-section input {
            padding: 5px;
            font-size: 1.1rem;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            width: 100px; /* 縮窄輸入框 */
            text-align: center;
        }

        .input-section input:focus { border-color: var(--primary-color); outline: none; }

        button {
            padding: 6px 15px;
            font-size: 0.95rem;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            height: 36px; /* 固定高度對齊輸入框 */
        }
        .btn-start { background-color: var(--primary-color); }
        .btn-check { background-color: var(--success-color); display: none; }
        .btn-reset { background-color: #95a5a6; }

        /* --- Game Area Layout --- */
        .main-container {
            display: flex;
            /* 手機預設：左側提示在上，右側計算在下 (或並排視寬度而定) */
            flex-direction: column; 
            gap: 10px;
            width: 100%;
            max-width: 1000px;
            align-items: flex-start; /* 靠上對齊 */
        }

        /* Desktop/Tablet: Row Layout (Info Left, Board Right) */
        @media (min-width: 600px) {
            .main-container {
                flex-direction: row; 
                align-items: flex-start;
            }
        }

        /* --- Info Box (放在左邊) --- */
        .info-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 6px solid #bdc3c7;
            transition: border-left-color 0.3s;
            box-sizing: border-box;
            width: 100%;
            /* 在大螢幕時固定寬度，小螢幕時全寬 */
            flex: 1; 
            min-width: 200px;
        }

        .status-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .status-msg {
            font-size: 1rem;
            line-height: 1.4;
            color: #555;
        }

        /* --- Board Wrapper (放在右邊) --- */
        .board-wrapper {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto; /* 允許橫向捲動 */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center; /* 內容置中 */
            align-items: flex-start;
            min-height: 300px;
            flex: 2; /* 佔比較大空間 */
        }

        .grid-container {
            display: grid;
            grid-auto-rows: 40px; /* 縮小行高 */
            column-gap: 0;
        }

        .grid-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            font-family: 'Courier New', monospace;
            font-size: var(--cell-font);
            font-weight: bold;
            width: var(--cell-size);
            height: 40px;
        }

        .game-input {
            width: 26px; /* 微調輸入框大小 */
            height: 30px;
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            border: 2px solid var(--primary-color);
            background-color: var(--highlight-bg);
            border-radius: 4px;
            outline: none;
            padding: 0;
            margin: 0;
        }
        
        .game-input.wrong {
            border-color: var(--error-color);
            background-color: #fab1a0;
            animation: shake 0.4s;
        }

        .val-quo { color: var(--success-color); }
        .val-prod { color: var(--primary-color); }
        .val-rem { color: #e67e22; }
        .val-div { color: var(--text-color); }

        .bracket-cell {
            border-right: 2px solid #2c3e50;
            border-top-right-radius: 10px;
            margin-right: 2px;
        }
        .dividend-cell {
            border-top: 2px solid #2c3e50;
            margin-top: -2px;
        }
        .subtraction-line {
            border-bottom: 2px solid #2c3e50;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
    </style>
</head>
<body>

    <h1>除法闖關大師</h1>
    
    <div class="input-section">
        <div class="input-group">
            <label>被除數</label>
            <input type="text" id="dividend" value="854" placeholder="數字" pattern="\d*" inputmode="numeric">
        </div>
        <div class="input-group">
            <label>除數</label>
            <input type="text" id="divisor" value="2" placeholder="數字" pattern="\d*" inputmode="numeric">
        </div>
        <button class="btn-start" onclick="startGame()">挑戰</button>
        <button class="btn-check" id="checkBtn" onclick="checkAnswer()">確認</button>
        <button class="btn-reset" onclick="resetGame()">重置</button>
    </div>

    <div class="main-container">
        <div class="info-box" id="infoBox">
            <div class="status-title" id="statusTitle">準備挑戰</div>
            <div class="status-msg" id="statusMsg">
                請輸入題目並點擊「挑戰」。<br>
                電腦會用語音鼓勵你喔！
            </div>
        </div>

        <div class="board-wrapper">
            <div class="grid-container" id="gridBoard"></div>
        </div>
    </div>

<script>
    // --- Voice Engine ---
    function speak(text, isHappy = true) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW'; 
            utterance.rate = 1.1; /* 稍微加快語速 */
            utterance.volume = 1;     
            utterance.pitch = isHappy ? 1.2 : 0.9; 
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- Game State ---
    let steps = [];
    let currentStepIndex = 0;
    let dividendStr = "";
    let divisorStr = "";
    
    const gridBoard = document.getElementById('gridBoard');
    const statusTitle = document.getElementById('statusTitle');
    const statusMsg = document.getElementById('statusMsg');
    const infoBox = document.getElementById('infoBox');
    const checkBtn = document.getElementById('checkBtn');

    document.addEventListener('keydown', (e) => {
        if (e.key === "Enter" && checkBtn.style.display !== 'none') checkAnswer();
    });

    function resetGame() {
        gridBoard.innerHTML = '';
        statusTitle.innerText = "準備挑戰";
        statusMsg.innerHTML = "請輸入數字開始遊戲。";
        infoBox.style.borderLeftColor = "#bdc3c7";
        checkBtn.style.display = 'none';
        steps = [];
        currentStepIndex = 0;
        window.speechSynthesis.cancel(); 
        
        // Reset Inputs
        document.getElementById('dividend').value = "";
        document.getElementById('divisor').value = "";
        document.getElementById('dividend').focus();
    }

    function startGame() {
        dividendStr = document.getElementById('dividend').value.trim();
        divisorStr = document.getElementById('divisor').value.trim();

        if (dividendStr === "" || divisorStr === "") {
            alert("請輸入數字！"); return;
        }
        if (!/^\d+$/.test(dividendStr) || !/^\d+$/.test(divisorStr)) {
            alert("請只輸入有效數字！"); return;
        }
        if (BigInt(divisorStr) === 0n) {
            alert("除數不能為 0"); return;
        }

        gridBoard.innerHTML = '';
        statusTitle.innerText = "準備挑戰";
        infoBox.style.borderLeftColor = "#bdc3c7";
        checkBtn.style.display = 'none';
        steps = [];
        currentStepIndex = 0;
        window.speechSynthesis.cancel();
        
        let totalCols = divisorStr.length + 1 + dividendStr.length + 1; 
        // 使用 CSS 變數設定寬度
        gridBoard.style.gridTemplateColumns = `repeat(${totalCols}, var(--cell-size))`;

        renderInitialGrid(dividendStr, divisorStr);
        generateSteps(dividendStr, divisorStr);

        if(steps.length === 0) {
            speak("這個題目太簡單了，請換個難一點的！");
            alert("這個題目不需要計算步驟（整除且無過程）！");
            return;
        }
        
        checkBtn.style.display = 'inline-block';
        speak("挑戰開始，請填寫黃色格子！");
        processNextStep();
    }

    function renderInitialGrid(dStr, divStr) {
        let divLen = divStr.length;
        let startCol = divLen + 1;
        window.dividendStartCol = startCol;
        
        let totalCols = divStr.length + 1 + dStr.length + 2;
        gridBoard.style.gridTemplateColumns = `repeat(${totalCols}, var(--cell-size))`;

        // 預設生成 40 列，足夠一般計算
        for(let r=0; r<40; r++) {
            for(let c=0; c<totalCols; c++) {
                let cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.id = `cell-${r}-${c}`;
                gridBoard.appendChild(cell);
            }
        }

        for(let i=0; i<divLen; i++) {
            let cell = document.getElementById(`cell-1-${i}`);
            cell.innerText = divStr[i];
        }

        document.getElementById(`cell-1-${divLen}`).classList.add('bracket-cell');

        for(let i=0; i<dStr.length; i++) {
            let cell = document.getElementById(`cell-1-${startCol + i}`);
            cell.innerText = dStr[i];
            cell.classList.add('dividend-cell');
        }
    }

    function generateSteps(dStr, divStr) {
        let divisor = BigInt(divStr);
        let currentVal = 0n;
        let currentRow = 1;
        let startCol = window.dividendStartCol;
        let hasStarted = false;

        for (let i = 0; i < dStr.length; i++) {
            let digit = BigInt(dStr[i]);
            currentVal = currentVal * 10n + digit;
            
            if (currentVal >= divisor || hasStarted || (i === dStr.length - 1 && !hasStarted)) {
                hasStarted = true;
                
                let q = currentVal / divisor;
                let prod = q * divisor;
                let rem = currentVal - prod;
                let currentCol = startCol + i;

                steps.push({
                    type: 'input_quotient',
                    row: 0,
                    col: currentCol,
                    correctVal: q.toString(),
                    hint: `算算看 <span style="color:#e67e22;font-weight:bold">${currentVal}</span> ÷ ${divStr}。<br>商是多少？`,
                    voiceSuccess: `答對了！商是 ${q}。`,
                    voiceFail: `加油，${divStr} 乘以多少最接近 ${currentVal}？`,
                    successMsg: `答對了！`,
                    failMsg: `加油！再試一次。`,
                    color: 'val-quo'
                });

                steps.push({
                    type: 'input_product',
                    row: currentRow + 1,
                    col: currentCol,
                    valStr: prod.toString(),
                    hint: `算出 ${q} × ${divStr} 的答案。`,
                    voiceSuccess: `很好！乘積是 ${prod}。`,
                    voiceFail: `乘法算錯囉，再算一次！`,
                    successMsg: `正確！`,
                    failMsg: `乘法錯囉！檢查一下。`,
                    color: 'val-prod'
                });

                currentRow += 2;
                steps.push({
                    type: 'input_remainder',
                    row: currentRow,
                    col: currentCol,
                    valStr: rem.toString(),
                    hint: `減法： ${currentVal} - ${prod} = ?`,
                    voiceSuccess: `正確！餘數是 ${rem}。`,
                    voiceFail: `減法算錯了，再試試！`,
                    successMsg: `很好！`,
                    failMsg: `減法錯囉！加油！`,
                    color: 'val-rem'
                });

                if (i < dStr.length - 1) {
                    let nextDigit = dStr[i+1];
                    steps.push({
                        type: 'input_bring_down',
                        row: currentRow,
                        col: currentCol + 1,
                        correctVal: nextDigit,
                        hint: `把哪個數字降下來？`,
                        voiceSuccess: `沒錯，降下 ${nextDigit}。`,
                        voiceFail: `看被除數後面是誰？`,
                        successMsg: `正確！`,
                        failMsg: `降錯囉，看清楚。`,
                        color: 'val-div'
                    });
                }
                
                currentVal = rem;
            }
        }

        steps.push({
            type: 'finish',
            msg: `恭喜你！全部完成！<br>太厲害了！`,
            voiceSuccess: "恭喜你！完成了所有的計算，你真是太厲害了！"
        });
    }

    function processNextStep() {
        if (currentStepIndex >= steps.length) return;
        let s = steps[currentStepIndex];

        if (s.type === 'finish') {
            speak(s.voiceSuccess, true);
            statusTitle.innerText = "挑戰成功！";
            statusTitle.style.color = "#27ae60";
            statusMsg.innerHTML = s.msg;
            infoBox.style.borderLeftColor = "#27ae60";
            checkBtn.style.display = 'none';
            return;
        }

        statusTitle.innerText = "請輸入答案";
        statusMsg.innerHTML = s.hint;
        infoBox.style.borderLeftColor = "#f1c40f";

        if (s.type === 'input_quotient' || s.type === 'input_bring_down') {
            createInputAt(s.row, s.col);
        } else {
            let str = s.valStr;
            for (let k = 0; k < str.length; k++) {
                let targetCol = s.col - (str.length - 1 - k);
                createInputAt(s.row, targetCol, k);
                if (s.type === 'input_product' && k === str.length - 1) {
                    document.getElementById(`cell-${s.row}-${targetCol}`).classList.add('subtraction-line');
                }
            }
        }
    }

    function createInputAt(row, col, index = 0) {
        let cell = document.getElementById(`cell-${row}-${col}`);
        cell.innerHTML = '';
        let input = document.createElement('input');
        input.type = "text"; 
        input.inputMode = "numeric";
        input.pattern = "[0-9]*";
        input.className = "game-input";
        input.id = `input-${currentStepIndex}-${index}`;
        if (index === 0) setTimeout(() => input.focus(), 50);
        cell.appendChild(input);
    }

    function checkAnswer() {
        let s = steps[currentStepIndex];
        let inputs = document.querySelectorAll('.game-input');
        let userStr = "";
        let allFilled = true;

        inputs.forEach(inp => {
            if(inp.value === "") allFilled = false;
            userStr += inp.value;
        });

        if(!allFilled) return;

        let targetStr = "";
        if (s.type === 'input_quotient' || s.type === 'input_bring_down') {
            targetStr = s.correctVal;
        } else {
            targetStr = s.valStr;
        }

        let isCorrect = (parseInt(userStr) === parseInt(targetStr));

        if (isCorrect) {
            speak(s.voiceSuccess, true);
            
            statusTitle.innerText = "答對了！";
            statusMsg.innerText = s.successMsg;
            infoBox.style.borderLeftColor = "#27ae60";

            inputs.forEach(inp => {
                let parent = inp.parentNode;
                let val = inp.value;
                parent.innerHTML = `<span class="${s.color}">${val}</span>`;
            });

            currentStepIndex++;
            setTimeout(processNextStep, 1500); 
        } else {
            speak(s.voiceFail, false);
            statusTitle.innerText = "加油！";
            statusMsg.innerText = s.failMsg;
            infoBox.style.borderLeftColor = "#c0392b";

            inputs.forEach(inp => {
                inp.classList.add('wrong');
                setTimeout(() => inp.classList.remove('wrong'), 500);
            });
            if(inputs.length > 0) inputs[0].focus();
        }
    }
</script>

</body>
</html>