<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™¤æ³•é—–é—œç‹ 3.1 (å·²ä¿®å¾©)</title>
    <style>
        :root {
            --primary: #2980b9;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            
            /* æ”¾å¤§ç‰ˆé¢è¨­å®š */
            --cell-size: 50px; 
            --font-base: 1.2rem;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
        }

        h1 { color: var(--primary); margin: 10px 0 20px 0; text-align: center; font-size: 2rem; }

        /* --- å­¸å“¡åç‰Œ --- */
        .user-profile {
            background-color: #fff3cd;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: #d35400;
            display: flex; align-items: center; gap: 10px;
        }

        /* --- å®¹å™¨ --- */
        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15); padding: 25px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* --- æŒ‰éˆ• --- */
        button {
            border: none; border-radius: 10px; padding: 12px 24px; 
            font-size: 1.1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 5px; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-block { width: 100%; padding: 15px; margin-top: 15px; font-size: 1.3rem; }

        /* --- åˆ—è¡¨ --- */
        .list-item {
            background: #f8f9fa; border: 2px solid #ddd; padding: 15px; margin-bottom: 10px;
            border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem;
        }
        
        /* --- ç·¨è¼¯å€ --- */
        .gen-controls { 
            display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; 
            background: #eef; padding: 15px; border-radius: 10px; font-size: 1.1rem;
        }
        .gen-controls input { padding: 8px; width: 70px; text-align: center; font-size: 1.1rem; border-radius: 5px; border: 1px solid #ccc;}
        
        .edit-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .edit-row input { padding: 10px; flex: 1; text-align: center; font-size: 1.2rem; border-radius: 5px; border: 1px solid #ccc; }

        /* --- æ¸¬é©—å€ --- */
        .quiz-header { 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; margin-bottom: 20px; background: #eee; padding: 15px; border-radius: 10px; 
            font-size: 1.3rem;
        }
        
        /* é™¤æ³•ç›´å¼ Grid */
        .grid-container {
            display: grid; grid-auto-rows: var(--cell-size); justify-content: center; margin: 20px 0;
            gap: 2px;
        }
        .grid-cell {
            width: var(--cell-size); height: var(--cell-size); 
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', monospace; font-weight: bold; 
            font-size: 1.8rem; position: relative;
        }
        .bracket-cell { border-right: 3px solid #333; border-top-right-radius: 15px; margin-right: 2px; }
        .dividend-cell { border-top: 3px solid #333; margin-top: -3px; }
        .subtraction-line { border-bottom: 3px solid #333; }
        
        .game-input { 
            width: 45px; height: 45px; font-size: 1.5rem; text-align: center; 
            border: 3px solid var(--primary); border-radius: 8px; background: #fff;
            font-weight: bold; outline: none;
        }
        /* é‡é»ï¼šä½œç”¨ä¸­çš„è¼¸å…¥æ¡†æ¨£å¼ */
        .game-input.active-input {
            background-color: #ffab40 !important; /* æ©™è‰²åº• */
            border-color: #d35400;
            box-shadow: 0 0 10px rgba(255, 171, 64, 0.5);
        }

        /* æ¸¬é©—æ¨¡å¼ */
        .test-mode-box { text-align: center; padding: 30px; font-size: 1.8rem; }
        .test-input { font-size: 1.8rem; padding: 10px; width: 100px; text-align: center; margin: 10px; border-radius: 8px; border: 2px solid #ccc;}

        /* è©³ç´°çµæœè¡¨æ ¼ */
        .result-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .result-table th, .result-table td {
            border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 1.1rem;
        }
        .result-table th { background-color: #f2f2f2; }
        .res-correct { color: var(--success); font-weight: bold; }
        .res-wrong { color: var(--danger); font-weight: bold; }

        .tabs { display: flex; border-bottom: 3px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: #777; font-weight: bold; font-size: 1.2rem;}
        .tab.active { color: var(--primary); border-bottom: 5px solid var(--primary); }

        /* ç‰ˆæœ¬è™Ÿæ¨™ç±¤ */
        .version-tag {
            margin-top: 30px;
            color: #bdc3c7;
            font-size: 0.9rem;
            text-align: center;
            font-family: monospace;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }

    </style>
</head>
<body>

    <div id="page-home" class="container active">
        <h1>â— é™¤æ³•é—–é—œç‹</h1>
        
        <div class="user-profile" onclick="changeName()">
            <span>ğŸ“</span> <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> <span>âœ</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡º</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv3.1 (é™¤æ³•é—–é—œç‹ - å·²ä¿®å¾©)</div>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:15px;">
            åç¨±: <input type="text" id="list-name" style="padding:8px; width:250px; font-size:1.2rem;">
        </div>
        <div class="gen-controls">
            <span>è‡ªå‹•ç”Ÿæˆ:</span>
            é¡Œæ•¸ <input type="number" id="gen-count" value="5">
            è¢«é™¤æ•¸ä½æ•¸ <input type="number" id="gen-len-a" value="3">
            é™¤æ•¸ä½æ•¸ <input type="number" id="gen-len-b" value="1">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>
        <div id="editor-rows" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        <div style="margin-top:25px; display:flex; gap:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– æ•™å­¸æ¨¡å¼</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ æ¸¬é©—æ¨¡å¼</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:30px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <button class="btn-danger" onclick="quitQuiz()">ğŸšª é€€å‡º</button>
        </div>

        <div id="teach-area" style="display:none;">
            <div id="teach-msg"></div>
            <div class="grid-container" id="gridBoard"></div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="font-size:3rem; margin-bottom:30px; font-family: monospace;"></div>
                å•†: <input type="number" id="test-quo" class="test-input"> <br>
                é¤˜: <input type="number" id="test-rem" class="test-input"> <br><br>
                <button class="btn-primary" onclick="checkTestAnswer()">é€å‡ºç­”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 4rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-summary" style="font-size: 1.5rem; margin-bottom: 15px;"></div>
            
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="result-table">
                    <thead><tr><th>é¡Œç›®</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>çµæœ</th></tr></thead>
                    <tbody id="res-table-body"></tbody>
                </table>
            </div>

            <button class="btn-warning btn-block" onclick="saveRank()">ç™»è¨˜è‹±é›„æ¦œ</button>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    // --- èªéŸ³ ---
    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let clean = text.replace(/<[^>]*>/g, '');
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'zh-TW'; u.rate = 1.1; 
            window.speechSynthesis.speak(u);
        }
    }

    // --- è³‡æ–™ ---
    let allLists = [], currentList = null, quizData = [];
    let currentQIdx = 0, currentMode = '', studentName = 'å°å°å­¸å“¡';
    let timerInt, startTime;
    let rankData = [];
    
    // â˜…â˜…â˜… ä¿®å¾©é» 1ï¼šå…¨åŸŸå®£å‘Šç·¨è¼¯IDï¼Œé¿å… undefined å•é¡Œ â˜…â˜…â˜…
    let editingId = null;

    window.onload = function() {
        if(localStorage.getItem('div_v3_lists')) allLists = JSON.parse(localStorage.getItem('div_v3_lists'));
        else { allLists = [{name: "åŸºç¤é™¤æ³•", qs: [{a:84, b:2}, {a:96, b:3}, {a:48, b:4}]}]; saveData(); }
        if(localStorage.getItem('div_v3_rank')) rankData = JSON.parse(localStorage.getItem('div_v3_rank'));
        if(localStorage.getItem('div_student')) studentName = localStorage.getItem('div_student');
        
        updateName();
        renderLists();
    };

    function saveData() { localStorage.setItem('div_v3_lists', JSON.stringify(allLists)); }
    function saveRankData() { localStorage.setItem('div_v3_rank', JSON.stringify(rankData)); }
    
    // --- å­¸å“¡å§“å ---
    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) { studentName = n.trim(); localStorage.setItem('div_student', studentName); updateName(); }
    }
    function updateName() { document.getElementById('display-name').innerText = studentName; }

    // --- å°èˆª ---
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- é¡Œåº«ç®¡ç† ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            d.innerHTML = `<div><strong>${l.name}</strong> (${l.qs.length}é¡Œ)</div><div><button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button><button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button><button class="btn-danger" onclick="delList(${i})">åˆª</button></div>`;
            c.appendChild(d);
        });
    }
    
    // â˜…â˜…â˜… ä¿®å¾©é» 2ï¼šæ–°å¢é¡Œåº«æ™‚ç¢ºå¯¦é‡ç½® editingId ç‚º null â˜…â˜…â˜…
    function createNewList() { 
        editingId = null; 
        document.getElementById('list-name').value="æ–°é¡Œåº«"; 
        document.getElementById('editor-rows').innerHTML=''; 
        showPage('page-editor'); 
    }
    
    function editList(i) { editingId=i; const l=allLists[i]; document.getElementById('list-name').value=l.name; document.getElementById('editor-rows').innerHTML=''; l.qs.forEach(q=>addEditRow(q.a,q.b)); showPage('page-editor'); }
    function addEditRow(a='', b='') { const d=document.createElement('div'); d.className='edit-row'; d.innerHTML=`<input type="number" class="inp-a" value="${a}">Ã·<input type="number" class="inp-b" value="${b}"><button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`; document.getElementById('editor-rows').appendChild(d); }
    
    function saveList() { 
        const n=document.getElementById('list-name').value; 
        const rs=document.querySelectorAll('.edit-row'); 
        const qs=[]; 
        rs.forEach(r=>{const a=parseInt(r.querySelector('.inp-a').value); const b=parseInt(r.querySelector('.inp-b').value); if(a&&b)qs.push({a,b})}); 
        if(qs.length<1)return alert("è«‹è¼¸å…¥é¡Œç›®"); 
        
        // ä¿®æ­£å¾Œçš„åˆ¤æ–·é‚è¼¯
        if(editingId===null) allLists.push({name:n,qs}); 
        else allLists[editingId]={name:n,qs}; 
        
        saveData(); 
        showPage('page-home'); 
        editingId=null; 
    }
    
    function delList(i) { if(confirm("åˆªé™¤ï¼Ÿ")){allLists.splice(i,1); saveData(); renderLists();} }
    function autoGenerate() { const c=document.getElementById('gen-count').value; const la=document.getElementById('gen-len-a').value; const lb=document.getElementById('gen-len-b').value; document.getElementById('editor-rows').innerHTML=''; for(let i=0;i<c;i++){let b=Math.floor(Math.random()*Math.pow(10,lb)); if(b<2)b=2; let a=Math.floor(Math.random()*Math.pow(10,la)); addEditRow(a,b);} }
    function exportData() { const b=new Blob([JSON.stringify(allLists)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="div_data.json"; a.click(); }
    function handleImport(inp) { const f=inp.files[0]; const r=new FileReader(); r.onload=(e)=>{ try{allLists=allLists.concat(JSON.parse(e.target.result));saveData();renderLists();alert("åŒ¯å…¥æˆåŠŸ");}catch(x){alert("éŒ¯èª¤");} }; r.readAsText(f); }

    // --- æ¸¬é©—é‚è¼¯ ---
    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        // åˆå§‹åŒ–è³‡æ–™ï¼šåŠ ä¸Šä½¿ç”¨è€…ä½œç­”ç´€éŒ„
        quizData = currentList.qs.map(q => ({
            a: q.a, b: q.b, 
            userQ: null, userR: null, isCorrect: false,
            steps: [], stepIdx: 0
        }));
        
        if(mode === 'teach') {
            quizData.forEach(q => { q.steps = generateDivSteps(q.a, q.b); });
        }

        currentQIdx = 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        
        showPage('page-quiz');
        speak(`${studentName}ï¼Œæ­¡è¿ä¾†åˆ°${mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼'}ï¼Œæº–å‚™é–‹å§‹å›‰ï¼`);
        loadQuestion();
    }

    function updTime() {
        const s = Math.floor((Date.now()-startTime)/1000);
        document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡ºï¼Ÿ")) { clearInterval(timerInt); showPage('page-home'); } }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        
        if(currentMode === 'test') {
            document.getElementById('teach-area').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
            document.getElementById('test-q-text').innerText = `${q.a} Ã· ${q.b} = ?`;
            document.getElementById('test-quo').value = '';
            document.getElementById('test-rem').value = '';
            document.getElementById('test-quo').focus();
        } else {
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('teach-area').style.display = 'block';
            renderTeachGrid(q);
        }
    }

    // --- æ¸¬é©—æ¨¡å¼ï¼šç«‹å³åˆ¤å®š ---
    function checkTestAnswer() {
        const q = quizData[currentQIdx];
        const uQ = document.getElementById('test-quo').value;
        const uR = document.getElementById('test-rem').value;
        
        if(uQ === '' || uR === '') { alert("è«‹è¼¸å…¥å•†å’Œé¤˜æ•¸(è‹¥ç„¡é¤˜æ•¸è«‹å¡«0)"); return; }

        q.userQ = parseInt(uQ);
        q.userR = parseInt(uR);
        
        const ansQ = Math.floor(q.a / q.b);
        const ansR = q.a % q.b;
        
        if(q.userQ === ansQ && q.userR === ansR) {
            q.isCorrect = true;
            speak(`ç­”å°äº†ï¼${studentName}çœŸæ£’ï¼`);
            alert("âœ… æ­£ç¢ºï¼");
        } else {
            q.isCorrect = false;
            speak(`å“å‘€ï¼Œç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯å•†${ansQ}ï¼Œé¤˜æ•¸${ansR}ã€‚`);
            alert(`âŒ éŒ¯èª¤ï¼\næ­£ç¢ºç­”æ¡ˆï¼šå•† ${ansQ} ... é¤˜ ${ansR}`);
        }

        // ä¸‹ä¸€é¡Œæˆ–çµæŸ
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    // --- æ•™å­¸æ¨¡å¼ï¼šè‡ªå‹•èšç„¦èˆ‡é¡è‰² ---
    function generateDivSteps(dividend, divisor) {
        /* åŒå‰ç‰ˆé‚è¼¯ï¼Œç”¢ç”Ÿé™¤æ³•æ­¥é©Ÿ */
        let dStr = dividend.toString();
        let steps = [];
        let curRem = 0;
        let row = 1;
        let offset = 6 - dStr.length;

        for(let i=0; i<dStr.length; i++) {
            let digit = parseInt(dStr[i]);
            let working = curRem * 10 + digit;
            let quo = Math.floor(working / divisor);
            let prod = quo * divisor;
            let rem = working - prod;
            let col = offset + i;

            if(!(i===0 && quo===0)) { 
                steps.push({ type:'quo', r:0, c:col, ans:quo, hint: `çœ‹ ${working} Ã· ${divisor}ï¼Œå•†å¤šå°‘ï¼Ÿ` });
            } else {
                curRem = working; continue;
            }
            steps.push({ type:'prod', r:row+1, c:col, ans:prod, hint: `${quo} Ã— ${divisor} = ?`, align:'right' });
            row += 2;
            steps.push({ type:'rem', r:row, c:col, ans:rem, hint: `${working} - ${prod} = ?`, align:'right' });

            if(i < dStr.length - 1) {
                let next = dStr[i+1];
                steps.push({ type:'drop', r:row, c:col+1, ans:next, hint: `æŠŠ ${next} é™ä¸‹ä¾†` });
            }
            curRem = rem;
        }
        return steps;
    }

    function renderTeachGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML='';
        const msg = document.getElementById('teach-msg');
        const cols = 8;
        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
        
        // ç¹ªè£½ç©ºç¶²æ ¼
        for(let r=0; r<20; r++) {
            for(let c=0; c<cols; c++) {
                const cell = document.createElement('div');
                cell.className='grid-cell'; cell.id=`c-${r}-${c}`;
                box.appendChild(cell);
            }
        }
        // å¡«é¡Œç›®æ•¸å­—
        const dStr = q.a.toString();
        const offset = 6 - dStr.length;
        document.getElementById(`c-1-${offset-2}`).innerText = q.b;
        document.getElementById(`c-1-${offset-1}`).classList.add('bracket-cell');
        for(let i=0; i<dStr.length; i++) {
            const cell = document.getElementById(`c-1-${offset+i}`);
            cell.innerText = dStr[i];
            cell.classList.add('dividend-cell');
        }

        // å¡«å…¥å·²å®Œæˆæ­¥é©Ÿ
        for(let i=0; i<q.stepIdx; i++) {
            const s = q.steps[i];
            fillCell(s.r, s.c, s.ans, s.type);
        }

        // åˆ¤æ–·æ˜¯å¦å®Œæˆ
        if(q.stepIdx >= q.steps.length) {
            msg.innerText = "å¤ªæ£’äº†ï¼æœ¬é¡Œå®Œæˆã€‚";
            q.isCorrect = true; // æ•™å­¸æ¨¡å¼å®Œæˆè¦–ç‚ºæ­£ç¢º
            
            const btn = document.createElement('button'); btn.className='btn-primary';
            if(currentQIdx < quizData.length-1) {
                btn.innerText = "ä¸‹ä¸€é¡Œ â¡";
                btn.onclick = () => { currentQIdx++; loadQuestion(); };
            } else {
                btn.innerText = "æŸ¥çœ‹æˆç¸¾ ğŸ†";
                btn.onclick = () => finishQuiz();
            }
            msg.appendChild(document.createElement('br'));
            msg.appendChild(btn);
            return;
        }

        // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿè¼¸å…¥æ¡†
        let cur = q.steps[q.stepIdx];
        msg.innerText = cur.hint;
        speak(cur.hint);

        const targetCell = document.getElementById(`c-${cur.r}-${cur.c}`);
        targetCell.innerHTML = '';
        const inp = document.createElement('input');
        inp.type='tel'; 
        inp.className='game-input active-input'; // åŠ å…¥ active class é¡¯ç¤ºæ©™è‰²
        
        // è‡ªå‹•èšç„¦
        setTimeout(() => inp.focus(), 100);

        inp.onkeydown = (e) => { if(e.key === 'Enter') checkTeachAnswer(inp, cur, q); };
        targetCell.appendChild(inp);
        
        const okBtn = document.createElement('button'); okBtn.className='btn-warning'; okBtn.innerText='OK';
        okBtn.onclick = () => checkTeachAnswer(inp, cur, q);
        msg.appendChild(document.createElement('br')); msg.appendChild(okBtn);
    }

    function fillCell(r, c, val, type) {
        const str = val.toString();
        for(let i=0; i<str.length; i++) {
            let tc = c - (str.length-1) + i; 
            let cell = document.getElementById(`c-${r}-${tc}`);
            if(cell) {
                cell.innerText = str[i];
                if(type==='prod' && i===str.length-1) cell.classList.add('subtraction-line');
            }
        }
    }

    function checkTeachAnswer(inp, step, q) {
        if(parseInt(inp.value) === parseInt(step.ans)) {
            speak("ç­”å°äº†ï¼");
            q.stepIdx++;
            renderTeachGrid(q);
        } else {
            speak("ç®—éŒ¯å›‰");
            inp.value=''; inp.focus();
        }
    }

    // --- çµç®—ç•«é¢ ---
    function finishQuiz() {
        clearInterval(timerInt);
        showPage('page-result');
        
        const correctCount = quizData.filter(q => q.isCorrect).length;
        const score = Math.round((correctCount / quizData.length) * 100);
        
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-summary').innerText = `${studentName}ï¼Œä½ ç­”å°äº† ${correctCount} / ${quizData.length} é¡Œï¼`;
        
        // ç”Ÿæˆè©³ç´°å ±è¡¨
        const tbody = document.getElementById('res-table-body');
        tbody.innerHTML = '';
        quizData.forEach(q => {
            const tr = document.createElement('tr');
            const ansQ = Math.floor(q.a/q.b);
            const ansR = q.a%q.b;
            
            // æ•™å­¸æ¨¡å¼æ²’æœ‰ userQï¼Œç›´æ¥ç•¶ä½œé€šé
            let userTxt = (currentMode==='teach') ? "(æ•™å­¸å®Œæˆ)" : `å•†${q.userQ} é¤˜${q.userR}`;
            let status = q.isCorrect ? '<span class="res-correct">O</span>' : '<span class="res-wrong">X</span>';
            
            tr.innerHTML = `
                <td>${q.a} Ã· ${q.b}</td>
                <td>${userTxt}</td>
                <td>${ansQ} ... ${ansR}</td>
                <td>${status}</td>
            `;
            tbody.appendChild(tr);
        });
        
        let praise = score===100?"å…¨å°ï¼å¤ªç¥äº†ï¼":score>=60?"è¡¨ç¾ä¸éŒ¯ï¼":"å†åŠ æ²¹å–”ï¼";
        speak(`æ¸¬é©—çµæŸï¼Œä½ å¾—äº†${score}åˆ†ã€‚${praise}`);
    }

    function saveRank() {
        const t = document.getElementById('q-timer').innerText;
        const s = document.getElementById('res-score').innerText;
        rankData.push({name: studentName, score: parseInt(s), time: t, list: currentList.name});
        saveRankData(); alert("å·²ç™»è¨˜"); switchTab('rank'); showPage('page-home');
    }

    function renderRank() {
        const box = document.getElementById('rank-container'); box.innerHTML='';
        rankData.sort((a,b)=>b.score-a.score || a.time.localeCompare(b.time));
        rankData.forEach((r,i)=>{
            const d=document.createElement('div'); d.className='rank-item';
            if(i===0) d.classList.add('rank-1');
            d.innerHTML=`<span>${i+1}. ${r.name} (${r.list})</span><span>${r.score}åˆ† <small>${r.time}</small></span>`;
            box.appendChild(d);
        });
    }
    function clearRank() { if(confirm("æ¸…ç©º?")){rankData=[]; saveRankData(); renderRank();} }

</script>

</body>
</html>
