<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™¤æ³•é—–é—œç‹ 5.2 (é®ä½æ³•å¼•å°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2980b9;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --help: #8e44ad;
            
            --hint-high: #27ae60;
            --hint-low: #2980b9;

            --cell-size: 42px; 
            --font-base: 1.1rem;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #fdfefe;
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0 15px 0; text-align: center; font-size: 1.8rem; }

        /* æ¨™é¡Œåˆ—èˆ‡æŒ‰éˆ• */
        .quiz-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-weight: bold; 
            margin-bottom: 5px; 
            background: #eee; 
            padding: 8px 12px; 
            border-radius: 10px; 
            font-size: 1.1rem;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
        }

        .header-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            overflow: hidden;
            font-size: 1rem;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-header-quit, .btn-header-next {
            padding: 6px 12px;
            font-size: 0.95rem;
            border-radius: 8px;
            margin: 0;
            border: none;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        .btn-header-quit { background-color: var(--danger); color: white; }
        .btn-header-next {
            background-color: var(--success);
            color: white;
            box-shadow: 0 2px 5px rgba(39, 174, 96, 0.4);
            animation: pulse-green 1.5s infinite;
        }

        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* å®¹å™¨ */
        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15); 
            padding: 15px; 
            margin-bottom: 20px;
            display: none;
            box-sizing: border-box;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* ä¸€èˆ¬æŒ‰éˆ• */
        button {
            border: none; border-radius: 10px; padding: 10px 20px; 
            font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 5px; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-help { background-color: var(--help); }
        .btn-gray { background-color: #95a5a6; }
        .btn-accent { background-color: #f39c12; }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; font-size: 1.2rem; }

        /* å…¶ä»–ä»‹é¢å…ƒç´  */
        .user-profile {
            background-color: #d6eaf8;
            border: 2px dashed var(--primary);
            border-radius: 15px;
            padding: 8px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark);
            display: flex; align-items: center; gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .stats-badge { background: #fff; padding: 5px 12px; border-radius: 20px; font-size: 1rem; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #f0f3f4; padding: 5px; border-radius: 30px; }
        .tab { flex: 1; text-align: center; padding: 10px 20px; cursor: pointer; color: #7f8c8d; font-weight: bold; border-radius: 25px; }
        .tab.active { color: white; background-color: var(--primary); }

        .list-item { background: #f8f9fa; border: 2px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .gem-tag { color: #2980b9; background: #d6eaf8; padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; margin-left: 5px;}
        .teach-gem-tag { color: #27ae60; background: #d5f5e3; padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; margin-left: 5px;}
        .score-tag { color: #d35400; background: #fdebd0; padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; margin-left: 5px;}
        
        /* ç·¨è¼¯å€æ¨£å¼ */
        .gen-controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; background: #eef; padding: 15px; border-radius: 10px; }
        .gen-controls input { padding: 8px; width: 60px; text-align: center; border-radius: 5px; border: 1px solid #ccc;}
        
        /* é¡Œç›®ç·¨è¼¯åˆ— */
        .edit-row { 
            display: flex; gap: 10px; margin-bottom: 8px; align-items: center; 
            background: #fff; padding: 5px; border-radius: 5px; border: 1px solid #eee;
        }
        .edit-row input { padding: 8px; flex: 1; text-align: center; border-radius: 5px; border: 1px solid #ccc; font-size: 1.1rem; }
        
        /* å•†åº—åˆ—æ¨£å¼ */
        .shop-row { 
            display: flex; gap: 10px; margin-bottom: 8px; align-items: center; 
            background: #fff; padding: 5px; border-radius: 5px; border: 1px solid #eee;
        }
        
        .settings-box { background-color: #f0f8ff; border: 2px solid #bcdbf3; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .checkbox-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;}
        .checkbox-item { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        .checkbox-item input { width: 20px; height: 20px; cursor: pointer; }
        
        /* ç®—å¼å€ */
        .grid-container {
            display: grid; grid-auto-rows: var(--cell-size); justify-content: center; 
            margin: 5px 0; 
            gap: 0; 
        }
        .grid-cell {
            width: var(--cell-size); height: var(--cell-size); 
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', monospace; font-weight: bold; 
            font-size: 1.6rem; position: relative; margin: 0; border: 1px solid transparent; 
        }
        .bracket-cell { border-right: 3px solid #333; border-top-right-radius: 15px; margin-right: 0px; }
        .dividend-cell { border-top: 3px solid #333; margin-top: -3px; }
        .subtraction-line { border-bottom: 3px solid #333 !important; }
        
        .hl-high { color: var(--hint-high); font-weight: 900; transform: scale(1.2); transition: 0.3s; }
        .hl-low { color: var(--hint-low); font-weight: 900; transform: scale(1.2); transition: 0.3s; }

        .game-input { 
            width: 36px; height: 36px; font-size: 1.3rem; text-align: center; 
            border: 2px solid var(--primary); border-radius: 6px; background: #fff;
            font-weight: bold; outline: none; z-index: 10; padding: 0;
        }
        .game-input.active-input { background-color: #ffab40 !important; border-color: #d35400; }

        /* æ±‚åŠ©èˆ‡çµæœ */
        .help-box { display: none; background-color: #f4ecf7; border-left: 6px solid #8e44ad; padding: 10px; margin-top: 10px; border-radius: 8px; text-align: left; animation: slideDown 0.3s; }
        .help-table { width: 100%; margin-top: 5px; font-family: monospace; }
        .help-row { display: flex; justify-content: space-between; padding: 2px 0; }
        .help-correct { color: #27ae60; background: #d5f5e3; padding: 0 5px; border-radius: 4px; }
        .help-wrong { color: #c0392b; opacity: 0.7; }

        .test-mode-box { text-align: center; padding: 20px; font-size: 1.5rem; }
        .test-input { font-size: 1.5rem; padding: 8px; width: 80px; text-align: center; margin: 10px; border-radius: 8px; border: 2px solid #ccc;}

        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .result-table th { background-color: #f2f2f2; }
        .res-correct { color: var(--success); font-weight: bold; }
        .res-wrong { color: var(--danger); font-weight: bold; }

        .version-tag { margin-top: 30px; color: #bdc3c7; font-size: 0.9rem; text-align: center; border-top: 1px dashed #eee; padding-top: 10px; }

        .shop-balance { background: linear-gradient(135deg, #2980b9 0%, #6dd5fa 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .exchange-form { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .reward-popup { background: #fff8e1; border: 3px solid #f1c40f; padding: 20px; border-radius: 15px; margin-top: 20px; font-weight: bold; color: #d35400; font-size: 1.5rem; text-align: center; animation: bounceIn 0.8s; }
        
        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; display: none; }
        .particle { position: absolute; font-size: 2rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>â— é™¤æ³•é—–é—œç‹</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" style="width:100%; border-radius:25px;">é¸æ“‡é¡Œåº«</div>
        </div>

        <div id="tab-quiz">
            <button class="btn-accent btn-block" style="margin-bottom:15px; box-shadow:0 4px #d35400;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥é¡Œåº«</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv5.2 (é®ä½æ³•å¼•å°ç‰ˆ)</div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        
        <div class="shop-balance">
            <h3>ç›®å‰æŒæœ‰</h3>
            <div class="balance-row">
                <span>ğŸ‘‘ <span id="shop-crowns">0</span></span>
                <span>ğŸ’ <span id="shop-gems">0</span></span>
            </div>
        </div>

        <div class="exchange-form">
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">æˆ‘è¦å…Œæ›...</div>
            <div style="margin-bottom: 15px;">
                <input type="text" id="gift-name" class="exchange-input" style="width:100%; box-sizing:border-box;" placeholder="è¼¸å…¥çå“åç¨± (å¦‚: çœ‹é›»è¦–10åˆ†é˜)">
            </div>
            
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">éœ€è¦èŠ±è²»</div>
            <div class="shop-row"> <input type="number" id="gift-cost" class="exchange-input" placeholder="æ•¸é‡" min="1">
                <select id="gift-currency" class="exchange-input" style="background:white;">
                    <option value="gems">ğŸ’ å¯¶çŸ³</option>
                    <option value="crowns">ğŸ‘‘ çš‡å† </option>
                </select>
            </div>

            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>

        <div style="margin-top:20px;">
            <h4>ğŸ“œ å…Œæ›ç´€éŒ„</h4>
            <div id="exchange-log" class="log-list"></div>
        </div>

        <button class="btn-gray btn-block" style="margin-top:20px;" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background:#eee; padding:15px; border-radius:10px;">
            <div style="flex:100%">åç¨±: <input type="text" id="list-name" style="padding:8px; width:70%; font-size:1rem;"></div>
            <div>ğŸ’ æ¸¬é©—å¯¶çŸ³: <input type="number" id="list-gems" style="padding:8px; width:60px;" value="5"></div>
            <div>ğŸ’ æ•™å­¸å¯¶çŸ³: <input type="number" id="list-teach-gems" style="padding:8px; width:60px;" value="2"></div>
            <div>ğŸ¯ ç²çåˆ†æ•¸: <input type="number" id="list-pass-score" style="padding:8px; width:60px;" value="100"></div>
        </div>
        
        <div class="gen-controls">
            <span>è‡ªå‹•ç”Ÿæˆ:</span>
            é¡Œæ•¸ <input type="number" id="gen-count" value="5">
            è¢«é™¤æ•¸ä½æ•¸ <input type="number" id="gen-len-a" value="3">
            é™¤æ•¸ä½æ•¸ <input type="number" id="gen-len-b" value="2">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>

        <div id="editor-rows" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; padding: 5px;"></div>
        
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ é¡Œç›®</button>
        
        <div style="margin-top:25px; display:flex; gap:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜é¡Œåº«</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div class="settings-box">
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º</label>
                <label class="checkbox-item"><input type="checkbox" id="opt-text" checked> ğŸ“ æ–‡å­—æç¤º</label>
                <label class="checkbox-item"><input type="checkbox" id="opt-help" checked> ğŸ’¡ å…è¨±æ±‚æ•‘</label>
            </div>
        </div>
        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– é€²å…¥æ•™å­¸æ¨¡å¼</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ é€²å…¥æ¸¬é©—æ¨¡å¼</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:30px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <div class="header-info">
                <span id="q-info">1/5</span>
                <span style="color:#aaa;">|</span>
                <span id="q-timer">00:00</span>
            </div>
            <div class="header-buttons">
                <button id="btn-next-q" class="btn-header-next" style="display:none;" onclick="goToNext()">ä¸‹ä¸€é¡Œ â¡</button>
                <button class="btn-header-quit" onclick="quitQuiz()">é€€å‡º âœ•</button>
            </div>
        </div>

        <div id="teach-area" style="display:none;">
            <div style="text-align: center; margin-bottom: 5px;">
                <div id="teach-msg" style="color:#8e44ad; font-weight:bold; font-size:1.1rem; min-height:1.2em; margin-bottom:5px;"></div>
                <div style="margin-bottom: 5px;">
                    <button id="btn-help-trigger" class="btn-help" style="padding: 5px 15px; font-size: 1rem;" onclick="toggleHelp()">ğŸ’¡ æ±‚åŠ© (é¡¯ç¤ºç­”æ¡ˆ)</button>
                </div>
                <div id="help-content" class="help-box"></div>
            </div>
            <div class="grid-container" id="gridBoard"></div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="font-size:2.5rem; margin-bottom:20px; font-family: monospace;"></div>
                å•†: <input type="number" id="test-quo" class="test-input"> <br>
                é¤˜: <input type="number" id="test-rem" class="test-input"> <br><br>
                <button class="btn-primary" onclick="checkTestAnswer()">é€å‡ºç­”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 4rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-summary" style="font-size: 1.5rem; margin-bottom: 15px;"></div>
            
            <div id="reward-area"></div>

            <div style="max-height: 300px; overflow-y: auto;">
                <table class="result-table">
                    <thead><tr><th>é¡Œç›®</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>çµæœ</th></tr></thead>
                    <tbody id="res-table-body"></tbody>
                </table>
            </div>

            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let quizSettings = { voice: true, text: true, allowHelp: true };
    let studentName = 'å°å°å­¸å“¡';
    let totalGems = 0; 
    let allLists = [], currentList = null, quizData = [];
    let currentQIdx = 0, currentMode = '', editingId = null;
    let timerInt, startTime;
    let exchangeLog = [];

    const STORAGE_KEY_LISTS = 'div_v5_0_lists';
    const STORAGE_KEY_USER = 'div_v5_0_user';
    const STORAGE_KEY_GEMS = 'div_v5_0_gems';
    const STORAGE_KEY_EXCHANGE = 'div_v5_0_exchange';

    // --- èªéŸ³åŠŸèƒ½ ---
    function speak(text) {
        let force = text.includes("å¯¶çŸ³") || text.includes("çš‡å† ") || text.includes("å…¨å°") || text.includes("å…Œæ›æˆåŠŸ");
        if(currentMode === 'teach' && !quizSettings.voice && !force) return;

        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let clean = text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
            clean = clean.replace(/Ã—/g, 'ä¹˜').replace(/Ã·/g, 'é™¤ä»¥').replace(/-/g, 'æ¸›');
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'zh-TW'; u.rate = 1.0; 
            window.speechSynthesis.speak(u);
        }
    }

    // --- åˆå§‹åŒ–èˆ‡è³‡æ–™è®€å¯« ---
    window.onload = function() {
        if(localStorage.getItem(STORAGE_KEY_LISTS)) allLists = JSON.parse(localStorage.getItem(STORAGE_KEY_LISTS));
        else { allLists = [{name: "ç¯„ä¾‹ï¼šä¼°ç®—ç·´ç¿’", gems: 5, teachGems: 2, passScore: 100, qs: [{a:9564, b:24}, {a:2584, b:348}]}]; saveData(); }
        
        if(localStorage.getItem(STORAGE_KEY_USER)) studentName = localStorage.getItem(STORAGE_KEY_USER);
        if(localStorage.getItem(STORAGE_KEY_GEMS)) totalGems = parseInt(localStorage.getItem(STORAGE_KEY_GEMS)) || 0;
        if(localStorage.getItem(STORAGE_KEY_EXCHANGE)) exchangeLog = JSON.parse(localStorage.getItem(STORAGE_KEY_EXCHANGE));
        
        updateProfile();
        renderLists();
        renderExchangeLog();
    };

    function saveData() { localStorage.setItem(STORAGE_KEY_LISTS, JSON.stringify(allLists)); }
    function saveStudentData() {
        localStorage.setItem(STORAGE_KEY_USER, studentName);
        localStorage.setItem(STORAGE_KEY_GEMS, totalGems);
        localStorage.setItem(STORAGE_KEY_EXCHANGE, JSON.stringify(exchangeLog));
        updateProfile();
    }
    
    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) { studentName = n.trim(); saveStudentData(); }
    }
    function updateProfile() { 
        document.getElementById('display-name').innerText = studentName; 
        let crowns = Math.floor(totalGems / 100);
        let remainGems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remainGems;

        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = crowns;
            document.getElementById('shop-gems').innerText = remainGems;
        }
    }

    // --- é é¢å°èˆª ---
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
        if(pid === 'page-result') updateProfile(); 
    }

    // --- é¡Œåº«ç®¡ç† ---
    function createNewList() { 
        editingId = null; 
        document.getElementById('list-name').value="æ–°é¡Œåº«"; 
        document.getElementById('list-gems').value = 5; 
        document.getElementById('list-teach-gems').value = 2;
        document.getElementById('list-pass-score').value = 100;
        document.getElementById('editor-rows').innerHTML=''; 
        showPage('page-editor'); 
    }
    
    function editList(i) { 
        editingId=i; 
        const l=allLists[i]; 
        document.getElementById('list-name').value=l.name; 
        document.getElementById('list-gems').value=l.gems || 5;
        document.getElementById('list-teach-gems').value=l.teachGems || 2;
        document.getElementById('list-pass-score').value=l.passScore || 100;
        document.getElementById('editor-rows').innerHTML=''; 
        l.qs.forEach(q=>addEditRow(q.a,q.b)); 
        showPage('page-editor'); 
    }

    // å¢åŠ ç·¨è¼¯åˆ—
    function addEditRow(a='', b='') { 
        try {
            const d = document.createElement('div'); 
            d.className = 'edit-row'; 
            d.innerHTML = `
                <input type="number" class="inp-a" placeholder="è¢«é™¤æ•¸" value="${a}"> Ã· 
                <input type="number" class="inp-b" placeholder="é™¤æ•¸" value="${b}">
                <button class="btn-danger" style="padding:5px 10px;" onclick="this.parentElement.remove()">Ã—</button>
            `; 
            document.getElementById('editor-rows').appendChild(d); 
        } catch(e) {
            alert("æ–°å¢å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
        }
    }
    
    // å„²å­˜é¡Œåº«
    function saveList() { 
        try {
            const n = document.getElementById('list-name').value; 
            const gVal = parseInt(document.getElementById('list-gems').value);
            const gems = isNaN(gVal) ? 5 : gVal;
            const tgVal = parseInt(document.getElementById('list-teach-gems').value);
            const teachGems = isNaN(tgVal) ? 2 : tgVal;
            const pVal = parseInt(document.getElementById('list-pass-score').value);
            const passScore = isNaN(pVal) ? 100 : pVal;

            const rs = document.querySelectorAll('#editor-rows .edit-row'); 
            const qs = []; 
            
            rs.forEach(r => {
                const aInput = r.querySelector('.inp-a');
                const bInput = r.querySelector('.inp-b');
                
                if (aInput && bInput) {
                    const a = parseInt(aInput.value); 
                    const b = parseInt(bInput.value); 
                    
                    if(!isNaN(a) && !isNaN(b) && b > 0) {
                        qs.push({a: a, b: b});
                    }
                }
            }); 

            if(qs.length < 1) {
                alert("è«‹è‡³å°‘è¼¸å…¥ä¸€é¡Œæœ‰æ•ˆçš„é¡Œç›®ï¼(æ³¨æ„ï¼šé™¤æ•¸ä¸èƒ½ç‚º0)"); 
                return;
            }
            
            const data = {name: n, gems: gems, teachGems: teachGems, passScore: passScore, qs: qs};
            
            if(editingId === null) {
                allLists.push(data); 
            } else {
                allLists[editingId] = data; 
            }
            
            saveData(); 
            showPage('page-home'); 
            editingId = null; 
        } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼");
        }
    }
    
    function delList(i) { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é¡Œåº«å—ï¼Ÿ")){allLists.splice(i,1); saveData(); renderLists();} }
    
    // è‡ªå‹•ç”Ÿæˆ
    function autoGenerate() { 
        const c = document.getElementById('gen-count').value; 
        const la = document.getElementById('gen-len-a').value; 
        const lb = document.getElementById('gen-len-b').value; 
        
        document.getElementById('editor-rows').innerHTML=''; 
        
        for(let i=0; i<c; i++){
            let b = Math.floor(Math.random() * Math.pow(10, lb)); 
            if(b < 2) b = 2;
            let a = Math.floor(Math.random() * Math.pow(10, la)); 
            if (a < b) a = b * (Math.floor(Math.random()*9)+1);
            addEditRow(a, b);
        } 
    }
    
    // --- å‚™ä»½èˆ‡åŒ¯å…¥ ---
    function exportData() { 
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
        const exportObj = {
            version: "5.2",
            student: { name: studentName, totalGems: totalGems },
            lists: allLists,
            exchangeLog: exchangeLog
        };
        const b=new Blob([JSON.stringify(exportObj)],{type:"application/json"}); 
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`div_backup_${dateStr}.json`; a.click(); 
    }
    
    function handleImport(inp) { 
        const f=inp.files[0]; const r=new FileReader(); 
        r.onload=(e)=>{ 
            try {
                const d = JSON.parse(e.target.result);
                if (Array.isArray(d)) {
                    allLists = allLists.concat(d); 
                } else if (d.lists) {
                    allLists = allLists.concat(d.lists);
                    if(d.student) {
                        if(confirm(`åŒ¯å…¥è³‡æ–™åŒ…å«å­¸å“¡ï¼š${d.student.name} (å¯¶çŸ³:${d.student.totalGems})ã€‚\nè¦è¦†è“‹ç›®å‰çš„é€²åº¦å—ï¼Ÿ`)) {
                            studentName = d.student.name;
                            totalGems = d.student.totalGems;
                            if(d.exchangeLog) exchangeLog = d.exchangeLog;
                            saveStudentData();
                        }
                    }
                }
                saveData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ");
            } catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f); 
    }

    // --- æ¸¬é©—æ ¸å¿ƒé‚è¼¯ ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            let gemVal = l.gems ? l.gems : 5; 
            let teachGemVal = l.teachGems ? l.teachGems : 2;
            let passVal = l.passScore ? l.passScore : 100;

            d.innerHTML = `
                <div>
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                    <div style="margin-top:5px;">
                        <span class="gem-tag">ğŸ’æ¸¬é©—+${gemVal}</span>
                        <span class="teach-gem-tag">ğŸ’æ•™å­¸+${teachGemVal}</span>
                        <span class="score-tag">ğŸ¯ ${passVal}åˆ†</span>
                    </div>
                </div>
                <div>
                    <button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                </div>`;
            c.appendChild(d);
        });
    }

    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        if(mode === 'teach') {
            quizSettings.voice = document.getElementById('opt-voice').checked;
            quizSettings.text = document.getElementById('opt-text').checked;
            quizSettings.allowHelp = document.getElementById('opt-help').checked; 
        }

        quizData = currentList.qs.map(q => ({
            a: q.a, b: q.b, 
            userQ: null, userR: null, isCorrect: false,
            steps: [], stepIdx: 0
        }));
        
        if(mode === 'teach') {
            quizData.forEach(q => { q.steps = generateDivSteps(q.a, q.b); });
        }

        currentQIdx = 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        
        document.getElementById('teach-area').style.display = mode==='teach'?'block':'none';
        document.getElementById('test-area').style.display = mode==='test'?'block':'none';
        
        showPage('page-quiz');
        speak(`${studentName}ï¼Œæ­¡è¿ä¾†åˆ°${mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼'}ï¼Œæº–å‚™é–‹å§‹å›‰ï¼`);
        loadQuestion();
    }

    function updTime() {
        const s = Math.floor((Date.now()-startTime)/1000);
        document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡ºï¼Ÿ")) { clearInterval(timerInt); showPage('page-home'); } }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `${currentQIdx+1}/${quizData.length}`;
        document.getElementById('btn-next-q').style.display = 'none'; 
        
        if(currentMode === 'test') {
            document.getElementById('teach-area').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
            document.getElementById('test-q-text').innerText = `${q.a} Ã· ${q.b} = ?`;
            document.getElementById('test-quo').value = '';
            document.getElementById('test-rem').value = '';
            document.getElementById('test-quo').focus();
        } else {
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('teach-area').style.display = 'block';
            renderTeachGrid(q);
        }
    }

    function checkTestAnswer() {
        const q = quizData[currentQIdx];
        const uQ = document.getElementById('test-quo').value;
        const uR = document.getElementById('test-rem').value;
        
        if(uQ === '' || uR === '') { alert("è«‹è¼¸å…¥å•†å’Œé¤˜æ•¸(è‹¥ç„¡é¤˜æ•¸è«‹å¡«0)"); return; }

        q.userQ = parseInt(uQ);
        q.userR = parseInt(uR);
        
        const ansQ = Math.floor(q.a / q.b);
        const ansR = q.a % q.b;
        
        if(q.userQ === ansQ && q.userR === ansR) {
            q.isCorrect = true;
            speak(`ç­”å°äº†ï¼${studentName}çœŸæ£’ï¼`);
            alert("âœ… æ­£ç¢ºï¼");
        } else {
            q.isCorrect = false;
            speak(`å“å‘€ï¼Œç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯å•†${ansQ}ï¼Œé¤˜æ•¸${ansR}ã€‚`);
            alert(`âŒ éŒ¯èª¤ï¼\næ­£ç¢ºç­”æ¡ˆï¼šå•† ${ansQ} ... é¤˜ ${ansR}`);
        }

        goToNext();
    }

    function goToNext() {
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    // --- ç”¢ç”Ÿé®ä½æ³•æç¤ºçš„è¼”åŠ©å‡½å¼ (åƒ…æä¾›æ€è€ƒæ–¹å‘ï¼Œä¸çµ¦ç­”æ¡ˆ) ---
    function getCoverMethodHint(currentVal, divisor, realQuo) {
        const dStr = divisor.toString();
        const vStr = currentVal.toString();
        
        // å–å¾—é®ä½å¾Œçš„ã€Œé ­ã€
        const dHead = parseInt(dStr[0]);
        // åˆ¤æ–·è¢«é™¤æ•¸è¦çœ‹å¹¾ä½ï¼šå¦‚æœè¢«é™¤æ•¸ä½æ•¸ > é™¤æ•¸ä½æ•¸ï¼Œå‰‡çœ‹å‰å…©ä½ï¼Œå¦å‰‡çœ‹ä¸€ä½
        let vHeadStr = (vStr.length > dStr.length) ? vStr.substring(0, 2) : vStr[0];
        let vHead = parseInt(vHeadStr);
        
        // é®ä½éƒ¨åˆ†çš„æ–‡å­—æè¿°
        const dCovered = dStr.substring(1);
        const vCovered = vStr.substring(vHeadStr.length);
        
        let hint = "";
        
        // åªæœ‰åœ¨é•·åº¦è¶³å¤ é®çš„æ™‚å€™æ‰é¡¯ç¤ºé®ä½æ³•æ–‡å­—ï¼Œå¦å‰‡ç°¡å–®é¡¯ç¤º
        if (dStr.length > 1) {
            hint += `<b>é®ä½æ³•ï¼š</b>${divisor}é®${dCovered}çœ‹<b style='color:red'>${dHead}</b>ï¼Œ`;
            hint += `${currentVal}é®${vCovered}çœ‹<b style='color:red'>${vHead}</b>ã€‚<br>`;
        } else {
            hint += `çœ‹ ${currentVal} Ã· ${divisor}ã€‚<br>`;
        }
        
        hint += `å…ˆæƒ³æƒ³ï¼š${vHead} Ã· ${dHead} å¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ<br>`;
        hint += `<small>(è‹¥å¡ä½äº†ï¼Œè«‹æŒ‰æ±‚åŠ©)</small>`;
        
        return hint;
    }

    // --- é™¤æ³•æ­¥é©Ÿç”¢ç”Ÿé‚è¼¯ ---
    function generateDivSteps(dividend, divisor) {
        let dStr = dividend.toString();
        let steps = [];
        let row = 1;
        let offset = 6 - dStr.length; 
        
        let divisorLen = divisor.toString().length;
        let dIndex = divisorLen - 1; 
        let workingStr = dStr.substring(0, divisorLen);
        let currentVal = parseInt(workingStr);
        let firstStep = true;

        // å¦‚æœä¸å¤ é™¤ï¼Œè‡ªå‹•å¤šæŠ“ä¸€ä½
        if (currentVal < divisor && dIndex < dStr.length - 1) {
            dIndex++;
            workingStr += dStr[dIndex];
            currentVal = parseInt(workingStr);
        }

        while(true) {
            let quo = Math.floor(currentVal / divisor);
            let prod = quo * divisor;
            let rem = currentVal - prod;
            let col = offset + dIndex; 

            // ç”Ÿæˆä¸€èˆ¬æç¤º (ç„¡ç­”æ¡ˆ)
            let hintText = getCoverMethodHint(currentVal, divisor, quo);

            steps.push({ 
                type: 'quo', r: 0, c: col, ans: quo, 
                hint: hintText,
                currVal: currentVal,
                workingStrLen: workingStr.length,
                dividendEndIdx: col,
                highlightRow: row 
            });

            steps.push({ 
                type: 'prod', r: row+1, c: col, ans: prod, 
                hint: `è«‹è¨ˆç®—å•† Ã— é™¤æ•¸ï¼Œå¡«å¯«ä¹˜ç©...`, align:'right', quoVal: quo 
            });

            row += 2;

            steps.push({ 
                type: 'rem', r: row, c: col, ans: rem, 
                hint: `è«‹è¨ˆç®—æ¸›æ³•æ±‚é¤˜æ•¸...`, align:'right', working: currentVal, prod: prod 
            });

            if(dIndex < dStr.length - 1) {
                dIndex++;
                let nextDigit = dStr[dIndex];

                steps.push({ 
                    type: 'drop', r: row, c: offset+dIndex, 
                    ans: nextDigit, hint: `æŠŠ ${nextDigit} é™ä¸‹ä¾†` 
                });

                workingStr = rem.toString() + nextDigit;
                currentVal = parseInt(workingStr);
                
            } else {
                break; 
            }
            
            firstStep = false;
        }

        return steps;
    }

    function renderTeachGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML='';
        const msg = document.getElementById('teach-msg');
        document.getElementById('help-content').style.display = 'none';
        
        const btnHelp = document.getElementById('btn-help-trigger');
        if(quizSettings.allowHelp) {
            btnHelp.style.display = 'inline-block';
        } else {
            btnHelp.style.display = 'none';
        }

        const cols = 8;
        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
        
        for(let r=0; r<20; r++) {
            for(let c=0; c<cols; c++) {
                const cell = document.createElement('div');
                cell.className='grid-cell'; cell.id=`c-${r}-${c}`;
                box.appendChild(cell);
            }
        }

        const dStr = q.a.toString();
        const bStr = q.b.toString();
        const offset = 6 - dStr.length;

        const divCell = document.getElementById(`c-1-${offset-2}`);
        divCell.innerHTML = '';
        let divHtml = '';
        for(let i=0; i<bStr.length; i++) {
            divHtml += `<span id="div-digit-${i}">${bStr[i]}</span>`;
        }
        divCell.innerHTML = divHtml;

        document.getElementById(`c-1-${offset-1}`).classList.add('bracket-cell');
        
        for(let i=0; i<dStr.length; i++) {
            const cell = document.getElementById(`c-1-${offset+i}`);
            cell.innerText = dStr[i];
            cell.classList.add('dividend-cell');
            cell.dataset.dIndex = i;
        }

        for(let i=0; i<q.stepIdx; i++) {
            const s = q.steps[i];
            fillCell(s.r, s.c, s.ans, s.type);
        }

        document.querySelectorAll('.hl-high, .hl-low').forEach(el => {
            el.classList.remove('hl-high', 'hl-low');
        });

        if(q.stepIdx >= q.steps.length) {
            msg.innerText = "å¤ªæ£’äº†ï¼æœ¬é¡Œå®Œæˆã€‚";
            q.isCorrect = true; 
            if(btnHelp) btnHelp.style.display = 'none';
            
            const btn = document.getElementById('btn-next-q');
            btn.style.display = 'inline-block';
            if(currentQIdx >= quizData.length - 1) btn.innerText = "çœ‹æˆç¸¾ ğŸ†";
            else btn.innerText = "ä¸‹ä¸€é¡Œ â¡";
            return;
        }

        let cur = q.steps[q.stepIdx];

        if(quizSettings.text) msg.innerHTML = cur.hint; 
        else msg.innerText = "è«‹è¨ˆç®—ä¸¦å¡«å…¥ç­”æ¡ˆ...";
        
        speak(cur.hint);

        if(cur.type === 'quo') {
            const bStr = q.b.toString();
            const wLen = cur.workingStrLen;
            const currentRow = cur.highlightRow; 

            if(bStr.length >= 2 && wLen >= 2) {
                for(let i=0; i<bStr.length; i++) {
                    const dEl = document.getElementById(`div-digit-${i}`);
                    if(dEl) {
                        if(i === bStr.length - 1) dEl.classList.add('hl-low');
                        else dEl.classList.add('hl-high');
                    }
                }
                const startCol = cur.dividendEndIdx - wLen + 1;
                for(let i=0; i<wLen; i++) {
                    const cell = document.getElementById(`c-${currentRow}-${startCol + i}`);
                    if(cell) {
                        if(i === wLen - 1) cell.classList.add('hl-low');
                        else cell.classList.add('hl-high');
                    }
                }
            }
        }

        const ansStr = cur.ans.toString();
        let createdInputs = [];

        for(let i=0; i<ansStr.length; i++) {
            let targetCol = cur.c - (ansStr.length - 1) + i;
            let targetCell = document.getElementById(`c-${cur.r}-${targetCol}`);
            
            if(targetCell) {
                targetCell.innerHTML = '';
                const inp = document.createElement('input');
                inp.type = 'tel'; 
                inp.maxLength = 1; 
                inp.className = 'game-input active-input step-input-group';
                inp.dataset.index = i; 
                
                inp.oninput = function() {
                    if(this.value.length === 1) {
                        const nextIndex = parseInt(this.dataset.index) + 1;
                        if(createdInputs[nextIndex]) {
                            createdInputs[nextIndex].focus();
                        }
                    }
                };

                inp.onkeydown = (e) => { 
                    if(e.key === 'Enter') checkTeachAnswerMulti(cur, q); 
                    if(e.key === 'Backspace' && this.value === '') {
                         const prevIndex = parseInt(this.dataset.index) - 1;
                         if(createdInputs[prevIndex]) createdInputs[prevIndex].focus();
                    }
                };

                targetCell.appendChild(inp);
                createdInputs.push(inp);
            }
        }
        
        if(createdInputs.length > 0) {
            setTimeout(() => createdInputs[0].focus(), 100);
        }
        
        const okBtn = document.createElement('button'); okBtn.className='btn-warning'; okBtn.innerText='OK';
        okBtn.onclick = () => checkTeachAnswerMulti(cur, q);
        
        let oldBtn = msg.querySelector('button'); 
        if(oldBtn) oldBtn.remove();
        
        msg.appendChild(document.createElement('br')); 
        msg.appendChild(okBtn);
    }

    function fillCell(r, c, val, type) {
        const str = val.toString();
        for(let i=0; i<str.length; i++) {
            let tc = c - (str.length-1) + i; 
            let cell = document.getElementById(`c-${r}-${tc}`);
            if(cell) {
                cell.innerText = str[i];
                if(type==='prod') cell.classList.add('subtraction-line');
            }
        }
    }

    // æª¢æŸ¥ç­”æ¡ˆ (éŒ¯èª¤æ™‚åªæç¤ºæ–¹å‘ï¼Œä¸çµ¦æ•¸å­—)
    function checkTeachAnswerMulti(step, q) {
        const inputs = document.querySelectorAll('.step-input-group');
        let userAnsStr = "";
        
        inputs.forEach(inp => { userAnsStr += inp.value; });

        if(userAnsStr === "") {
             if(inputs.length > 0) inputs[0].focus();
             return;
        }

        const userVal = parseInt(userAnsStr);
        const correctVal = parseInt(step.ans);

        if(userVal === correctVal) {
            speak("ç­”å°äº†ï¼");
            q.stepIdx++;
            renderTeachGrid(q);
        } else {
            let errorMsg = "ç®—éŒ¯å›‰ï¼Œå†è©¦è©¦çœ‹";
            if(step.type === 'quo') {
                const divisor = q.b;
                const working = step.currVal;
                const prod = divisor * userVal;

                if (prod > working) {
                    // å¤ªå¤§äº†ï¼Œåªæç¤ºå¤ªå¤§
                    errorMsg = `å¤ªå¤§äº†ï¼${divisor}ä¹˜${userVal}æœƒè¶…é${working}å–”ã€‚è©¦è©¦å°ä¸€é»çš„æ•¸ã€‚`;
                } else if ((working - prod) >= divisor) {
                    // å¤ªå°äº†ï¼Œåªæç¤ºå¤ªå°
                    errorMsg = `å¤ªå°äº†ï¼é¤˜æ•¸æœƒæ¯”é™¤æ•¸${divisor}é‚„å¤§å–”ã€‚è©¦è©¦å¤§ä¸€é»çš„æ•¸ã€‚`;
                }
            } else if (step.type === 'prod') {
                errorMsg = `ä¹˜æ³•ç®—éŒ¯å›‰ï¼Œè«‹å†ç®—ä¸€æ¬¡ ${step.quoVal} Ã— ${q.b}`;
            } else if (step.type === 'rem') {
                errorMsg = `æ¸›æ³•ç®—éŒ¯å›‰ï¼Œè«‹å†ç®—ä¸€æ¬¡`;
            }

            speak(errorMsg);
            
            const msg = document.getElementById('teach-msg');
            let oldBtn = msg.querySelector('button'); 
            if(oldBtn) oldBtn.remove();
            
            msg.innerText = errorMsg; 
            const okBtn = document.createElement('button'); okBtn.className='btn-warning'; okBtn.innerText='OK';
            okBtn.onclick = () => checkTeachAnswerMulti(step, q);
            msg.appendChild(document.createElement('br')); 
            msg.appendChild(okBtn);

            inputs.forEach(inp => inp.value = '');
            if(inputs.length > 0) inputs[0].focus();
        }
    }

    // æ±‚åŠ©æŒ‰éˆ•ï¼šåªæœ‰æŒ‰ä¸‹å»æ‰é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆèˆ‡éç¨‹
    function toggleHelp() {
        if (!quizSettings.allowHelp) return; 

        const helpBox = document.getElementById('help-content');
        if(helpBox.style.display === 'block') {
            helpBox.style.display = 'none';
            return;
        }
        const q = quizData[currentQIdx];
        const step = q.steps[q.stepIdx];
        const divisor = q.b;
        let html = '';

        if(step.type === 'quo') {
            const target = step.currVal;
            const ans = parseInt(step.ans);
            html += `<strong>ğŸ” è©¦å•†éç¨‹è§£æï¼š</strong><br>`;
            html += `<div class="help-table">`;
            
            let start = Math.max(1, ans - 1);
            let end = Math.min(9, ans + 1);
            if(ans === 0) { start = 0; end = 1; } 

            for(let i=start; i<=end; i++) {
                let res = divisor * i;
                let status = '';
                if(i === ans) status = '<span class="help-correct">âœ” å‰›å¥½!</span>';
                else if(res > target) status = '<span class="help-wrong">(å¤ªå¤§äº†)</span>';
                else status = '<span class="help-wrong">(å¤ªå°äº†)</span>';
                html += `<div class="help-row"><span>${divisor} Ã— ${i} = ${res}</span> ${status}</div>`;
            }
            html += `</div>`;
            html += `æ­£ç¢ºçš„å•†æ˜¯ï¼š<strong style="color:var(--primary)">${ans}</strong>`;

        } else if(step.type === 'prod') {
            html += `é€™è£¡æ˜¯è¨ˆç®—ä¹˜æ³•ï¼šå•† Ã— é™¤æ•¸<br>`;
            html += `ç®—å¼ï¼š<strong>${step.quoVal} Ã— ${divisor} = <span style="color:var(--primary)">${step.ans}</span></strong>`;
        } else if(step.type === 'rem') {
            html += `é€™è£¡æ˜¯è¨ˆç®—é¤˜æ•¸ï¼šè¢«é™¤æ•¸ - ä¹˜ç©<br>`;
            html += `ç®—å¼ï¼š<strong>${step.working} - ${step.prod} = <span style="color:var(--primary)">${step.ans}</span></strong>`;
        } else if(step.type === 'drop') {
            html += `ç­”æ¡ˆæ˜¯ï¼š<strong>${step.ans}</strong>`;
        }

        helpBox.innerHTML = html;
        helpBox.style.display = 'block';
        speak("åˆ¥æ“”å¿ƒï¼Œçœ‹çœ‹ä¸‹é¢çš„ç­”æ¡ˆ");
    }

    function finishQuiz() {
        clearInterval(timerInt);
        showPage('page-result');
        const correctCount = quizData.filter(q => q.isCorrect).length;
        const score = Math.round((correctCount / quizData.length) * 100);
        
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-summary').innerText = `${studentName}ï¼Œä½ ç­”å°äº† ${correctCount} / ${quizData.length} é¡Œï¼`;
        
        const rewardArea = document.getElementById('reward-area');
        rewardArea.innerHTML = '';
        
        let targetScore = currentList.passScore || 100;
        let gemsReward = currentList.gems || 5;
        let teachGemsReward = currentList.teachGems || 2;
        let earnedGems = 0;
        
        if (currentMode === 'test' && score >= targetScore) {
            earnedGems = gemsReward;
        } else if (currentMode === 'teach' && score === 100) { 
            earnedGems = teachGemsReward;
        }

        if (earnedGems > 0) {
            let oldGems = totalGems;
            let oldCrowns = Math.floor(oldGems / 100);
            totalGems += earnedGems;
            saveStudentData(); 
            let newCrowns = Math.floor(totalGems / 100);
            let earnedCrowns = newCrowns - oldCrowns;

            if (earnedCrowns > 0) {
                triggerRewardAnimation('crown');
                rewardArea.innerHTML = `<div class="reward-popup" style="border-color:#e67e22; color:#e67e22;">ğŸ‘‘ æ­å–œå‡ç´šï¼ç²å¾— ${earnedCrowns} é ‚çš‡å† ï¼<br>(åŒæ™‚ç²å¾— ${earnedGems} é¡†å¯¶çŸ³)</div>`;
                speak(`å¤ªå²å®³äº†ï¼åˆ†æ•¸é”æ¨™ï¼æ­å–œä½ ç²å¾—äº† ${earnedCrowns} é ‚çš‡å† ï¼`);
            } else {
                triggerRewardAnimation('gem');
                rewardArea.innerHTML = `<div class="reward-popup">ğŸ‰ æ­å–œé”æ¨™ï¼ç²å¾— ${earnedGems} é¡†å¯¶çŸ³ ğŸ’<br>ç›®å‰ç´¯ç©: ${totalGems} é¡†</div>`;
                speak(`å¤ªæ£’äº†ï¼åˆ†æ•¸é”æ¨™ï¼ä½ ç²å¾—äº† ${earnedGems} é¡†å¯¶çŸ³ï¼`);
            }
        } else {
            let praise = score>=60?"è¡¨ç¾ä¸éŒ¯ï¼Œä¸‹æ¬¡æŒ‘æˆ°æ‹¿å¯¶çŸ³ï¼":"å†å¤šç·´ç¿’å¹¾æ¬¡ï¼ŒåŠ æ²¹ï¼";
            speak(`æ¸¬é©—çµæŸï¼Œä½ å¾—äº†${score}åˆ†ã€‚${praise}`);
        }

        const tbody = document.getElementById('res-table-body');
        tbody.innerHTML = '';
        quizData.forEach(q => {
            const tr = document.createElement('tr');
            const ansQ = Math.floor(q.a/q.b);
            const ansR = q.a%q.b;
            let userTxt = (currentMode==='teach') ? "(æ•™å­¸å®Œæˆ)" : `å•†${q.userQ} é¤˜${q.userR}`;
            let status = q.isCorrect ? '<span class="res-correct">O</span>' : '<span class="res-wrong">X</span>';
            tr.innerHTML = `<td>${q.a} Ã· ${q.b}</td><td>${userTxt}</td><td>${ansQ} ... ${ansR}</td><td>${status}</td>`;
            tbody.appendChild(tr);
        });
    }

    function triggerRewardAnimation(type) {
        const container = document.getElementById('particle-container');
        container.style.display = 'block';
        container.innerHTML = ''; 
        let symbol = type === 'crown' ? 'ğŸ‘‘' : 'ğŸ’';
        for (let i = 0; i < 30; i++) {
            let p = document.createElement('div');
            p.innerText = symbol;
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (Math.random() * 2 + 1) + 's'; 
            p.style.fontSize = (Math.random() * 2 + 1) + 'rem';
            container.appendChild(p);
        }
        setTimeout(() => { container.style.display = 'none'; container.innerHTML = ''; }, 3000);
    }

    function processExchange() {
        const giftName = document.getElementById('gift-name').value.trim();
        const costVal = parseInt(document.getElementById('gift-cost').value);
        const currency = document.getElementById('gift-currency').value;
        if (!giftName) { alert("è«‹è¼¸å…¥çå“åç¨±"); return; }
        if (isNaN(costVal) || costVal <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡"); return; }
        let costInGems = costVal;
        if (currency === 'crowns') costInGems = costVal * 100;
        if (totalGems >= costInGems) {
            if(confirm(`ç¢ºå®šè¦èŠ±è²» ${costVal} ${currency === 'crowns' ? 'çš‡å† ' : 'å¯¶çŸ³'} å…Œæ›ã€Œ${giftName}ã€å—ï¼Ÿ`)) {
                totalGems -= costInGems;
                const logItem = { date: new Date().toLocaleString(), item: giftName, cost: `${costVal} ${currency === 'crowns' ? 'ğŸ‘‘' : 'ğŸ’'}` };
                exchangeLog.unshift(logItem);
                saveStudentData(); renderExchangeLog();
                document.getElementById('gift-name').value = ''; document.getElementById('gift-cost').value = '';
                triggerRewardAnimation(currency === 'crowns' ? 'crown' : 'gem'); speak(`å…Œæ›æˆåŠŸï¼äº«å—ä½ çš„çå‹µå§ï¼`);
            }
        } else { alert("é¤˜é¡ä¸è¶³å–”ï¼å†å¤šç·´ç¿’è³ºå–å¯¶çŸ³å§ï¼"); }
    }
    function renderExchangeLog() {
        const div = document.getElementById('exchange-log'); if(!div) return; div.innerHTML = '';
        exchangeLog.forEach(log => {
            const row = document.createElement('div'); row.className = 'log-item';
            row.innerHTML = `<span>ğŸ“… ${log.date} - å…Œæ› <strong>${log.item}</strong></span> <span>-${log.cost}</span>`;
            div.appendChild(row);
        });
    }
</script>

</body>
</html>
