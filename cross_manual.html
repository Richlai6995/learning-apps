<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹˜æ³•é—–é—œç‹ 4.6 (æ¥µé€Ÿå„ªåŒ–ç‰ˆ)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --light: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --cell-size: 50px; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 10px 0; text-align: center; font-size: 1.8rem;}

        /* --- å­¸å“¡åç‰Œ & çå‹µ --- */
        .user-profile {
            background-color: #fff3cd;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: #d35400;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            justify-content: center;
        }
        .user-profile:active { transform: scale(0.98); }
        
        .stats-badge {
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px;
            color: #2c3e50;
        }

        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 6px; padding: 8px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 2px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-accent { background-color: #f39c12; }
        .btn-help { background-color: #e67e22; box-shadow: 0 4px #d35400; }
        .btn-help:active { box-shadow: 0 0 #d35400; transform: translateY(4px); }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; }
        
        .btn-next-level {
            background-color: #27ae60; color: white; font-size: 1.5rem; padding: 15px 30px;
            border-radius: 50px; box-shadow: 0 6px #1e8449; margin-top: 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none; 
        }
        .btn-next-level:active { transform: translateY(6px); box-shadow: 0 0 #1e8449; }
        @keyframes popIn { from {transform: scale(0);} to {transform: scale(1);} }

        /* --- åˆ—è¡¨èˆ‡æ¨™ç±¤ --- */
        .list-item {
            background: #fdf2ff; border: 1px solid #e1bee7; padding: 10px; margin-bottom: 8px;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
        }
        .gem-tag { color: #2980b9; font-weight: bold; background: #d6eaf8; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}
        .teach-gem-tag { color: #27ae60; font-weight: bold; background: #d5f5e3; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}
        .score-tag { color: #d35400; font-weight: bold; background: #fdebd0; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}

        .gen-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; background: #f3e5f5; padding: 10px; border-radius: 8px;}
        .gen-controls input { padding: 5px; width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px;}
        .edit-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .edit-row input { padding: 5px; flex: 1; text-align: center; border: 1px solid #ccc; border-radius: 4px;}

        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 6px; }
        
        .settings-panel {
            background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;
        }
        .settings-panel h3 { margin: 0 0 10px 0; color: var(--dark); font-size: 1.1rem; }
        .settings-panel label { display: block; margin-bottom: 8px; cursor: pointer; font-size: 1.1rem; }
        .settings-panel input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; }

        .grid-container {
            display: grid; grid-auto-rows: 50px; justify-content: center; margin: 20px 0; gap: 0; position: relative; 
        }
        .grid-cell {
            width: var(--cell-size); height: 50px; 
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.8rem; 
            position: relative; z-index: 2; 
        }
        
        .arrow-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;
        }

        .game-input { 
            width: 90%; height: 90%; margin: auto; font-size: 1.5rem; text-align: center; 
            border: 3px solid var(--primary); border-radius: 8px; background: #fff; outline: none; z-index: 10;
        }
        .game-input.correct { border-color: #27ae60; background-color: #d5f5e3; color: #27ae60; }
        .game-input:focus { border-color: #2ecc71; background: #e8f8f5; box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }

        .carry-input {
            width: 32px; height: 32px; font-size: 1.2rem; text-align: center;
            border: 2px solid #e67e22; border-radius: 50%; background: #fef5e7; outline: none;
            position: absolute; bottom: 2px; color: #d35400; z-index: 20; font-weight: bold; padding: 0;
        }
        .carry-input.correct { border-color: #27ae60; background-color: #d5f5e3; color: #27ae60; }
        .carry-input:focus { transform: scale(1.2); border-color: #d35400; box-shadow: 0 0 5px #e67e22; }

        .carry-display {
            font-size: 1rem; color: #d35400; font-weight: bold;
            border: 1px dashed #e67e22; border-radius: 50%; width: 28px; height: 28px;
            display: flex; justify-content: center; align-items: center;
        }

        .game-input.wrong, .carry-input.wrong { background: #fadbd8; border-color: var(--danger); animation: shake 0.4s; }
        
        /* ç§»é™¤ input çš„ä¸Šä¸‹ç®­é ­ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .multiplication-line { border-bottom: 3px solid #333; }
        .operator { color: var(--primary); }

        .help-box {
            background: #fff8e1; border-left: 5px solid #ffc107; padding: 10px; margin: 10px 0;
            border-radius: 5px; display: none; font-size: 1.1rem; text-align: left;
        }
        .highlight-digit { color: #e74c3c; font-weight: bold; transform: scale(1.2); display:inline-block;}

        .test-mode-box { text-align: center; padding: 30px; font-size: 1.5rem; }
        .test-input { font-size: 1.5rem; padding: 8px; width: 120px; text-align: center; border: 2px solid #ccc; border-radius: 6px; margin-left: 10px; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .rank-1 { color: #f39c12; font-weight: bold; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .version-tag {
            margin-top: 30px; color: #27ae60; font-size: 1rem; text-align: center;
            font-family: monospace; border-top: 1px dashed #eee; padding-top: 10px; font-weight: bold;
        }

        /* --- çå‹µå…Œæ›å€ --- */
        .shop-balance {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            color: white; padding: 20px; border-radius: 15px; text-align: center;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .shop-balance h3 { color: white; margin: 0 0 10px 0; font-weight: normal; font-size: 1rem; opacity: 0.9; }
        .balance-row { display: flex; justify-content: center; gap: 20px; font-size: 1.5rem; font-weight: bold; }
        
        .exchange-form { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .exchange-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .exchange-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; text-align: center; }
        .exchange-select { padding: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; background: white; }
        
        .log-list { max-height: 200px; overflow-y: auto; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 0.9rem; color: #666; }
        .log-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }

        /* --- ç²çå‹•ç•«èˆ‡ç‰¹æ•ˆ --- */
        .reward-popup {
            background: #fff8e1; border: 3px solid #f1c40f; padding: 20px;
            border-radius: 15px; margin-top: 20px; font-weight: bold; color: #d35400;
            font-size: 1.5rem; text-align: center;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
            animation: bounceIn 0.8s;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* ç²’å­å‹•ç•«å®¹å™¨ */
        #particle-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden; display: none;
        }
        .particle {
            position: absolute; font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>âœ–ï¸ ä¹˜æ³•é—–é—œç‹ 4.6</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <button class="btn-accent btn-block" style="margin-bottom:15px; box-shadow:0 4px #d35400;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px; display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½ (å«å¯¶çŸ³)</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv4.6 (å„ªåŒ–è¼¸å…¥é«”é©—ç‰ˆ)</div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        
        <div class="shop-balance">
            <h3>ç›®å‰æŒæœ‰</h3>
            <div class="balance-row">
                <span>ğŸ‘‘ <span id="shop-crowns">0</span></span>
                <span>ğŸ’ <span id="shop-gems">0</span></span>
            </div>
        </div>

        <div class="exchange-form">
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">æˆ‘è¦å…Œæ›...</div>
            <div class="exchange-row">
                <input type="text" id="gift-name" class="exchange-input" placeholder="è¼¸å…¥çå“åç¨± (å¦‚: çœ‹é›»è¦–10åˆ†é˜)">
            </div>
            
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">éœ€è¦èŠ±è²»</div>
            <div class="exchange-row">
                <input type="number" id="gift-cost" class="exchange-input" placeholder="æ•¸é‡" min="1">
                <select id="gift-currency" class="exchange-select">
                    <option value="gems">ğŸ’ å¯¶çŸ³</option>
                    <option value="crowns">ğŸ‘‘ çš‡å† </option>
                </select>
            </div>

            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>

        <div style="margin-top:20px;">
            <h4>ğŸ“œ å…Œæ›ç´€éŒ„</h4>
            <div id="exchange-log" class="log-list"></div>
        </div>

        <button class="btn-gray btn-block" style="margin-top:20px;" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background:#eee; padding:15px; border-radius:10px;">
            <div style="flex:100%">åç¨±: <input type="text" id="list-name" style="padding:5px; width:70%;"></div>
            <div>ğŸ’ æ¸¬é©—å¯¶çŸ³: <input type="number" id="list-gems" placeholder="5" style="padding:5px; width:60px;" value="5"></div>
            <div>ğŸ’ æ•™å­¸å¯¶çŸ³: <input type="number" id="list-teach-gems" placeholder="2" style="padding:5px; width:60px;" value="2"></div>
            <div>ğŸ¯ ç²çåˆ†æ•¸: <input type="number" id="list-pass-score" placeholder="100" style="padding:5px; width:60px;" value="100"></div>
        </div>
        <div class="gen-controls">
            <span>ç”Ÿæˆ:</span>
            é¡Œæ•¸<input type="number" id="gen-count" value="5">
            è¢«ä¹˜æ•¸<input type="number" id="gen-len-a" value="2">
            ä¹˜æ•¸<input type="number" id="gen-len-b" value="2">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
            <div id="editor-rows"></div>
        </div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div class="settings-panel">
            <h3>ğŸ› ï¸ æ•™å­¸è¼”åŠ©è¨­å®š</h3>
            <label><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º</label>
            <label><input type="checkbox" id="opt-text" checked> ğŸ”¤ æ–‡å­—æç¤º</label>
            <label><input type="checkbox" id="opt-arrow" checked> â†—ï¸ ç®­é ­æç¤º</label>
        </div>
        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– æ•™å­¸æ¨¡å¼ (é€æ­¥å¼•å°)</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ æ¸¬é©—æ¨¡å¼ (ç›´æ¥è¨ˆç®—)</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:20px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-mode">æ¨¡å¼</span>
        </div>

        <div id="teach-area" style="display:none;">
            <div style="text-align: center; margin-bottom: 10px;">
                <div id="teach-msg" style="color:#8e44ad; font-weight:bold; font-size:1.2rem; min-height:1.5em; margin-bottom:10px;"></div>
                <button id="btn-help-trigger" class="btn-help" onclick="toggleHelp()">ğŸ’¡ æ±‚åŠ©ï¼šé€™ä¸€æ­¥æ€éº¼ç®—ï¼Ÿ</button>
                <div id="help-content" class="help-box"></div>
            </div>
            
            <div class="grid-container" id="gridBoard">
                <svg id="arrow-layer" class="arrow-layer">
                    <defs>
                        <marker id="arrowhead" markerWidth="3" markerHeight="2" refX="2" refY="1" orient="auto">
                            <polygon points="0 0, 3 1, 0 2" fill="#e74c3c" />
                        </marker>
                    </defs>
                    <line id="calc-arrow" x1="0" y1="0" x2="0" y2="0" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead)" style="display:none;" />
                </svg>
            </div>
            
            <div style="text-align: center;">
                <button id="btn-next-q" class="btn-next-level" onclick="goToNextQuestion()">ğŸ‰ æœ¬é¡Œå®Œæˆï¼é€²å…¥ä¸‹ä¸€é¡Œ â¡</button>
            </div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="font-size:2rem; margin-bottom:20px;"></div>
                ç­”æ¡ˆ: <input type="number" id="test-ans" class="test-input">
            </div>
        </div>

        <div class="quiz-nav" style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-gray" id="btn-prev" onclick="navQuestion(-1)">ä¸Šä¸€é¡Œ</button>
            <button class="btn-primary" id="btn-next" onclick="navQuestion(1)">ä¸‹ä¸€é¡Œ</button>
            <button class="btn-success" id="btn-submit" onclick="submitTest()" style="display:none;">äº¤å·</button>
        </div>
        
        <button class="btn-danger" style="float:right; margin-top:10px;" onclick="quitQuiz()">é€€å‡º</button>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 3rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-detail" style="font-size: 1.2rem; margin: 10px;">ç­”å° 5 / 5 é¡Œ</div>
            <div id="res-time" style="color:#777;">è€—æ™‚ 01:20</div>
            
            <div id="reward-area"></div>

            <div style="margin-top:20px;">
                ä½ çš„åå­—: <input type="text" id="player-name" style="padding:5px; font-size:1.2rem; text-align:center;" readonly>
                <button class="btn-warning" onclick="saveRank()">ç™»è¨˜æ¦œå–®</button>
            </div>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    let quizSettings = { voice: true, text: true, arrow: true };
    let studentName = "å°å°å­¸å“¡"; 
    let totalGems = 0;

    function speak(text) {
        let force = text.includes("å¯¶çŸ³") || text.includes("çš‡å† ") || text.includes("å…¨å°");
        if(currentMode === 'teach' && !quizSettings.voice && !force) return;

        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let cleanText = text.replace(/<[^>]*>/g, '').replace(/Ã—/g, 'ä¹˜ä»¥').replace(/\+/g, 'åŠ ').replace(/=/g, 'ç­‰æ–¼');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'zh-TW'; utterance.rate = 1.0; 
            window.speechSynthesis.speak(utterance);
        }
    }

    let allLists = [], currentList = null, quizData = [], currentQIdx = 0, currentMode = '', editingId = null;
    let timerInt, startTime, rankData = [];
    let exchangeLog = [];

    const STORAGE_KEY_LISTS = 'mul_v4_5_lists';
    const STORAGE_KEY_RANK = 'mul_v4_5_rank';
    const STORAGE_KEY_USER = 'mul_v4_5_user';
    const STORAGE_KEY_GEMS = 'mul_v4_5_gems';
    const STORAGE_KEY_EXCHANGE = 'mul_v4_5_exchange';

    window.onload = function() {
        if(localStorage.getItem(STORAGE_KEY_LISTS)) {
            allLists = JSON.parse(localStorage.getItem(STORAGE_KEY_LISTS));
        } else {
            allLists = [{name: "é€²éšç·´ç¿’ (2ä½æ•¸)", gems: 5, teachGems: 2, passScore: 100, qs: [{a:56, b:29}, {a:99, b:88}]}];
            saveData();
        }
        if(localStorage.getItem(STORAGE_KEY_RANK)) {
            rankData = JSON.parse(localStorage.getItem(STORAGE_KEY_RANK));
        }
        if(localStorage.getItem(STORAGE_KEY_USER)) {
            studentName = localStorage.getItem(STORAGE_KEY_USER);
        }
        if(localStorage.getItem(STORAGE_KEY_GEMS)) {
            totalGems = parseInt(localStorage.getItem(STORAGE_KEY_GEMS)) || 0;
        }
        if(localStorage.getItem(STORAGE_KEY_EXCHANGE)) {
            exchangeLog = JSON.parse(localStorage.getItem(STORAGE_KEY_EXCHANGE));
        }
        updateProfile();
        renderLists();
        renderExchangeLog();
    };

    function saveData() { localStorage.setItem(STORAGE_KEY_LISTS, JSON.stringify(allLists)); }
    function saveRankData() { localStorage.setItem(STORAGE_KEY_RANK, JSON.stringify(rankData)); }
    function saveStudentData() {
        localStorage.setItem(STORAGE_KEY_USER, studentName);
        localStorage.setItem(STORAGE_KEY_GEMS, totalGems);
        localStorage.setItem(STORAGE_KEY_EXCHANGE, JSON.stringify(exchangeLog));
        updateProfile();
    }

    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) {
            studentName = n.trim();
            saveStudentData();
        }
    }
    function updateProfile() {
        document.getElementById('display-name').innerText = studentName;
        document.getElementById('player-name').value = studentName; 
        
        let crowns = Math.floor(totalGems / 100);
        let remainGems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remainGems;

        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = crowns;
            document.getElementById('shop-gems').innerText = remainGems;
        }
    }

    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
        if(pid === 'page-result') updateProfile(); 
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- çå‹µå…Œæ›é‚è¼¯ ---
    function processExchange() {
        const giftName = document.getElementById('gift-name').value.trim();
        const costVal = parseInt(document.getElementById('gift-cost').value);
        const currency = document.getElementById('gift-currency').value;

        if (!giftName) { alert("è«‹è¼¸å…¥çå“åç¨±"); return; }
        if (isNaN(costVal) || costVal <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡"); return; }

        let costInGems = costVal;
        if (currency === 'crowns') {
            costInGems = costVal * 100;
        }

        if (totalGems >= costInGems) {
            if(confirm(`ç¢ºå®šè¦èŠ±è²» ${costVal} ${currency === 'crowns' ? 'çš‡å† ' : 'å¯¶çŸ³'} å…Œæ›ã€Œ${giftName}ã€å—ï¼Ÿ`)) {
                totalGems -= costInGems;
                const logItem = {
                    date: new Date().toLocaleString(),
                    item: giftName,
                    cost: `${costVal} ${currency === 'crowns' ? 'ğŸ‘‘' : 'ğŸ’'}`
                };
                exchangeLog.unshift(logItem);
                saveStudentData();
                renderExchangeLog();
                document.getElementById('gift-name').value = '';
                document.getElementById('gift-cost').value = '';
                triggerRewardAnimation(currency === 'crowns' ? 'crown' : 'gem');
                speak(`å…Œæ›æˆåŠŸï¼äº«å—ä½ çš„çå‹µå§ï¼`);
            }
        } else {
            alert("é¤˜é¡ä¸è¶³å–”ï¼å†å¤šç·´ç¿’è³ºå–å¯¶çŸ³å§ï¼");
        }
    }

    function renderExchangeLog() {
        const div = document.getElementById('exchange-log');
        if(!div) return;
        div.innerHTML = '';
        exchangeLog.forEach(log => {
            const row = document.createElement('div');
            row.className = 'log-item';
            row.innerHTML = `<span>ğŸ“… ${log.date} - å…Œæ› <strong>${log.item}</strong></span> <span>-${log.cost}</span>`;
            div.appendChild(row);
        });
    }

    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        if(allLists.length===0) c.innerHTML='<p style="text-align:center">ç„¡é¡Œåº«</p>';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            let gemVal = l.gems ? l.gems : 5; 
            let teachGemVal = l.teachGems ? l.teachGems : 2;
            let passVal = l.passScore ? l.passScore : 100;
            
            d.innerHTML = `
                <div>
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                    <span class="gem-tag">ğŸ’æ¸¬é©—+${gemVal}</span>
                    <span class="teach-gem-tag">ğŸ’æ•™å­¸+${teachGemVal}</span>
                    <span class="score-tag">ğŸ¯ ${passVal}åˆ†</span>
                </div>
                <div>
                    <button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                </div>`;
            c.appendChild(d);
        });
    }

    function createNewList() {
        editingId = null;
        document.getElementById('list-name').value = "æ–°é¡Œåº«";
        document.getElementById('list-gems').value = 5;
        document.getElementById('list-teach-gems').value = 2;
        document.getElementById('list-pass-score').value = 100;
        document.getElementById('editor-rows').innerHTML = '';
        showPage('page-editor');
    }

    function editList(i) {
        editingId = i; const l = allLists[i];
        document.getElementById('list-name').value = l.name;
        document.getElementById('list-gems').value = l.gems || 5;
        document.getElementById('list-teach-gems').value = l.teachGems || 2;
        document.getElementById('list-pass-score').value = l.passScore || 100;
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        l.qs.forEach(q => addEditRow(q.a, q.b));
        showPage('page-editor');
    }

    function addEditRow(a='', b='') {
        const div = document.createElement('div'); div.className='edit-row';
        div.innerHTML = `<input type="number" class="inp-a" placeholder="è¢«ä¹˜æ•¸" value="${a}"> Ã— <input type="number" class="inp-b" placeholder="ä¹˜æ•¸" value="${b}"><button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('editor-rows').appendChild(div);
    }

    function autoGenerate() {
        const count = parseInt(document.getElementById('gen-count').value);
        const lenA = parseInt(document.getElementById('gen-len-a').value);
        const lenB = parseInt(document.getElementById('gen-len-b').value);
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        const minA = Math.pow(10, lenA-1), maxA = Math.pow(10, lenA)-1;
        const minB = Math.pow(10, lenB-1), maxB = Math.pow(10, lenB)-1;
        for(let i=0; i<count; i++) {
            let a = Math.floor(Math.random()*(maxA-minA+1)) + minA;
            let b = Math.floor(Math.random()*(maxB-minB+1)) + minB;
            addEditRow(a, b);
        }
    }

    function saveList() {
        const name = document.getElementById('list-name').value;
        const gVal=parseInt(document.getElementById('list-gems').value);
        const gems = isNaN(gVal) ? 5 : gVal;
        const tgVal=parseInt(document.getElementById('list-teach-gems').value);
        const teachGems = isNaN(tgVal) ? 2 : tgVal;
        const pVal=parseInt(document.getElementById('list-pass-score').value);
        const passScore = isNaN(pVal) ? 100 : pVal;
        
        const rows = document.querySelectorAll('.edit-row');
        const qs = [];
        rows.forEach(r => {
            const a = parseInt(r.querySelector('.inp-a').value);
            const b = parseInt(r.querySelector('.inp-b').value);
            if(!isNaN(a) && !isNaN(b)) qs.push({a,b});
        });
        if(qs.length===0) return alert("è‡³å°‘ä¸€é¡Œ");
        
        const data = {name, gems, teachGems, passScore, qs};
        if(editingId === null) allLists.push(data); else allLists[editingId] = data;
        saveData(); showPage('page-home');
    }
    function delList(i) { if(confirm("åˆªé™¤?")) { allLists.splice(i,1); saveData(); renderLists(); } }
    
    function exportData() {
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
        const exportObj = {
            version: "4.5",
            student: { name: studentName, totalGems: totalGems },
            lists: allLists,
            exchangeLog: exchangeLog
        };
        const blob = new Blob([JSON.stringify(exportObj)], {type: "application/json"});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob);
        a.download = `multiplication_backup_${dateStr}.json`; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function handleImport(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) {
                    allLists = allLists.concat(d); 
                } else if (d.lists) {
                    allLists = allLists.concat(d.lists);
                    if(d.student) {
                        if(confirm(`åŒ¯å…¥è³‡æ–™åŒ…å«å­¸å“¡ï¼š${d.student.name} (å¯¶çŸ³:${d.student.totalGems})ã€‚\nè¦è¦†è“‹ç›®å‰çš„é€²åº¦å—ï¼Ÿ`)) {
                            studentName = d.student.name;
                            totalGems = d.student.totalGems;
                            if(d.exchangeLog) exchangeLog = d.exchangeLog;
                            saveStudentData();
                        }
                    }
                }
                saveData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ");
            } catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f);
    }

    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        
        if(mode === 'teach') {
            quizSettings.voice = document.getElementById('opt-voice').checked;
            quizSettings.text = document.getElementById('opt-text').checked;
            quizSettings.arrow = document.getElementById('opt-arrow').checked;
        }

        quizData = currentList.qs.map(q => ({
            a: q.a, b: q.b, userAns: null, steps: [], stepIdx: 0
        }));
        
        if(mode === 'teach') {
            quizData.forEach(q => { q.steps = generateDetailedSteps(q.a, q.b); });
        }

        currentQIdx = 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        document.getElementById('q-mode').innerText = mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼';
        document.getElementById('teach-area').style.display = mode==='teach'?'block':'none';
        document.getElementById('test-area').style.display = mode==='test'?'block':'none';
        
        showPage('page-quiz');
        speak(`${studentName}ï¼Œæº–å‚™é–‹å§‹${mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼'}ï¼ŒåŠ æ²¹ï¼`);
        loadQuestion();
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡º?")) { clearInterval(timerInt); showPage('page-home'); } }
    function updTime() {
        const s = Math.floor((Date.now()-startTime)/1000);
        document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
    }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('btn-prev').style.visibility = currentQIdx===0 ? 'hidden' : 'visible';
        document.getElementById('btn-next-q').style.display = 'none'; 
        
        if(currentMode === 'test') {
            document.getElementById('btn-next').style.display = currentQIdx===quizData.length-1 ? 'none' : 'inline-block';
            document.getElementById('btn-submit').style.display = currentQIdx===quizData.length-1 ? 'inline-block' : 'none';
            document.getElementById('test-q-text').innerText = `${q.a} Ã— ${q.b} = ?`;
            document.getElementById('test-ans').value = q.userAns !== null ? q.userAns : '';
        } else {
            document.getElementById('btn-next').style.display = 'none'; 
            document.getElementById('btn-submit').style.display = 'none';
            renderTeachGrid(q);
        }
    }

    function navQuestion(dir) {
        if(currentMode === 'test') quizData[currentQIdx].userAns = document.getElementById('test-ans').value;
        currentQIdx += dir;
        loadQuestion();
    }

    function goToNextQuestion() {
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            submitTest();
        }
    }

    function submitTest() {
        if(currentMode === 'test') quizData[currentQIdx].userAns = document.getElementById('test-ans').value;
        clearInterval(timerInt);
        let correct = 0;
        quizData.forEach(q => {
            if(parseInt(q.userAns) === (q.a * q.b)) correct++;
        });
        showResult(Math.round((correct/quizData.length)*100), correct, quizData.length);
    }

    function generateDetailedSteps(a, b) {
        let sA = a.toString();
        let sB = b.toString();
        let steps = [];
        let cols = sA.length + sB.length + 1;
        
        const ROW_MUL_CARRY = 0;
        const ROW_A = 1;
        const ROW_B = 2;
        const ROW_MUL_LINE = 3;
        const ROW_PARTIAL_START = 4;
        const hasAddition = sB.length > 1;
        const ROW_ADD_CARRY = hasAddition ? (ROW_PARTIAL_START + sB.length) : -1;
        const ROW_ADD_LINE = hasAddition ? (ROW_ADD_CARRY + 1) : -1;
        const ROW_FINAL_SUM = hasAddition ? (ROW_ADD_LINE + 1) : (ROW_PARTIAL_START);
        let gridSim = {}; 

        for(let j = sB.length - 1; j >= 0; j--) {
            let digitB = parseInt(sB[j]);
            let currentCarry = 0;
            let shift = (sB.length - 1) - j; 
            let currentRow = ROW_PARTIAL_START + (sB.length - 1 - j); 
            
            if(shift > 0) {
                steps.push({ type: 'clear_mul_carry', hint: `é–‹å§‹è¨ˆç®—ä¹˜æ•¸çš„åä½æ•¸ï¼Œå…ˆæ¸…ç©ºé€²ä½ã€‚` });
            }

            for(let i = sA.length - 1; i >= 0; i--) {
                let digitA = parseInt(sA[i]);
                let rawProd = digitA * digitB;
                let product = rawProd + currentCarry;
                let unit = product % 10;
                let newCarry = Math.floor(product / 10);
                let gridCol = cols - 1 - shift - (sA.length - 1 - i);
                
                let srcRowA = ROW_A; let srcColA = cols - sA.length + i;
                let srcRowB = ROW_B; let srcColB = cols - sB.length + j;
                let isLastInRow = (i === 0);
                let writeCarryVal = isLastInRow ? 0 : newCarry;

                let step = {
                    type: 'mul', aDigit: digitA, bDigit: digitB, prevCarry: currentCarry, rawProd: rawProd, totalProd: product,
                    writeAns: unit, writeCarry: writeCarryVal, ansRow: currentRow, ansCol: gridCol,
                    carryRow: ROW_MUL_CARRY, carryCol: gridCol - 1, isLastInRow: isLastInRow,
                    isMultiDigit: true, srcRowA: srcRowA, srcColA: srcColA, srcRowB: srcRowB, srcColB: srcColB
                };
                
                let hint = `è«‹è¨ˆç®— ${digitA} ä¹˜ä»¥ ${digitB} æ˜¯å¤šå°‘ï¼Ÿ`;
                if(currentCarry > 0) hint += ` (åˆ¥å¿˜äº†åŠ ä¸Šé€²ä½ ${currentCarry})`;
                step.hint = hint;
                
                step.fullExplanation = `è¨ˆç®—ï¼š${digitA} Ã— ${digitB} = ${rawProd}<br>${currentCarry > 0 ? `åŠ ä¸Šé€²ä½ï¼š${rawProd} + ${currentCarry} = ${product}<br>` : ''}å¡«å¯«ï¼šå€‹ä½ ${unit} ${newCarry > 0 ? `ï¼Œé€²ä½ ${newCarry}` : ''}`;

                steps.push(step);
                gridSim[`${currentRow}-${gridCol}`] = unit;
                if(isLastInRow && newCarry > 0) gridSim[`${currentRow}-${gridCol-1}`] = newCarry;
                currentCarry = newCarry;
            }
        }

        if(hasAddition) {
            steps.push({ type: 'clear_mul_carry', hint: 'ä¹˜æ³•å®Œæˆï¼Œæ¸…ç©ºé€²ä½æº–å‚™ç›¸åŠ ã€‚' });
            steps.push({ type: 'line', row: ROW_ADD_LINE, hint: 'ç•«ç·šæº–å‚™ç›¸åŠ ã€‚' });
            let sTotal = (a * b).toString();
            let currentSumCarry = 0;
            
            for(let c = cols - 1; c >= 0; c--) {
                let colSum = currentSumCarry;
                let hasVal = false;
                if(currentSumCarry > 0) hasVal = true;
                for(let r = ROW_PARTIAL_START; r < ROW_PARTIAL_START + sB.length; r++) {
                    let val = gridSim[`${r}-${c}`];
                    if(val !== undefined) { colSum += val; hasVal = true; }
                }
                let expectedIndex = cols - sTotal.length;
                if(c < expectedIndex && !hasVal) break;
                let unit = colSum % 10;
                let newCarry = Math.floor(colSum / 10);
                let step = {
                    type: 'add', writeAns: unit, writeCarry: newCarry, 
                    ansRow: ROW_FINAL_SUM, ansCol: c, carryRow: ROW_ADD_CARRY, carryCol: c - 1,
                    hint: `å°‡é€™ä¸€è¡Œçš„æ•¸å­—ç›¸åŠ  ${currentSumCarry > 0 ? '(å«ä¹‹å‰é€²ä½)' : ''}ï¼Œé€™æ ¼è©²å¡«å¤šå°‘ï¼Ÿ`,
                    fullExplanation: `ç›´è¡Œç›¸åŠ çµæœï¼š${colSum}ã€‚å¡«å¯« ${unit} ${newCarry > 0 ? 'ï¼Œé€²ä½ ' + newCarry : ''}ã€‚`,
                    isLast: (c === expectedIndex)
                };
                steps.push(step);
                currentSumCarry = newCarry;
            }
        }
        return steps;
    }

    function renderTeachGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML = '';
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "arrow-layer"; svg.setAttribute("class", "arrow-layer");
        svg.innerHTML = `<defs><marker id="arrowhead" markerWidth="3" markerHeight="2" refX="2" refY="1" orient="auto"><polygon points="0 0, 3 1, 0 2" fill="#e74c3c" /></marker></defs><line id="calc-arrow" x1="0" y1="0" x2="0" y2="0" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead)" style="display:none;" />`;
        box.appendChild(svg);

        const msg = document.getElementById('teach-msg');
        document.getElementById('help-content').style.display = 'none'; 
        document.getElementById('btn-help-trigger').style.display = 'inline-block';

        if(!q || q.a === undefined) { msg.innerText = "é¡Œç›®éŒ¯èª¤"; return; }

        const sA = q.a.toString(), sB = q.b.toString();
        const cols = sA.length + sB.length + 1;
        const hasAddition = sB.length > 1;
        let totalRows = hasAddition ? (4 + sB.length + 3) : (4 + sB.length); 
        const mulLineRow = 3;
        const addCarryRow = hasAddition ? (4 + sB.length) : -1;
        const addLineRow = hasAddition ? (addCarryRow + 1) : -1; 

        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

        for(let r=0; r<totalRows; r++) {
            for(let c=0; c<cols; c++) {
                let cell = document.createElement('div');
                cell.className='grid-cell'; cell.id=`c-${r}-${c}`;
                if(r===0) cell.style.height = '30px';
                if(r===addCarryRow) cell.style.height = '20px'; 
                if(r === mulLineRow || (hasAddition && r === addLineRow)) { cell.style.height = '5px'; cell.style.padding = '0'; }
                box.appendChild(cell);
            }
        }

        for(let i=0; i<sA.length; i++) { document.getElementById(`c-1-${cols-sA.length+i}`).innerText = sA[i]; }
        let opCell = document.getElementById(`c-2-${cols-sB.length-1}`); opCell.innerText = 'Ã—'; opCell.classList.add('operator');
        for(let i=0; i<sB.length; i++) { document.getElementById(`c-2-${cols-sB.length+i}`).innerText = sB[i]; }
        for(let c=0; c<cols; c++) { document.getElementById(`c-2-${c}`).classList.add('multiplication-line'); }

        for(let i=0; i<q.stepIdx; i++) {
            let s = q.steps[i];
            if(s.type === 'clear_mul_carry') {
                for(let c=0; c<cols; c++) { if(document.getElementById(`c-0-${c}`)) document.getElementById(`c-0-${c}`).innerHTML = ''; }
                continue;
            }
            if(s.type === 'line') {
                for(let c=0; c<cols; c++) {
                    let cell = document.getElementById(`c-${s.row}-${c}`);
                    if(cell) {
                        cell.classList.add('multiplication-line');
                        if(c===0 && s.row === addLineRow) {
                            let plusCell = document.getElementById(`c-${s.row-1}-0`);
                            if(plusCell) { plusCell.innerText = '+'; plusCell.classList.add('operator'); }
                        }
                    }
                }
                continue;
            }
            if(s.type === 'mul' && s.isLastInRow && s.totalProd >= 10) {
                let strVal = s.totalProd.toString(); 
                let unitCell = document.getElementById(`c-${s.ansRow}-${s.ansCol}`); if(unitCell) unitCell.innerText = strVal[1];
                let tenCell = document.getElementById(`c-${s.ansRow}-${s.ansCol-1}`); if(tenCell) tenCell.innerText = strVal[0];
            } else {
                let ansCell = document.getElementById(`c-${s.ansRow}-${s.ansCol}`); if(ansCell) ansCell.innerText = s.writeAns;
            }
            if(s.writeCarry > 0) {
                let carryCell = document.getElementById(`c-${s.carryRow}-${s.carryCol}`); if(carryCell) carryCell.innerHTML = `<div class="carry-display">${s.writeCarry}</div>`;
            }
        }

        if(q.stepIdx >= q.steps.length) {
            msg.innerText = "å¤ªæ£’äº†ï¼æœ¬é¡Œå®Œæˆã€‚";
            document.getElementById('btn-help-trigger').style.display = 'none';
            q.userAns = q.a * q.b; 
            for(let c=0; c<cols; c++) { 
                if(document.getElementById(`c-0-${c}`)) document.getElementById(`c-0-${c}`).innerHTML = ''; 
                if(addCarryRow > 0 && document.getElementById(`c-${addCarryRow}-${c}`)) { if(c > 0) document.getElementById(`c-${addCarryRow}-${c}`).innerHTML = ''; }
            }
            document.getElementById('btn-next-q').style.display = 'block';
            let btnNext = document.getElementById('btn-next-q');
            if(currentQIdx >= quizData.length - 1) btnNext.innerText = "å…¨éƒ¨å®Œæˆï¼æŸ¥çœ‹æˆç¸¾ ğŸ†"; else btnNext.innerText = "ğŸ‰ æœ¬é¡Œå®Œæˆï¼é€²å…¥ä¸‹ä¸€é¡Œ â¡";
            return;
        }

        let cur = q.steps[q.stepIdx];
        drawArrow(cur);
        if(cur.type === 'clear_mul_carry' || cur.type === 'line') { setTimeout(() => { q.stepIdx++; renderTeachGrid(q); }, 500); return; }
        if(quizSettings.text) msg.innerText = cur.hint; else msg.innerText = "";
        if(quizSettings.voice) speak(cur.hint);
        setTimeout(() => { createStepInputs(cur, q); }, 50);
    }

    function drawArrow(step) {
        let arrowLine = document.getElementById('calc-arrow'); if(!arrowLine) return;
        if(!quizSettings.arrow || step.type !== 'mul') { arrowLine.style.display = 'none'; return; }
        if(step.type === 'mul') {
            let cellA = document.getElementById(`c-${step.srcRowA}-${step.srcColA}`);
            let cellB = document.getElementById(`c-${step.srcRowB}-${step.srcColB}`);
            if(cellA && cellB) {
                let x1 = cellB.offsetLeft + cellB.offsetWidth / 2;
                let y1 = cellB.offsetTop + cellB.offsetHeight / 2;
                let x2 = cellA.offsetLeft + cellA.offsetWidth / 2;
                let y2 = cellA.offsetTop + cellA.offsetHeight / 2;
                let angle = Math.atan2(y2 - y1, x2 - x1);
                let padding = 15; 
                x1 += Math.cos(angle) * padding; y1 += Math.sin(angle) * padding;
                x2 -= Math.cos(angle) * padding; y2 -= Math.sin(angle) * padding;
                arrowLine.setAttribute('x1', x1); arrowLine.setAttribute('y1', y1);
                arrowLine.setAttribute('x2', x2); arrowLine.setAttribute('y2', y2);
                arrowLine.style.display = 'block'; return;
            }
        }
        arrowLine.style.display = 'none';
    }

    function createStepInputs(step, q) {
        let msgArea = document.getElementById('teach-msg');
        let oldBtn = msgArea.querySelector('button'); if(oldBtn) oldBtn.remove();
        
        // æ”¶é›†æ‰€æœ‰éœ€è¦çš„ inputs å¼•ç”¨ï¼Œç”¨æ–¼è¨­å®šè·³è½‰é †åº
        let inputsOrder = [];

        // 1. å¦‚æœæœ‰é€²ä½ (è¼”åŠ©è¨˜è™Ÿ)ï¼Œé€šå¸¸åœ¨æœ€å·¦é‚Šæˆ–ä¸Šé¢ï¼Œå…ˆåŠ å…¥
        let needsCarry = (step.type==='mul' && !step.isLastInRow && step.writeCarry > 0) || (step.type==='add' && step.writeCarry > 0);
        
        if(needsCarry) {
            let carryCell = document.getElementById(`c-${step.carryRow}-${step.carryCol}`);
            if(carryCell) { 
                carryCell.innerHTML = ''; 
                let cinp = createInput('inp-carry', 'carry-input', step, q); 
                carryCell.appendChild(cinp);
                inputsOrder.push(cinp); // é€²ä½å„ªå…ˆ
            }
        }

        // 2. å¦‚æœæ˜¯ä¹˜æ³•ä¸”æ˜¯è©²è¡Œæœ€å¾Œä¸€æ­¥ (ä¾‹å¦‚ 9x9=81)ï¼Œæœƒæœ‰åä½æ•¸å’Œå€‹ä½æ•¸
        if(step.type === 'mul' && step.isLastInRow && step.totalProd >= 10) {
            let tenCell = document.getElementById(`c-${step.ansRow}-${step.ansCol-1}`);
            if(tenCell) { 
                tenCell.innerHTML = ''; 
                let inpTen = createInput('inp-ans-ten', 'game-input', step, q); 
                tenCell.appendChild(inpTen);
                inputsOrder.push(inpTen); // åä½æ•¸ (å·¦é‚Š)
            }
            
            let unitCell = document.getElementById(`c-${step.ansRow}-${step.ansCol}`);
            if(unitCell) { 
                unitCell.innerHTML = ''; 
                let inpUnit = createInput('inp-ans-unit', 'game-input', step, q); 
                unitCell.appendChild(inpUnit); 
                inputsOrder.push(inpUnit); // å€‹ä½æ•¸ (å³é‚Š)
            }
        } else {
            // æ™®é€šæƒ…æ³ï¼šåªæœ‰ä¸€å€‹çµæœæ ¼
            let ansCell = document.getElementById(`c-${step.ansRow}-${step.ansCol}`);
            if(ansCell) { 
                ansCell.innerHTML = ''; 
                let inp = createInput('inp-ans', 'game-input', step, q); 
                ansCell.appendChild(inp); 
                inputsOrder.push(inp);
            }
        }

        // 3. è¨­å®šè‡ªå‹•è·³è½‰é‚è¼¯
        setupInputNavigation(inputsOrder, step, q);

        // éš±è—åŸæœ¬çš„ OK æŒ‰éˆ•ï¼Œæ”¹ç‚ºè‡ªå‹•è§¸ç™¼
        let btn = document.createElement('button'); 
        btn.className = 'btn-warning'; 
        btn.innerText = 'OK'; 
        btn.style.marginLeft = "10px";
        btn.style.display = "none"; // éš±è—æŒ‰éˆ•ï¼Œä¾é è‡ªå‹•è·³è½‰
        btn.onclick = () => checkStepAnswer(step, q, false); 
        if(msgArea.innerText === "") msgArea.style.minHeight = "40px"; 
        msgArea.appendChild(btn);
    }

    function createInput(id, className, step, q) {
        let inp = document.createElement('input'); 
        inp.type = 'tel'; // ä½¿ç”¨ tel éµç›¤ä¾¿æ–¼æ‰‹æ©Ÿè¼¸å…¥æ•¸å­—
        inp.className = className; 
        inp.id = id;
        inp.maxLength = 1; // é™åˆ¶åªèƒ½è¼¸å…¥ 1 å€‹å­—å…ƒ
        return inp;
    }

    function setupInputNavigation(inputs, step, q) {
        if (inputs.length === 0) return;

        // èšç„¦ç¬¬ä¸€å€‹è¼¸å…¥æ¡† (æœ€å·¦é‚Šæˆ–è¼”åŠ©è¨˜è™Ÿ)
        inputs[0].focus();

        inputs.forEach((inp, index) => {
            inp.oninput = function() {
                // ç§»é™¤éæ•¸å­—
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // ç§»é™¤éŒ¯èª¤ç´…æ¡† (å¦‚æœæœ‰çš„è©±)
                this.classList.remove('wrong');

                if (this.value.length === 1) {
                    if (index < inputs.length - 1) {
                        // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹ï¼Œè·³åˆ°ä¸‹ä¸€å€‹
                        inputs[index + 1].focus();
                    } else {
                        // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹ï¼ŒåŸ·è¡Œæª¢æŸ¥
                        checkStepAnswer(step, q, true);
                    }
                }
            };

            // æ”¯æ´ Backspace åˆªé™¤ä¸¦å›åˆ°ä¸Šä¸€æ ¼
            inp.onkeydown = function(e) {
                if (e.key === 'Backspace' && this.value === '') {
                    if (index > 0) {
                        inputs[index - 1].focus();
                    }
                }
            };
        });
    }

    function checkStepAnswer(step, q, isAuto) {
        let allCorrect = true; let allFilled = true;
        let iTen = document.getElementById('inp-ans-ten'); let iUnit = document.getElementById('inp-ans-unit');
        let iAns = document.getElementById('inp-ans'); let iCarry = document.getElementById('inp-carry');

        if(step.type === 'mul' && step.isLastInRow && step.totalProd >= 10) { if(!iTen || !iUnit || iTen.value==='' || iUnit.value==='') allFilled = false; } else { if(!iAns || iAns.value==='') allFilled = false; }
        let needsCarry = (step.type==='mul' && !step.isLastInRow && step.writeCarry > 0) || (step.type==='add' && step.writeCarry > 0);
        if(needsCarry) { if(!iCarry || iCarry.value==='') allFilled = false; }

        if(isAuto && !allFilled) return; // è‡ªå‹•æ¨¡å¼ä¸‹ï¼Œæœªå¡«å®Œä¸å ±éŒ¯ï¼Œåƒ…ç­‰å¾…

        if(step.type === 'mul' && step.isLastInRow && step.totalProd >= 10) {
            let tenVal = Math.floor(step.totalProd / 10); let unitVal = step.totalProd % 10;
            if(parseInt(iTen.value) !== tenVal) { if(!isAuto || iTen.value.length>0) iTen.classList.add('wrong'); allCorrect = false; } else { iTen.classList.remove('wrong'); if(isAuto) iTen.classList.add('correct'); }
            if(parseInt(iUnit.value) !== unitVal) { if(!isAuto || iUnit.value.length>0) iUnit.classList.add('wrong'); allCorrect = false; } else { iUnit.classList.remove('wrong'); if(isAuto) iUnit.classList.add('correct'); }
        } else {
            if(parseInt(iAns.value) !== step.writeAns) { if(!isAuto || iAns.value.length>0) iAns.classList.add('wrong'); allCorrect = false; } else { iAns.classList.remove('wrong'); if(isAuto) iAns.classList.add('correct'); }
        }

        if(needsCarry) {
            if(parseInt(iCarry.value) !== step.writeCarry) { if(!isAuto || iCarry.value.length>0) iCarry.classList.add('wrong'); allCorrect = false; } else { iCarry.classList.remove('wrong'); if(isAuto) iCarry.classList.add('correct'); }
        }

        if(allCorrect) {
            if(!isAuto) { if(quizSettings.voice) speak("ç­”å°äº†ï¼"); else speak("å®å’š"); } else { speak("å®å’š"); }
            if(iTen) iTen.disabled = true; if(iUnit) iUnit.disabled = true; if(iAns) iAns.disabled = true; if(iCarry) iCarry.disabled = true;
            setTimeout(() => { q.stepIdx++; renderTeachGrid(q); }, 500);
        } else { 
            // å¦‚æœå¡«æ»¿äº†ä½†éŒ¯èª¤ï¼Œæ‰å ±éŒ¯
            if(allFilled) {
                if(quizSettings.voice) speak("ç®—éŒ¯å›‰"); else speak("å—¶å—¶"); 
            }
        }
    }

    function toggleHelp() {
        const box = document.getElementById('help-content');
        if(box.style.display === 'block') { box.style.display = 'none'; return; }
        const q = quizData[currentQIdx]; const step = q.steps[q.stepIdx];
        box.innerHTML = step.fullExplanation || `<strong>æç¤ºï¼š</strong> ${step.hint}`; box.style.display = 'block';
    }

    function showResult(score, correct, total) {
        showPage('page-result');
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-detail').innerText = `ç­”å° ${correct} / ${total} é¡Œ`;
        document.getElementById('res-time').innerText = `è€—æ™‚ ${document.getElementById('q-timer').innerText}`;
        
        // --- å¯¶çŸ³çå‹µ ---
        const rewardArea = document.getElementById('reward-area');
        rewardArea.innerHTML = '';
        
        let targetScore = currentList.passScore || 100;
        let gemsReward = currentList.gems || 5;
        let teachGemsReward = currentList.teachGems || 2;
        let earnedGems = 0;

        if (currentMode === 'test' && score >= targetScore) earnedGems = gemsReward;
        else if (currentMode === 'teach' && score === 100) earnedGems = teachGemsReward;

        if (earnedGems > 0) {
            let oldGems = totalGems; let oldCrowns = Math.floor(oldGems / 100);
            totalGems += earnedGems; saveStudentData(); 
            let newCrowns = Math.floor(totalGems / 100); let earnedCrowns = newCrowns - oldCrowns;

            if (earnedCrowns > 0) {
                triggerRewardAnimation('crown');
                rewardArea.innerHTML = `<div class="reward-popup" style="border-color:#e67e22; color:#e67e22;">ğŸ‘‘ æ­å–œå‡ç´šï¼ç²å¾— ${earnedCrowns} é ‚çš‡å† ï¼<br>(åŒæ™‚ç²å¾— ${earnedGems} é¡†å¯¶çŸ³)</div>`;
                speak(`å¤ªå²å®³äº†ï¼åˆ†æ•¸é”æ¨™ï¼æ­å–œä½ ç²å¾—äº† ${earnedCrowns} é ‚çš‡å† ï¼`);
            } else {
                triggerRewardAnimation('gem');
                rewardArea.innerHTML = `<div class="reward-popup">ğŸ‰ æ­å–œé”æ¨™ï¼ç²å¾— ${earnedGems} é¡†å¯¶çŸ³ ğŸ’<br>ç›®å‰ç´¯ç©: ${totalGems} é¡†</div>`;
                speak(`å¤ªæ£’äº†ï¼åˆ†æ•¸é”æ¨™ï¼ä½ ç²å¾—äº† ${earnedGems} é¡†å¯¶çŸ³ï¼`);
            }
        } else {
            let praise = score>=60?"è¡¨ç¾ä¸éŒ¯ï¼Œä¸‹æ¬¡æŒ‘æˆ°æ‹¿å¯¶çŸ³ï¼":"å†å¤šç·´ç¿’å¹¾æ¬¡ï¼ŒåŠ æ²¹ï¼";
            speak(`æ¸¬é©—çµæŸï¼Œä½ å¾—äº†${score}åˆ†ã€‚${praise}`);
        }
    }

    function triggerRewardAnimation(type) {
        const container = document.getElementById('particle-container');
        container.style.display = 'block'; container.innerHTML = ''; 
        let symbol = type === 'crown' ? 'ğŸ‘‘' : 'ğŸ’';
        for (let i = 0; i < 30; i++) {
            let p = document.createElement('div'); p.innerText = symbol; p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw'; p.style.animationDuration = (Math.random() * 2 + 1) + 's'; 
            p.style.fontSize = (Math.random() * 2 + 1) + 'rem'; container.appendChild(p);
        }
        setTimeout(() => { container.style.display = 'none'; container.innerHTML = ''; }, 3000);
    }
</script>

</body>
</html>
