<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹˜æ³•é—–é—œç‹ 3.6 (é‚è¼¯ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --light: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --cell-size: 50px; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { color: var(--primary); margin: 10px 0; text-align: center; font-size: 1.8rem;}

        .user-profile {
            background-color: #fff3cd;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: #d35400;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user-profile:active { transform: scale(0.98); }

        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 6px; padding: 8px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 2px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-help { background-color: #e67e22; box-shadow: 0 4px #d35400; }
        .btn-help:active { box-shadow: 0 0 #d35400; transform: translateY(4px); }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; }
        
        .btn-next-level {
            background-color: #27ae60;
            color: white;
            font-size: 1.5rem;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 6px #1e8449;
            margin-top: 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: none; 
        }
        .btn-next-level:active { transform: translateY(6px); box-shadow: 0 0 #1e8449; }
        @keyframes popIn { from {transform: scale(0);} to {transform: scale(1);} }

        .list-item {
            background: #fdf2ff; border: 1px solid #e1bee7; padding: 10px; margin-bottom: 8px;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
        }

        .gen-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; background: #f3e5f5; padding: 10px; border-radius: 8px;}
        .gen-controls input { padding: 5px; width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px;}
        .edit-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .edit-row input { padding: 5px; flex: 1; text-align: center; border: 1px solid #ccc; border-radius: 4px;}

        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 6px; }
        
        .settings-panel {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .settings-panel h3 { margin: 0 0 10px 0; color: var(--dark); font-size: 1.1rem; }
        .settings-panel label { display: block; margin-bottom: 8px; cursor: pointer; font-size: 1.1rem; }
        .settings-panel input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; }

        .grid-container {
            display: grid; 
            grid-auto-rows: 50px; 
            justify-content: center; 
            margin: 20px 0;
            gap: 0;
            position: relative; 
        }
        .grid-cell {
            width: var(--cell-size); 
            height: 50px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            font-size: 1.8rem; 
            position: relative;
            z-index: 2; 
        }
        
        .arrow-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 1;
        }

        .game-input { 
            width: 90%; height: 90%; margin: auto;
            font-size: 1.5rem; text-align: center; 
            border: 3px solid var(--primary); border-radius: 8px; background: #fff; outline: none;
            z-index: 10;
        }
        .game-input.correct { border-color: #27ae60; background-color: #d5f5e3; color: #27ae60; }
        .game-input:focus { border-color: #2ecc71; background: #e8f8f5; box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }

        .carry-input {
            width: 36px; 
            height: 36px; 
            font-size: 1.3rem; 
            text-align: center;
            border: 2px solid #e67e22; 
            border-radius: 50%; 
            background: #fef5e7; 
            outline: none;
            position: absolute; 
            bottom: 0px; 
            color: #d35400;
            z-index: 10;
            font-weight: bold;
        }
        .carry-input.correct { border-color: #27ae60; background-color: #d5f5e3; color: #27ae60; }
        .carry-input:focus { transform: scale(1.1); border-color: #d35400; box-shadow: 0 0 5px #e67e22; }

        .game-input.wrong, .carry-input.wrong { background: #fadbd8; border-color: var(--danger); animation: shake 0.4s; }
        
        .multiplication-line { border-bottom: 3px solid #333; }
        .operator { color: var(--primary); }

        .help-box {
            background: #fff8e1; border-left: 5px solid #ffc107; padding: 10px; margin: 10px 0;
            border-radius: 5px; display: none; font-size: 1.1rem; text-align: left;
        }
        .highlight-digit { color: #e74c3c; font-weight: bold; transform: scale(1.2); display:inline-block;}

        .test-mode-box { text-align: center; padding: 30px; font-size: 1.5rem; }
        .test-input { font-size: 1.5rem; padding: 8px; width: 120px; text-align: center; border: 2px solid #ccc; border-radius: 6px; margin-left: 10px; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .rank-1 { color: #f39c12; font-weight: bold; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .version-tag {
            margin-top: 30px;
            color: #27ae60;
            font-size: 1rem;
            text-align: center;
            font-family: monospace;
            border-top: 1px dashed #eee;
            padding-top: 10px;
            font-weight: bold;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div id="page-home" class="container active">
        <h1>âœ–ï¸ ä¹˜æ³•é—–é—œç‹ 3.6</h1>
        
        <div class="user-profile" onclick="changeName()">
            <span>ğŸ“</span> <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> <span>âœ</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px; display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡º (å«æ™‚é–“)</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv3.6 (é‚è¼¯ä¿®æ­£ç‰ˆ)</div>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:10px;">
            åç¨±: <input type="text" id="list-name" style="padding:5px; width:200px;">
        </div>
        <div class="gen-controls">
            <span>ç”Ÿæˆ:</span>
            é¡Œæ•¸<input type="number" id="gen-count" value="5">
            è¢«ä¹˜æ•¸ä½æ•¸<input type="number" id="gen-len-a" value="2">
            ä¹˜æ•¸ä½æ•¸<input type="number" id="gen-len-b" value="2">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
            <div id="editor-rows"></div>
        </div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        
        <div class="settings-panel">
            <h3>ğŸ› ï¸ æ•™å­¸è¼”åŠ©è¨­å®š (é€æ­¥æ’¤é™¤é·¹æ¶)</h3>
            <label><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º (é¡Œç›®å¼•å°)</label>
            <label><input type="checkbox" id="opt-text" checked> ğŸ”¤ æ–‡å­—æç¤º (æ“ä½œèªªæ˜)</label>
            <label><input type="checkbox" id="opt-arrow" checked> â†—ï¸ ç®­é ­æç¤º (è¨ˆç®—é †åº)</label>
        </div>

        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– æ•™å­¸æ¨¡å¼ (é€æ­¥å¼•å°)</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ æ¸¬é©—æ¨¡å¼ (ç›´æ¥è¨ˆç®—)</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:20px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-mode">æ¨¡å¼</span>
        </div>

        <div id="teach-area" style="display:none;">
            <div style="text-align: center; margin-bottom: 10px;">
                <div id="teach-msg" style="color:#8e44ad; font-weight:bold; font-size:1.2rem; min-height:1.5em; margin-bottom:10px;"></div>
                <button id="btn-help-trigger" class="btn-help" onclick="toggleHelp()">ğŸ’¡ æ±‚åŠ©ï¼šé€™ä¸€æ­¥æ€éº¼ç®—ï¼Ÿ</button>
                <div id="help-content" class="help-box"></div>
            </div>
            
            <div class="grid-container" id="gridBoard">
                <svg id="arrow-layer" class="arrow-layer">
                    <defs>
                        <marker id="arrowhead" markerWidth="3" markerHeight="2" refX="2" refY="1" orient="auto">
                            <polygon points="0 0, 3 1, 0 2" fill="#e74c3c" />
                        </marker>
                    </defs>
                    <line id="calc-arrow" x1="0" y1="0" x2="0" y2="0" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead)" style="display:none;" />
                </svg>
            </div>
            
            <div style="text-align: center;">
                <button id="btn-next-q" class="btn-next-level" onclick="goToNextQuestion()">ğŸ‰ æœ¬é¡Œå®Œæˆï¼é€²å…¥ä¸‹ä¸€é¡Œ â¡</button>
            </div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="font-size:2rem; margin-bottom:20px;"></div>
                ç­”æ¡ˆ: <input type="number" id="test-ans" class="test-input">
            </div>
        </div>

        <div class="quiz-nav" style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-gray" id="btn-prev" onclick="navQuestion(-1)">ä¸Šä¸€é¡Œ</button>
            <button class="btn-primary" id="btn-next" onclick="navQuestion(1)">ä¸‹ä¸€é¡Œ</button>
            <button class="btn-success" id="btn-submit" onclick="submitTest()" style="display:none;">äº¤å·</button>
        </div>
        
        <button class="btn-danger" style="float:right; margin-top:10px;" onclick="quitQuiz()">é€€å‡º</button>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 3rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-detail" style="font-size: 1.2rem; margin: 10px;">ç­”å° 5 / 5 é¡Œ</div>
            <div id="res-time" style="color:#777;">è€—æ™‚ 01:20</div>
            
            <div style="margin-top:20px;">
                ä½ çš„åå­—: <input type="text" id="player-name" style="padding:5px; font-size:1.2rem; text-align:center;" readonly>
                <button class="btn-warning" onclick="saveRank()">ç™»è¨˜æ¦œå–®</button>
            </div>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let cleanText = text.replace(/<[^>]*>/g, '').replace(/Ã—/g, 'ä¹˜ä»¥').replace(/\+/g, 'åŠ ').replace(/=/g, 'ç­‰æ–¼');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'zh-TW'; utterance.rate = 1.0; 
            window.speechSynthesis.speak(utterance);
        }
    }

    let allLists = [], currentList = null, quizData = [], currentQIdx = 0, currentMode = '', editingId = null;
    let timerInt, startTime, rankData = [];
    let studentName = "å°å°å­¸å“¡"; 

    let settingVoice = true;
    let settingText = true;
    let settingArrow = true;

    const STORAGE_KEY_LISTS = 'mul_v3_6_lists';
    const STORAGE_KEY_RANK = 'mul_v3_6_rank';
    const STORAGE_KEY_USER = 'mul_v3_6_user';

    window.onload = function() {
        if(localStorage.getItem(STORAGE_KEY_LISTS)) {
            allLists = JSON.parse(localStorage.getItem(STORAGE_KEY_LISTS));
        } else {
            allLists = [{name: "é€²éšç·´ç¿’ (2ä½æ•¸)", qs: [{a:56, b:29}, {a:48, b:5}, {a:75, b:14}]}];
            saveData();
        }
        if(localStorage.getItem(STORAGE_KEY_RANK)) {
            rankData = JSON.parse(localStorage.getItem(STORAGE_KEY_RANK));
        }
        if(localStorage.getItem(STORAGE_KEY_USER)) {
            studentName = localStorage.getItem(STORAGE_KEY_USER);
        }
        updateName();
        renderLists();
    };

    function saveData() { localStorage.setItem(STORAGE_KEY_LISTS, JSON.stringify(allLists)); }
    function saveRankData() { localStorage.setItem(STORAGE_KEY_RANK, JSON.stringify(rankData)); }

    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) {
            studentName = n.trim();
            localStorage.setItem(STORAGE_KEY_USER, studentName);
            updateName();
        }
    }
    function updateName() {
        document.getElementById('display-name').innerText = studentName;
        document.getElementById('player-name').value = studentName; 
    }

    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
        if(pid === 'page-result') updateName(); 
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
    }

    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        if(allLists.length===0) c.innerHTML='<p style="text-align:center">ç„¡é¡Œåº«</p>';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            d.innerHTML = `<div><strong>${l.name}</strong> (${l.qs.length}é¡Œ)</div><div><button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button><button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button><button class="btn-danger" onclick="delList(${i})">åˆª</button></div>`;
            c.appendChild(d);
        });
    }

    function createNewList() {
        editingId = null;
        document.getElementById('list-name').value = "æ–°é¡Œåº«";
        document.getElementById('editor-rows').innerHTML = '';
        showPage('page-editor');
    }

    function editList(i) {
        editingId = i; const l = allLists[i];
        document.getElementById('list-name').value = l.name;
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        l.qs.forEach(q => addEditRow(q.a, q.b));
        showPage('page-editor');
    }

    function addEditRow(a='', b='') {
        const div = document.createElement('div'); div.className='edit-row';
        div.innerHTML = `<input type="number" class="inp-a" placeholder="è¢«ä¹˜æ•¸" value="${a}"> Ã— <input type="number" class="inp-b" placeholder="ä¹˜æ•¸" value="${b}"><button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('editor-rows').appendChild(div);
    }

    function autoGenerate() {
        const count = parseInt(document.getElementById('gen-count').value);
        const lenA = parseInt(document.getElementById('gen-len-a').value);
        const lenB = parseInt(document.getElementById('gen-len-b').value);
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        const minA = Math.pow(10, lenA-1), maxA = Math.pow(10, lenA)-1;
        const minB = Math.pow(10, lenB-1), maxB = Math.pow(10, lenB)-1;
        for(let i=0; i<count; i++) {
            let a = Math.floor(Math.random()*(maxA-minA+1)) + minA;
            let b = Math.floor(Math.random()*(maxB-minB+1)) + minB;
            addEditRow(a, b);
        }
    }

    function saveList() {
        const name = document.getElementById('list-name').value;
        const rows = document.querySelectorAll('.edit-row');
        const qs = [];
        rows.forEach(r => {
            const a = parseInt(r.querySelector('.inp-a').value);
            const b = parseInt(r.querySelector('.inp-b').value);
            if(!isNaN(a) && !isNaN(b)) qs.push({a,b});
        });
        if(qs.length===0) return alert("è‡³å°‘ä¸€é¡Œ");
        if(editingId === null) allLists.push({name, qs}); else allLists[editingId] = {name, qs};
        saveData(); showPage('page-home');
    }
    function delList(i) { if(confirm("åˆªé™¤?")) { allLists.splice(i,1); saveData(); renderLists(); } }
    
    function exportData() {
        const blob = new Blob([JSON.stringify(allLists)], {type: "application/json"});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob);
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const timestamp = `${yyyy}${mm}${dd}_${hh}${min}`;
        a.download = `multiplication_data_${timestamp}.json`; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function handleImport(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) { allLists = allLists.concat(d); saveData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ"); }
            } catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f);
    }

    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        
        if(mode === 'teach') {
            settingVoice = document.getElementById('opt-voice').checked;
            settingText = document.getElementById('opt-text').checked;
            settingArrow = document.getElementById('opt-arrow').checked;
        }

        quizData = currentList.qs.map(q => ({
            a: q.a, b: q.b, userAns: null, steps: [], stepIdx: 0
        }));
        
        if(mode === 'teach') {
            quizData.forEach(q => { q.steps = generateDetailedSteps(q.a, q.b); });
        }

        currentQIdx = 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        document.getElementById('q-mode').innerText = mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼';
        document.getElementById('teach-area').style.display = mode==='teach'?'block':'none';
        document.getElementById('test-area').style.display = mode==='test'?'block':'none';
        
        showPage('page-quiz');
        speak(`${studentName}ï¼Œæº–å‚™é–‹å§‹${mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼'}ï¼ŒåŠ æ²¹ï¼`);
        loadQuestion();
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡º?")) { clearInterval(timerInt); showPage('page-home'); } }
    function updTime() {
        const s = Math.floor((Date.now()-startTime)/1000);
        document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
    }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('btn-prev').style.visibility = currentQIdx===0 ? 'hidden' : 'visible';
        document.getElementById('btn-next-q').style.display = 'none'; 
        
        if(currentMode === 'test') {
            document.getElementById('btn-next').style.display = currentQIdx===quizData.length-1 ? 'none' : 'inline-block';
            document.getElementById('btn-submit').style.display = currentQIdx===quizData.length-1 ? 'inline-block' : 'none';
            document.getElementById('test-q-text').innerText = `${q.a} Ã— ${q.b} = ?`;
            document.getElementById('test-ans').value = q.userAns !== null ? q.userAns : '';
        } else {
            document.getElementById('btn-next').style.display = 'none'; 
            document.getElementById('btn-submit').style.display = 'none';
            renderTeachGrid(q);
        }
    }

    function navQuestion(dir) {
        if(currentMode === 'test') quizData[currentQIdx].userAns = document.getElementById('test-ans').value;
        currentQIdx += dir;
        loadQuestion();
    }

    function goToNextQuestion() {
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            submitTest();
        }
    }

    function submitTest() {
        quizData[currentQIdx].userAns = document.getElementById('test-ans').value;
        clearInterval(timerInt);
        let correct = 0;
        quizData.forEach(q => {
            if(parseInt(q.userAns) === (q.a * q.b)) correct++;
        });
        showResult(Math.round((correct/quizData.length)*100), correct, quizData.length);
    }

    // --- é‚è¼¯å‡ç´šï¼šGrid Memory Simulation ---
    function generateDetailedSteps(a, b) {
        let sA = a.toString();
        let sB = b.toString();
        let steps = [];
        
        let cols = sA.length + sB.length + 1;
        let baseRow = 2; 
        
        // å»ºç«‹æ¨¡æ“¬ Grid ä¾†è¨˜éŒ„ä½ç½®ï¼Œæ–¹ä¾¿å¾ŒçºŒåŠ æ³•æŠ“å€¼
        let gridSim = {}; // key: "row-col", value: int

        // 1. ä¹˜æ³•
        for(let j = sB.length - 1; j >= 0; j--) {
            let digitB = parseInt(sB[j]);
            let currentCarry = 0;
            let shift = (sB.length - 1) - j; 
            let currentRow = baseRow + 2 + (sB.length - 1 - j); 
            
            if(shift > 0) {
                steps.push({ type: 'clear_carry', hint: `é–‹å§‹è¨ˆç®—ä¹˜æ•¸çš„åä½æ•¸ï¼Œå…ˆæ¸…ç©ºé€²ä½ã€‚` });
            }

            for(let i = sA.length - 1; i >= 0; i--) {
                let digitA = parseInt(sA[i]);
                let rawProd = digitA * digitB;
                let product = rawProd + currentCarry;
                let unit = product % 10;
                let newCarry = Math.floor(product / 10);
                let gridCol = cols - 1 - shift - (sA.length - 1 - i);
                
                let srcRowA = 1; 
                let srcColA = cols - sA.length + i;
                let srcRowB = 2;
                let srcColB = cols - sB.length + j;

                let isLastInRow = (i === 0);
                let writeCarryVal = isLastInRow ? 0 : newCarry; // æœ€å¾Œä¸€ä½ä¸å¯«é€²ä½æ©˜åœˆ

                let step = {
                    type: 'mul',
                    aDigit: digitA,
                    bDigit: digitB,
                    prevCarry: currentCarry,
                    rawProd: rawProd,
                    totalProd: product,
                    writeAns: unit,
                    writeCarry: writeCarryVal,
                    ansRow: currentRow,
                    ansCol: gridCol,
                    carryRow: 0, 
                    carryCol: gridCol - 1,
                    isLastInRow: isLastInRow,
                    isMultiDigit: true,
                    srcRowA: srcRowA,
                    srcColA: srcColA,
                    srcRowB: srcRowB,
                    srcColB: srcColB
                };
                
                let hint = `è«‹è¨ˆç®— ${digitA} ä¹˜ä»¥ ${digitB} æ˜¯å¤šå°‘ï¼Ÿ`;
                if(currentCarry > 0) hint += ` (åˆ¥å¿˜äº†åŠ ä¸Šé€²ä½ ${currentCarry})`;
                step.hint = hint;
                
                step.fullExplanation = `
                    è¨ˆç®—ï¼š${digitA} Ã— ${digitB} = ${rawProd}<br>
                    ${currentCarry > 0 ? `åŠ ä¸Šé€²ä½ï¼š${rawProd} + ${currentCarry} = ${product}<br>` : ''}
                    å¡«å¯«ï¼šå€‹ä½ ${unit} ${newCarry > 0 ? `ï¼Œé€²ä½ ${newCarry}` : ''}
                `;

                steps.push(step);
                
                // ç´€éŒ„åˆ° GridSim
                if(isLastInRow) {
                    // æœ€å¾Œä¸€ä½ï¼Œå¦‚æœé‚„æœ‰é€²ä½ï¼Œè¦å¯«åœ¨å·¦é‚Šé‚£æ ¼
                    gridSim[`${currentRow}-${gridCol}`] = unit;
                    if(newCarry > 0) {
                        gridSim[`${currentRow}-${gridCol-1}`] = newCarry;
                    }
                } else {
                    gridSim[`${currentRow}-${gridCol}`] = unit;
                }

                currentCarry = newCarry;
            }
        }

        // 2. åŠ æ³• (åŸºæ–¼ GridSim é€åˆ—ç›¸åŠ )
        if(sB.length > 1) {
            steps.push({ type: 'clear_carry', hint: 'ä¹˜æ³•å®Œæˆï¼Œæ¸…ç©ºé€²ä½æº–å‚™ç›¸åŠ ã€‚' });
            steps.push({ type: 'line', row: baseRow + 2 + sB.length, hint: 'ç•«ç·šæº–å‚™ç›¸åŠ ã€‚' });
            
            let sumRow = baseRow + 2 + sB.length + 1;
            let totalSum = a * b;
            let sTotal = totalSum.toString();
            let currentSumCarry = 0;
            
            // å¾æœ€å³é‚Šé–‹å§‹æƒæ
            for(let c = cols - 1; c >= 0; c--) {
                let colSum = currentSumCarry;
                let hasValue = false; // æª¢æŸ¥é€™ä¸€è¡Œæœ‰æ²’æœ‰æ±è¥¿

                // æƒææ‰€æœ‰éƒ¨åˆ†ç©çš„ Row
                for(let r = baseRow + 2; r < baseRow + 2 + sB.length; r++) {
                    let val = gridSim[`${r}-${c}`];
                    if(val !== undefined) {
                        colSum += val;
                        hasValue = true;
                    }
                }

                // å¦‚æœé€™ä¸€è¡Œå®Œå…¨æ²’æ±è¥¿ä¸”æ²’é€²ä½ï¼Œä¸”å·²ç¶“è¶…éäº†ç¸½å’Œé•·åº¦ï¼Œå°±åœæ­¢
                // (ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœ sTotal é‚„æœ‰ä½æ•¸è¦å¡«ï¼Œå°±ç¹¼çºŒ)
                // æ¯”è¼ƒå¥½çš„æ–¹å¼æ˜¯ç›´æ¥å°æ‡‰ sTotal çš„ä½æ•¸
                // ä½†ç‚ºäº†ç²¾ç¢ºï¼Œæˆ‘å€‘ç”¨ column index åæ¨ sTotal çš„ index
                // sTotal å°é½Šæœ€å³é‚Š cols-1
                let sTotalIndex = sTotal.length - 1 - (cols - 1 - c);
                
                if(sTotalIndex < 0) break; // å·²ç¶“ç®—å®Œäº†

                let unit = colSum % 10;
                let newCarry = Math.floor(colSum / 10);
                
                let step = {
                    type: 'add',
                    writeAns: unit,
                    writeCarry: newCarry, // â˜…â˜…â˜… é€™è£¡æœƒå‚³å‡ºåŠ æ³•é€²ä½ â˜…â˜…â˜…
                    ansRow: sumRow,
                    ansCol: c,
                    carryRow: 0, // å¯«åœ¨æœ€ä¸Šé¢
                    carryCol: c - 1,
                    hint: `å°‡é€™ä¸€è¡Œçš„æ•¸å­—ç›¸åŠ  ${currentSumCarry > 0 ? '(å«ä¹‹å‰é€²ä½)' : ''}ï¼Œé€™æ ¼è©²å¡«å¤šå°‘ï¼Ÿ`,
                    fullExplanation: `ç›´è¡Œç›¸åŠ çµæœï¼š${colSum}ã€‚å¡«å¯« ${unit} ${newCarry > 0 ? 'ï¼Œé€²ä½ ' + newCarry : ''}ã€‚`,
                    isLast: (sTotalIndex === 0)
                };
                steps.push(step);
                currentSumCarry = newCarry;
            }
        }

        return steps;
    }

    function renderTeachGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML = '';
        
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "arrow-layer";
        svg.setAttribute("class", "arrow-layer");
        svg.innerHTML = `<defs><marker id="arrowhead" markerWidth="3" markerHeight="2" refX="2" refY="1" orient="auto"><polygon points="0 0, 3 1, 0 2" fill="#e74c3c" /></marker></defs><line id="calc-arrow" x1="0" y1="0" x2="0" y2="0" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead)" style="display:none;" />`;
        box.appendChild(svg);

        const msg = document.getElementById('teach-msg');
        document.getElementById('help-content').style.display = 'none'; 
        document.getElementById('btn-help-trigger').style.display = 'inline-block';

        if(!q || q.a === undefined) { msg.innerText = "é¡Œç›®éŒ¯èª¤"; return; }

        const sA = q.a.toString(), sB = q.b.toString();
        const cols = sA.length + sB.length + 1;
        let totalRows = 4 + sB.length;
        if(sB.length > 1) totalRows += 2; 
        
        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

        for(let r=0; r<totalRows; r++) {
            for(let c=0; c<cols; c++) {
                let cell = document.createElement('div');
                cell.className='grid-cell'; cell.id=`c-${r}-${c}`;
                if(r===0) cell.style.height = '30px'; 
                
                const mulLineRow = 3; 
                const addLineRow = (sB.length > 1) ? 4 + sB.length : -1;
                if(r === mulLineRow || r === addLineRow) {
                    cell.style.height = '5px'; 
                    cell.style.padding = '0';
                }

                box.appendChild(cell);
            }
        }

        for(let i=0; i<sA.length; i++) {
            document.getElementById(`c-1-${cols-sA.length+i}`).innerText = sA[i];
        }
        let opCell = document.getElementById(`c-2-${cols-sB.length-1}`);
        opCell.innerText = 'Ã—'; opCell.classList.add('operator');
        
        for(let i=0; i<sB.length; i++) {
            document.getElementById(`c-2-${cols-sB.length+i}`).innerText = sB[i];
        }
        for(let c=0; c<cols; c++) {
             document.getElementById(`c-2-${c}`).classList.add('multiplication-line');
        }

        for(let i=0; i<q.stepIdx; i++) {
            let s = q.steps[i];
            if(s.type === 'clear_carry') {
                for(let c=0; c<cols; c++) { if(document.getElementById(`c-0-${c}`)) document.getElementById(`c-0-${c}`).innerHTML = ''; }
                continue;
            }
            if(s.type === 'line') {
                for(let c=0; c<cols; c++) {
                    document.getElementById(`c-${s.row}-${c}`).classList.add('multiplication-line');
                    const addLineRow = (sB.length > 1) ? 4 + sB.length : -1;
                    if(c===0 && s.row === addLineRow) {
                        let plusCell = document.getElementById(`c-${s.row-1}-0`);
                        if(plusCell) { plusCell.innerText = '+'; plusCell.classList.add('operator'); }
                    }
                }
                continue;
            }

            if(s.type === 'mul' && s.isLastInRow && s.totalProd >= 10) {
                let strVal = s.totalProd.toString(); 
                let tenVal = strVal[0];
                let unitVal = strVal[1];
                
                let unitCell = document.getElementById(`c-${s.ansRow}-${s.ansCol}`);
                if(unitCell) unitCell.innerText = unitVal;
                
                let tenCell = document.getElementById(`c-${s.ansRow}-${s.ansCol-1}`);
                if(tenCell) tenCell.innerText = tenVal;
                
            } else {
                let ansCell = document.getElementById(`c-${s.ansRow}-${s.ansCol}`);
                if(ansCell) ansCell.innerText = s.writeAns;
            }
            
            // â˜…â˜…â˜… åŠ æ³•é€²ä½ä¹Ÿè¦é¡¯ç¤º â˜…â˜…â˜…
            if(s.writeCarry > 0) {
                let carryCell = document.getElementById(`c-${s.carryRow}-${s.carryCol}`);
                if(carryCell) carryCell.innerHTML = `<span style="font-size:1rem; color:#d35400;">${s.writeCarry}</span>`;
            }
        }

        if(q.stepIdx >= q.steps.length) {
            msg.innerText = "å¤ªæ£’äº†ï¼æœ¬é¡Œå®Œæˆã€‚";
            document.getElementById('btn-help-trigger').style.display = 'none';
            q.userAns = q.a * q.b; 
            for(let c=0; c<cols; c++) { if(document.getElementById(`c-0-${c}`)) document.getElementById(`c-0-${c}`).innerHTML = ''; }
            document.getElementById('btn-next-q').style.display = 'block';
            let btnNext = document.getElementById('btn-next-q');
            if(currentQIdx >= quizData.length - 1) btnNext.innerText = "å…¨éƒ¨å®Œæˆï¼æŸ¥çœ‹æˆç¸¾ ğŸ†";
            else btnNext.innerText = "ğŸ‰ æœ¬é¡Œå®Œæˆï¼é€²å…¥ä¸‹ä¸€é¡Œ â¡";
            return;
        }

        let cur = q.steps[q.stepIdx];
        
        drawArrow(cur);

        if(cur.type === 'clear_carry' || cur.type === 'line') {
            setTimeout(() => {
                q.stepIdx++;
                renderTeachGrid(q);
            }, 500); 
            return;
        }

        if(settingText) {
            msg.innerText = cur.hint;
        } else {
            msg.innerText = ""; 
        }

        if(settingVoice) {
            speak(cur.hint);
        }
        
        setTimeout(() => {
            createStepInputs(cur, q);
        }, 50);
    }

    function drawArrow(step) {
        let arrowLine = document.getElementById('calc-arrow');
        if(!arrowLine) return;

        if(!settingArrow || step.type !== 'mul') {
            arrowLine.style.display = 'none';
            return;
        }

        if(step.type === 'mul') {
            let cellA = document.getElementById(`c-${step.srcRowA}-${step.srcColA}`);
            let cellB = document.getElementById(`c-${step.srcRowB}-${step.srcColB}`);

            if(cellA && cellB) {
                let x1 = cellB.offsetLeft + cellB.offsetWidth / 2;
                let y1 = cellB.offsetTop + cellB.offsetHeight / 2;
                let x2 = cellA.offsetLeft + cellA.offsetWidth / 2;
                let y2 = cellA.offsetTop + cellA.offsetHeight / 2;

                let angle = Math.atan2(y2 - y1, x2 - x1);
                let padding = 15; 
                x1 += Math.cos(angle) * padding;
                y1 += Math.sin(angle) * padding;
                x2 -= Math.cos(angle) * padding;
                y2 -= Math.sin(angle) * padding;

                arrowLine.setAttribute('x1', x1);
                arrowLine.setAttribute('y1', y1);
                arrowLine.setAttribute('x2', x2);
                arrowLine.setAttribute('y2', y2);
                arrowLine.style.display = 'block';
                return;
            }
        }
        arrowLine.style.display = 'none';
    }

    function createStepInputs(step, q) {
        let msgArea = document.getElementById('teach-msg');
        let oldBtn = msgArea.querySelector('button');
        if(oldBtn) oldBtn.remove();

        if(step.type === 'mul' && step.isLastInRow && step.totalProd >= 10) {
            let tenCell = document.getElementById(`c-${step.ansRow}-${step.ansCol-1}`);
            if(tenCell) {
                tenCell.innerHTML = '';
                let inpTen = createInput('inp-ans-ten', 'game-input', step, q);
                tenCell.appendChild(inpTen);
            }
            let unitCell = document.getElementById(`c-${step.ansRow}-${step.ansCol}`);
            if(unitCell) {
                unitCell.innerHTML = '';
                let inpUnit = createInput('inp-ans-unit', 'game-input', step, q);
                unitCell.appendChild(inpUnit);
                inpUnit.focus();
            }
        } else {
            let ansCell = document.getElementById(`c-${step.ansRow}-${step.ansCol}`);
            if(ansCell) {
                ansCell.innerHTML = '';
                let inp = createInput('inp-ans', 'game-input', step, q);
                ansCell.appendChild(inp);
                inp.focus();
            }
        }

        // â˜…â˜…â˜… é€²ä½è¼¸å…¥ï¼šä¹˜æ³•ä¸­é€” OR åŠ æ³•æœ‰é€²ä½æ™‚ â˜…â˜…â˜…
        if( (step.type==='mul' && !step.isLastInRow && step.writeCarry > 0) || 
            (step.type==='add' && step.writeCarry > 0) ) {
            let carryCell = document.getElementById(`c-${step.carryRow}-${step.carryCol}`);
            if(carryCell) {
                carryCell.innerHTML = ''; 
                let cinp = createInput('inp-carry', 'carry-input', step, q);
                carryCell.appendChild(cinp);
            }
        }

        let btn = document.createElement('button');
        btn.className = 'btn-warning'; btn.innerText = 'OK';
        btn.style.marginLeft = "10px";
        btn.onclick = () => checkStepAnswer(step, q, false); 
        
        if(msgArea.innerText === "") {
             msgArea.style.minHeight = "40px";
        }
        msgArea.appendChild(btn);
    }

    function createInput(id, className, step, q) {
        let inp = document.createElement('input');
        inp.type = 'tel';
        inp.className = className;
        inp.id = id;
        inp.onkeydown = (e) => { if(e.key === 'Enter') checkStepAnswer(step, q, false); };
        inp.oninput = () => {
             inp.classList.remove('wrong');
             checkStepAnswer(step, q, true);
        };
        return inp;
    }

    function checkStepAnswer(step, q, isAuto) {
        let allCorrect = true;
        let allFilled = true;

        let iTen = document.getElementById('inp-ans-ten');
        let iUnit = document.getElementById('inp-ans-unit');
        let iAns = document.getElementById('inp-ans');
        let iCarry = document.getElementById('inp-carry');

        // å¡«å¯«æª¢æŸ¥
        if(step.type === 'mul' && step.isLastInRow && step.totalProd >= 10) {
            if(!iTen || !iUnit || iTen.value==='' || iUnit.value==='') allFilled = false;
        } else {
            if(!iAns || iAns.value==='') allFilled = false;
        }
        // é€²ä½æ ¼å­˜åœ¨æ‰æª¢æŸ¥
        if( (step.type==='mul' && !step.isLastInRow && step.writeCarry > 0) || (step.type==='add' && step.writeCarry > 0) ) {
            if(!iCarry || iCarry.value==='') allFilled = false;
        }

        if(isAuto && !allFilled) return; 

        // é©—è­‰
        if(step.type === 'mul' && step.isLastInRow && step.totalProd >= 10) {
            let tenVal = Math.floor(step.totalProd / 10);
            let unitVal = step.totalProd % 10;
            
            if(parseInt(iTen.value) !== tenVal) { if(!isAuto) iTen.classList.add('wrong'); allCorrect = false; }
            else { iTen.classList.remove('wrong'); if(isAuto) iTen.classList.add('correct'); }
            
            if(parseInt(iUnit.value) !== unitVal) { if(!isAuto) iUnit.classList.add('wrong'); allCorrect = false; }
            else { iUnit.classList.remove('wrong'); if(isAuto) iUnit.classList.add('correct'); }
        } else {
            if(parseInt(iAns.value) !== step.writeAns) { if(!isAuto) iAns.classList.add('wrong'); allCorrect = false; }
            else { iAns.classList.remove('wrong'); if(isAuto) iAns.classList.add('correct'); }
        }

        if(iCarry) {
            if(parseInt(iCarry.value) !== step.writeCarry) { if(!isAuto) iCarry.classList.add('wrong'); allCorrect = false; }
            else { iCarry.classList.remove('wrong'); if(isAuto) iCarry.classList.add('correct'); }
        }

        if(allCorrect) {
            if(!isAuto) {
                 if(settingVoice) speak("ç­”å°äº†ï¼"); else speak("å®å’š"); 
            } else {
                 speak("å®å’š"); 
            }

            if(iTen) iTen.disabled = true;
            if(iUnit) iUnit.disabled = true;
            if(iAns) iAns.disabled = true;
            if(iCarry) iCarry.disabled = true;

            setTimeout(() => {
                q.stepIdx++;
                renderTeachGrid(q);
            }, 500);
        } else {
            if(!isAuto) {
                if(settingVoice) speak("ç®—éŒ¯å›‰"); else speak("å—¶å—¶");
            }
        }
    }

    function toggleHelp() {
        const box = document.getElementById('help-content');
        if(box.style.display === 'block') { box.style.display = 'none'; return; }
        
        const q = quizData[currentQIdx];
        const step = q.steps[q.stepIdx];
        box.innerHTML = step.fullExplanation || `<strong>æç¤ºï¼š</strong> ${step.hint}`;
        box.style.display = 'block';
    }

    function showResult(score, correct, total) {
        showPage('page-result');
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-detail').innerText = `ç­”å° ${correct} / ${total} é¡Œ`;
        document.getElementById('res-time').innerText = `è€—æ™‚ ${document.getElementById('q-timer').innerText}`;
        if(settingVoice) speak(`æ¸¬é©—çµæŸï¼Œä½ å¾—äº†${score}åˆ†ã€‚`);
    }

    function saveRank() {
        const score = document.getElementById('res-score').innerText;
        const time = document.getElementById('res-time').innerText;
        rankData.push({name: studentName, score: parseInt(score), time, list: currentList.name});
        saveRankData(); alert("ç™»è¨˜æˆåŠŸï¼"); switchTab('rank'); showPage('page-home');
    }

    function renderRank() {
        const box = document.getElementById('rank-container'); box.innerHTML = '';
        rankData.sort((a,b) => b.score - a.score || a.time.localeCompare(b.time));
        rankData.forEach((r, i) => {
            const div = document.createElement('div'); div.className='rank-item';
            if(i===0) div.classList.add('rank-1');
            div.innerHTML = `<span>${i+1}. ${r.name} (${r.list})</span><span>${r.score}åˆ† <small>${r.time}</small></span>`;
            box.appendChild(div);
        });
    }
    function clearRank() { if(confirm("æ¸…ç©º?")) { rankData=[]; saveRankData(); renderRank(); } }

</script>

</body>
</html>
