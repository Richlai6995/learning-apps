<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹˜æ³•é—–é—œç‹ 2.1 (å«é€²ä½è¨»è¨˜)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --light: #f3e5f5;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --cell-size: 45px;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { color: var(--primary); margin: 10px 0; text-align: center; }

        .container {
            width: 100%; max-width: 800px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 6px; padding: 8px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 2px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-help { background-color: #e67e22; box-shadow: 0 4px #d35400; }
        .btn-help:active { box-shadow: 0 0 #d35400; transform: translateY(4px); }
        .btn-block { width: 100%; padding: 12px; margin-top: 10px; }

        .list-item {
            background: #fdf2ff; border: 1px solid #e1bee7; padding: 10px; margin-bottom: 8px;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
        }

        .gen-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; background: #f3e5f5; padding: 10px; border-radius: 8px;}
        .gen-controls input { padding: 5px; width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px;}
        .edit-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .edit-row input { padding: 5px; flex: 1; text-align: center; border: 1px solid #ccc; border-radius: 4px;}

        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 6px; }
        
        /* Grid ç³»çµ± */
        .grid-container {
            display: grid; grid-auto-rows: 50px; justify-content: center; margin: 20px 0;
            gap: 2px;
        }
        .grid-cell {
            width: var(--cell-size); height: 50px; display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.6rem; position: relative;
        }
        
        /* ä¸€èˆ¬è¼¸å…¥æ¡† (ç­”æ¡ˆ) */
        .game-input { 
            width: 35px; height: 35px; font-size: 1.4rem; text-align: center; 
            border: 2px solid var(--primary); border-radius: 8px; background: #fff; outline: none;
        }
        .game-input:focus { border-color: #2ecc71; background: #e8f8f5; }

        /* é€²ä½è¨»è¨˜è¼¸å…¥æ¡† (è¼ƒå°ï¼Œåœ“å½¢ï¼Œä½æ–¼ä¸Šæ–¹) */
        .carry-input {
            width: 25px; height: 25px; font-size: 1rem; text-align: center;
            border: 2px solid #e67e22; border-radius: 50%; background: #fef5e7; outline: none;
            position: absolute; bottom: 5px; /* é ä¸‹å°é½Š */
            color: #d35400;
        }
        .carry-input:focus { transform: scale(1.2); border-color: #d35400; }

        .game-input.wrong, .carry-input.wrong { background: #fadbd8; border-color: var(--danger); animation: shake 0.4s; }
        
        .multiplication-line { border-bottom: 3px solid #333; }
        .operator { color: var(--primary); }

        /* æ±‚åŠ©è¨Šæ¯æ¡† */
        .help-box {
            background: #fff8e1; border-left: 5px solid #ffc107; padding: 10px; margin: 10px 0;
            border-radius: 5px; display: none; font-size: 1.1rem; text-align: left;
        }
        .highlight-digit { color: #e74c3c; font-weight: bold; transform: scale(1.2); display:inline-block;}

        .test-mode-box { text-align: center; padding: 30px; font-size: 1.5rem; }
        .test-input { font-size: 1.5rem; padding: 8px; width: 120px; text-align: center; border: 2px solid #ccc; border-radius: 6px; margin-left: 10px; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .rank-1 { color: #f39c12; font-weight: bold; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div id="page-home" class="container active">
        <h1>âœ–ï¸ ä¹˜æ³•é—–é—œç‹ 2.1</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px; display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡º</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:10px;">
            åç¨±: <input type="text" id="list-name" style="padding:5px; width:200px;">
        </div>
        
        <div class="gen-controls">
            <span>ç”Ÿæˆ:</span>
            é¡Œæ•¸<input type="number" id="gen-count" value="5">
            è¢«ä¹˜æ•¸ä½æ•¸<input type="number" id="gen-len-a" value="2">
            ä¹˜æ•¸ä½æ•¸<input type="number" id="gen-len-b" value="1">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>

        <div style="max-height: 300px; overflow-y: auto;">
            <div id="editor-rows"></div>
        </div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– æ•™å­¸æ¨¡å¼ (å«é€²ä½å¼•å°)</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ æ¸¬é©—æ¨¡å¼ (ç›´æ¥è¨ˆç®—)</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:20px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <span id="q-mode">æ¨¡å¼</span>
        </div>

        <div id="teach-area" style="display:none;">
            <div style="text-align: center; margin-bottom: 10px;">
                <div id="teach-msg" style="color:#8e44ad; font-weight:bold; font-size:1.2rem; min-height:1.5em;"></div>
                <button class="btn-help" onclick="toggleHelp()">ğŸ’¡ æ±‚åŠ©ï¼šé€™ä¸€æ­¥æ€éº¼ç®—ï¼Ÿ</button>
                <div id="help-content" class="help-box"></div>
            </div>
            <div class="grid-container" id="gridBoard"></div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="font-size:2rem; margin-bottom:20px;"></div>
                ç­”æ¡ˆ: <input type="number" id="test-ans" class="test-input">
            </div>
        </div>

        <div class="quiz-nav" style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-gray" id="btn-prev" onclick="navQuestion(-1)">ä¸Šä¸€é¡Œ</button>
            <button class="btn-primary" id="btn-next" onclick="navQuestion(1)">ä¸‹ä¸€é¡Œ</button>
            <button class="btn-success" id="btn-submit" onclick="submitTest()" style="display:none;">äº¤å·</button>
        </div>
        
        <button class="btn-danger" style="float:right; margin-top:10px;" onclick="quitQuiz()">é€€å‡º</button>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 3rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-detail" style="font-size: 1.2rem; margin: 10px;">ç­”å° 5 / 5 é¡Œ</div>
            <div id="res-time" style="color:#777;">è€—æ™‚ 01:20</div>
            
            <div style="margin-top:20px;">
                ä½ çš„åå­—: <input type="text" id="player-name" value="å­¸å“¡" style="padding:5px;">
                <button class="btn-warning" onclick="saveRank()">ç™»è¨˜æ¦œå–®</button>
            </div>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    // --- èªéŸ³å¼•æ“ ---
    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let cleanText = text.replace(/<[^>]*>/g, '').replace(/Ã—/g, 'ä¹˜ä»¥').replace(/\+/g, 'åŠ ').replace(/=/g, 'ç­‰æ–¼');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'zh-TW'; utterance.rate = 1.0; 
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- è³‡æ–™è®Šæ•¸ ---
    let allLists = [];
    let currentList = null;
    let quizData = []; 
    let currentQIdx = 0;
    let currentMode = '';
    let editingId = null;
    let timerInt, startTime;
    let rankData = [];

    window.onload = function() {
        if(localStorage.getItem('mul_v2_lists')) allLists = JSON.parse(localStorage.getItem('mul_v2_lists'));
        else {
            allLists = [{name: "é€²ä½ç·´ç¿’ (2ä½ä¹˜1ä½)", qs: [{a:56, b:9}, {a:48, b:5}, {a:75, b:4}]}];
            saveData();
        }
        if(localStorage.getItem('mul_v2_rank')) rankData = JSON.parse(localStorage.getItem('mul_v2_rank'));
        renderLists();
    };

    function saveData() { localStorage.setItem('mul_v2_lists', JSON.stringify(allLists)); }
    function saveRankData() { localStorage.setItem('mul_v2_rank', JSON.stringify(rankData)); }

    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- é¡Œåº«ç®¡ç† ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        if(allLists.length===0) c.innerHTML='<p style="text-align:center">ç„¡é¡Œåº«</p>';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            d.innerHTML = `<div><strong>${l.name}</strong> (${l.qs.length}é¡Œ)</div><div><button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button><button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button><button class="btn-danger" onclick="delList(${i})">åˆª</button></div>`;
            c.appendChild(d);
        });
    }

    function createNewList() {
        editingId = null;
        document.getElementById('list-name').value = "æ–°é¡Œåº«";
        document.getElementById('editor-rows').innerHTML = '';
        showPage('page-editor');
    }

    function editList(i) {
        editingId = i; const l = allLists[i];
        document.getElementById('list-name').value = l.name;
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        l.qs.forEach(q => addEditRow(q.a, q.b));
        showPage('page-editor');
    }

    function addEditRow(a='', b='') {
        const div = document.createElement('div'); div.className='edit-row';
        div.innerHTML = `<input type="number" class="inp-a" placeholder="è¢«ä¹˜æ•¸" value="${a}"> Ã— <input type="number" class="inp-b" placeholder="ä¹˜æ•¸" value="${b}"><button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('editor-rows').appendChild(div);
    }

    function autoGenerate() {
        const count = parseInt(document.getElementById('gen-count').value);
        const lenA = parseInt(document.getElementById('gen-len-a').value);
        const lenB = parseInt(document.getElementById('gen-len-b').value);
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        const minA = Math.pow(10, lenA-1), maxA = Math.pow(10, lenA)-1;
        const minB = Math.pow(10, lenB-1), maxB = Math.pow(10, lenB)-1;
        for(let i=0; i<count; i++) {
            let a = Math.floor(Math.random()*(maxA-minA+1)) + minA;
            let b = Math.floor(Math.random()*(maxB-minB+1)) + minB;
            addEditRow(a, b);
        }
    }

    function saveList() {
        const name = document.getElementById('list-name').value;
        const rows = document.querySelectorAll('.edit-row');
        const qs = [];
        rows.forEach(r => {
            const a = parseInt(r.querySelector('.inp-a').value);
            const b = parseInt(r.querySelector('.inp-b').value);
            if(!isNaN(a) && !isNaN(b)) qs.push({a,b});
        });
        if(qs.length===0) return alert("è‡³å°‘ä¸€é¡Œ");
        if(editingId === null) allLists.push({name, qs}); else allLists[editingId] = {name, qs};
        saveData(); showPage('page-home');
    }
    function delList(i) { if(confirm("åˆªé™¤?")) { allLists.splice(i,1); saveData(); renderLists(); } }
    function exportData() {
        const blob = new Blob([JSON.stringify(allLists)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = "multiplication_data.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function handleImport(inp) {
        const f = inp.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) { allLists = allLists.concat(d); saveData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ"); }
            } catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f);
    }

    // --- æ¸¬é©—é‚è¼¯ ---
    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        quizData = currentList.qs.map(q => ({
            a: q.a, b: q.b, 
            userAns: null, 
            steps: [], stepIdx: 0
        }));
        
        // æ•™å­¸æ¨¡å¼éœ€é å…ˆç”Ÿæˆè©³ç´°å¾®æ­¥é©Ÿ
        if(mode === 'teach') {
            quizData.forEach(q => { q.steps = generateDetailedSteps(q.a, q.b); });
        }

        currentQIdx = 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        document.getElementById('q-mode').innerText = mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼';
        document.getElementById('teach-area').style.display = mode==='teach'?'block':'none';
        document.getElementById('test-area').style.display = mode==='test'?'block':'none';
        
        showPage('page-quiz');
        speak(`é–‹å§‹${mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼'}ï¼ŒåŠ æ²¹ï¼`);
        loadQuestion();
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡º?")) { clearInterval(timerInt); showPage('page-home'); } }
    function updTime() {
        const s = Math.floor((Date.now()-startTime)/1000);
        document.getElementById('q-timer').innerText = new Date(s*1000).toISOString().substr(14,5);
    }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('btn-prev').style.visibility = currentQIdx===0 ? 'hidden' : 'visible';
        
        if(currentMode === 'test') {
            document.getElementById('btn-next').style.display = currentQIdx===quizData.length-1 ? 'none' : 'inline-block';
            document.getElementById('btn-submit').style.display = currentQIdx===quizData.length-1 ? 'inline-block' : 'none';
            document.getElementById('test-q-text').innerText = `${q.a} Ã— ${q.b} = ?`;
            document.getElementById('test-ans').value = q.userAns !== null ? q.userAns : '';
        } else {
            document.getElementById('btn-next').style.display = 'none'; 
            document.getElementById('btn-submit').style.display = 'none';
            renderTeachGrid(q);
        }
    }

    function navQuestion(dir) {
        if(currentMode === 'test') quizData[currentQIdx].userAns = document.getElementById('test-ans').value;
        currentQIdx += dir;
        loadQuestion();
    }

    function submitTest() {
        quizData[currentQIdx].userAns = document.getElementById('test-ans').value;
        clearInterval(timerInt);
        let correct = 0;
        quizData.forEach(q => {
            if(parseInt(q.userAns) === (q.a * q.b)) correct++;
        });
        showResult(Math.round((correct/quizData.length)*100), correct, quizData.length);
    }

    // --- è©³ç´°å¾®æ­¥é©Ÿç”Ÿæˆ (æ ¸å¿ƒä¿®æ”¹) ---
    function generateDetailedSteps(a, b) {
        let sA = a.toString();
        let sB = b.toString();
        let steps = [];
        
        // ç‚ºäº†ç°¡åŒ– 2.0 ç‰ˆï¼Œè‹¥ä¹˜æ•¸å¤§æ–¼1ä½ï¼Œé€™è£¡å…ˆåšç°¡æ˜“è™•ç†(å¾ŒçºŒå¯æ“´å……)
        // æ­¤è™•å°ˆæ³¨æ–¼ å–®å€‹ä½æ•¸ä¹˜æ³• çš„é€²ä½é‚è¼¯ (å¦‚ 56 * 9)
        // è‹¥æ˜¯ 56 * 19ï¼Œå…ˆæ‹†è§£æˆ 56*9 å’Œ 56*10
        
        let cols = sA.length + sB.length + 1;
        let baseRow = 2; // è¢«ä¹˜æ•¸æ‰€åœ¨çš„åˆ— (0æ˜¯é€²ä½åˆ—, 1æ˜¯è¢«ä¹˜æ•¸, 2æ˜¯ä¹˜æ•¸, 3æ˜¯æ©«ç·š, 4é–‹å§‹æ˜¯ç©)
        
        // ç›®å‰åªå¯¦ä½œ 1ä½æ•¸ä¹˜æ•¸ çš„è©³ç´°é€²ä½ï¼Œå¤šä½æ•¸ä¹˜æ•¸é‚„æ˜¯ç”¨èˆŠçš„ Row é‚è¼¯
        if(sB.length === 1) {
            let mult = parseInt(sB);
            let currentCarry = 0;
            
            // å¾è¢«ä¹˜æ•¸å€‹ä½é–‹å§‹å¾€å·¦ç®—
            for(let i = sA.length - 1; i >= 0; i--) {
                let digitA = parseInt(sA[i]);
                let product = digitA * mult + currentCarry;
                let unit = product % 10;
                let newCarry = Math.floor(product / 10);
                
                // å®šä½ï¼šGrid çš„ Column æ˜¯å¾å·¦åˆ°å³ (0é–‹å§‹)
                // sA åœ¨ Grid ä¸­çš„èµ·å§‹ col æ˜¯ (cols - sA.length)
                // i æ˜¯ sA çš„ index (å¾0é–‹å§‹)
                // æ‰€ä»¥ digitA åœ¨ Grid çš„ col æ˜¯ (cols - sA.length + i)
                let gridCol = cols - sA.length + i;
                
                let step = {
                    type: 'digit',
                    aDigit: digitA,
                    bDigit: mult,
                    prevCarry: currentCarry,
                    rawProd: digitA * mult,
                    totalProd: product,
                    writeAns: unit,
                    writeCarry: newCarry,
                    
                    // åº§æ¨™
                    ansRow: baseRow + 2, // 0:carry, 1:A, 2:B, 3:line, 4:Result
                    ansCol: gridCol,
                    
                    // é€²ä½è¨»è¨˜ä½ç½®ï¼šé€šå¸¸è¨˜åœ¨ä¸‹ä¸€å€‹é«˜ä½ä¸Šæ–¹ (å³ gridCol - 1)
                    // å¦‚æœæ˜¯æœ€å¾Œä¸€ä½(i=0)ä¸”æœ‰é€²ä½ï¼Œé€™å€‹é€²ä½ç›´æ¥å¯«åœ¨ç­”æ¡ˆåˆ—ï¼Œä¸å¯«åœ¨è¨»è¨˜åˆ—
                    carryRow: 0,
                    carryCol: gridCol - 1,
                    
                    isLast: (i === 0)
                };
                
                // æç¤ºæ–‡å­—
                let hint = `${digitA} Ã— ${mult} = ${step.rawProd}ã€‚`;
                if(currentCarry > 0) hint += ` åŠ ä¸Šé€²ä½ ${currentCarry} ç­‰æ–¼ ${product}ã€‚`;
                if(step.isLast) {
                    hint += ` å¯« ${product}ã€‚`;
                } else {
                    if(newCarry > 0) hint += ` å¯« ${unit}ï¼Œé€²ä½è¨»è¨˜ ${newCarry}ã€‚`;
                    else hint += ` å¯« ${unit}ã€‚`;
                }
                step.hint = hint;
                
                steps.push(step);
                currentCarry = newCarry;
            }
        } else {
            // å¤šä½æ•¸ä¹˜æ•¸çš„ fallback (èˆŠé‚è¼¯)
            // é€™è£¡ç‚ºäº†ä¿æŒç¯„ä¾‹ "56*9" çš„å®Œæ•´æ€§ï¼Œæˆ‘å€‘æš«æ™‚ä¿ç•™å–®æ•¸é‚è¼¯
            // è‹¥éœ€è¦å¤šä½æ•¸ï¼Œéœ€æ›´è¤‡é›œçš„ grid ç®¡ç†
            steps.push({type:'simple', ans: a*b, hint:'å¤šä½æ•¸ä¹˜æ³•æš«æ™‚ä»¥æ•´è¡Œé¡¯ç¤ºï¼Œè«‹ç›´æ¥è¨ˆç®—ç¸½å’Œ'});
        }
        
        return steps;
    }

    function renderTeachGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML = '';
        const msg = document.getElementById('teach-msg');
        document.getElementById('help-content').style.display = 'none'; // é‡ç½®æ±‚åŠ©
        
        // è‹¥æ˜¯ fallback çš„ç°¡å–®æ¨¡å¼
        if(q.steps.length > 0 && q.steps[0].type === 'simple') {
            msg.innerText = "æ­¤é¡Œç‚ºå¤šä½æ•¸ä¹˜æ³•ï¼Œè«‹ç›´æ¥è¨ˆç®—ã€‚";
            return;
        }

        const sA = q.a.toString(), sB = q.b.toString();
        const cols = sA.length + sB.length + 1;
        const totalRows = 6; // 0:Carry, 1:A, 2:B, 3:Line, 4:Result
        
        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

        // å»ºç«‹æ ¼å­
        for(let r=0; r<totalRows; r++) {
            for(let c=0; c<cols; c++) {
                let cell = document.createElement('div');
                cell.className='grid-cell'; cell.id=`c-${r}-${c}`;
                // ç¬¬0åˆ—ç‰¹åˆ¥è™•ç† (é€²ä½åˆ—)
                if(r===0) cell.style.height = '30px'; 
                box.appendChild(cell);
            }
        }

        // å¡«é¡Œç›® (Row 1: è¢«ä¹˜æ•¸)
        for(let i=0; i<sA.length; i++) {
            let cell = document.getElementById(`c-1-${cols-sA.length+i}`);
            cell.innerText = sA[i];
        }
        // å¡«é¡Œç›® (Row 2: ä¹˜æ•¸)
        document.getElementById(`c-2-${cols-sB.length-1}`).innerText = 'Ã—';
        document.getElementById(`c-2-${cols-sB.length-1}`).classList.add('operator');
        for(let i=0; i<sB.length; i++) {
            let cell = document.getElementById(`c-2-${cols-sB.length+i}`);
            cell.innerText = sB[i];
        }
        // ç•«ç·š (Row 3)
        for(let c=0; c<cols; c++) {
             document.getElementById(`c-2-${c}`).classList.add('multiplication-line');
        }

        // å¡«å…¥ã€Œå·²å®Œæˆã€çš„æ­¥é©Ÿ
        for(let i=0; i<q.stepIdx; i++) {
            let s = q.steps[i];
            // å¡«å¯«ç­”æ¡ˆ
            let ansCell = document.getElementById(`c-${s.ansRow}-${s.ansCol}`);
            if(s.isLast) ansCell.innerText = s.totalProd; // æœ€å¾Œä¸€æ­¥å¯«å…¨æ•¸
            else ansCell.innerText = s.writeAns;
            
            // å¡«å¯«é€²ä½ (å¦‚æœæœ‰)
            if(!s.isLast && s.writeCarry > 0) {
                let carryCell = document.getElementById(`c-${s.carryRow}-${s.carryCol}`);
                carryCell.innerHTML = `<span style="font-size:1rem; color:#d35400;">${s.writeCarry}</span>`;
            }
        }

        // åˆ¤æ–·æ˜¯å¦å…¨å°å®Œæˆ
        if(q.stepIdx >= q.steps.length) {
            msg.innerText = "å¤ªæ£’äº†ï¼æœ¬é¡Œå®Œæˆã€‚";
            q.userAns = q.a * q.b; // è‡ªå‹•å¡«å…¥
            let btn = document.createElement('button');
            btn.className = 'btn-primary';
            if(currentQIdx < quizData.length-1) {
                btn.innerText = "ä¸‹ä¸€é¡Œ â¡"; btn.onclick = () => {currentQIdx++; loadQuestion();};
            } else {
                btn.innerText = "æŸ¥çœ‹æˆç¸¾ ğŸ†"; btn.onclick = () => submitTest();
            }
            msg.appendChild(document.createElement('br')); msg.appendChild(btn);
            return;
        }

        // ç•¶å‰æ­¥é©Ÿ
        let cur = q.steps[q.stepIdx];
        msg.innerText = cur.hint;
        speak(cur.hint);
        
        // ç”¢ç”Ÿè¼¸å…¥æ¡†
        createStepInputs(cur, q);
    }

    function createStepInputs(step, q) {
        // 1. ç­”æ¡ˆè¼¸å…¥æ¡†
        let ansCell = document.getElementById(`c-${step.ansRow}-${step.ansCol}`);
        ansCell.innerHTML = '';
        
        if(step.isLast && step.totalProd >= 10) {
            // æœ€å¾Œä¸€æ­¥å¦‚æœå¤§æ–¼10ï¼Œå¯èƒ½è¦å¡«å…©å€‹æ•¸å­— (ä¾‹å¦‚ 5*9=45ï¼Œè¦å¡«45)
            // é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥çµ¦ä¸€å€‹å¯¬ä¸€é»çš„ input æˆ–æ˜¯å…©å€‹ input
            // ç‚ºäº†æ•™å­¸ä¸€è‡´æ€§ï¼Œæˆ‘å€‘è®“å­¸å“¡åœ¨ç•¶æ ¼å¡«å€‹ä½ï¼Œå·¦é‚Šæ ¼å¡«åä½
            let unit = step.totalProd % 10;
            let ten = Math.floor(step.totalProd / 10);
            
            // åä½
            let tenCell = document.getElementById(`c-${step.ansRow}-${step.ansCol-1}`);
            let inpTen = document.createElement('input');
            inpTen.type='tel'; inpTen.className='game-input'; inpTen.id = 'inp-ans-ten';
            tenCell.appendChild(inpTen);
            
            // å€‹ä½
            let inpUnit = document.createElement('input');
            inpUnit.type='tel'; inpUnit.className='game-input'; inpUnit.id = 'inp-ans-unit';
            ansCell.appendChild(inpUnit);
            
            setTimeout(()=>inpUnit.focus(), 100);
            
        } else {
            // ä¸€èˆ¬å–®æ ¼è¼¸å…¥
            let inp = document.createElement('input');
            inp.type='tel'; inp.className='game-input'; inp.id = 'inp-ans';
            ansCell.appendChild(inp);
            setTimeout(()=>inp.focus(), 100);
        }

        // 2. é€²ä½è¼¸å…¥æ¡† (è‹¥æœ‰é€²ä½ä¸”éæœ€å¾Œä¸€æ­¥)
        if(!step.isLast && step.writeCarry > 0) {
            let carryCell = document.getElementById(`c-${step.carryRow}-${step.carryCol}`);
            carryCell.innerHTML = ''; // æ¸…ç©º
            let cinp = document.createElement('input');
            cinp.type='tel'; cinp.className='carry-input'; cinp.id = 'inp-carry';
            carryCell.appendChild(cinp);
        }

        // OK æŒ‰éˆ•
        let btn = document.createElement('button');
        btn.className = 'btn-warning'; btn.innerText = 'OK';
        btn.onclick = () => checkStepAnswer(step, q);
        document.getElementById('teach-msg').appendChild(document.createElement('br'));
        document.getElementById('teach-msg').appendChild(btn);
    }

    function checkStepAnswer(step, q) {
        let allCorrect = true;
        
        // æª¢æŸ¥ç­”æ¡ˆ
        if(step.isLast && step.totalProd >= 10) {
            let tenVal = Math.floor(step.totalProd / 10);
            let unitVal = step.totalProd % 10;
            let iTen = document.getElementById('inp-ans-ten');
            let iUnit = document.getElementById('inp-ans-unit');
            
            if(parseInt(iTen.value) !== tenVal) { iTen.classList.add('wrong'); allCorrect = false; }
            else iTen.classList.remove('wrong');
            
            if(parseInt(iUnit.value) !== unitVal) { iUnit.classList.add('wrong'); allCorrect = false; }
            else iUnit.classList.remove('wrong');
            
        } else {
            let inp = document.getElementById('inp-ans');
            if(parseInt(inp.value) !== step.writeAns) {
                inp.classList.add('wrong'); allCorrect = false;
            } else {
                inp.classList.remove('wrong');
            }
        }

        // æª¢æŸ¥é€²ä½è¨»è¨˜ (é€™æ˜¯æœ¬æ¬¡é‡é»åŠŸèƒ½)
        if(!step.isLast && step.writeCarry > 0) {
            let cinp = document.getElementById('inp-carry');
            if(!cinp || parseInt(cinp.value) !== step.writeCarry) {
                if(cinp) cinp.classList.add('wrong');
                allCorrect = false;
                speak("é€²ä½è¨»è¨˜ä¹Ÿè¦å¡«å¯«å–”ï¼");
            } else {
                if(cinp) cinp.classList.remove('wrong');
            }
        }

        if(allCorrect) {
            speak("ç­”å°äº†ï¼");
            q.stepIdx++;
            renderTeachGrid(q);
        } else {
            speak("ç®—éŒ¯å›‰ï¼Œè«‹æª¢æŸ¥ç´…è‰²æ ¼å­ã€‚");
        }
    }

    // --- æ±‚åŠ©åŠŸèƒ½ ---
    function toggleHelp() {
        const box = document.getElementById('help-content');
        if(box.style.display === 'block') {
            box.style.display = 'none';
        } else {
            const q = quizData[currentQIdx];
            const step = q.steps[q.stepIdx];
            let html = `<strong>æ­¥é©Ÿè©³è§£ï¼š</strong><br>`;
            
            html += `1. è¨ˆç®—ï¼š <span class="highlight-digit">${step.aDigit}</span> Ã— <span class="highlight-digit">${step.bDigit}</span> = ${step.rawProd}<br>`;
            
            if(step.prevCarry > 0) {
                html += `2. åŠ ä¸Šå‰ä¸€ä½çš„é€²ä½ï¼š ${step.rawProd} + <span style="color:#e67e22;font-weight:bold;">${step.prevCarry}</span> = <strong>${step.totalProd}</strong><br>`;
            } else {
                html += `2. ç„¡é€²ä½éœ€åŠ ï¼Œç¸½å’Œç‚º <strong>${step.totalProd}</strong><br>`;
            }

            if(step.isLast) {
                html += `3. é€™æ˜¯æœ€å¾Œä¸€ä½ï¼Œç›´æ¥å¯« <strong>${step.totalProd}</strong> åœ¨ä¸‹æ–¹ã€‚`;
            } else {
                html += `3. å€‹ä½æ•¸ <strong>${step.writeAns}</strong> å¯«åœ¨ä¸‹é¢ã€‚<br>`;
                if(step.writeCarry > 0) {
                    html += `4. åä½æ•¸ <strong>${step.writeCarry}</strong> å¯«åœ¨ä¸Šé¢é€²ä½å€(æ©˜è‰²å°åœˆ)ã€‚`;
                } else {
                    html += `4. æ²’æœ‰é€²ä½ (0)ã€‚`;
                }
            }
            
            box.innerHTML = html;
            box.style.display = 'block';
            speak("è«‹çœ‹æ±‚åŠ©æç¤º");
        }
    }

    // --- çµæœèˆ‡æ¦œå–® ---
    function showResult(score, correct, total) {
        showPage('page-result');
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-detail').innerText = `ç­”å° ${correct} / ${total} é¡Œ`;
        document.getElementById('res-time').innerText = `è€—æ™‚ ${document.getElementById('q-timer').innerText}`;
        speak(`æ¸¬é©—çµæŸï¼Œä½ å¾—äº†${score}åˆ†ã€‚`);
    }

    function saveRank() {
        const name = document.getElementById('player-name').value;
        const score = document.getElementById('res-score').innerText;
        const time = document.getElementById('res-time').innerText;
        rankData.push({name, score: parseInt(score), time, list: currentList.name});
        saveRankData(); alert("ç™»è¨˜æˆåŠŸï¼"); switchTab('rank'); showPage('page-home');
    }

    function renderRank() {
        const box = document.getElementById('rank-container'); box.innerHTML = '';
        rankData.sort((a,b) => b.score - a.score || a.time.localeCompare(b.time));
        rankData.forEach((r, i) => {
            const div = document.createElement('div'); div.className='rank-item';
            if(i===0) div.classList.add('rank-1');
            div.innerHTML = `<span>${i+1}. ${r.name} (${r.list})</span><span>${r.score}åˆ† <small>${r.time}</small></span>`;
            box.appendChild(div);
        });
    }
    function clearRank() { if(confirm("æ¸…ç©º?")) { rankData=[]; saveRankData(); renderRank(); } }

</script>

</body>
</html>
