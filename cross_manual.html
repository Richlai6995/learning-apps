<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>乘法闖關大師 (右側聚焦修正版)</title>
    <style>
        :root {
            --primary-color: #8e44ad;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --highlight-bg: #fff3cd;
            --bg-color: #f3e5f5;
            --text-color: #2c3e50;
            
            /* 手機版格線設定 */
            --cell-size: 34px; 
            --cell-font: 1.3rem;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            /* 防止手機雙擊縮放 */
            touch-action: manipulation;
        }

        h1 { 
            color: var(--primary-color); 
            margin: 10px 0 15px 0; 
            font-size: 1.5rem; 
        }

        /* --- 輸入區塊 --- */
        .input-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 800px;
            box-sizing: border-box;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input {
            padding: 8px;
            font-size: 1.1rem;
            border: 2px solid #d7bde2;
            border-radius: 6px;
            width: 80px;
            text-align: center;
        }

        input:focus { border-color: var(--primary-color); outline: none; }

        button {
            padding: 8px 16px;
            font-size: 1rem;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        .btn-start { background-color: var(--primary-color); }
        .btn-check { background-color: var(--success-color); display: none; }
        .btn-reset { background-color: #95a5a6; }

        /* --- 版面配置 --- */
        .main-container {
            display: flex;
            flex-direction: column; /* 手機預設垂直排列 */
            gap: 15px;
            width: 100%;
            max-width: 1000px;
            align-items: flex-start;
        }

        @media (min-width: 768px) {
            .main-container {
                flex-direction: row; /* 電腦版左右排列 */
            }
            .info-box { flex: 1; order: 1; }
            .board-wrapper { flex: 2; order: 2; }
        }

        /* --- 提示區 --- */
        .info-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 6px solid #bdc3c7;
            transition: border-left-color 0.3s;
            box-sizing: border-box;
            width: 100%;
        }

        .status-title {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .status-msg {
            font-size: 1.1rem;
            line-height: 1.5;
            color: #555;
        }

        /* --- 計算區 --- */
        .board-wrapper {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-x: auto; 
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 350px;
        }

        .grid-container {
            display: grid;
            grid-auto-rows: 40px;
            column-gap: 0;
        }

        .grid-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            font-family: 'Courier New', monospace;
            font-size: var(--cell-font);
            font-weight: bold;
            width: var(--cell-size);
            height: 40px;
        }

        /* 互動輸入框 */
        .game-input {
            width: 30px;
            height: 34px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            border: 2px solid var(--primary-color);
            background-color: var(--highlight-bg);
            border-radius: 4px;
            outline: none;
            padding: 0;
            margin: 0;
            /* iOS 輸入優化 */
            -webkit-appearance: none;
        }
        
        .game-input.wrong {
            border-color: var(--error-color);
            background-color: #fab1a0;
            animation: shake 0.4s;
        }

        .val-base { color: #333; }
        .val-prod1 { color: #2980b9; } 
        .val-prod2 { color: #d35400; } 
        .val-prod3 { color: #8e44ad; } 
        .val-final { color: #27ae60; } 
        .operator { color: var(--primary-color); }

        .multiplication-line {
            border-bottom: 2px solid #2c3e50;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

    <h1>乘法闖關大師</h1>
    
    <div class="input-section">
        <div class="input-group">
            <input type="text" id="multiplicand" value="125" placeholder="被乘數" pattern="\d*" inputmode="numeric">
            <span>×</span>
            <input type="text" id="multiplier" value="3" placeholder="乘數" pattern="\d*" inputmode="numeric">
        </div>
        <button class="btn-start" onclick="startGame()">挑戰</button>
        <button class="btn-check" id="checkBtn" onclick="checkAnswer()">確認</button>
        <button class="btn-reset" onclick="resetGame()">重置</button>
    </div>

    <div class="main-container">
        <div class="info-box" id="infoBox">
            <div class="status-title" id="statusTitle">準備挑戰</div>
            <div class="status-msg" id="statusMsg">
                請輸入數字並點擊「挑戰」。<br>
                記得從個位數(右邊)開始算喔！
            </div>
        </div>

        <div class="board-wrapper">
            <div class="grid-container" id="gridBoard"></div>
        </div>
    </div>

<script>
    // --- 語音系統 ---
    function speak(text, isHappy = true) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let cleanText = text.replace(/<[^>]*>/g, '').replace(/×/g, '乘以').replace(/\+/g, '加').replace(/=/g, '等於');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'zh-TW'; 
            utterance.rate = 1.1;
            utterance.volume = 1;     
            utterance.pitch = isHappy ? 1.2 : 0.9; 
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- 遊戲變數 ---
    let steps = [];
    let currentStepIndex = 0;
    let multiplicandStr = "";
    let multiplierStr = "";
    
    const gridBoard = document.getElementById('gridBoard');
    const statusTitle = document.getElementById('statusTitle');
    const statusMsg = document.getElementById('statusMsg');
    const infoBox = document.getElementById('infoBox');
    const checkBtn = document.getElementById('checkBtn');

    document.addEventListener('keydown', (e) => {
        if (e.key === "Enter" && checkBtn.style.display !== 'none') checkAnswer();
    });

    function resetGame() {
        gridBoard.innerHTML = '';
        statusTitle.innerText = "準備挑戰";
        statusMsg.innerHTML = "請輸入數字開始遊戲。";
        infoBox.style.borderLeftColor = "#bdc3c7";
        checkBtn.style.display = 'none';
        steps = [];
        currentStepIndex = 0;
        window.speechSynthesis.cancel(); 
        
        document.getElementById('multiplicand').value = "";
        document.getElementById('multiplier').value = "";
        document.getElementById('multiplicand').focus();
    }

    function startGame() {
        multiplicandStr = document.getElementById('multiplicand').value.trim();
        multiplierStr = document.getElementById('multiplier').value.trim();

        if (multiplicandStr === "" || multiplierStr === "") {
            alert("請輸入數字！"); return;
        }
        if (!/^\d+$/.test(multiplicandStr) || !/^\d+$/.test(multiplierStr)) {
            alert("請只輸入有效數字！"); return;
        }

        gridBoard.innerHTML = '';
        statusTitle.innerText = "準備挑戰";
        infoBox.style.borderLeftColor = "#bdc3c7";
        checkBtn.style.display = 'none';
        steps = [];
        currentStepIndex = 0;
        window.speechSynthesis.cancel();
        
        let totalCols = multiplicandStr.length + multiplierStr.length + 1;
        gridBoard.style.gridTemplateColumns = `repeat(${totalCols}, var(--cell-size))`;

        renderInitialGrid(multiplicandStr, multiplierStr, totalCols);
        generateSteps(multiplicandStr, multiplierStr, totalCols);
        
        checkBtn.style.display = 'inline-block';
        speak("挑戰開始！請從右邊個位數開始算！");
        processNextStep();
    }

    function renderInitialGrid(mStr1, mStr2, totalCols) {
        let totalRows = 2 + mStr2.length + 2; 
        for(let r=0; r<totalRows; r++) {
            for(let c=0; c<totalCols; c++) {
                let cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.id = `cell-${r}-${c}`;
                gridBoard.appendChild(cell);
            }
        }

        for(let i=0; i<mStr1.length; i++) {
            let col = totalCols - mStr1.length + i;
            let cell = document.getElementById(`cell-0-${col}`);
            cell.innerText = mStr1[i];
            cell.className += " val-base";
        }

        let opCell = document.getElementById(`cell-1-${totalCols - Math.max(mStr1.length, mStr2.length) - 1}`);
        if(opCell) {
            opCell.innerText = "×";
            opCell.className += " operator";
        }

        for(let i=0; i<mStr2.length; i++) {
            let col = totalCols - mStr2.length + i;
            let cell = document.getElementById(`cell-1-${col}`);
            cell.innerText = mStr2[i];
            cell.className += " val-base";
        }
        
        for(let c=0; c<totalCols; c++) {
             let cell = document.getElementById(`cell-1-${c}`);
             if (c >= totalCols - Math.max(mStr1.length, mStr2.length) - 1) {
                 cell.classList.add("multiplication-line");
             }
        }
    }

    function generateSteps(mStr1, mStr2, totalCols) {
        let num1 = BigInt(mStr1);
        let num2 = BigInt(mStr2);
        let currentRow = 2;

        if (mStr2.length === 1) {
            let product = num1 * num2;
            steps.push({
                type: 'input_final',
                row: currentRow,
                endCol: totalCols - 1,
                valStr: product.toString(),
                hint: `${mStr1} × ${mStr2} 是多少？`,
                voiceSuccess: `答對了！答案是 ${product}。`,
                voiceFail: `算錯囉，先算個位，再算十位。`,
                successMsg: `正確！`,
                failMsg: `加油！再算一次。`,
                color: 'val-final'
            });
            
            steps.push({
                type: 'finish',
                msg: `恭喜你！答案是 ${product}！`,
                voiceSuccess: "恭喜你，計算完成！你是乘法大師！"
            });
            return;
        }

        for (let i = mStr2.length - 1; i >= 0; i--) {
            let digit2 = parseInt(mStr2[i]);
            let partialProduct = num1 * BigInt(digit2);
            let shift = (mStr2.length - 1) - i;
            
            steps.push({
                type: 'input_partial',
                row: currentRow,
                endCol: totalCols - 1 - shift, 
                valStr: partialProduct.toString(),
                hint: `用乘數的 ${digit2} 去乘 ${mStr1}。<br>(${mStr1} × ${digit2})`,
                voiceSuccess: `太棒了！這一步是 ${partialProduct}。`,
                voiceFail: `加油，是用 ${digit2} 乘以上面的數字喔。`,
                successMsg: `正確！`,
                failMsg: `算錯囉！注意進位。`,
                color: `val-prod${(shift % 3) + 1}` 
            });
            
            currentRow++;
        }

        let finalProduct = num1 * num2;
        
        for(let c=0; c<totalCols; c++) {
             let cell = document.getElementById(`cell-${currentRow-1}-${c}`);
             if (c >= totalCols - finalProduct.toString().length - 2) { 
                 cell.classList.add("multiplication-line");
             }
        }

        let plusCell = document.getElementById(`cell-${currentRow-1}-${totalCols - finalProduct.toString().length - 1}`);
        if(plusCell) {
             plusCell.innerText = "+";
             plusCell.className += " operator";
        }

        steps.push({
            type: 'input_final',
            row: currentRow,
            endCol: totalCols - 1,
            valStr: finalProduct.toString(),
            hint: `最後，把上面的數字全部加起來！`,
            voiceSuccess: `好極了！最終答案是 ${finalProduct}。`,
            voiceFail: `加法算錯囉，對齊位數慢慢加。`,
            successMsg: `全對！你真棒！`,
            failMsg: `加法錯囉！加油！`,
            color: 'val-final'
        });

        steps.push({
            type: 'finish',
            msg: `恭喜你！全部完成！<br>你真是乘法大師！`,
            voiceSuccess: "恭喜你！完成了所有的計算，你真是太厲害了！"
        });
    }

    function processNextStep() {
        if (currentStepIndex >= steps.length) return;
        let s = steps[currentStepIndex];

        if (s.type === 'finish') {
            speak(s.voiceSuccess, true);
            statusTitle.innerText = "挑戰成功！";
            statusTitle.style.color = "#27ae60";
            statusMsg.innerHTML = s.msg;
            infoBox.style.borderLeftColor = "#27ae60";
            checkBtn.style.display = 'none';
            return;
        }

        statusTitle.innerText = "請輸入答案";
        statusMsg.innerHTML = s.hint;
        infoBox.style.borderLeftColor = "#f1c40f";

        // 1. 先建立所有輸入框
        let str = s.valStr;
        for (let k = 0; k < str.length; k++) {
            let targetCol = s.endCol - (str.length - 1 - k);
            createInputAt(s.row, targetCol, k);
        }

        // 2. 建立完成後，明確聚焦到最右邊的輸入框 (個位數)
        // 最右邊的輸入框索引值是 str.length - 1
        let rightmostIndex = str.length - 1;
        let targetInputId = `input-${currentStepIndex}-${rightmostIndex}`;
        
        // 使用 setTimeout 確保 DOM 已更新且在手機上能正確喚起鍵盤
        setTimeout(() => {
            let targetInput = document.getElementById(targetInputId);
            if (targetInput) {
                targetInput.focus();
            }
        }, 100);
    }

    function createInputAt(row, col, index) {
        let cell = document.getElementById(`cell-${row}-${col}`);
        cell.innerHTML = '';
        let input = document.createElement('input');
        input.type = "text"; 
        input.inputMode = "numeric"; 
        input.pattern = "[0-9]*";
        input.className = "game-input";
        input.id = `input-${currentStepIndex}-${index}`; // index 0 是最高位(左)，length-1 是最低位(右)
        
        // 自動往左跳轉邏輯
        input.addEventListener('input', function() {
            if (this.value.length === 1) {
                // 輸入一個數字後，跳到索引值更小的輸入框 (即左邊那位)
                let prevId = `input-${currentStepIndex}-${index - 1}`;
                let prevInput = document.getElementById(prevId);
                if (prevInput) {
                    prevInput.focus();
                }
            }
        });

        cell.appendChild(input);
    }

    function checkAnswer() {
        let s = steps[currentStepIndex];
        let inputs = document.querySelectorAll('.game-input');
        let userStr = "";
        let allFilled = true;

        inputs.forEach(inp => {
            if(inp.value === "") allFilled = false;
            userStr += inp.value;
        });

        if(!allFilled) return;

        let targetStr = s.valStr;
        let isCorrect = (parseInt(userStr) === parseInt(targetStr));

        if (isCorrect) {
            speak(s.voiceSuccess, true);
            statusTitle.innerText = "答對了！";
            statusMsg.innerText = s.successMsg;
            infoBox.style.borderLeftColor = "#27ae60";

            inputs.forEach(inp => {
                let parent = inp.parentNode;
                let val = inp.value;
                parent.innerHTML = `<span class="${s.color}">${val}</span>`;
            });

            currentStepIndex++;
            setTimeout(processNextStep, 1800); 
        } else {
            speak(s.voiceFail, false);
            statusTitle.innerText = "加油！";
            statusMsg.innerText = s.failMsg;
            infoBox.style.borderLeftColor = "#c0392b";

            inputs.forEach(inp => {
                inp.classList.add('wrong');
                setTimeout(() => inp.classList.remove('wrong'), 500);
            });
            
            // 答錯時，重新聚焦到最右邊的輸入框
            let lastInputIndex = s.valStr.length - 1;
            let lastInput = document.getElementById(`input-${currentStepIndex}-${lastInputIndex}`);
            if(lastInput) lastInput.focus();
        }
    }
</script>

</body>
</html>