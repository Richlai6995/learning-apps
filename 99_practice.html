<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>99ä¹˜æ³•é—–é—œç‹ 1.7 (å¯¶çŸ³çå‹µç‰ˆ)</title>
    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #9b59b6;
            --light: #f4ecf7;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --help: #2980b9;
            
            --hint-a: #27ae60; 
            --hint-b: #2980b9; 
            --font-base: 1.2rem;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #fdfefe;
            color: var(--dark);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
        }

        h1 { color: var(--primary); margin: 10px 0 20px 0; text-align: center; font-size: 2rem; }

        /* --- å­¸å“¡åç‰Œ & çå‹µé¡¯ç¤º --- */
        .user-profile {
            background-color: #e8daef;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark);
            display: flex; align-items: center; gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .stats-badge {
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- å®¹å™¨ --- */
        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15); padding: 25px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* --- æŒ‰éˆ• --- */
        button {
            border: none; border-radius: 10px; padding: 12px 24px; 
            font-size: 1.1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 5px; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-help { background-color: var(--help); }
        .btn-gray { background-color: #95a5a6; }
        .btn-block { width: 100%; padding: 15px; margin-top: 15px; font-size: 1.3rem; }

        /* --- åˆ—è¡¨ --- */
        .list-item {
            background: #f8f9fa; border: 2px solid #ddd; padding: 15px; margin-bottom: 10px;
            border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem;
        }
        .list-info small { color: #e74c3c; font-weight: bold; display: block; margin-top: 5px;}
        .gem-tag { color: #2980b9; font-weight: bold; background: #d6eaf8; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; margin-left: 5px;}
        
        /* --- ç·¨è¼¯å€ --- */
        .gen-controls { 
            display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; 
            background: #f4f6f7; padding: 15px; border-radius: 10px; font-size: 1.1rem;
        }
        .gen-controls input { padding: 8px; width: 150px; text-align: left; font-size: 1.1rem; border-radius: 5px; border: 1px solid #ccc;}
        
        .edit-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; justify-content: center;}
        .edit-row input { padding: 10px; width: 80px; text-align: center; font-size: 1.2rem; border-radius: 5px; border: 1px solid #ccc; }

        /* --- è¨­å®šé¸é … --- */
        .settings-box {
            background-color: #eafaf1;
            border: 2px solid #a9dfbf;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        .settings-title { font-weight: bold; margin-bottom: 10px; color: var(--dark); }
        .checkbox-group { display: flex; gap: 20px; justify-content: center; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; cursor: pointer; }
        .checkbox-item input { width: 22px; height: 22px; cursor: pointer; }

        /* --- æ¸¬é©—å€ --- */
        .quiz-header { 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; margin-bottom: 20px; background: #eee; padding: 15px; border-radius: 10px; 
            font-size: 1.3rem;
        }
        #q-timer { font-family: monospace; font-size: 1.5rem; color: #2c3e50; }
        .timer-urgent { color: #e74c3c !important; animation: blink 1s infinite; font-weight: 900; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* æ©«å¼ç®—å¼ */
        .equation-board {
            display: flex; justify-content: center; align-items: center; margin: 30px 0; gap: 15px;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 3.5rem; flex-wrap: wrap;
        }
        .hl-a { color: var(--hint-a); font-weight: 900; }
        .hl-b { color: var(--hint-b); font-weight: 900; }
        .hl-op { color: #7f8c8d; }
        .input-group { display: flex; gap: 8px; }

        .game-input { 
            width: 60px; height: 60px; font-size: 2.5rem; text-align: center; 
            border: 3px solid var(--primary); border-radius: 10px; background: #fff;
            font-weight: bold; outline: none; padding: 0;
        }
        .game-input.active-input {
            background-color: #f5b7b1 !important; border-color: #c0392b; box-shadow: 0 0 10px rgba(192, 57, 43, 0.5);
        }

        /* æ±‚åŠ© */
        .help-box {
            display: none; background-color: #eaf2f8; border-left: 6px solid #3498db;
            padding: 15px; margin-top: 15px; border-radius: 8px; text-align: left;
            font-size: 1.1rem; line-height: 1.6; animation: slideDown 0.3s;
        }
        @keyframes slideDown { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }
        .help-table { width: 100%; margin-top: 5px; font-family: monospace; }
        .help-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom:1px dashed #ddd;}
        .help-focus { background-color: #f9e79f; font-weight:bold; padding:0 5px; border-radius:3px;}

        .test-mode-box { text-align: center; padding: 30px; font-size: 1.8rem; }
        .test-input { font-size: 1.8rem; padding: 10px; width: 120px; text-align: center; margin: 10px; border-radius: 8px; border: 2px solid #ccc;}

        /* è©³ç´°çµæœ */
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 1.1rem; }
        .result-table th { background-color: #f2f2f2; }
        .res-correct { color: var(--success); font-weight: bold; }
        .res-wrong { color: var(--danger); font-weight: bold; }

        .version-tag {
            margin-top: 30px; color: #bdc3c7; font-size: 0.9rem; text-align: center;
            font-family: monospace; border-top: 1px dashed #eee; padding-top: 10px;
        }
        
        /* ç²çå‹•ç•«æ•ˆæœ */
        .reward-popup {
            animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #fff8e1; border: 3px solid #f1c40f; padding: 15px;
            border-radius: 10px; margin-top: 20px; font-weight: bold; color: #d35400;
        }
        @keyframes pop { from{transform: scale(0);} to{transform: scale(1);} }

    </style>
</head>
<body>

    <div id="page-home" class="container active">
        <h1>âŒ 99ä¹˜æ³•é—–é—œç‹</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½ (å«å¯¶çŸ³)</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv1.7 (å¯¶çŸ³çå‹µç‰ˆ)</div>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯/ç”Ÿæˆé¡Œåº«</h2>
        <div style="margin-bottom:15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
            <div>åç¨±: <input type="text" id="list-name" style="padding:8px; width:180px; font-size:1.2rem;"></div>
            <div>â±ï¸ é™æ™‚(ç§’): <input type="number" id="list-timer" placeholder="0ä¸é™" style="padding:8px; width:70px; font-size:1.2rem;" value="0"></div>
            <div>ğŸ’ çå‹µå¯¶çŸ³: <input type="number" id="list-gems" placeholder="5" style="padding:8px; width:70px; font-size:1.2rem;" value="5"></div>
        </div>
        <div class="gen-controls">
            <span><strong>å¿«é€Ÿç”Ÿæˆ:</strong> è¼¸å…¥æ•¸å­— (é€—è™Ÿåˆ†éš”) å¦‚: 2,5,8</span><br>
            <div style="margin-top:10px;">
                <input type="text" id="gen-targets" value="2,3,5" placeholder="è¼¸å…¥æ•¸å­—...">
                <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆé¡Œç›®</button>
            </div>
        </div>
        <div id="editor-rows" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        <div style="margin-top:25px; display:flex; gap:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        
        <div class="settings-box">
            <div class="settings-title">âš™ï¸ æ•™å­¸æ¨¡å¼è¼”åŠ©è¨­å®šï¼š</div>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º</label>
                <label class="checkbox-item"><input type="checkbox" id="opt-text" checked> ğŸ“ æ–‡å­—æç¤º</label>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– é€²å…¥æ•™å­¸æ¨¡å¼</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ é€²å…¥æ¸¬é©—æ¨¡å¼</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:30px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <button class="btn-danger" onclick="quitQuiz()">ğŸšª é€€å‡º</button>
        </div>

        <div id="teach-area" style="display:none;">
            <div id="teach-msg" style="font-weight:bold; font-size:1.3rem; min-height: 3.6rem; color:var(--primary);"></div>
            <div style="margin: 10px 0;">
                <button class="btn-help" onclick="toggleHelp()">ğŸ’¡ å¿˜è¨˜äº†ï¼Œæ±‚åŠ©ï¼</button>
                <div id="help-content" class="help-box"></div>
            </div>
            <div class="equation-board" id="gridBoard"></div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="font-size:3rem; margin-bottom:30px; font-family: monospace;"></div>
                ç©: <input type="number" id="test-ans" class="test-input"> <br><br>
                <button class="btn-primary" onclick="checkTestAnswer()">é€å‡ºç­”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 4rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-summary" style="font-size: 1.5rem; margin-bottom: 15px;"></div>
            
            <div id="reward-area"></div>

            <div style="max-height: 300px; overflow-y: auto;">
                <table class="result-table">
                    <thead><tr><th>é¡Œç›®</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>çµæœ</th></tr></thead>
                    <tbody id="res-table-body"></tbody>
                </table>
            </div>

            <button class="btn-warning btn-block" onclick="saveRank()">ç™»è¨˜è‹±é›„æ¦œ</button>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    let quizSettings = { voice: true, text: true };
    let studentName = 'å°å°æ•¸å­¸å®¶';
    let totalGems = 0; // å­¸å“¡ç¸½å¯¶çŸ³æ•¸

    // --- èªéŸ³ ---
    function speak(text) {
        let force = text.includes("æ™‚é–“") || text.includes("å¯¶çŸ³") || text.includes("å…¨å°");
        if(currentMode === 'teach' && !quizSettings.voice && !force) return;
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let clean = text.replace(/<[^>]*>/g, '').replace(/Ã—/g, 'ä¹˜').replace(/=/g, 'ç­‰æ–¼');
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'zh-TW'; u.rate = 1.0; 
            window.speechSynthesis.speak(u);
        }
    }

    // --- è³‡æ–™ ---
    let allLists = [], currentList = null, quizData = [];
    let currentQIdx = 0, currentMode = '';
    let timerInt, startTime, limitSeconds = 0, isWarningPlayed = false;
    let rankData = [], editingId = null; 

    window.onload = function() {
        if(localStorage.getItem('mul_v1_lists')) allLists = JSON.parse(localStorage.getItem('mul_v1_lists'));
        else { allLists = [{name: "åŸºç¤ç·´ç¿’ (2,5)", timer: 0, gems: 5, qs: genQs([2,5])}]; saveData(); }
        
        if(localStorage.getItem('mul_v1_rank')) rankData = JSON.parse(localStorage.getItem('mul_v1_rank'));
        
        if(localStorage.getItem('mul_student')) studentName = localStorage.getItem('mul_student');
        if(localStorage.getItem('mul_gems')) totalGems = parseInt(localStorage.getItem('mul_gems')) || 0;
        
        updateProfile();
        renderLists();
    };

    function saveData() { localStorage.setItem('mul_v1_lists', JSON.stringify(allLists)); }
    function saveRankData() { localStorage.setItem('mul_v1_rank', JSON.stringify(rankData)); }
    function saveStudentData() { 
        localStorage.setItem('mul_student', studentName); 
        localStorage.setItem('mul_gems', totalGems);
        updateProfile();
    }
    
    // --- å­¸å“¡è³‡æ–™ & å¯¶çŸ³é¡¯ç¤º ---
    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) { studentName = n.trim(); saveStudentData(); }
    }
    function updateProfile() { 
        document.getElementById('display-name').innerText = studentName; 
        // æ›ç®—çš‡å† ï¼š100å¯¶çŸ³ = 1çš‡å† 
        let crowns = Math.floor(totalGems / 100);
        let remainGems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remainGems;
    }
    
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- é¡Œåº«åˆ—è¡¨ ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            let timerInfo = l.timer > 0 ? `<small>â±ï¸ é™æ™‚ ${l.timer} ç§’</small>` : '';
            // é è¨­å¯¶çŸ³æ•¸
            let gemVal = l.gems ? l.gems : 5; 
            
            d.innerHTML = `
                <div class="list-info">
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                    <span class="gem-tag">ğŸ’ +${gemVal}</span>
                    ${timerInfo}
                </div>
                <div>
                    <button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                </div>`;
            c.appendChild(d);
        });
    }

    function createNewList() { 
        editingId = null; 
        document.getElementById('list-name').value="æ–°ä¹˜æ³•ç·´ç¿’"; 
        document.getElementById('list-timer').value = 0; 
        document.getElementById('list-gems').value = 5; 
        document.getElementById('editor-rows').innerHTML=''; 
        showPage('page-editor'); 
    }

    function editList(i) { 
        editingId=i; const l=allLists[i]; 
        document.getElementById('list-name').value=l.name; 
        document.getElementById('list-timer').value=l.timer || 0; 
        document.getElementById('list-gems').value=l.gems || 5;
        document.getElementById('editor-rows').innerHTML=''; 
        l.qs.forEach(q=>addEditRow(q.a,q.b)); 
        showPage('page-editor'); 
    }

    function addEditRow(a='', b='') { 
        const d=document.createElement('div'); d.className='edit-row'; 
        d.innerHTML=`<input type="number" class="inp-a" value="${a}"> Ã— <input type="number" class="inp-b" value="${b}"><button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`; 
        document.getElementById('editor-rows').appendChild(d); 
    }

    function autoGenerate() {
        const input = document.getElementById('gen-targets').value;
        const targets = input.split(/[,ï¼Œ]/).map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        if(targets.length === 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—"); return; }
        
        document.getElementById('editor-rows').innerHTML = '';
        let newQs = genQs(targets);
        newQs.sort(() => Math.random() - 0.5);
        newQs.forEach(q => addEditRow(q.a, q.b));
    }

    function genQs(targets) {
        let qs = [];
        targets.forEach(t => { for(let i=1; i<=10; i++) qs.push({a: t, b: i}); });
        return qs;
    }

    function saveList() { 
        const n=document.getElementById('list-name').value; 
        const tVal=parseInt(document.getElementById('list-timer').value); 
        const timer = isNaN(tVal) ? 0 : tVal;
        const gVal=parseInt(document.getElementById('list-gems').value);
        const gems = isNaN(gVal) ? 5 : gVal;

        const rs=document.querySelectorAll('.edit-row'); 
        const qs=[]; 
        rs.forEach(r=>{const a=parseInt(r.querySelector('.inp-a').value); const b=parseInt(r.querySelector('.inp-b').value); if(a&&b)qs.push({a,b})}); 
        if(qs.length<1)return alert("è«‹è¼¸å…¥é¡Œç›®"); 
        
        const data = {name:n, timer:timer, gems:gems, qs:qs};
        if(editingId===null) allLists.push(data); else allLists[editingId]=data; 
        
        saveData(); showPage('page-home'); editingId=null; 
    }

    function delList(i) { if(confirm("åˆªé™¤ï¼Ÿ")){allLists.splice(i,1); saveData(); renderLists();} }

    // --- åŒ¯å‡ºè³‡æ–™ (å«å¯¶çŸ³) ---
    function exportData() { 
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
        // åŒ…è£è³‡æ–™ï¼šåŒ…å«é¡Œåº«èˆ‡å­¸å“¡æ•¸æ“š
        const exportObj = {
            version: "1.7",
            student: { name: studentName, totalGems: totalGems },
            lists: allLists
        };
        const b=new Blob([JSON.stringify(exportObj)],{type:"application/json"}); 
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`mul_backup_${dateStr}.json`; a.click(); 
    }
    
    // --- åŒ¯å…¥è³‡æ–™ ---
    function handleImport(inp) { 
        const f=inp.files[0]; const r=new FileReader(); 
        r.onload=(e)=>{ 
            try {
                const data = JSON.parse(e.target.result);
                // åˆ¤æ–·æ˜¯æ–°ç‰ˆå‚™ä»½(å«student)é‚„æ˜¯èˆŠç‰ˆ(åªæœ‰é™£åˆ—)
                if (Array.isArray(data)) {
                    allLists = allLists.concat(data); // èˆŠç‰ˆç›¸å®¹
                } else if (data.lists) {
                    // æ–°ç‰ˆ
                    allLists = allLists.concat(data.lists);
                    if(data.student) {
                        if(confirm(`åŒ¯å…¥è³‡æ–™åŒ…å«å­¸å“¡ï¼š${data.student.name} (å¯¶çŸ³:${data.student.totalGems})ã€‚\nè¦è¦†è“‹ç›®å‰çš„é€²åº¦å—ï¼Ÿ`)) {
                            studentName = data.student.name;
                            totalGems = data.student.totalGems;
                            saveStudentData();
                        }
                    }
                }
                saveData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ");
            } catch(x){alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");} 
        }; 
        r.readAsText(f); 
    }

    // --- æ¸¬é©—æµç¨‹ ---
    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        if(mode === 'teach') {
            quizSettings.voice = document.getElementById('opt-voice').checked;
            quizSettings.text = document.getElementById('opt-text').checked;
        }

        let questions = [...currentList.qs];
        questions.sort(() => Math.random() - 0.5);

        quizData = questions.map(q => ({
            a: q.a, b: q.b, 
            ans: q.a * q.b,
            userAns: null, isCorrect: false,
            done: false
        }));
        
        currentQIdx = 0;
        limitSeconds = currentList.timer || 0; 
        isWarningPlayed = false;
        startTime = Date.now();
        document.getElementById('q-timer').classList.remove('timer-urgent');

        clearInterval(timerInt); 
        timerInt = setInterval(updTime, 1000);
        updTime();

        showPage('page-quiz');
        let intro = `${studentName}ï¼Œæ­¡è¿ä¾†åˆ°${mode==='teach'?'æ•™å­¸æ¨¡å¼':'æ¸¬é©—æ¨¡å¼'}ï¼`;
        if(limitSeconds > 0) intro += `æœ¬é—œå¡é™æ™‚ ${limitSeconds} ç§’ï¼ŒåŠ æ²¹ï¼`;
        speak(intro);
        loadQuestion();
    }

    function updTime() {
        let elapsed = Math.floor((Date.now()-startTime)/1000);
        if (limitSeconds > 0) {
            let remaining = limitSeconds - elapsed;
            if (remaining <= 0) {
                remaining = 0;
                document.getElementById('q-timer').innerText = "00:00";
                clearInterval(timerInt);
                speak("æ™‚é–“åˆ°ï¼åœæ­¢ä½œç­”ï¼");
                alert("â° æ™‚é–“åˆ°ï¼æ¸¬é©—çµæŸï¼");
                finishQuiz(); 
                return;
            }
            let mm = Math.floor(remaining / 60).toString().padStart(2,'0');
            let ss = (remaining % 60).toString().padStart(2,'0');
            document.getElementById('q-timer').innerText = `${mm}:${ss}`;
            if (remaining <= 10) {
                document.getElementById('q-timer').classList.add('timer-urgent');
                if (!isWarningPlayed) { speak("æ™‚é–“å¿«åˆ°äº†ï¼ŒåŠ æ²¹ï¼"); isWarningPlayed = true; }
            }
        } else {
            let d = new Date(elapsed * 1000);
            document.getElementById('q-timer').innerText = d.toISOString().substr(14, 5);
        }
    }

    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡ºï¼Ÿ")) { clearInterval(timerInt); showPage('page-home'); } }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        
        if(currentMode === 'test') {
            document.getElementById('teach-area').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
            document.getElementById('test-q-text').innerText = `${q.a} Ã— ${q.b} = ?`;
            const inp = document.getElementById('test-ans');
            inp.value = '';
            inp.focus();
            inp.onkeydown = (e) => { if(e.key === 'Enter') checkTestAnswer(); };
        } else {
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('teach-area').style.display = 'block';
            renderMulGrid(q);
        }
    }

    function renderMulGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML = ''; 
        const msg = document.getElementById('teach-msg');
        document.getElementById('help-content').style.display = 'none';
        
        const elA = document.createElement('span'); elA.innerText = q.a; elA.className = 'hl-a'; box.appendChild(elA);
        const elSign = document.createElement('span'); elSign.innerText = ' Ã— '; elSign.className = 'hl-op'; box.appendChild(elSign);
        const elB = document.createElement('span'); elB.innerText = q.b; elB.className = 'hl-b'; box.appendChild(elB);
        const elEq = document.createElement('span'); elEq.innerText = ' = '; elEq.className = 'hl-op'; box.appendChild(elEq);

        const inputGroup = document.createElement('div'); inputGroup.className = 'input-group';
        const strAns = q.ans.toString();
        let createdInputs = [];

        for(let i=0; i<strAns.length; i++) {
            const inp = document.createElement('input');
            inp.type = 'tel'; inp.maxLength = 1; inp.className = 'game-input active-input step-input-group';
            inp.dataset.index = i; 
            inp.oninput = function() {
                if(this.value.length === 1) {
                    const nextIndex = parseInt(this.dataset.index) + 1;
                    if(createdInputs[nextIndex]) createdInputs[nextIndex].focus();
                }
            };
            inp.onkeydown = (e) => { 
                if(e.key === 'Enter') checkTeachAnswerMulti(q); 
                if(e.key === 'Backspace' && this.value === '') {
                     const prevIndex = parseInt(this.dataset.index) - 1;
                     if(createdInputs[prevIndex]) createdInputs[prevIndex].focus();
                }
            };
            inputGroup.appendChild(inp); createdInputs.push(inp);
        }
        box.appendChild(inputGroup);

        let hint = `è«‹è¨ˆç®— ${q.a} ä¹˜ä»¥ ${q.b} æ˜¯å¤šå°‘ï¼Ÿ`;
        if(quizSettings.text) msg.innerText = hint; else msg.innerText = "è«‹å¡«å¯«ç­”æ¡ˆ...";
        speak(hint);

        if(createdInputs.length > 0) setTimeout(() => createdInputs[0].focus(), 100);

        const okBtn = document.createElement('button'); okBtn.className='btn-warning'; okBtn.innerText='OK';
        okBtn.onclick = () => checkTeachAnswerMulti(q);
        if(document.getElementById('ok-btn')) document.getElementById('ok-btn').remove();
        let oldBtn = msg.querySelector('button'); if(oldBtn) oldBtn.remove();
        msg.appendChild(document.createElement('br')); msg.appendChild(okBtn);
    }

    function checkTeachAnswerMulti(q) {
        const inputs = document.querySelectorAll('.step-input-group');
        let userAnsStr = ""; inputs.forEach(inp => userAnsStr += inp.value);
        if(userAnsStr === "") { if(inputs.length>0) inputs[0].focus(); return; }

        if(parseInt(userAnsStr) === q.ans) {
            speak("ç­”å°äº†ï¼"); q.isCorrect = true; q.userAns = q.ans; nextQuestion();
        } else {
            speak(`ç®—éŒ¯å›‰ï¼Œ${q.a} ä¹˜ä»¥ ${q.b} ä¸æ˜¯ ${userAnsStr}ï¼Œå†æƒ³æƒ³çœ‹ã€‚`);
            inputs.forEach(inp => inp.value = ''); if(inputs.length>0) inputs[0].focus();
        }
    }

    function checkTestAnswer() {
        const q = quizData[currentQIdx];
        const uAns = document.getElementById('test-ans').value;
        if(uAns === '') { return; } 
        q.userAns = parseInt(uAns);
        if(q.userAns === q.ans) {
            q.isCorrect = true; speak("ç­”å°äº†ï¼"); nextQuestion();
        } else {
            q.isCorrect = false; speak(`éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${q.ans}`);
            alert(`âŒ ç®—éŒ¯å›‰ï¼\n\né¡Œç›®ï¼š${q.a} Ã— ${q.b}\næ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${q.ans}`);
            nextQuestion();
        }
    }

    function nextQuestion() {
        if(currentQIdx < quizData.length - 1) { currentQIdx++; loadQuestion(); } else { finishQuiz(); }
    }

    function toggleHelp() {
        const helpBox = document.getElementById('help-content');
        if(helpBox.style.display === 'block') { helpBox.style.display = 'none'; return; }
        const q = quizData[currentQIdx];
        let html = `<strong>ğŸ” ${q.a} çš„ä¹˜æ³•è¡¨ï¼š</strong><br><div class="help-table">`;
        for(let i=1; i<=10; i++) {
            let style = (i === q.b) ? 'class="help-row help-focus"' : 'class="help-row"';
            let mark = (i === q.b) ? 'ğŸ‘ˆ' : '';
            html += `<div ${style}><span>${q.a} Ã— ${i} = ${q.a*i}</span> ${mark}</div>`;
        }
        html += `</div>`;
        helpBox.innerHTML = html; helpBox.style.display = 'block'; speak(`ä¾†çœ‹çœ‹ ${q.a} çš„ä¹˜æ³•è¡¨`);
    }

    function finishQuiz() {
        clearInterval(timerInt);
        showPage('page-result');
        
        const correctCount = quizData.filter(q => q.isCorrect).length;
        const score = Math.round((correctCount / quizData.length) * 100);
        
        document.getElementById('res-score').innerText = score;
        let summary = `${studentName}ï¼Œä½ ç­”å°äº† ${correctCount} / ${quizData.length} é¡Œï¼`;
        if(limitSeconds > 0 && currentQIdx < quizData.length - 1) summary += " (æ™‚é–“åˆ°ï¼Œéƒ¨åˆ†æœªå®Œæˆ)";
        document.getElementById('res-summary').innerText = summary;
        
        // --- å¯¶çŸ³çå‹µçµç®— ---
        const rewardArea = document.getElementById('reward-area');
        rewardArea.innerHTML = '';
        
        if (currentMode === 'test' && score === 100) {
            let gemsEarned = currentList.gems || 5;
            totalGems += gemsEarned;
            saveStudentData(); // å„²å­˜å¯¶çŸ³
            
            rewardArea.innerHTML = `
                <div class="reward-popup">
                    ğŸ‰ æ­å–œæ»¿åˆ†ï¼ç²å¾— ${gemsEarned} é¡†å¯¶çŸ³ ğŸ’<br>
                    ç›®å‰ç´¯ç©: ${totalGems} é¡†
                </div>`;
            speak(`å¤ªæ£’äº†ï¼å…¨å°ï¼ä½ ç²å¾—äº† ${gemsEarned} é¡†å¯¶çŸ³ï¼`);
        } else {
            let praise = score>=60?"è¡¨ç¾ä¸éŒ¯ï¼Œä¸‹æ¬¡æŒ‘æˆ°æ»¿åˆ†æ‹¿å¯¶çŸ³ï¼":"å†å¤šç·´ç¿’å¹¾æ¬¡ï¼ŒåŠ æ²¹ï¼";
            speak(`æ¸¬é©—çµæŸï¼Œä½ å¾—äº†${score}åˆ†ã€‚${praise}`);
        }

        const tbody = document.getElementById('res-table-body');
        tbody.innerHTML = '';
        quizData.forEach(q => {
            const tr = document.createElement('tr');
            let status = q.isCorrect ? '<span class="res-correct">O</span>' : '<span class="res-wrong">X</span>';
            let uAnsShow = (q.userAns === null) ? "<span style='color:gray'>æœªç­”</span>" : q.userAns;
            if(currentMode === 'teach' && q.isCorrect) uAnsShow = "(å®Œæˆ)";
            
            tr.innerHTML = `<td>${q.a} Ã— ${q.b}</td><td>${uAnsShow}</td><td>${q.ans}</td><td>${status}</td>`;
            tbody.appendChild(tr);
        });
    }

    function saveRank() {
        const t = document.getElementById('q-timer').innerText;
        const s = document.getElementById('res-score').innerText;
        let listName = currentList.name;
        if(limitSeconds > 0) listName += ` [é™æ™‚${limitSeconds}s]`;
        rankData.push({name: studentName, score: parseInt(s), time: t, list: listName});
        saveRankData(); alert("å·²ç™»è¨˜"); switchTab('rank'); showPage('page-home');
    }

    function renderRank() {
        const box = document.getElementById('rank-container'); box.innerHTML='';
        rankData.sort((a,b)=>b.score-a.score || a.time.localeCompare(b.time));
        rankData.forEach((r,i)=>{
            const d=document.createElement('div'); d.className='rank-item';
            d.innerHTML=`<span>${i+1}. ${r.name} (${r.list})</span><span>${r.score}åˆ† <small>${r.time}</small></span>`;
            box.appendChild(d);
        });
    }
    function clearRank() { if(confirm("æ¸…ç©º?")){rankData=[]; saveRankData(); renderRank();} }

</script>

</body>
</html>
