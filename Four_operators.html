<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å‰‡é‹ç®—è§€å¿µå»ºç«‹ç³»çµ± (å„ªåŒ–ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2980b9;
            --primary-dark: #21618c;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f; /* é»ƒè‰² */
            --warning-text: #7f6000; /* é»ƒè‰²æŒ‰éˆ•ä¸Šçš„æ·±è‰²å­— */
            
            --op-add: #e74c3c;
            --op-sub: #8e44ad;
            --op-mul: #2980b9;
            --op-div: #16a085;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem;}
        
        .container {
            width: 100%; max-width: 800px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px;
            display: none; flex-direction: column; 
            animation: fadeIn 0.3s;
        }
        .container.active { display: flex; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            border: none; border-radius: 8px; padding: 10px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 3px; transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.96); box-shadow: none; }
        
        .btn-block { width: 100%; padding: 12px; margin-top: 5px; }
        
        /* è‰²å½©å„ªåŒ–ï¼šç¢ºä¿å°æ¯”åº¦ */
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: var(--warning-text); } /* å„ªåŒ–ï¼šé»ƒåº•é»‘å­— */
        .btn-gray { background-color: #95a5a6; color: white; }
        .btn-outline { background: white; border: 2px solid #bdc3c7; color: #555; }
        
        /* --- é‹ç®—ç¬¦è™Ÿé¸æ“‡å€ --- */
        .operator-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;
        }
        .op-card {
            background: white; border: 2px solid #eee; border-radius: 15px;
            height: 110px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 0 #ddd; position: relative;
        }
        .op-card:active { transform: translateY(4px); box-shadow: none; }
        .op-card span { font-size: 2.8rem; font-weight: bold; }
        .op-card div { font-size: 1rem; margin-top: 5px; font-weight: bold; }

        .op-add { color: var(--op-add); border-color: #fadbd8; background: #fdedec; }
        .op-sub { color: var(--op-sub); border-color: #ebdef0; background: #f4ecf7; }
        .op-mul { color: var(--op-mul); border-color: #d6eaf8; background: #ebf5fb; }
        .op-div { color: var(--op-div); border-color: #d0ece7; background: #e8f8f5; }

        .op-card:hover { filter: brightness(0.95); }

        /* --- å‹•ç•«æ¼”ç¤ºå€ --- */
        .concept-stage {
            background: #fff8e1; border: 2px dashed #f39c12; border-radius: 10px;
            min-height: 160px; margin: 15px 0; padding: 10px;
            position: relative; overflow: hidden;
            display: none; 
            animation: popIn 0.5s;
        }
        @keyframes popIn { from {transform: scale(0.9); opacity:0;} to {transform: scale(1); opacity:1;} }

        .concept-note {
            position: absolute; top: 5px; left: 5px; 
            font-size: 0.85rem; background: rgba(255,255,255,0.9); padding: 3px 8px; border-radius: 4px;
            font-weight: bold; color: #d35400; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* åŠ æ³•/æ¸›æ³• æ¢ç‹€åœ– */
        .bar-container { display: flex; align-items: center; margin-bottom: 10px; transition: 1s; width: 100%; }
        .bar { height: 35px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; font-weight: bold; transition: width 0.8s ease-in-out; box-shadow: 0 2px 0 rgba(0,0,0,0.1);}
        .bar-a { background-color: var(--primary); }
        .bar-b { background-color: var(--success); }
        .bracket { border-bottom: 2px solid #333; border-left: 2px solid #333; border-right: 2px solid #333; height: 10px; margin-top: 5px; position: relative; }

        /* ä¹˜æ³•/é™¤æ³• ç‰©ä»¶åœ– */
        .grid-objects { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; padding: 10px; }
        .obj-group { border: 2px solid #ccc; padding: 5px; border-radius: 8px; margin: 4px; background: white; transition: 0.5s; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .dot { width: 14px; height: 14px; background-color: var(--danger); border-radius: 50%; display: inline-block; margin: 2px; }

        /* --- é¡Œç›®é¡¯ç¤º --- */
        .problem-text { font-size: 1.4rem; line-height: 1.5; margin-bottom: 10px; font-weight: bold; color: #2c3e50; text-align: left; padding: 0 5px;}
        .hint-box { 
            background: #eafaf1; color: #27ae60; padding: 12px; border-radius: 8px; 
            margin-bottom: 10px; font-size: 1rem; display: none; border-left: 5px solid #27ae60;
            font-weight: bold;
        }

        /* --- åˆ—è¡¨æ¨£å¼å„ªåŒ– --- */
        .pool-item { 
            padding: 15px; border-bottom: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center;
            background: white; border-radius: 8px; margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .pool-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.2s; }
        
        .editor-input { padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
        .editor-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }

        /* è¨­å®šé–‹é—œæ¨£å¼ */
        .setting-switch {
            display: flex; align-items: center; justify-content: space-between;
            background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #eee;
        }
        .setting-switch input[type="checkbox"] { transform: scale(1.5); margin-left: 10px; cursor: pointer; }
        
        .user-panel {
            background: #fff3cd; border: 2px solid #f39c12; border-radius: 50px;
            padding: 5px 20px; margin-bottom: 15px; font-weight: bold; color: #d35400;
            display: flex; gap: 15px; align-items: center; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="page-home" class="container active">
        <h1>ğŸ§® å››å‰‡é‹ç®—è§€å¿µç·´ç¿’</h1>
        
        <div style="display:flex; justify-content:center;">
            <div class="user-panel" onclick="editUser()">
                <span>ğŸ“ <span id="u-name">å­¸å“¡</span></span>
                <span>ğŸ’ <span id="u-gems">0</span></span>
            </div>
        </div>

        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 5px;">ğŸ“š é¸æ“‡ç·´ç¿’é¡Œåº«</h3>
        <div id="quiz-list" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
        
        <div style="margin-top:auto; border-top: 1px dashed #ccc; padding-top: 15px;">
            <button class="btn-primary btn-block" onclick="showEditor()">âœï¸ å»ºç«‹ / ç·¨è¼¯é¡Œåº«</button>
            
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button class="btn-gray" style="flex:1;" onclick="exportJson()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1;" onclick="document.getElementById('file-upload').click()">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
                <input type="file" id="file-upload" style="display:none" accept=".json" onchange="handleFileImport(this)">
            </div>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:10px;">v2.0 å„ªåŒ–ç‰ˆ</div>
    </div>

    <div id="page-setting" class="container">
        <h2>ğŸ“ ç·´ç¿’è¨­å®š</h2>
        <div class="problem-text" id="setting-title" style="font-size:1.1rem; color:#555;"></div>
        
        <div style="padding: 10px; border-radius: 8px; margin: 10px 0;">
            <h4 style="margin:5px 0 10px 0; color:var(--primary);">1. è¼”åŠ©åŠŸèƒ½é–‹é—œ</h4>
            
            <label class="setting-switch">
                <span>ğŸ”Š èªéŸ³æç¤º (æœ—è®€é¡Œç›®èˆ‡æç¤º)</span>
                <input type="checkbox" id="opt-voice" checked>
            </label>

            <label class="setting-switch">
                <span>ğŸ“ æ–‡å­—èˆ‡åœ–è§£æç¤º (é¡¯ç¤ºè§€å¿µåœ–)</span>
                <input type="checkbox" id="opt-visual" checked>
            </label>

            <label class="setting-switch">
                <span>ğŸ’¡ å…è¨±ã€Œæ±‚åŠ©ã€æŒ‰éˆ•</span>
                <input type="checkbox" id="opt-help" checked>
            </label>

            <h4 style="margin:15px 0 10px 0; color:var(--primary);">2. é¡Œç›®ç¯©é¸</h4>
            <select id="filter-op" class="editor-input" style="width:100%;">
                <option value="all">å…¨éƒ¨æ··åˆ (All)</option>
                <option value="add">åªç·´ åŠ æ³• (+)</option>
                <option value="sub">åªç·´ æ¸›æ³• (-)</option>
                <option value="mul">åªç·´ ä¹˜æ³• (Ã—)</option>
                <option value="div">åªç·´ é™¤æ³• (Ã·)</option>
            </select>
        </div>

        <button class="btn-success btn-block" onclick="startQuiz()">ğŸš€ é–‹å§‹ç·´ç¿’</button>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="page-quiz" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span id="q-progress" style="font-weight:bold; color:#7f8c8d; background:#f0f2f5; padding:4px 10px; border-radius:10px;">1 / 10</span>
            <span id="q-timer" style="font-family:monospace; font-size:1.2rem;">00:00</span>
            <button id="btn-help" class="btn-warning" style="font-size:0.95rem; padding:6px 12px; box-shadow:0 3px #d4ac0d;" onclick="useHelp()">ğŸ’¡ æ±‚åŠ©</button>
        </div>

        <div id="quiz-content" style="flex:1;">
            <div id="q-text" class="problem-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            
            <div id="q-hint-container">
                <div id="q-hint" class="hint-box"></div>
                
                <div id="anim-stage" class="concept-stage">
                    <div class="concept-note">è§€å¿µæ¼”ç¤º</div>
                    <div id="anim-content" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;"></div>
                </div>
            </div>

            <div style="text-align:center; margin:15px 0 5px 0; font-size:1rem; color:#666;">è«‹é»æ“Šæ­£ç¢ºçš„é‹ç®—ç¬¦è™Ÿï¼š</div>

            <div class="operator-grid">
                <div class="op-card op-add" onclick="checkAnswer('add')">
                    <span>+</span><div>åŠ æ³•</div>
                </div>
                <div class="op-card op-sub" onclick="checkAnswer('sub')">
                    <span>-</span><div>æ¸›æ³•</div>
                </div>
                <div class="op-card op-mul" onclick="checkAnswer('mul')">
                    <span>Ã—</span><div>ä¹˜æ³•</div>
                </div>
                <div class="op-card op-div" onclick="checkAnswer('div')">
                    <span>Ã·</span><div>é™¤æ³•</div>
                </div>
            </div>
        </div>

        <div id="feedback-msg" style="text-align:center; font-weight:bold; height:30px; margin-top:10px; font-size:1.2rem;"></div>

        <button id="btn-next" class="btn-success btn-block" style="display:none; margin-top:15px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡</button>
        <button class="btn-danger" style="margin-top:20px; width:100%; background:white; color:var(--danger); border:1px solid var(--danger);" onclick="quitQuiz()">ä¸­é€”çµæŸ</button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="background:#eee; padding:10px; border-radius:6px; margin-bottom:10px;">
            <input type="text" id="edit-list-name" placeholder="é¡Œåº«åç¨±" class="editor-input" style="width:100%; font-weight:bold;">
        </div>
        
        <div style="background:#f8f9fa; padding:15px; border:1px solid #ddd; border-radius:8px;">
            <h4 style="margin-top:0;">â• æ–°å¢é¡Œç›®</h4>
            <textarea id="ed-text" class="editor-input" style="width:100%; height:70px; margin-bottom:8px;" placeholder="è¼¸å…¥å•é¡Œ (ä¾‹å¦‚: è˜‹æœä¸€é¡†10å…ƒï¼Œè²·5é¡†å¤šå°‘éŒ¢?)"></textarea>
            <input type="text" id="ed-hint" class="editor-input" style="width:100%; margin-bottom:8px;" placeholder="è¼¸å…¥æç¤º (ä¾‹å¦‚: ç®—å‡ºç¸½åƒ¹æ˜¯å€æ•¸é—œä¿‚)">
            
            <div class="editor-row">
                <select id="ed-op" class="editor-input" style="flex:1; background:white;">
                    <option value="" disabled selected>æ­£ç¢ºç¬¦è™Ÿ</option>
                    <option value="add">åŠ æ³• (+)</option>
                    <option value="sub">æ¸›æ³• (-)</option>
                    <option value="mul">ä¹˜æ³• (Ã—)</option>
                    <option value="div">é™¤æ³• (Ã·)</option>
                </select>
                <input type="number" id="ed-n1" class="editor-input" style="width:80px;" placeholder="æ•¸å­—A">
                <input type="number" id="ed-n2" class="editor-input" style="width:80px;" placeholder="æ•¸å­—B">
            </div>
            <div style="font-size:0.85rem; color:#888; margin-bottom:10px;">* æ•¸å­— A èˆ‡ B ç”¨æ–¼ç”Ÿæˆæ•™å­¸å‹•ç•« (ä¾‹å¦‚ A=3, B=2 è¡¨ç¤º 3 å€‹æ±è¥¿æœ‰ 2 çµ„)</div>
            <button class="btn-warning btn-block" style="color:#7f6000;" onclick="addQuestionToPool()">åŠ å…¥ä¸‹æ–¹åˆ—è¡¨ â¬‡</button>
        </div>

        <div style="margin-top:15px;">
            <strong>ç›®å‰é¡Œç›®åˆ—è¡¨ (<span id="pool-count">0</span>)</strong>
            <div id="editor-pool-list" style="max-height: 300px; overflow-y: auto; margin-top: 5px;"></div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-success" style="flex:1" onclick="saveList()">ğŸ’¾ å„²å­˜é¡Œåº«</button>
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- è³‡æ–™çµæ§‹ ---
        let user = { name: "å°å°å­¸å“¡", gems: 0 };
        let allLists = [];
        let currentList = null;
        let quizState = {
            questions: [],
            idx: 0,
            correct: 0,
            timer: 0,
            interval: null,
            settings: { voice: true, visual: true, help: true } // å„²å­˜ç•¶æ¬¡æ¸¬é©—è¨­å®š
        };

        // é è¨­ç¯„ä¾‹é¡Œåº«
        const defaultList = {
            id: 1, name: "ç¯„ä¾‹ï¼šç”Ÿæ´»æ•¸å­¸åŸºç¤", 
            qs: [
                { text: "ä¸€ç½é£²æ–™12å…ƒï¼Œè²·5ç½è¦å¤šå°‘éŒ¢ï¼Ÿ", hint: "æƒ³çŸ¥é“ç¸½å…±å¤šå°‘éŒ¢ï¼Œæ˜¯é‡è¤‡åŠ 5æ¬¡åŒæ¨£çš„éŒ¢", op: "mul", n1: 12, n2: 5 },
                { text: "æœ‰15é¡†ç³–æœï¼Œå¹³åˆ†çµ¦3ä½å°æœ‹å‹ï¼Œæ¯äººæ‹¿å¹¾é¡†ï¼Ÿ", hint: "æŠŠç¸½æ•¸å¹³å‡åˆ†çµ¦æ¯ä¸€å€‹äºº", op: "div", n1: 15, n2: 3 },
                { text: "å“¥å“¥æœ‰50å…ƒï¼Œè²·ç­†è¨˜æœ¬èŠ±äº†30å…ƒï¼Œé‚„å‰©å¤šå°‘å…ƒï¼Ÿ", hint: "åŸæœ‰çš„éŒ¢æ‰£æ‰èŠ±æ‰çš„éŒ¢", op: "sub", n1: 50, n2: 30 },
                { text: "å°æ˜ä¸Šåˆè·‘äº†200å…¬å°ºï¼Œä¸‹åˆè·‘äº†300å…¬å°ºï¼Œä»Šå¤©å…±è·‘äº†å¹¾å…¬å°ºï¼Ÿ", hint: "æŠŠå…©æ¬¡è·‘çš„è·é›¢åˆèµ·ä¾†", op: "add", n1: 200, n2: 300 }
            ]
        };

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadData();
            renderHome();
        };

        function loadData() {
            const savedLists = localStorage.getItem('fo_lists_v2');
            if(savedLists) allLists = JSON.parse(savedLists);
            else allLists = [defaultList];
            
            const savedUser = localStorage.getItem('fo_user');
            if(savedUser) user = JSON.parse(savedUser);
            updateUserUI();
        }

        function saveData() {
            localStorage.setItem('fo_lists_v2', JSON.stringify(allLists));
            localStorage.setItem('fo_user', JSON.stringify(user));
        }

        // --- èªéŸ³åˆæˆ ---
        function speak(text) {
            if(!quizState.settings.voice) return;
            // åœæ­¢ä¹‹å‰çš„èªéŸ³ï¼Œé¿å…é‡ç–Š
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 0.9; //ç¨å¾®æ”¾æ…¢èªé€Ÿ
            window.speechSynthesis.speak(u);
        }

        // --- é é¢åˆ‡æ› ---
        function showPage(pid) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            if(pid === 'page-home') renderHome();
        }

        function updateUserUI() {
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-gems').innerText = user.gems;
        }

        function editUser() {
            const n = prompt("è¼¸å…¥ä½ çš„åå­—", user.name);
            if(n) { user.name = n; saveData(); updateUserUI(); }
        }

        // --- é¦–é æ¸²æŸ“ (å„ªåŒ–ï¼šæ¯å€‹é¡Œåº«éƒ½æœ‰ç·´ç¿’æŒ‰éˆ•) ---
        function renderHome() {
            const listDiv = document.getElementById('quiz-list');
            listDiv.innerHTML = '';
            
            if(allLists.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ç›®å‰æ²’æœ‰é¡Œåº«ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å»ºç«‹æˆ–åŒ¯å…¥ã€‚</div>';
                return;
            }

            allLists.forEach((list, idx) => {
                const div = document.createElement('div');
                div.className = 'pool-item';
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:1.1rem; color:var(--dark);">${list.name}</div> 
                        <div style="font-size:0.9rem; color:#7f8c8d; margin-top:4px;">å…± ${list.qs.length} é¡Œ</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <button class="btn-success" style="padding:8px 15px; font-size:0.95rem;" onclick="prepareQuiz(${idx})">â–¶ é–‹å§‹ç·´ç¿’</button>
                        <button class="btn-outline" style="padding:8px 10px;" onclick="editList(${idx})">âš™ï¸</button>
                        <button class="btn-danger" style="padding:8px 10px;" onclick="delList(${idx})">Ã—</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        // --- è€ƒå‰è¨­å®š ---
        function prepareQuiz(idx) {
            currentList = allLists[idx];
            document.getElementById('setting-title').innerText = `ç›®å‰é¸æ“‡ï¼š${currentList.name}`;
            showPage('page-setting');
        }

        // --- æ¸¬é©—æµç¨‹ ---
        function startQuiz() {
            const filter = document.getElementById('filter-op').value;
            
            // è®€å–è¨­å®š
            const settings = {
                voice: document.getElementById('opt-voice').checked,
                visual: document.getElementById('opt-visual').checked,
                help: document.getElementById('opt-help').checked
            };

            // ç¯©é¸é¡Œç›®
            let qPool = currentList.qs;
            if(filter !== 'all') {
                qPool = qPool.filter(q => q.op === filter);
            }

            if(qPool.length === 0) return alert("æ­¤ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰é¡Œç›®ï¼Œè«‹é¸æ“‡å…¶ä»–åˆ†é¡ï¼");

            quizState = {
                questions: shuffle([...qPool]),
                idx: 0,
                correct: 0,
                timer: 0,
                settings: settings,
                interval: setInterval(() => {
                    quizState.timer++;
                    let m = Math.floor(quizState.timer/60).toString().padStart(2,'0');
                    let s = (quizState.timer%60).toString().padStart(2,'0');
                    document.getElementById('q-timer').innerText = `${m}:${s}`;
                }, 1000)
            };

            showPage('page-quiz');
            
            // è¨­å®šæ±‚åŠ©æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
            document.getElementById('btn-help').style.display = settings.help ? 'block' : 'none';
            
            renderQuestion();
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function renderQuestion() {
            const q = quizState.questions[quizState.idx];
            document.getElementById('q-progress').innerText = `${quizState.idx + 1} / ${quizState.questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            
            // é‡ç½®æç¤ºå€
            document.getElementById('q-hint').style.display = 'none';
            document.getElementById('anim-stage').style.display = 'none';
            document.getElementById('q-hint').innerText = q.hint || "æ­¤é¡Œç„¡æ–‡å­—æç¤º";
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('btn-next').style.display = 'none';
            
            // é‡ç½®æŒ‰éˆ•
            document.querySelectorAll('.op-card').forEach(c => {
                c.style.opacity = '1';
                c.style.pointerEvents = 'auto';
                c.style.border = '2px solid #eee';
            });

            // å¦‚æœé–‹å•ŸèªéŸ³ï¼Œæœ—è®€é¡Œç›®
            speak(q.text);
        }

        // --- åŠŸèƒ½ï¼šæ±‚åŠ© (è²éŸ³ + åœ–åƒ) ---
        function useHelp() {
            const q = quizState.questions[quizState.idx];
            
            // 1. é¡¯ç¤ºæ–‡å­—æç¤º (å¦‚æœé–‹å•Ÿè¨­å®š)
            if(quizState.settings.visual) {
                document.getElementById('q-hint').style.display = 'block';
                // 2. ç›´æ¥é¡¯ç¤ºå‹•ç•«åœ–è§£
                playAnimation(q);
            }

            // 3. èªéŸ³æç¤º (å¦‚æœé–‹å•Ÿè¨­å®š)
            if(quizState.settings.voice) {
                let msg = q.hint ? `æç¤ºï¼š${q.hint}` : "é€™é¡Œæ²’æœ‰æç¤ºå–”";
                speak(msg);
            }
        }

        function checkAnswer(selectedOp) {
            const q = quizState.questions[quizState.idx];
            const isCorrect = (selectedOp === q.op);

            if(isCorrect) {
                document.getElementById('feedback-msg').innerText = "ğŸ‰ ç­”å°äº†ï¼";
                document.getElementById('feedback-msg').style.color = "var(--success)";
                speak("ç­”å°äº†ï¼");
                quizState.correct++;
                
                // é–å®š
                document.querySelectorAll('.op-card').forEach(c => c.style.pointerEvents = 'none');
                
                // æ¨™è¨˜æ­£ç¢º
                const card = document.querySelector(`.op-${selectedOp}`);
                card.style.border = "4px solid var(--success)";
                
                // æ·¡å‡ºéŒ¯èª¤çš„
                document.querySelectorAll('.op-card').forEach(c => {
                    if(!c.classList.contains(`op-${selectedOp}`)) c.style.opacity = '0.3';
                });

                // å¦‚æœé‚„æ²’é¡¯ç¤ºå‹•ç•«ä¸”è¨­å®šå…è¨±ï¼Œç­”å°æ™‚ä¹Ÿç§€ä¸€ä¸‹åŠ æ·±å°è±¡
                if(document.getElementById('anim-stage').style.display === 'none' && quizState.settings.visual) {
                    playAnimation(q);
                }

                document.getElementById('btn-next').style.display = 'block';

            } else {
                document.getElementById('feedback-msg').innerText = "âŒ å†è©¦ä¸€æ¬¡...";
                document.getElementById('feedback-msg').style.color = "var(--danger)";
                speak("ä¸å°å–”ï¼Œå†æƒ³ä¸€æƒ³");
                
                const card = document.querySelector(`.op-${selectedOp}`);
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none'; // è©²é¸é …ä¸èƒ½å†æŒ‰
            }
        }

        function nextQuestion() {
            quizState.idx++;
            if(quizState.idx >= quizState.questions.length) {
                endQuiz();
            } else {
                renderQuestion();
            }
        }

        function endQuiz() {
            clearInterval(quizState.interval);
            let score = Math.round((quizState.correct / quizState.questions.length) * 100);
            let gemsEarned = (score === 100) ? 5 : (score >= 60 ? 2 : 1);
            
            user.gems += gemsEarned;
            saveData();
            speak(`ç·´ç¿’çµæŸï¼Œä½ å¾—åˆ°${score}åˆ†`);
            
            setTimeout(() => {
                alert(`ğŸ ç·´ç¿’çµæŸï¼\nå¾—åˆ†: ${score}\nç²å¾—å¯¶çŸ³: ${gemsEarned} ğŸ’`);
                showPage('page-home');
            }, 500);
        }

        function quitQuiz() {
            if(confirm("ç¢ºå®šè¦çµæŸç·´ç¿’å—ï¼Ÿé€²åº¦ä¸æœƒä¿å­˜ã€‚")) {
                clearInterval(quizState.interval);
                window.speechSynthesis.cancel();
                showPage('page-home');
            }
        }

        // --- è§€å¿µå‹•ç•« (å„ªåŒ–ç‰ˆ) ---
        function playAnimation(q) {
            const stage = document.getElementById('anim-stage');
            const content = document.getElementById('anim-content');
            stage.style.display = 'block'; // é¡¯ç¤ºå€åŸŸ
            content.innerHTML = '';

            let n1 = parseFloat(q.n1) || 5;
            let n2 = parseFloat(q.n2) || 2;
            
            // é™åˆ¶æ•¸é‡é¿å…ç•¶æ©Ÿ
            let d1 = n1 > 12 ? 12 : n1; 
            let d2 = n2 > 6 ? 6 : n2;

            if(q.op === 'mul') {
                content.style.flexDirection = 'column';
                for(let i=0; i<d2; i++) {
                    let group = document.createElement('div');
                    group.className = 'obj-group';
                    // å…§å®¹ç‰©
                    for(let j=0; j< (d1 > 10 ? 5 : d1); j++) {
                        let d = document.createElement('span'); d.className='dot'; group.appendChild(d);
                    }
                    if(d1 > 10) group.innerHTML += `<span style="font-size:0.8rem">...${n1}</span>`;
                    
                    group.style.opacity = '0';
                    content.appendChild(group);
                    setTimeout(() => group.style.opacity = '1', i * 200);
                }
                stage.querySelector('.concept-note').innerText = `ä¹˜æ³•ï¼š${n1} å‡ºç¾äº† ${n2} æ¬¡ (å€æ•¸)`;
            } 
            else if(q.op === 'div') {
                stage.querySelector('.concept-note').innerText = `é™¤æ³•ï¼š${n1} å¹³åˆ†çµ¦ ${n2} ä»½`;
                for(let i=0; i<d2; i++) {
                    let b = document.createElement('div');
                    b.className = 'obj-group';
                    b.style.minWidth = '45px'; b.style.textAlign='center';
                    b.innerHTML = `<div style="font-size:0.8rem; border-bottom:1px solid #ddd; margin-bottom:2px;">ç¬¬${i+1}çµ„</div><span style="color:var(--primary); font-weight:bold; font-size:1.2rem;">?</span>`;
                    content.appendChild(b);
                }
                setTimeout(() => {
                   const ans = Math.floor(n1/n2);
                   Array.from(content.children).forEach(b => {
                       b.querySelector('span').innerText = ans;
                   });
                }, 600);
            }
            else if(q.op === 'add') {
                stage.querySelector('.concept-note').innerText = `åŠ æ³•ï¼šåˆä½µåœ¨ä¸€èµ·`;
                let total = n1 + n2;
                let w1 = (n1/(n1+n2)) * 90; 
                let w2 = (n2/(n1+n2)) * 90;
                
                content.innerHTML = `
                    <div class="bar-container" style="justify-content:center;">
                        <div class="bar bar-a" style="width:0%;">${n1}</div>
                        <div class="spacer" style="width:10px; text-align:center; font-weight:bold;">+</div>
                        <div class="bar bar-b" style="width:0%;">${n2}</div>
                    </div>
                `;
                setTimeout(() => {
                    content.querySelector('.bar-a').style.width = w1 + '%';
                    content.querySelector('.bar-b').style.width = w2 + '%';
                }, 100);
                setTimeout(() => {
                   content.querySelector('.spacer').style.width = '0px'; 
                   content.querySelector('.spacer').innerHTML = '';
                }, 800);
            }
            else if(q.op === 'sub') {
                stage.querySelector('.concept-note').innerText = `æ¸›æ³•ï¼šæ¯”è¼ƒå·®è· / æ‹¿èµ°`;
                content.style.flexDirection = 'column';
                let max = Math.max(n1, n2);
                let w1 = (n1/max) * 80;
                let w2 = (n2/max) * 80;

                content.innerHTML = `
                    <div class="bar-container"><div class="bar bar-a" style="width:10px">${n1}</div></div>
                    <div class="bar-container"><div class="bar bar-b" style="width:10px; opacity:0.6;">${n2}</div></div>
                `;
                setTimeout(() => {
                    content.children[0].children[0].style.width = w1 + '%';
                    content.children[1].children[0].style.width = w2 + '%';
                }, 100);
                
                // ç•«å‡ºå·®è·
                setTimeout(() => {
                    let diffW = Math.abs(w1 - w2);
                    let diff = document.createElement('div');
                    diff.innerHTML = `<div style="margin-left:${Math.min(w1,w2)}%; width:${diffW}%; border:2px dashed var(--danger); height:35px; margin-top:-45px; position:relative;"></div>`;
                    content.appendChild(diff);
                }, 1000);
            }
        }

        // --- ç·¨è¼¯å™¨èˆ‡åŒ¯å…¥åŒ¯å‡º ---
        let editingListId = null;
        let tempPool = [];

        function showEditor() {
            editingListId = null;
            tempPool = [];
            document.getElementById('edit-list-name').value = "";
            renderEditorPool();
            showPage('page-editor');
        }

        function editList(idx) {
            editingListId = idx;
            const l = allLists[idx];
            document.getElementById('edit-list-name').value = l.name;
            tempPool = JSON.parse(JSON.stringify(l.qs)); 
            renderEditorPool();
            showPage('page-editor');
        }

        function delList(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤é¡Œåº«?")) {
                allLists.splice(idx, 1);
                saveData();
                renderHome();
            }
        }

        function addQuestionToPool() {
            const text = document.getElementById('ed-text').value.trim();
            const hint = document.getElementById('ed-hint').value.trim();
            const op = document.getElementById('ed-op').value;
            const n1 = document.getElementById('ed-n1').value;
            const n2 = document.getElementById('ed-n2').value;

            if(!text || !op) return alert("è«‹è¼¸å…¥é¡Œç›®ä¸¦é¸æ“‡æ­£ç¢ºç¬¦è™Ÿ");
            
            tempPool.push({
                text, hint, op, 
                n1: parseFloat(n1)||10, 
                n2: parseFloat(n2)||5 
            });
            
            // æ¸…ç©º
            document.getElementById('ed-text').value = '';
            document.getElementById('ed-hint').value = '';
            renderEditorPool();
        }

        function renderEditorPool() {
            const list = document.getElementById('editor-pool-list');
            list.innerHTML = '';
            document.getElementById('pool-count').innerText = tempPool.length;
            
            const opColors = { 'add': 'var(--op-add)', 'sub': 'var(--op-sub)', 'mul': 'var(--op-mul)', 'div': 'var(--op-div)' };
            const opNames = { 'add': '+', 'sub': '-', 'mul': 'Ã—', 'div': 'Ã·' };

            tempPool.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'pool-item';
                div.style.padding = '10px';
                div.innerHTML = `
                    <div style="flex:1;">
                        <span style="background:${opColors[q.op]}; color:white; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:5px;">${opNames[q.op]}</span>
                        ${q.text.substring(0, 25)}${q.text.length>25?'...':''}
                    </div>
                    <button class="btn-danger" style="padding:2px 8px; font-size:0.8rem;" onclick="removeTempQ(${i})">åˆªé™¤</button>
                `;
                list.appendChild(div);
            });
        }

        function removeTempQ(i) {
            tempPool.splice(i, 1);
            renderEditorPool();
        }

        function saveList() {
            const name = document.getElementById('edit-list-name').value.trim() || "æœªå‘½åé¡Œåº«";
            if(tempPool.length === 0) return alert("è«‹è‡³å°‘åŠ å…¥ä¸€é¡Œ");

            const newList = { id: Date.now(), name: name, qs: tempPool };

            if(editingListId !== null) allLists[editingListId] = newList;
            else allLists.push(newList);
            
            saveData();
            showPage('page-home');
        }

        // --- åŒ¯å…¥ / åŒ¯å‡º ---
        function exportJson() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allLists));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "math_quiz_backup.json");
            dlAnchorElem.click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) {
                        // åˆä½µæˆ–å–ä»£? é€™è£¡é¸æ“‡é™„åŠ åœ¨ç¾æœ‰åˆ—è¡¨å¾Œ
                        allLists = allLists.concat(json);
                        saveData();
                        renderHome();
                        alert(`æˆåŠŸåŒ¯å…¥ ${json.length} çµ„é¡Œåº«ï¼`);
                    } else {
                        alert("æ ¼å¼éŒ¯èª¤ï¼šæª”æ¡ˆå…§å®¹å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼");
                    }
                } catch(err) { alert("æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯æ­£ç¢ºçš„ JSON æª”"); }
            };
            reader.readAsText(file);
            input.value = '';
        }
    </script>
</body>
</html>
