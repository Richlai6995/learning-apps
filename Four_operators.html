<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å‰‡é‹ç®—è§€å¿µç³»çµ± (v5.2 æ™ºæ…§åŒ¯å…¥ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2980b9;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f; 
            --warning-text: #7f6000;
            
            --op-add: #e74c3c;
            --op-sub: #8e44ad;
            --op-mul: #2980b9;
            --op-div: #16a085;

            --mode-teach: #16a085;
            --mode-test: #c0392b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem;}
        
        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px;
            display: none; flex-direction: column; 
            animation: fadeIn 0.3s;
            position: relative; z-index: 10;
        }
        .container.active { display: flex; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            border: none; border-radius: 8px; padding: 10px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 3px; transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.96); box-shadow: none; }
        .btn-block { width: 100%; padding: 12px; margin-top: 5px; }
        
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: var(--warning-text); }
        .btn-gray { background-color: #95a5a6; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-accent { background-color: #9b59b6; color: white; } 
        .btn-outline { background: white; border: 2px solid #bdc3c7; color: #555; }
        
        /* --- é‹ç®—ç¬¦è™Ÿé¸æ“‡å€ --- */
        .operator-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .op-card {
            background: white; border: 2px solid #eee; border-radius: 15px;
            height: 110px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 0 #ddd; position: relative;
        }
        .op-card:active { transform: translateY(4px); box-shadow: none; }
        .op-card span { font-size: 2.8rem; font-weight: bold; }
        .op-card div { font-size: 1rem; margin-top: 5px; font-weight: bold; }

        .op-add { color: var(--op-add); border-color: #fadbd8; background: #fdedec; }
        .op-sub { color: var(--op-sub); border-color: #ebdef0; background: #f4ecf7; }
        .op-mul { color: var(--op-mul); border-color: #d6eaf8; background: #ebf5fb; }
        .op-div { color: var(--op-div); border-color: #d0ece7; background: #e8f8f5; }

        /* --- å‹•ç•«èˆ‡æç¤º --- */
        .concept-stage {
            background: #fff8e1; border: 2px dashed #f39c12; border-radius: 10px;
            min-height: 180px; margin: 15px 0; padding: 20px 10px;
            position: relative; overflow: hidden; display: none; animation: popIn 0.5s;
        }
        @keyframes popIn { from {transform: scale(0.9); opacity:0;} to {transform: scale(1); opacity:1;} }
        
        .bar-container { display: flex; align-items: center; margin-bottom: 10px; transition: 1s; width: 100%; }
        .bar { height: 40px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; font-weight: bold; transition: width 0.8s ease-in-out; box-shadow: 0 2px 0 rgba(0,0,0,0.1);}
        .bar-a { background-color: var(--primary); }
        .bar-b { background-color: var(--success); }
        
        .obj-group { 
            border: 2px solid #ccc; padding: 5px; border-radius: 8px; margin: 5px; 
            background: white; transition: 0.5s; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); 
        }
        .dot { width: 16px; height: 16px; background-color: var(--danger); border-radius: 50%; display: inline-block; margin: 2px; }

        .problem-text { font-size: 1.4rem; line-height: 1.5; margin-bottom: 10px; font-weight: bold; color: #2c3e50; text-align: left; padding: 0 5px;}
        .hint-box { 
            background: #eafaf1; color: #27ae60; padding: 15px; border-radius: 8px; 
            margin-bottom: 10px; font-size: 1.1rem; display: none; border-left: 6px solid #27ae60;
            font-weight: bold; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- åˆ—è¡¨èˆ‡ç·¨è¼¯å™¨ --- */
        .pool-item { 
            padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .editor-layout { display: flex; gap: 20px; flex-wrap: wrap; }
        .editor-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; }
        .editor-box { background:#f8f9fa; padding:15px; border:1px solid #ddd; border-radius:8px; display: flex; flex-direction: column; height: 100%; }
        .editor-input { padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
        .editor-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .pool-scroll-area { flex: 1; overflow-y: auto; margin-top: 10px; max-height: 400px; min-height: 300px; background: white; border: 1px solid #eee; border-radius: 4px; padding: 5px; }

        .setting-switch { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #eee; }
        .setting-switch input[type="checkbox"] { transform: scale(1.5); margin-left: 10px; cursor: pointer; }
        
        .user-panel {
            background: #fff3cd; border: 2px solid #f39c12; border-radius: 50px;
            padding: 5px 20px; margin-bottom: 15px; font-weight: bold; color: #d35400;
            display: flex; gap: 15px; align-items: center; cursor: pointer;
        }
        .op-tag { color:white; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:5px; font-weight: bold; }
        .gem-badge { background: #f1c40f; color: #7f6000; font-weight: bold; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; margin-left: 5px; }

        /* --- æ¨¡å¼é¸æ“‡ --- */
        .mode-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; text-align: center; cursor: pointer; transition: 0.3s; }
        .mode-btn.selected { border-color: var(--primary); background: #ebf5fb; box-shadow: 0 0 10px rgba(41, 128, 185, 0.2); }
        .mode-btn h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .mode-btn p { margin: 0; font-size: 0.85rem; color: #666; }

        /* --- å•†åº—æ¨£å¼ --- */
        .shop-balance {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: white; padding: 25px; border-radius: 15px; text-align: center;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
        .exchange-form { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px;}
        .shop-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }
        
        /* --- ç²’å­ç‰¹æ•ˆ --- */
        #particle-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden; display: none;
        }
        .particle { position: absolute; font-size: 1.5rem; animation: fall linear forwards; }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>ğŸ§® å››å‰‡é‹ç®—è§€å¿µç·´ç¿’</h1>
        
        <div style="display:flex; justify-content:center;">
            <div class="user-panel" onclick="editUser()">
                <span>ğŸ“ <span id="u-name">å­¸å“¡</span></span>
                <span>ğŸ’ <span id="u-gems">0</span></span>
            </div>
        </div>

        <button class="btn-accent btn-block" style="margin-bottom:15px; box-shadow:0 4px #8e44ad;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>

        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 5px;">ğŸ“š ç·´ç¿’æ¸¬é©—å·åˆ—è¡¨</h3>
        <div id="quiz-list" style="flex:1; overflow-y:auto; margin-bottom:10px; min-height: 200px;"></div>
        
        <div style="margin-top:auto; border-top: 1px dashed #ccc; padding-top: 15px;">
            <button class="btn-primary btn-block" onclick="createQuiz()">âœï¸ å»ºç«‹æ–°æ¸¬é©—å·</button>
            
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button class="btn-info" style="flex:1;" onclick="document.getElementById('import-pool').click()">ğŸ“¥ åŒ¯å…¥é¡Œç›®</button>
                <input type="file" id="import-pool" style="display:none" accept=".json" onchange="handlePoolImport(this)">
            </div>
            
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button class="btn-gray" style="flex:1;" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
                <button class="btn-gray" style="flex:1;" onclick="document.getElementById('import-data').click()">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
                <input type="file" id="import-data" style="display:none" accept=".json" onchange="handleDataImport(this)">
            </div>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:10px;">v5.2 æ™ºæ…§åŒ¯å…¥ç‰ˆ</div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        
        <div class="shop-balance">
            <h3 style="margin:0; opacity:0.9;">ç›®å‰æŒæœ‰å¯¶çŸ³</h3>
            <div style="font-size:3.5rem; font-weight:bold; margin-top:5px;">ğŸ’ <span id="shop-gems">0</span></div>
        </div>

        <div class="exchange-form">
            <h4 style="margin-top:0;">ğŸ“ æˆ‘è¦å…Œæ›...</h4>
            <input type="text" id="gift-name" class="shop-input" placeholder="è¼¸å…¥çå“ (å¦‚: çœ‹é›»è¦–10åˆ†é˜)">
            <input type="number" id="gift-cost" class="shop-input" placeholder="èŠ±è²»å¯¶çŸ³æ•¸é‡" min="1">
            <button class="btn-success btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>

        <div style="flex:1; overflow-y:auto; border-top:1px solid #eee; padding-top:10px;">
            <h4 style="margin:0 0 10px 0;">ğŸ“œ å…Œæ›ç´€éŒ„</h4>
            <div id="exchange-log" style="font-size:0.9rem; color:#666;"></div>
        </div>

        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-setting" class="container">
        <h2>ğŸ“ æº–å‚™é–‹å§‹</h2>
        <div class="problem-text" id="setting-title" style="font-size:1.1rem; color:#555;"></div>
        
        <div id="setting-reward-info" style="text-align:center; font-weight:bold; font-size:1.1rem; color:#d35400; background:#fff3cd; padding:8px; border-radius:8px; margin-bottom:10px; border:1px solid #f39c12;"></div>
        
        <div style="padding: 10px; border-radius: 8px; margin: 5px 0;">
            <h4 style="margin:5px 0 10px 0; color:var(--primary);">1. é¸æ“‡æ¨¡å¼</h4>
            <div class="mode-selector">
                <div class="mode-btn selected" id="btn-mode-teach" onclick="selectMode('teaching')">
                    <h4 style="color:var(--mode-teach);">ğŸ“– æ•™å­¸æ¨¡å¼</h4>
                    <p>ç„¡é™å˜—è©¦ã€æœ‰æç¤º</p>
                </div>
                <div class="mode-btn" id="btn-mode-test" onclick="selectMode('testing')">
                    <h4 style="color:var(--mode-test);">ğŸ”¥ æ¸¬é©—æ¨¡å¼</h4>
                    <p>ä¸€é¡Œå®šç”Ÿæ­»ã€ç„¡æç¤º</p>
                </div>
            </div>

            <div id="setting-options-area">
                <h4 style="margin:5px 0 10px 0; color:var(--primary);">2. è¼”åŠ©åŠŸèƒ½ (åƒ…æ•™å­¸æ¨¡å¼)</h4>
                <label class="setting-switch">
                    <span>ğŸ”Š èªéŸ³æç¤º (æœ—è®€é¡Œç›®)</span>
                    <input type="checkbox" id="opt-voice" checked>
                </label>
                <label class="setting-switch">
                    <span>ğŸ“ æ–‡å­—èˆ‡åœ–è§£æç¤º</span>
                    <input type="checkbox" id="opt-visual" checked>
                </label>
            </div>

            <h4 style="margin:15px 0 10px 0; color:var(--primary);">3. é¡Œç›®ç¯„åœ</h4>
            <select id="filter-op" class="editor-input" style="width:100%;">
                <option value="all">å…¨éƒ¨æ··åˆ (All)</option>
                <option value="add">åªç·´ åŠ æ³• (+)</option>
                <option value="sub">åªç·´ æ¸›æ³• (-)</option>
                <option value="mul">åªç·´ ä¹˜æ³• (Ã—)</option>
                <option value="div">åªç·´ é™¤æ³• (Ã·)</option>
            </select>
        </div>

        <button class="btn-success btn-block" onclick="startQuiz()">ğŸš€ é–‹å§‹</button>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="page-quiz" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span id="quiz-mode-badge" style="font-weight:bold; color:white; padding:4px 10px; border-radius:10px; font-size:0.9rem;">æ•™å­¸æ¨¡å¼</span>
            <span id="q-progress" style="font-weight:bold; color:#7f8c8d; background:#f0f2f5; padding:4px 10px; border-radius:10px;">1 / 10</span>
            <span id="q-timer" style="font-family:monospace; font-size:1.2rem;">00:00</span>
        </div>
        
        <div style="text-align:right;">
             <button id="btn-help" class="btn-warning" style="font-size:0.9rem; padding:4px 10px; margin-bottom:5px;" onclick="useHelp()">ğŸ’¡ æ±‚åŠ©</button>
        </div>

        <div id="quiz-content" style="flex:1;">
            <div id="q-text" class="problem-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            
            <div id="q-hint-container">
                <div id="q-hint" class="hint-box"></div>
                <div id="anim-stage" class="concept-stage">
                    <div id="anim-content" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;"></div>
                </div>
            </div>

            <div style="text-align:center; margin:15px 0 5px 0; font-size:1rem; color:#666;">è«‹é»æ“Šæ­£ç¢ºçš„é‹ç®—ç¬¦è™Ÿï¼š</div>
            <div class="operator-grid">
                <div class="op-card op-add" onclick="checkAnswer('add')"><span>+</span><div>åŠ æ³•</div></div>
                <div class="op-card op-sub" onclick="checkAnswer('sub')"><span>-</span><div>æ¸›æ³•</div></div>
                <div class="op-card op-mul" onclick="checkAnswer('mul')"><span>Ã—</span><div>ä¹˜æ³•</div></div>
                <div class="op-card op-div" onclick="checkAnswer('div')"><span>Ã·</span><div>é™¤æ³•</div></div>
            </div>
        </div>

        <div id="feedback-msg" style="text-align:center; font-weight:bold; height:30px; margin-top:10px; font-size:1.2rem;"></div>

        <button id="btn-next" class="btn-success btn-block" style="display:none; margin-top:15px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡</button>
        <button class="btn-danger" style="margin-top:20px; width:100%; background:white; color:var(--danger); border:1px solid var(--danger);" onclick="quitQuiz()">ä¸­é€”çµæŸ</button>
    </div>

    <div id="page-editor" class="container" style="max-width: 1000px;">
        <h2>âœï¸ ç·¨è¼¯æ¸¬é©—å·</h2>
        
        <div style="background:#eee; padding:10px; border-radius:6px; margin-bottom:10px;">
            <div style="margin-bottom:5px; font-weight:bold;">æ¸¬é©—å·åç¨±ï¼š</div>
            <input type="text" id="edit-list-name" placeholder="è«‹è¼¸å…¥åç¨±" class="editor-input" style="width:100%; font-weight:bold; margin-bottom:10px;">
            
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div style="flex:1; min-width:140px; display:flex; align-items:center; background:white; padding:5px 10px; border-radius:4px; border:1px solid #ddd;">
                    <span style="color:var(--mode-teach); font-weight:bold;">ğŸ“– æ•™å­¸çå‹µ ğŸ’:</span>
                    <input type="number" id="edit-gems-teach" class="editor-input" style="width:70px; margin-left:5px; padding:2px;" value="10">
                </div>
                <div style="flex:1; min-width:140px; display:flex; align-items:center; background:white; padding:5px 10px; border-radius:4px; border:1px solid #ddd;">
                    <span style="color:var(--mode-test); font-weight:bold;">ğŸ”¥ æ¸¬é©—çå‹µ ğŸ’:</span>
                    <input type="number" id="edit-gems-test" class="editor-input" style="width:70px; margin-left:5px; padding:2px;" value="20">
                </div>
            </div>
        </div>

        <div class="editor-layout">
            <div class="editor-col">
                <div class="editor-box">
                    <h4 style="margin:0 0 10px 0; color:var(--dark);">ğŸ“‹ æœ¬å·é¡Œç›® (<span id="curr-count">0</span>)</h4>
                    <div style="background:#fff; border:1px solid #ddd; padding:10px; border-radius:4px; margin-bottom:10px;">
                        <h5 style="margin:0 0 5px 0;">âœï¸ æ‰‹å‹•æ–°å¢</h5>
                        <textarea id="ed-text" class="editor-input" style="width:100%; height:50px; margin-bottom:5px;" placeholder="é¡Œç›®..."></textarea>
                        <input type="text" id="ed-hint" class="editor-input" style="width:100%; margin-bottom:5px;" placeholder="æç¤º..."></textarea>
                        <div class="editor-row" style="margin-bottom:5px;">
                            <select id="ed-op" class="editor-input" style="flex:1;">
                                <option value="add">åŠ  (+)</option>
                                <option value="sub">æ¸› (-)</option>
                                <option value="mul">ä¹˜ (Ã—)</option>
                                <option value="div">é™¤ (Ã·)</option>
                            </select>
                            <input type="number" id="ed-n1" class="editor-input" style="width:60px;" placeholder="A">
                            <input type="number" id="ed-n2" class="editor-input" style="width:60px;" placeholder="B">
                        </div>
                        <button class="btn-primary" style="width:100%; padding:5px;" onclick="addManualQ()">â• åŠ å…¥æœ¬å·</button>
                    </div>
                    <div id="quiz-q-list" class="pool-scroll-area"></div>
                </div>
            </div>

            <div class="editor-col">
                <div class="editor-box" style="background: #fff8e1; border-color: #f39c12;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0; color:#d35400;">ğŸ“š ç¸½é¡Œåº«ä¾†æº (<span id="pool-count">0</span>)</h4>
                        <button class="btn-danger" style="font-size:0.8rem; padding:3px 8px;" onclick="clearMasterPool()">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.6); padding:8px; border-radius:6px; margin-top:10px; border:1px solid #ddd;">
                        <h5 style="margin:0 0 5px 0; color:#555;">ğŸ² æ‰¹æ¬¡éš¨æ©ŸåŒ¯å…¥ (è‡ªå‹•å»é‡)</h5>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="batch-type" class="editor-input" style="flex:1;">
                                <option value="all">æ··åˆéš¨æ©Ÿ</option>
                                <option value="add">åªå– åŠ æ³•</option>
                                <option value="sub">åªå– æ¸›æ³•</option>
                                <option value="mul">åªå– ä¹˜æ³•</option>
                                <option value="div">åªå– é™¤æ³•</option>
                            </select>
                            <input type="number" id="batch-count" class="editor-input" style="width:80px;" placeholder="æ•¸é‡" min="1" value="5">
                        </div>
                        <button class="btn-info" style="width:100%; font-size:0.9rem; padding:5px;" onclick="batchImportFromPool()">ğŸ“¥ éš¨æ©ŸåŠ å…¥</button>
                    </div>
                    
                    <div style="margin-top:10px;">
                        ç¯©é¸åˆ—è¡¨ï¼š
                        <select id="pool-filter" class="editor-input" onchange="renderPoolSource()">
                            <option value="all">å…¨éƒ¨é¡¯ç¤º</option>
                            <option value="add">åªé¡¯ç¤º åŠ æ³•</option>
                            <option value="sub">åªé¡¯ç¤º æ¸›æ³•</option>
                            <option value="mul">åªé¡¯ç¤º ä¹˜æ³•</option>
                            <option value="div">åªé¡¯ç¤º é™¤æ³•</option>
                        </select>
                    </div>
                    <div id="master-pool-list" class="pool-scroll-area"></div>
                </div>
            </div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-success" style="flex:1" onclick="saveList()">ğŸ’¾ å„²å­˜æ¸¬é©—å·</button>
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let user = { name: "å°å°å­¸å“¡", gems: 0 };
        let masterPool = []; // ç¸½é¡Œåº«
        let allLists = [];   // æ¸¬é©—å·åˆ—è¡¨
        let exchangeLog = []; // å…Œæ›ç´€éŒ„
        let currentList = null;
        let selectedMode = 'teaching'; // 'teaching' or 'testing'
        let quizState = { questions: [], idx: 0, correct: 0, timer: 0, interval: null, settings: {}, mode: 'teaching' };

        // ç·¨è¼¯å™¨æš«å­˜
        let editingListId = null;
        let tempQuizQs = []; 

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadData();
            renderHome();
        };

        function loadData() {
            const dLists = localStorage.getItem('fo_lists_v52'); // å‡ç´škey
            if(dLists) {
                allLists = JSON.parse(dLists);
                allLists.forEach(l => {
                    if(!l.gemsTeach) l.gemsTeach = 10;
                    if(!l.gemsTest) l.gemsTest = l.gems || 20; 
                });
            } else {
                // é è¨­ç¯„ä¾‹
                const demoList = {
                    id: 1, name: "å…¥é–€æ··åˆç·´ç¿’", gemsTeach: 10, gemsTest: 20,
                    qs: [
                        { text: "ä¸€ç½é£²æ–™12å…ƒï¼Œè²·5ç½è¦å¤šå°‘éŒ¢ï¼Ÿ", hint: "é‡è¤‡åŠ 5æ¬¡", op: "mul", n1: 12, n2: 5 },
                        { text: "æœ‰8å¡Šé¤…ä¹¾ï¼Œå¹³å‡åˆ†çµ¦2å€‹å°æœ‹å‹ï¼Œæ¯äººæ‹¿å¹¾å¡Šï¼Ÿ", hint: "å¹³åˆ†", op: "div", n1: 8, n2: 2 },
                        { text: "å°æ˜æœ‰50å…ƒï¼Œè²·ç­†èŠ±äº†20å…ƒï¼Œé‚„å‰©å¤šå°‘ï¼Ÿ", hint: "æ‹¿èµ°/è®Šå°‘", op: "sub", n1: 50, n2: 20 },
                        { text: "ç›¤å­è£¡æœ‰3é¡†è˜‹æœï¼Œåª½åª½åˆæ”¾äº†2é¡†ï¼Œç¾åœ¨æœ‰å¹¾é¡†ï¼Ÿ", hint: "åˆä½µ/è®Šå¤š", op: "add", n1: 3, n2: 2 }
                    ]
                };
                allLists = [demoList];
            }
            
            const dPool = localStorage.getItem('fo_master_pool');
            if(dPool) masterPool = JSON.parse(dPool);

            const dUser = localStorage.getItem('fo_user');
            if(dUser) user = JSON.parse(dUser);
            
            const dLog = localStorage.getItem('fo_exchange_log');
            if(dLog) exchangeLog = JSON.parse(dLog);

            updateUserUI();
        }

        function saveData() {
            localStorage.setItem('fo_lists_v52', JSON.stringify(allLists));
            localStorage.setItem('fo_master_pool', JSON.stringify(masterPool));
            localStorage.setItem('fo_user', JSON.stringify(user));
            localStorage.setItem('fo_exchange_log', JSON.stringify(exchangeLog));
        }

        // --- èªéŸ³ ---
        function speak(text) {
            if(!quizState.settings.voice) return;
            if(quizState.mode === 'testing' && text.length > 10) return; 

            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        // --- å°èˆª ---
        function showPage(pid) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            if(pid === 'page-home') renderHome();
            if(pid === 'page-shop') renderShop();
        }

        function updateUserUI() {
            document.getElementById('u-name').innerText = user.name;
            document.querySelectorAll('#u-gems, #shop-gems').forEach(el => el.innerText = user.gems);
        }
        function editUser() {
            const n = prompt("è¼¸å…¥ä½ çš„åå­—", user.name);
            if(n) { user.name = n; saveData(); updateUserUI(); }
        }

        // --- å•†åº—é‚è¼¯ ---
        function renderShop() {
            updateUserUI();
            const logDiv = document.getElementById('exchange-log');
            logDiv.innerHTML = '';
            if(exchangeLog.length === 0) logDiv.innerHTML = '<div style="padding:10px; text-align:center;">æš«ç„¡ç´€éŒ„</div>';
            
            exchangeLog.forEach(log => {
                const d = document.createElement('div');
                d.style.borderBottom = '1px solid #eee'; d.style.padding = '8px';
                d.innerHTML = `<b>${log.item}</b> <span style="color:#d35400;">-${log.cost}ğŸ’</span> <span style="color:#999; font-size:0.8rem; float:right;">${log.date}</span>`;
                logDiv.appendChild(d);
            });
        }

        function processExchange() {
            const name = document.getElementById('gift-name').value.trim();
            const cost = parseInt(document.getElementById('gift-cost').value);
            
            if(!name || isNaN(cost) || cost <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„çå“åç¨±èˆ‡æ•¸é‡");
            if(user.gems < cost) return alert("å¯¶çŸ³ä¸è¶³ï¼å†å¤šç·´ç¿’å¹¾é¡Œå§ï¼");

            if(confirm(`ç¢ºå®šèŠ±è²» ${cost} å¯¶çŸ³å…Œæ›ã€Œ${name}ã€å—ï¼Ÿ`)) {
                user.gems -= cost;
                exchangeLog.unshift({ item: name, cost: cost, date: new Date().toLocaleDateString() });
                saveData();
                renderShop();
                document.getElementById('gift-name').value = '';
                document.getElementById('gift-cost').value = '';
                spawnParticles('ğŸ’'); 
            }
        }

        function spawnParticles(char) {
            const con = document.getElementById('particle-container');
            con.style.display = 'block'; con.innerHTML = '';
            for(let i=0; i<30; i++) {
                let p = document.createElement('div'); p.className='particle'; p.innerText = char;
                p.style.left = Math.random()*100+'vw';
                p.style.animationDuration = (Math.random()*2+1)+'s';
                con.appendChild(p);
            }
            setTimeout(() => { con.style.display='none'; }, 3000);
        }

        // --- é¦–é é‚è¼¯ ---
        function renderHome() {
            updateUserUI();
            const listDiv = document.getElementById('quiz-list');
            listDiv.innerHTML = '';
            if(allLists.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">å°šæœªå»ºç«‹æ¸¬é©—å·ï¼Œè«‹é»æ“Šã€Œå»ºç«‹æ–°æ¸¬é©—å·ã€ã€‚</div>';
                return;
            }
            allLists.forEach((list, idx) => {
                const div = document.createElement('div');
                div.className = 'pool-item';
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:1.1rem;">
                            ${list.name} <span class="gem-badge" style="background:#ddd; color:#555;">${list.qs.length}é¡Œ</span>
                        </div> 
                        <div style="font-size:0.9rem; margin-top:5px;">
                            <span style="color:var(--mode-teach);">ğŸ“–${list.gemsTeach||10}</span> 
                            <span style="color:#ccc;">|</span> 
                            <span style="color:var(--mode-test);">ğŸ”¥${list.gemsTest||20}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-success" style="padding:8px 15px;" onclick="prepareQuiz(${idx})">â–¶ é–‹å§‹</button>
                        <button class="btn-outline" onclick="editList(${idx})">âš™ï¸</button>
                        <button class="btn-danger" onclick="delList(${idx})">Ã—</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        // --- æ¸¬é©—æµç¨‹ ---
        function prepareQuiz(idx) {
            currentList = allLists[idx];
            document.getElementById('setting-title').innerText = `ç›®å‰é¸æ“‡ï¼š${currentList.name}`;
            selectMode('teaching');
            showPage('page-setting');
        }

        function selectMode(mode) {
            selectedMode = mode;
            document.getElementById('btn-mode-teach').classList.remove('selected');
            document.getElementById('btn-mode-test').classList.remove('selected');
            const infoBox = document.getElementById('setting-reward-info');
            
            if(mode === 'teaching') {
                document.getElementById('btn-mode-teach').classList.add('selected');
                document.getElementById('setting-options-area').style.display = 'block';
                infoBox.innerText = `ğŸ“– æ•™å­¸ç›®æ¨™ï¼šå®Œæˆç·´ç¿’å³å¯ç²å¾— ${currentList.gemsTeach || 10} ğŸ’`;
            } else {
                document.getElementById('btn-mode-test').classList.add('selected');
                document.getElementById('setting-options-area').style.display = 'none';
                infoBox.innerText = `ğŸ”¥ æ¸¬é©—æŒ‘æˆ°ï¼šæ»¿åˆ†å¯ç²å¾— ${currentList.gemsTest || 20} ğŸ’`;
            }
        }

        function startQuiz() {
            const filter = document.getElementById('filter-op').value;
            let qPool = currentList.qs;
            if(filter !== 'all') qPool = qPool.filter(q => q.op === filter);

            if(qPool.length === 0) return alert("æ­¤åˆ†é¡ç„¡é¡Œç›®ï¼");

            quizState = {
                questions: qPool.sort(() => Math.random() - 0.5),
                idx: 0, correct: 0, timer: 0,
                mode: selectedMode,
                settings: {
                    voice: document.getElementById('opt-voice').checked,
                    visual: document.getElementById('opt-visual').checked
                },
                interval: setInterval(() => {
                    quizState.timer++;
                    let m = Math.floor(quizState.timer/60).toString().padStart(2,'0');
                    let s = (quizState.timer%60).toString().padStart(2,'0');
                    document.getElementById('q-timer').innerText = `${m}:${s}`;
                }, 1000)
            };

            const badge = document.getElementById('quiz-mode-badge');
            if(selectedMode === 'teaching') {
                badge.innerText = "ğŸ“– æ•™å­¸æ¨¡å¼";
                badge.style.background = "var(--mode-teach)";
                document.getElementById('btn-help').style.display = 'block';
            } else {
                badge.innerText = "ğŸ”¥ æ¸¬é©—æ¨¡å¼";
                badge.style.background = "var(--mode-test)";
                document.getElementById('btn-help').style.display = 'none';
                quizState.settings.voice = true; 
                quizState.settings.visual = false; 
            }

            showPage('page-quiz');
            renderQuestion();
        }

        function renderQuestion() {
            const q = quizState.questions[quizState.idx];
            document.getElementById('q-progress').innerText = `${quizState.idx + 1} / ${quizState.questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            
            document.getElementById('q-hint').style.display = 'none';
            document.getElementById('anim-stage').style.display = 'none';
            document.getElementById('q-hint').innerText = q.hint || "ç„¡æç¤º";
            
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('btn-next').style.display = 'none';
            
            document.querySelectorAll('.op-card').forEach(c => {
                c.style.opacity = '1'; c.style.pointerEvents = 'auto'; c.style.border = '2px solid #eee';
                c.style.background = "white"; 
                c.style.boxShadow = "0 4px 0 #ddd";
            });

            if(quizState.mode === 'teaching' && quizState.settings.voice) speak(q.text);
        }

        function useHelp() {
            if(quizState.mode === 'testing') return; 
            const q = quizState.questions[quizState.idx];
            if(quizState.settings.visual) playAnimation(q);
            if(quizState.settings.voice) speak(q.hint || "é€™é¡Œæ²’æœ‰æç¤ºå–”");
        }

        function checkAnswer(op) {
            const q = quizState.questions[quizState.idx];
            const isCorrect = (op === q.op);

            if(quizState.mode === 'testing' || isCorrect) {
                document.querySelectorAll('.op-card').forEach(c => c.style.pointerEvents = 'none');
            }

            if(isCorrect) {
                document.getElementById('feedback-msg').innerText = "ğŸ‰ ç­”å°äº†ï¼";
                document.getElementById('feedback-msg').style.color = "var(--success)";
                speak("ç­”å°äº†");
                quizState.correct++;
                spawnParticles('â­'); 
                document.querySelector(`.op-${op}`).style.border = "4px solid var(--success)";
                document.querySelector(`.op-${op}`).style.background = "#eafaf1";
                document.querySelectorAll('.op-card').forEach(c => { if(!c.classList.contains(`op-${op}`)) c.style.opacity = '0.3'; });
                
                if(quizState.mode === 'teaching' && quizState.settings.visual && document.getElementById('anim-stage').style.display === 'none') {
                    playAnimation(q);
                }
                document.getElementById('btn-next').style.display = 'block';

            } else {
                document.getElementById('feedback-msg').innerText = "âŒ ä¸å°å–”...";
                document.getElementById('feedback-msg').style.color = "var(--danger)";
                speak("ä¸å°å–”");

                if(quizState.mode === 'testing') {
                    document.querySelector(`.op-${op}`).style.background = "#ffebee";
                    document.querySelector(`.op-${op}`).style.borderColor = "var(--danger)";
                    document.querySelector(`.op-${q.op}`).style.border = "4px solid var(--success)";
                    document.querySelector(`.op-${q.op}`).style.boxShadow = "0 0 10px var(--success)";
                    document.getElementById('feedback-msg').innerText += " (ç­”æ¡ˆæ˜¯ " + getOpName(q.op) + ")";
                    document.getElementById('btn-next').style.display = 'block';
                } else {
                    document.querySelector(`.op-${op}`).style.opacity = '0.5';
                    document.querySelector(`.op-${op}`).style.pointerEvents = 'none';
                }
            }
        }
        
        function getOpName(op) {
            const names = {'add':'åŠ æ³•','sub':'æ¸›æ³•','mul':'ä¹˜æ³•','div':'é™¤æ³•'};
            return names[op];
        }

        function nextQuestion() {
            quizState.idx++;
            if(quizState.idx >= quizState.questions.length) endQuiz();
            else renderQuestion();
        }

        function endQuiz() {
            clearInterval(quizState.interval);
            let score = Math.round((quizState.correct / quizState.questions.length) * 100);
            
            let rewardGems = 0;
            let msg = "";

            if (quizState.mode === 'teaching') {
                rewardGems = currentList.gemsTeach || 10;
                msg = `ç·´ç¿’å®Œæˆï¼ç²å¾— ${rewardGems} ğŸ’ (æ•™å­¸çå‹µ)`;
            } else {
                let maxReward = currentList.gemsTest || 20;
                if (score === 100) {
                    rewardGems = maxReward;
                    msg = `å¤ªæ£’äº†ï¼æ»¿åˆ†ï¼ç²å¾— ${rewardGems} ğŸ’`;
                } else if (score >= 60) {
                    rewardGems = Math.floor(maxReward / 2) || 1;
                    msg = `é€šéæ¸¬é©—ï¼ç²å¾— ${rewardGems} ğŸ’`;
                } else {
                    rewardGems = 1;
                    msg = `ä¸åŠæ ¼...ç²å¾— 1 ğŸ’ å®‰æ…°çï¼Œå†æ¥å†å²ï¼`;
                }
            }

            user.gems += rewardGems; 
            saveData();
            speak(`çµæŸï¼Œå¾—åˆ†${score}`);
            setTimeout(() => { 
                alert(`æ¨¡å¼ï¼š${quizState.mode === 'teaching' ? 'æ•™å­¸' : 'æ¸¬é©—'}\nå¾—åˆ†ï¼š${score}\n\n${msg}`); 
                showPage('page-home'); 
            }, 500);
        }

        function quitQuiz() {
            if(confirm("ç¢ºå®šçµæŸï¼Ÿ")) { clearInterval(quizState.interval); window.speechSynthesis.cancel(); showPage('page-home'); }
        }

        // --- è§€å¿µå‹•ç•« ---
        function playAnimation(q) {
            const stage = document.getElementById('anim-stage');
            const content = document.getElementById('anim-content');
            const hintBox = document.getElementById('q-hint');
            stage.style.display = 'block'; content.innerHTML = ''; hintBox.style.display = 'block';
            let n1 = parseFloat(q.n1)||10, n2 = parseFloat(q.n2)||2;

            if(q.op === 'mul') {
                hintBox.innerText = `${n1} çš„ ${n2} å€ (ç´¯åŠ )`;
                let count = n2 > 8 ? 8 : n2; 
                content.style.flexDirection = 'column';
                for(let i=0; i<count; i++) {
                    let g = document.createElement('div'); g.className='obj-group';
                    let dotCount = n1 > 10 ? 5 : n1;
                    for(let j=0; j<dotCount; j++) { let d=document.createElement('span'); d.className='dot'; g.appendChild(d); }
                    if(n1 > 10) g.innerHTML += `<span style="font-size:0.8rem; margin-left:5px;">...å…±${n1}</span>`;
                    g.style.opacity='0'; content.appendChild(g);
                    setTimeout(()=>g.style.opacity='1', i*200);
                }
            } else if(q.op === 'div') {
                let groupCount = Math.floor(n1 / n2);
                hintBox.innerText = `ç¸½æ•¸ ${n1}ï¼Œæ¯ ${n2} å€‹è£ä¸€çµ„...`;
                content.style.flexDirection = 'row'; content.style.flexWrap = 'wrap'; content.style.justifyContent = 'center';
                let displayCount = groupCount > 12 ? 12 : groupCount; 
                for(let i=0; i < displayCount; i++) {
                    let box = document.createElement('div'); box.className='obj-group'; 
                    box.style.display = 'flex'; box.style.flexWrap = 'wrap'; box.style.width = '60px'; box.style.justifyContent = 'center';
                    box.style.margin = '5px'; box.style.position = 'relative';
                    if(n2 <= 9) {
                        for(let j=0; j<n2; j++) {
                            let d=document.createElement('span'); d.className='dot'; d.style.width='10px'; d.style.height='10px'; d.style.background='#e74c3c'; box.appendChild(d); 
                        }
                    } else box.innerHTML = `<span style="font-size:1.2rem; font-weight:bold; color:#e74c3c;">${n2}</span>`;
                    let label = document.createElement('div'); label.style.width='100%'; label.style.textAlign='center'; label.style.fontSize='0.7rem'; label.style.color='#777';
                    label.innerText = (i+1); box.appendChild(label);
                    box.style.opacity='0'; box.style.transform='scale(0.5)'; box.style.transition='all 0.3s';
                    content.appendChild(box);
                    setTimeout(() => { box.style.opacity='1'; box.style.transform='scale(1)'; }, i * 300);
                }
                if(groupCount > displayCount) {
                    let more = document.createElement('div'); more.style.alignSelf = 'center'; more.innerText = `...å…± ${groupCount} çµ„`;
                    content.appendChild(more);
                } else {
                    setTimeout(() => { hintBox.innerText = `${n1} æ¯ ${n2} å€‹ä¸€ä»½ï¼Œå…± ${groupCount} ä»½`; }, displayCount * 300);
                }
            } else if(q.op === 'add') {
                hintBox.innerText = `å°‡ ${n1} å’Œ ${n2} åˆä½µåœ¨ä¸€èµ·`;
                content.innerHTML = `<div class="bar-container" style="justify-content:center;"><div class="bar bar-a" style="width:0%;">${n1}</div><div class="bar bar-b" style="width:0%;margin-left:5px;">${n2}</div></div>`;
                let sum = n1+n2;
                setTimeout(()=>{content.querySelector('.bar-a').style.width=(n1/sum*90)+'%'; content.querySelector('.bar-b').style.width=(n2/sum*90)+'%';},100);
            } else if(q.op === 'sub') {
                hintBox.innerText = `æ¯”è¼ƒ ${n1} å’Œ ${n2} çš„å·®è· / æ‹¿èµ°`;
                content.style.flexDirection = 'column';
                let max = Math.max(n1, n2);
                content.innerHTML = `<div class="bar-container"><div class="bar bar-a" style="width:10px">${n1}</div></div><div class="bar-container"><div class="bar bar-b" style="width:10px;opacity:0.6;">${n2}</div></div>`;
                setTimeout(()=>{content.children[0].children[0].style.width=(n1/max*80)+'%'; content.children[1].children[0].style.width=(n2/max*80)+'%';},100);
            }
        }

        // --- ç·¨è¼¯å™¨ ---
        function createQuiz() {
            editingListId = null; tempQuizQs = [];
            document.getElementById('edit-list-name').value = "";
            document.getElementById('edit-gems-teach').value = 10; 
            document.getElementById('edit-gems-test').value = 20;  
            showPage('page-editor'); renderQuizQs(); renderPoolSource();
        }
        function editList(idx) {
            editingListId = idx; const l = allLists[idx];
            document.getElementById('edit-list-name').value = l.name;
            document.getElementById('edit-gems-teach').value = l.gemsTeach || 10;
            document.getElementById('edit-gems-test').value = l.gemsTest || l.gems || 20;
            tempQuizQs = JSON.parse(JSON.stringify(l.qs));
            showPage('page-editor'); renderQuizQs(); renderPoolSource();
        }
        function delList(idx) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ¸¬é©—å·ï¼Ÿ")) { allLists.splice(idx, 1); saveData(); renderHome(); } }

        function renderQuizQs() {
            const container = document.getElementById('quiz-q-list'); container.innerHTML = '';
            document.getElementById('curr-count').innerText = tempQuizQs.length;
            const opColors = { 'add': 'var(--op-add)', 'sub': 'var(--op-sub)', 'mul': 'var(--op-mul)', 'div': 'var(--op-div)' };
            const opNames = { 'add': '+', 'sub': '-', 'mul': 'Ã—', 'div': 'Ã·' };
            tempQuizQs.forEach((q, i) => {
                const d = document.createElement('div'); d.className = 'pool-item'; d.style.padding='8px';
                d.innerHTML = `<div style="flex:1; font-size:0.9rem;"><span class="op-tag" style="background:${opColors[q.op]}">${opNames[q.op]}</span>${q.text.substring(0, 15)}...</div><button class="btn-danger" style="font-size:0.8rem; padding:2px 6px;" onclick="removeQuizQ(${i})">ç§»é™¤</button>`;
                container.appendChild(d);
            });
        }
        function removeQuizQ(i) { tempQuizQs.splice(i, 1); renderQuizQs(); }

        function renderPoolSource() {
            const container = document.getElementById('master-pool-list'); container.innerHTML = '';
            const filter = document.getElementById('pool-filter').value;
            let displayPool = masterPool;
            if(filter !== 'all') displayPool = masterPool.filter(q => q.op === filter);
            document.getElementById('pool-count').innerText = masterPool.length;
            const opColors = { 'add': 'var(--op-add)', 'sub': 'var(--op-sub)', 'mul': 'var(--op-mul)', 'div': 'var(--op-div)' };
            const opNames = { 'add': '+', 'sub': '-', 'mul': 'Ã—', 'div': 'Ã·' };
            displayPool.forEach((q) => {
                const d = document.createElement('div'); d.className = 'pool-item'; d.style.padding='8px';
                d.innerHTML = `<div style="flex:1; font-size:0.9rem;"><span class="op-tag" style="background:${opColors[q.op]}">${opNames[q.op]}</span>${q.text}</div><button class="btn-warning" style="font-size:0.8rem; padding:4px 8px; color:#7f6000;" onclick='addToQuizFromPool(${JSON.stringify(q)})'>â•</button>`;
                container.appendChild(d);
            });
        }
        function addToQuizFromPool(q) { tempQuizQs.push(q); renderQuizQs(); }

        // --- æ–°å¢: æ‰¹æ¬¡éš¨æ©ŸåŒ¯å…¥é‚è¼¯ (v5.2) ---
        function batchImportFromPool() {
            const type = document.getElementById('batch-type').value;
            const count = parseInt(document.getElementById('batch-count').value);

            if(isNaN(count) || count <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸é‡ï¼");
            if(masterPool.length === 0) return alert("ç¸½é¡Œåº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆå»ºç«‹æˆ–åŒ¯å…¥é¡Œç›®ï¼");

            // 1. ç¯©é¸é¡å‹
            let candidates = masterPool.filter(q => type === 'all' || q.op === type);

            // 2. å»é™¤é‡è¤‡ (æ¯”å°ç›®å‰è©¦å·ä¸­çš„é¡Œç›®å…§å®¹)
            // å»ºç«‹ä¸€å€‹ç‰¹å¾µå­—ä¸² Set ä¾†åšæ¯”å° (å…§å®¹+æ•¸å­—)
            const currentSignatures = new Set(tempQuizQs.map(q => q.text + q.op + q.n1 + q.n2));
            candidates = candidates.filter(q => !currentSignatures.has(q.text + q.op + q.n1 + q.n2));

            if(candidates.length === 0) return alert("æ²’æœ‰ç¬¦åˆæ¢ä»¶ä¸”ä¸é‡è¤‡çš„é¡Œç›®äº†ï¼");

            // 3. æ•¸é‡æª¢æŸ¥èˆ‡è­¦ç¤º
            let importCount = count;
            if(count > candidates.length) {
                alert(`âš ï¸ ç¸½é¡Œåº«ä¸­ç¬¦åˆæ¢ä»¶ä¸”æœªé‡è¤‡çš„é¡Œç›®åªæœ‰ ${candidates.length} é¡Œï¼Œå°‡å…¨éƒ¨åŒ¯å…¥ã€‚`);
                importCount = candidates.length;
            }

            // 4. éš¨æ©Ÿæ‰“äº‚ä¸¦å–å‰ N å€‹
            candidates.sort(() => Math.random() - 0.5);
            const toAdd = candidates.slice(0, importCount);

            // 5. åŠ å…¥ä¸¦æ›´æ–°
            tempQuizQs = tempQuizQs.concat(toAdd);
            renderQuizQs();
            // ç°¡å–®å‹•ç•«æˆ–æç¤º
            alert(`å·²æˆåŠŸåŒ¯å…¥ ${importCount} é¡Œï¼`);
        }

        function addManualQ() {
            const text = document.getElementById('ed-text').value.trim(); const hint = document.getElementById('ed-hint').value.trim();
            const op = document.getElementById('ed-op').value; const n1 = document.getElementById('ed-n1').value; const n2 = document.getElementById('ed-n2').value;
            if(!text) return alert("è«‹è¼¸å…¥é¡Œç›®");
            tempQuizQs.push({ text, hint, op, n1:parseFloat(n1)||0, n2:parseFloat(n2)||0 });
            document.getElementById('ed-text').value = ''; document.getElementById('ed-hint').value = '';
            renderQuizQs();
        }

        function saveList() {
            const name = document.getElementById('edit-list-name').value.trim();
            const gemsTeach = parseInt(document.getElementById('edit-gems-teach').value) || 10;
            const gemsTest = parseInt(document.getElementById('edit-gems-test').value) || 20;
            
            if(!name || tempQuizQs.length === 0) return alert("è«‹è¼¸å…¥åç¨±ä¸¦è‡³å°‘åŠ å…¥ä¸€é¡Œ");
            
            const newList = { 
                id: Date.now(), 
                name: name, 
                qs: tempQuizQs, 
                gemsTeach: gemsTeach, 
                gemsTest: gemsTest 
            };
            
            if(editingListId !== null) allLists[editingListId] = newList; else allLists.push(newList);
            saveData(); showPage('page-home');
        }
        function clearMasterPool() { if(confirm("ç¢ºå®šæ¸…ç©ºç¸½é¡Œåº«ï¼Ÿ")) { masterPool = []; saveData(); renderPoolSource(); } }

        function exportData() {
            const data = { allLists, masterPool, user, exchangeLog };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = "math_full_backup.json"; a.click();
        }
        function handleDataImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.allLists && d.masterPool) {
                        allLists = d.allLists; masterPool = d.masterPool;
                        if(d.user) user = d.user;
                        if(d.exchangeLog) exchangeLog = d.exchangeLog;
                        saveData(); renderHome(); alert("åŒ¯å…¥æˆåŠŸï¼");
                    } else alert("æ ¼å¼ä¸ç¬¦");
                } catch(e) { alert("æª”æ¡ˆéŒ¯èª¤"); }
            }; r.readAsText(f); input.value='';
        }
        function handlePoolImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) { masterPool = masterPool.concat(json); saveData(); alert(`å·²åŒ¯å…¥ ${json.length} é¡Œï¼`); }
                    else alert("æ ¼å¼éŒ¯èª¤");
                } catch(e) { alert("JSONéŒ¯èª¤"); }
            }; r.readAsText(f); input.value='';
        }
    </script>
</body>
</html>
