<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å‰‡é‹ç®—è§€å¿µå»ºç«‹ç³»çµ±</title>
    <style>
        :root {
            --primary: #2980b9;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --op-add: #e74c3c;
            --op-sub: #8e44ad;
            --op-mul: #2980b9;
            --op-div: #16a085;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { color: var(--primary); margin: 5px 0; text-align: center; font-size: 1.6rem;}
        
        .container {
            width: 100%; max-width: 800px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px;
            display: none; flex-direction: column; 
        }
        .container.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            border: none; border-radius: 8px; padding: 10px 15px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 3px; transition: 0.2s;
        }
        button:active { transform: scale(0.96); }
        .btn-block { width: 100%; padding: 12px; margin-top: 5px; }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #555; }
        
        /* --- é‹ç®—ç¬¦è™Ÿé¸æ“‡å€ --- */
        .operator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .op-card {
            background: white; border: 2px solid #eee; border-radius: 15px;
            height: 120px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 0 #ddd;
        }
        .op-card:active { transform: translateY(4px); box-shadow: none; }
        .op-card span { font-size: 3rem; font-weight: bold; }
        .op-card div { font-size: 1rem; margin-top: 5px; }

        .op-add { color: var(--op-add); border-color: #fadbd8; background: #fdedec; }
        .op-sub { color: var(--op-sub); border-color: #ebdef0; background: #f4ecf7; }
        .op-mul { color: var(--op-mul); border-color: #d6eaf8; background: #ebf5fb; }
        .op-div { color: var(--op-div); border-color: #d0ece7; background: #e8f8f5; }

        .op-card:hover { filter: brightness(0.95); }

        /* --- å‹•ç•«æ¼”ç¤ºå€ --- */
        .concept-stage {
            background: #fff8e1; border: 2px dashed #f39c12; border-radius: 10px;
            min-height: 150px; margin: 15px 0; padding: 10px;
            position: relative; overflow: hidden;
            display: none; /* é è¨­éš±è—ï¼Œè§¸ç™¼æ™‚é¡¯ç¤º */
        }
        .concept-note {
            position: absolute; top: 5px; left: 5px; 
            font-size: 0.8rem; background: rgba(255,255,255,0.8); padding: 2px 5px; border-radius: 4px;
        }

        /* åŠ æ³•/æ¸›æ³• æ¢ç‹€åœ– */
        .bar-container { display: flex; align-items: center; margin-bottom: 10px; transition: 1s; }
        .bar { height: 30px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; font-weight: bold; transition: width 1s ease-in-out;}
        .bar-a { background-color: var(--primary); }
        .bar-b { background-color: var(--success); }
        .bracket { border-bottom: 2px solid #333; border-left: 2px solid #333; border-right: 2px solid #333; height: 10px; margin-top: 5px; position: relative; }
        .bracket::after { content: '?'; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); }

        /* ä¹˜æ³•/é™¤æ³• ç‰©ä»¶åœ– */
        .grid-objects { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; padding: 10px; }
        .obj-group { border: 2px solid #ccc; padding: 5px; border-radius: 8px; margin: 2px; background: white; transition: 0.5s; }
        .dot { width: 12px; height: 12px; background-color: var(--danger); border-radius: 50%; display: inline-block; margin: 1px; }

        /* --- é¡Œç›®é¡¯ç¤º --- */
        .problem-text { font-size: 1.3rem; line-height: 1.5; margin-bottom: 10px; font-weight: bold; color: #2c3e50; }
        .hint-box { 
            background: #eafaf1; color: #27ae60; padding: 10px; border-radius: 6px; 
            margin-bottom: 10px; font-size: 0.95rem; display: none; border-left: 4px solid #27ae60;
        }

        /* --- ç·¨è¼¯å™¨ --- */
        .editor-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .editor-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .pool-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .pool-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .pool-item:nth-child(even) { background: #f9f9f9; }
        .tag-op { padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; margin-right: 5px;}

        /* --- çå‹µèˆ‡å€‹äºº --- */
        .user-panel {
            background: #fff3cd; border: 2px solid #f39c12; border-radius: 50px;
            padding: 5px 20px; margin-bottom: 15px; font-weight: bold; color: #d35400;
            display: flex; gap: 15px; align-items: center; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="page-home" class="container active">
        <h1>ğŸ§® å››å‰‡é‹ç®—è§€å¿µç·´ç¿’</h1>
        
        <div style="display:flex; justify-content:center;">
            <div class="user-panel" onclick="editUser()">
                <span>ğŸ“ <span id="u-name">å­¸å“¡</span></span>
                <span>ğŸ’ <span id="u-gems">0</span></span>
            </div>
        </div>

        <h3>é¸æ“‡ç·´ç¿’é¡Œåº«</h3>
        <div id="quiz-list" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
        
        <div style="margin-top:auto; border-top: 1px dashed #ccc; padding-top: 10px;">
            <button class="btn-secondary btn-block" onclick="showEditor()">âœï¸ ç·¨è¼¯ / å»ºç«‹é¡Œåº«</button>
            <button class="btn-gray btn-block" onclick="importJsonBtn()">ğŸ“¥ åŒ¯å…¥ JSON é¡Œåº«</button>
            <input type="file" id="file-upload" style="display:none" accept=".json" onchange="handleFileImport(this)">
            <button class="btn-gray btn-block" onclick="exportJson()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:10px;">Four_operators.html v1.0</div>
    </div>

    <div id="page-setting" class="container">
        <h2>ğŸ“ é¸æ“‡æ¨¡å¼</h2>
        <div class="problem-text" id="setting-title"></div>
        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
            <label style="display:block; margin-bottom:10px; cursor:pointer;">
                <input type="radio" name="mode" value="teach" checked> 
                <strong>ğŸ“– æ•™å­¸æ¨¡å¼</strong>
                <p style="font-size:0.9rem; color:#666; margin:5px 0 0 20px;">
                    æä¾›æç¤ºæŒ‰éˆ•ï¼Œç­”å°å¾Œæœƒå‡ºç¾å‹•ç•«æ¼”ç¤ºè§€å¿µ (åŠ æ¸›ä¹˜é™¤çš„åœ–è§£)ã€‚
                </p>
            </label>
            <hr>
            <label style="display:block; margin-top:10px; cursor:pointer;">
                <input type="radio" name="mode" value="test"> 
                <strong>ğŸ† æ¸¬é©—æ¨¡å¼</strong>
                <p style="font-size:0.9rem; color:#666; margin:5px 0 0 20px;">
                    ç„¡æç¤ºï¼Œç„¡å‹•ç•«ï¼Œå°ˆæ³¨æ–¼å¿«é€Ÿåˆ¤æ–·èˆ‡è§£é¡Œï¼Œè³ºå–å¯¶çŸ³ã€‚
                </p>
            </label>
            
            <div style="margin-top:15px;">
                ç¯©é¸ç¬¦è™Ÿ: 
                <select id="filter-op" style="padding:5px;">
                    <option value="all">å…¨éƒ¨ (æ··åˆ)</option>
                    <option value="add">åªç·´åŠ æ³• (+)</option>
                    <option value="sub">åªç·´æ¸›æ³• (-)</option>
                    <option value="mul">åªç·´ä¹˜æ³• (Ã—)</option>
                    <option value="div">åªç·´é™¤æ³• (Ã·)</option>
                </select>
            </div>
        </div>
        <button class="btn-primary btn-block" onclick="startQuiz()">é–‹å§‹ç·´ç¿’</button>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="page-quiz" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span id="q-progress" style="font-weight:bold; color:#7f8c8d;">1 / 10</span>
            <span id="q-timer" style="font-family:monospace; font-size:1.2rem;">00:00</span>
            <button id="btn-hint" class="btn-warning" style="font-size:0.9rem; padding:5px 10px;" onclick="showHint()">ğŸ’¡ æç¤º</button>
        </div>

        <div id="quiz-content" style="flex:1;">
            <div id="q-text" class="problem-text">é¡Œç›®æ–‡å­—è¼‰å…¥ä¸­...</div>
            
            <div id="q-hint" class="hint-box"></div>

            <div id="anim-stage" class="concept-stage">
                <div class="concept-note">è§€å¿µæ¼”ç¤º</div>
                <div id="anim-content" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;"></div>
            </div>

            <div style="text-align:center; margin:10px 0; font-size:1.1rem; color:#555;">è«‹å•é€™é¡Œè¦ç”¨å“ªä¸€ç¨®é‹ç®—ï¼Ÿ</div>

            <div class="operator-grid">
                <div class="op-card op-add" onclick="checkAnswer('add')">
                    <span>+</span><div>åŠ æ³•</div>
                </div>
                <div class="op-card op-sub" onclick="checkAnswer('sub')">
                    <span>-</span><div>æ¸›æ³•</div>
                </div>
                <div class="op-card op-mul" onclick="checkAnswer('mul')">
                    <span>Ã—</span><div>ä¹˜æ³•</div>
                </div>
                <div class="op-card op-div" onclick="checkAnswer('div')">
                    <span>Ã·</span><div>é™¤æ³•</div>
                </div>
            </div>
        </div>

        <div id="feedback-msg" style="text-align:center; font-weight:bold; height:30px; margin-top:10px; color:var(--primary);"></div>

        <button id="btn-next" class="btn-success btn-block" style="display:none; margin-top:20px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡</button>
        <button class="btn-danger" style="margin-top:20px;" onclick="quitQuiz()">ä¸­é€”çµæŸ</button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="background:#eee; padding:10px; border-radius:6px; margin-bottom:10px;">
            <input type="text" id="edit-list-name" placeholder="é¡Œåº«åç¨±" class="editor-input" style="width:100%">
        </div>
        
        <div style="background:#f9f9f9; padding:10px; border:1px solid #ddd; border-radius:6px;">
            <h4>â• æ–°å¢é¡Œç›®</h4>
            <textarea id="ed-text" class="editor-input" style="width:100%; height:60px; margin-bottom:5px;" placeholder="è¼¸å…¥å•é¡Œ (ä¾‹å¦‚: è˜‹æœä¸€é¡†10å…ƒï¼Œè²·5é¡†å¤šå°‘éŒ¢?)"></textarea>
            <input type="text" id="ed-hint" class="editor-input" style="width:100%; margin-bottom:5px;" placeholder="è¼¸å…¥æç¤º (ä¾‹å¦‚: ç®—å‡ºç¸½åƒ¹æ˜¯å€æ•¸é—œä¿‚)">
            
            <div class="editor-row">
                <select id="ed-op" class="editor-input" style="flex:1;">
                    <option value="" disabled selected>é¸æ“‡æ­£ç¢ºç¬¦è™Ÿ</option>
                    <option value="add">åŠ æ³• (+)</option>
                    <option value="sub">æ¸›æ³• (-)</option>
                    <option value="mul">ä¹˜æ³• (Ã—)</option>
                    <option value="div">é™¤æ³• (Ã·)</option>
                </select>
            </div>
            <div class="editor-row">
                <input type="number" id="ed-n1" class="editor-input" placeholder="æ•¸å­— A (ç”¨æ–¼å‹•ç•«)">
                <input type="number" id="ed-n2" class="editor-input" placeholder="æ•¸å­— B (ç”¨æ–¼å‹•ç•«)">
            </div>
            <div style="font-size:0.8rem; color:#888;">* æ•¸å­— A èˆ‡ B ç”¨æ–¼ç”Ÿæˆæ•™å­¸å‹•ç•« (ä¾‹å¦‚ä¹˜æ³•: A=10, B=5 è¡¨ç¤º 10 å‡ºç¾ 5 æ¬¡)</div>
            <button class="btn-primary btn-block" onclick="addQuestionToPool()">åŠ å…¥é¡Œåº«</button>
        </div>

        <div style="margin-top:15px;">
            <strong>ç›®å‰é¡Œç›®åˆ—è¡¨ (<span id="pool-count">0</span>)</strong>
            <div id="editor-pool-list" class="pool-list"></div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-success" style="flex:1" onclick="saveList()">å„²å­˜ä¸¦è¿”å›</button>
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- è³‡æ–™çµæ§‹ ---
        let user = { name: "å°å°å­¸å“¡", gems: 0 };
        let currentList = null;
        let quizState = {
            questions: [],
            idx: 0,
            mode: 'teach',
            correct: 0,
            timer: 0,
            interval: null
        };
        
        // é è¨­é¡Œåº«
        let allLists = [
            {
                id: 1, name: "ç”Ÿæ´»æ‡‰ç”¨åŸºç¤é¡Œ (ç¯„ä¾‹)", 
                qs: [
                    { text: "ä¸€ç½é£²æ–™12å…ƒï¼Œè²·5ç½è¦å¤šå°‘éŒ¢ï¼Ÿ", hint: "æƒ³çŸ¥é“ç¸½å…±å¤šå°‘éŒ¢ï¼Œæ˜¯é‡è¤‡åŠ 5æ¬¡åŒæ¨£çš„éŒ¢", op: "mul", n1: 12, n2: 5 },
                    { text: "æœ‰15é¡†ç³–æœï¼Œå¹³åˆ†çµ¦3ä½å°æœ‹å‹ï¼Œæ¯äººæ‹¿å¹¾é¡†ï¼Ÿ", hint: "æŠŠç¸½æ•¸å¹³å‡åˆ†çµ¦æ¯ä¸€å€‹äºº", op: "div", n1: 15, n2: 3 },
                    { text: "å“¥å“¥æœ‰50å…ƒï¼Œè²·ç­†è¨˜æœ¬èŠ±äº†30å…ƒï¼Œé‚„å‰©å¤šå°‘å…ƒï¼Ÿ", hint: "åŸæœ‰çš„éŒ¢æ‰£æ‰èŠ±æ‰çš„éŒ¢", op: "sub", n1: 50, n2: 30 },
                    { text: "å°æ˜ä¸Šåˆè·‘äº†200å…¬å°ºï¼Œä¸‹åˆè·‘äº†300å…¬å°ºï¼Œä»Šå¤©å…±è·‘äº†å¹¾å…¬å°ºï¼Ÿ", hint: "æŠŠå…©æ¬¡è·‘çš„è·é›¢åˆèµ·ä¾†", op: "add", n1: 200, n2: 300 }
                ]
            }
        ];

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadData();
            renderHome();
        };

        function loadData() {
            const savedLists = localStorage.getItem('fo_lists');
            if(savedLists) allLists = JSON.parse(savedLists);
            const savedUser = localStorage.getItem('fo_user');
            if(savedUser) user = JSON.parse(savedUser);
            updateUserUI();
        }

        function saveData() {
            localStorage.setItem('fo_lists', JSON.stringify(allLists));
            localStorage.setItem('fo_user', JSON.stringify(user));
        }

        // --- é é¢åˆ‡æ› ---
        function showPage(pid) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            if(pid === 'page-home') renderHome();
        }

        function updateUserUI() {
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-gems').innerText = user.gems;
        }

        function editUser() {
            const n = prompt("è¼¸å…¥ä½ çš„åå­—", user.name);
            if(n) { user.name = n; saveData(); updateUserUI(); }
        }

        // --- é¦–é æ¸²æŸ“ ---
        function renderHome() {
            const listDiv = document.getElementById('quiz-list');
            listDiv.innerHTML = '';
            allLists.forEach((list, idx) => {
                const div = document.createElement('div');
                div.className = 'pool-item';
                div.innerHTML = `
                    <div style="cursor:pointer;" onclick="prepareQuiz(${idx})">
                        <strong>${list.name}</strong> 
                        <span style="font-size:0.8rem; color:#666;">(${list.qs.length}é¡Œ)</span>
                    </div>
                    <div>
                        <button class="btn-outline" style="font-size:0.8rem;" onclick="editList(${idx})">ç·¨è¼¯</button>
                        <button class="btn-danger" style="font-size:0.8rem; padding:5px 8px;" onclick="delList(${idx})">Ã—</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        // --- æ¸¬é©—æµç¨‹ ---
        function prepareQuiz(idx) {
            currentList = allLists[idx];
            document.getElementById('setting-title').innerText = `ç›®å‰é¸æ“‡ï¼š${currentList.name}`;
            showPage('page-setting');
        }

        function startQuiz() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const filter = document.getElementById('filter-op').value;
            
            // ç¯©é¸é¡Œç›®
            let qPool = currentList.qs;
            if(filter !== 'all') {
                qPool = qPool.filter(q => q.op === filter);
            }

            if(qPool.length === 0) return alert("æ­¤åˆ†é¡ä¸‹æ²’æœ‰é¡Œç›®ï¼");

            quizState = {
                questions: shuffle([...qPool]), // éš¨æ©Ÿæ’åº
                idx: 0,
                mode: mode,
                correct: 0,
                timer: 0,
                interval: setInterval(() => {
                    quizState.timer++;
                    let m = Math.floor(quizState.timer/60).toString().padStart(2,'0');
                    let s = (quizState.timer%60).toString().padStart(2,'0');
                    document.getElementById('q-timer').innerText = `${m}:${s}`;
                }, 1000)
            };

            showPage('page-quiz');
            document.getElementById('btn-hint').style.display = (mode === 'teach') ? 'inline-block' : 'none';
            renderQuestion();
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function renderQuestion() {
            const q = quizState.questions[quizState.idx];
            document.getElementById('q-progress').innerText = `${quizState.idx + 1} / ${quizState.questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            document.getElementById('q-hint').style.display = 'none';
            document.getElementById('q-hint').innerText = q.hint || "æ­¤é¡Œç„¡æç¤º";
            document.getElementById('anim-stage').style.display = 'none'; // éš±è—å‹•ç•«
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('btn-next').style.display = 'none';
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.op-card').forEach(c => {
                c.style.opacity = '1';
                c.style.pointerEvents = 'auto';
                c.style.border = '2px solid #eee';
            });
        }

        function showHint() {
            document.getElementById('q-hint').style.display = 'block';
        }

        function checkAnswer(selectedOp) {
            const q = quizState.questions[quizState.idx];
            const isCorrect = (selectedOp === q.op);

            if(isCorrect) {
                document.getElementById('feedback-msg').innerText = "âœ… ç­”å°äº†ï¼";
                document.getElementById('feedback-msg').style.color = "var(--success)";
                quizState.correct++;
                
                // é–å®šæ‰€æœ‰æŒ‰éˆ•
                document.querySelectorAll('.op-card').forEach(c => c.style.pointerEvents = 'none');
                
                // æ¨™è¨˜æ­£ç¢º
                const card = document.querySelector(`.op-${selectedOp}`);
                card.style.border = "4px solid var(--success)";
                
                // æ·¡å‡ºéŒ¯èª¤çš„
                document.querySelectorAll('.op-card').forEach(c => {
                    if(!c.classList.contains(`op-${selectedOp}`)) c.style.opacity = '0.3';
                });

                // æ•™å­¸æ¨¡å¼ä¸‹ï¼Œç­”å°é¡¯ç¤ºå‹•ç•«
                if(quizState.mode === 'teach') {
                    playAnimation(q);
                }

                document.getElementById('btn-next').style.display = 'block';

            } else {
                document.getElementById('feedback-msg').innerText = "âŒ å†æƒ³ä¸€æƒ³...";
                document.getElementById('feedback-msg').style.color = "var(--danger)";
                // æ‡²ç½°ï¼šè©²æŒ‰éˆ•è®Šæš—
                const card = document.querySelector(`.op-${selectedOp}`);
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
                
                if(quizState.mode === 'teach') {
                    showHint(); // ç­”éŒ¯è‡ªå‹•æç¤º
                }
            }
        }

        function nextQuestion() {
            quizState.idx++;
            if(quizState.idx >= quizState.questions.length) {
                endQuiz();
            } else {
                renderQuestion();
            }
        }

        function endQuiz() {
            clearInterval(quizState.interval);
            let score = Math.round((quizState.correct / quizState.questions.length) * 100);
            let gemsEarned = (score === 100) ? 5 : (score >= 60 ? 2 : 0);
            
            // æ¸¬é©—æ¨¡å¼çå‹µåŠ å€
            if(quizState.mode === 'test') gemsEarned *= 2;
            
            user.gems += gemsEarned;
            saveData();
            
            alert(`æ¸¬é©—çµæŸï¼\nå¾—åˆ†: ${score}\nç²å¾—å¯¶çŸ³: ${gemsEarned} ğŸ’`);
            showPage('page-home');
        }

        function quitQuiz() {
            if(confirm("ç¢ºå®šè¦çµæŸæ¸¬é©—å—ï¼Ÿ")) {
                clearInterval(quizState.interval);
                showPage('page-home');
            }
        }

        // --- æ ¸å¿ƒï¼šè§€å¿µå‹•ç•«æ¼”ç¤º ---
        function playAnimation(q) {
            const stage = document.getElementById('anim-stage');
            const content = document.getElementById('anim-content');
            stage.style.display = 'block';
            content.innerHTML = '';

            let n1 = parseFloat(q.n1) || 10;
            let n2 = parseFloat(q.n2) || 2;
            
            // é™åˆ¶å‹•ç•«æ•¸é‡ä»¥å…ç€è¦½å™¨å¡é “
            let displayN1 = n1 > 20 ? 20 : n1; 
            let displayN2 = n2 > 10 ? 10 : n2;

            if(q.op === 'mul') {
                // ä¹˜æ³•ï¼šé‡è¤‡å‡ºç¾çµ„åˆ¥
                content.style.flexDirection = 'column';
                for(let i=0; i<displayN2; i++) {
                    let group = document.createElement('div');
                    group.className = 'obj-group';
                    // å…§å®¹ç‰©
                    for(let j=0; j< (displayN1 > 10 ? 5 : displayN1); j++) {
                        let d = document.createElement('span'); d.className='dot';
                        group.appendChild(d);
                    }
                    if(displayN1 > 10) group.innerHTML += `<span style="font-size:0.8rem">...å…±${n1}</span>`;
                    
                    // å»¶é²é¡¯ç¤ºå‹•ç•«
                    group.style.opacity = '0';
                    content.appendChild(group);
                    setTimeout(() => group.style.opacity = '1', i * 300);
                }
                stage.querySelector('.concept-note').innerText = `ä¹˜æ³•ï¼š${n1} çš„æ±è¥¿ï¼Œè²·äº† ${n2} ä»½ (ç´¯è¨ˆ)`;
            } 
            else if(q.op === 'div') {
                // é™¤æ³•ï¼šç¸½æ•¸åˆ†ç™¼
                stage.querySelector('.concept-note').innerText = `é™¤æ³•ï¼šç¸½å…± ${n1}ï¼Œå¹³åˆ†çµ¦ ${n2} å€‹å°è±¡`;
                // å»ºç«‹ç±ƒå­
                let baskets = [];
                for(let i=0; i<displayN2; i++) {
                    let b = document.createElement('div');
                    b.className = 'obj-group';
                    b.style.minWidth = '40px'; b.style.minHeight = '40px'; b.style.textAlign='center';
                    b.innerHTML = `<div style="font-size:0.8rem; border-bottom:1px solid #ddd;">${i+1}</div>`;
                    content.appendChild(b);
                    baskets.push(b);
                }
                // æ¨¡æ“¬åˆ†é…(è¦–è¦ºä¸Šç”¨æ–‡å­—æˆ–å°‘é‡é»ä»£è¡¨)
                setTimeout(() => {
                    baskets.forEach(b => {
                        let span = document.createElement('span');
                        span.style.color = 'var(--primary)'; span.style.fontWeight='bold';
                        span.innerText = Math.floor(n1/n2);
                        b.appendChild(span);
                    });
                }, 500);
            }
            else if(q.op === 'add') {
                // åŠ æ³•ï¼šåˆä½µ
                stage.querySelector('.concept-note').innerText = `åŠ æ³•ï¼šA (${n1}) å’Œ B (${n2}) åˆèµ·ä¾†`;
                // æ¯”ä¾‹æ¢
                let total = n1 + n2;
                let w1 = (n1/total) * 80; 
                let w2 = (n2/total) * 80;
                
                let box = document.createElement('div');
                box.className = 'bar-container';
                box.style.width = '100%'; box.style.justifyContent = 'center';
                
                box.innerHTML = `
                    <div class="bar bar-a" style="width:0%;">${n1}</div>
                    <div style="width:5px;"></div>
                    <div class="bar bar-b" style="width:0%;">${n2}</div>
                `;
                content.appendChild(box);
                
                // å‹•ç•«: è®Šé•· -> åˆä½µ
                setTimeout(() => {
                    box.children[0].style.width = w1 + '%';
                    box.children[2].style.width = w2 + '%';
                }, 100);
                setTimeout(() => {
                   box.children[1].style.width = '0px'; // å»é™¤é–“éš™
                }, 1000);
            }
            else if(q.op === 'sub') {
                // æ¸›æ³•ï¼šæ¯”è¼ƒå·®é¡
                stage.querySelector('.concept-note').innerText = `æ¸›æ³•ï¼šA (${n1}) å’Œ B (${n2}) å·®å¤šå°‘ï¼Ÿ`;
                content.style.flexDirection = 'column';
                
                let max = Math.max(n1, n2);
                let w1 = (n1/max) * 90;
                let w2 = (n2/max) * 90;

                content.innerHTML = `
                    <div class="bar-container" style="width:100%;"><div class="bar bar-a" style="width:${w1}%">${n1}</div></div>
                    <div class="bar-container" style="width:100%;"><div class="bar bar-b" style="width:${w2}%">${n2}</div></div>
                `;
                
                // ç•«å‡ºå·®ç•°ç·š
                let diffW = Math.abs(w1 - w2);
                let spacer = Math.min(w1, w2);
                let bracket = document.createElement('div');
                bracket.style.display = 'flex'; bracket.style.width = '100%';
                bracket.innerHTML = `<div style="width:${spacer}%"></div><div style="width:${diffW}%"><div class="bracket"></div></div>`;
                content.appendChild(bracket);
            }
        }

        // --- ç·¨è¼¯å™¨é‚è¼¯ ---
        let editingListId = null;
        let tempPool = [];

        function showEditor() {
            editingListId = null;
            tempPool = [];
            document.getElementById('edit-list-name').value = "æ–°é¡Œåº«";
            renderEditorPool();
            showPage('page-editor');
        }

        function editList(idx) {
            editingListId = idx;
            const l = allLists[idx];
            document.getElementById('edit-list-name').value = l.name;
            tempPool = JSON.parse(JSON.stringify(l.qs)); // Deep copy
            renderEditorPool();
            showPage('page-editor');
        }

        function delList(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤é¡Œåº«?")) {
                allLists.splice(idx, 1);
                saveData();
                renderHome();
            }
        }

        function addQuestionToPool() {
            const text = document.getElementById('ed-text').value.trim();
            const hint = document.getElementById('ed-hint').value.trim();
            const op = document.getElementById('ed-op').value;
            const n1 = document.getElementById('ed-n1').value;
            const n2 = document.getElementById('ed-n2').value;

            if(!text || !op) return alert("è«‹è¼¸å…¥é¡Œç›®èˆ‡é¸æ“‡ç¬¦è™Ÿ");
            
            tempPool.push({
                text, hint, op, 
                n1: parseFloat(n1)||10, 
                n2: parseFloat(n2)||5 
            });
            
            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('ed-text').value = '';
            document.getElementById('ed-hint').value = '';
            renderEditorPool();
        }

        function renderEditorPool() {
            const list = document.getElementById('editor-pool-list');
            list.innerHTML = '';
            document.getElementById('pool-count').innerText = tempPool.length;
            
            const opColors = { 'add': 'var(--op-add)', 'sub': 'var(--op-sub)', 'mul': 'var(--op-mul)', 'div': 'var(--op-div)' };
            const opNames = { 'add': '+', 'sub': '-', 'mul': 'Ã—', 'div': 'Ã·' };

            tempPool.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'pool-item';
                div.innerHTML = `
                    <div style="flex:1;">
                        <span class="tag-op" style="background:${opColors[q.op]}">${opNames[q.op]}</span>
                        ${q.text.substring(0, 20)}...
                    </div>
                    <button class="btn-danger" style="padding:2px 8px;" onclick="removeTempQ(${i})">Ã—</button>
                `;
                list.appendChild(div);
            });
        }

        function removeTempQ(i) {
            tempPool.splice(i, 1);
            renderEditorPool();
        }

        function saveList() {
            const name = document.getElementById('edit-list-name').value.trim();
            if(!name || tempPool.length === 0) return alert("è«‹è¼¸å…¥é¡Œåº«åç¨±ä¸¦è‡³å°‘åŠ å…¥ä¸€é¡Œ");

            const newList = {
                id: Date.now(),
                name: name,
                qs: tempPool
            };

            if(editingListId !== null) {
                allLists[editingListId] = newList;
            } else {
                allLists.push(newList);
            }
            saveData();
            showPage('page-home');
        }

        // --- JSON åŒ¯å…¥/åŒ¯å‡º ---
        function exportJson() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allLists));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "math_quiz_backup.json");
            dlAnchorElem.click();
        }

        function importJsonBtn() {
            document.getElementById('file-upload').click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    // ç°¡å–®æ ¼å¼æª¢æŸ¥
                    if(Array.isArray(json)) {
                        allLists = allLists.concat(json);
                        saveData();
                        renderHome();
                        alert("åŒ¯å…¥æˆåŠŸï¼");
                    } else {
                        alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹åŒ¯å…¥æœ¬ç³»çµ±åŒ¯å‡ºä¹‹ JSON é™£åˆ—æ ¼å¼ã€‚");
                    }
                } catch(err) {
                    alert("æª”æ¡ˆè§£æå¤±æ•—");
                }
            };
            reader.readAsText(file);
            input.value = ''; // reset
        }
    </script>
</body>
</html>