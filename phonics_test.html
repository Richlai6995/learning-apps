<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phonics æ‹¼å­—é—–é—œç‹ 9.0 (å¯¶çŸ³çå‹µç‰ˆ)</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --dark: #2C3E50;
            --light: #F7F9FC;
            --accent: #FFE66D;
            --success: #2ecc71;
            --danger: #e74c3c;
            --link: #3498db;
            --user-bg: #fff3cd;
            
            --rank-1: #FFD700;
            --rank-2: #C0C0C0;
            --rank-3: #CD7F32;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none; /* é˜²æ­¢ iPad é è¨­æ‰‹å‹¢å¹²æ“¾ */
            overflow-x: hidden;
            overflow-y: auto; 
        }

        h1, h2 { margin: 5px 0; color: var(--dark); text-align: center; }

        /* --- é€šç”¨å®¹å™¨ --- */
        .container {
            width: 100%; max-width: 600px; background: white; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box;
            margin-bottom: 20px; display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            border: none; border-radius: 8px; padding: 8px 12px; font-size: 0.95rem;
            font-weight: bold; cursor: pointer; transition: transform 0.1s;
            color: white; margin: 2px; touch-action: manipulation;
        }
        button:active { transform: scale(0.95); }
        
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-accent { background-color: #f39c12; }
        .btn-gray { background-color: #95a5a6; }
        .btn-danger { background-color: var(--danger); }
        .btn-link { background-color: var(--link); }
        .btn-gold { background-color: #f1c40f; color: #333; }
        .btn-outline { background: transparent; border: 1px solid #999; color: #666; padding: 5px 10px; font-size: 0.85rem;}
        .btn-block { width: 100%; margin: 5px 0; padding: 12px; font-size: 1.1rem; }

        /* --- å­¸å“¡åç‰Œ & çå‹µ --- */
        .user-profile {
            background-color: var(--user-bg);
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-wrap: wrap;
            gap: 10px;
        }
        .user-name { font-size: 1.2rem; font-weight: bold; color: #d35400; margin-right: 5px;}
        .stats-badge {
            background: #fff; padding: 3px 8px; border-radius: 12px; font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 3px;
        }

        /* --- åˆ—è¡¨é …ç›® --- */
        .list-item {
            background: #f8f9fa; border: 1px solid #e9ecef; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; display: flex; align-items: center; gap: 10px;
        }
        .list-checkbox { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; }
        .list-content-wrapper { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .list-header { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap;}
        .list-actions { display: flex; gap: 5px; justify-content: flex-end; width: 100%; flex-wrap: wrap; }
        
        .gem-tag { color: #2980b9; font-weight: bold; background: #d6eaf8; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; margin-left: 5px;}
        .score-tag { color: #d35400; font-weight: bold; background: #fdebd0; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; margin-left: 5px;}

        /* --- è‹±é›„æ¦œ --- */
        .rank-list { margin-top: 10px; }
        .rank-item { display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: #fff; border-radius: 8px; border: 1px solid #eee; position: relative; }
        .rank-num { font-size: 1.5rem; font-weight: 900; width: 40px; text-align: center; margin-right: 10px; color: #7f8c8d; }
        .rank-info { flex: 1; }
        .rank-user { font-weight: bold; font-size: 1.1rem; display: block; }
        .rank-detail { font-size: 0.9rem; color: #666; }
        .rank-score { font-weight: bold; color: var(--primary); }
        .rank-item.rank-1 { background: linear-gradient(to right, #fff, #fff9c4); border: 2px solid var(--rank-1); }
        .rank-item.rank-1 .rank-num { color: #d4ac0d; font-size: 2rem; }
        .rank-item.rank-2 { border-left: 5px solid var(--rank-2); } .rank-item.rank-2 .rank-num { color: #7f8c8d; }
        .rank-item.rank-3 { border-left: 5px solid var(--rank-3); } .rank-item.rank-3 .rank-num { color: #a0522d; }

        /* --- æ­·å²ç´€éŒ„ --- */
        .history-item {
            background: #e8f6f3; border-left: 5px solid var(--secondary); padding: 12px; margin-bottom: 10px; border-radius: 4px;
            display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
        }
        .history-info { display: flex; flex-direction: column; gap: 4px; }
        .history-title { font-weight: bold; color: #34495e; font-size: 0.9rem; }
        .history-user { font-weight: bold; color: var(--dark); }
        .history-score { color: var(--primary); font-size: 1.1rem; font-weight: 900; margin-left: 5px; }
        .delete-history-btn { background: transparent; color: #bdc3c7; border: 1px solid #bdc3c7; width: 32px; height: 32px; border-radius: 50%; padding: 0; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* --- åŒ¯å‡ºåŒ¯å…¥å€ --- */
        .data-controls { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #eee; }
        .data-btn-row { display: flex; gap: 10px; }

        /* --- ç·¨è¼¯å€ --- */
        .edit-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; background: #fff; padding: 5px; border: 1px solid #eee; border-radius: 8px; }
        .edit-row input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .thumb-preview { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; background: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .file-input { display: none; }
        
        .quiz-header { display: flex; justify-content: space-between; font-weight: bold; color: #7f8c8d; margin-bottom: 15px; background: #f1f2f6; padding: 10px; border-radius: 8px; }
        .timer-badge { background: var(--dark); color: #fff; padding: 2px 8px; border-radius: 4px; font-family: monospace; }
        .question-area { text-align: center; margin-bottom: 15px; }
        .q-image-box { height: 140px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .q-image-box img { max-height: 100%; max-width: 100%; border-radius: 8px; }
        .q-image-box span { font-size: 5rem; }
        
        .answer-area { display: flex; justify-content: center; gap: 8px; margin-bottom: 30px; min-height: 60px; padding: 10px; background: #fff; border-radius: 10px; }
        .slot { width: 45px; height: 55px; border-bottom: 4px solid var(--secondary); background-color: #f8f9fa; border-radius: 6px 6px 0 0; display: flex; justify-content: center; align-items: center; position: relative; }
        .pool-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; min-height: 70px; padding: 15px; background: #ecf0f1; border-radius: 10px; border: 2px dashed #bdc3c7; }
        
        .tile { 
            width: 42px; height: 42px; background-color: var(--dark); color: white; 
            font-size: 1.6rem; font-weight: bold; display: flex; justify-content: center; align-items: center; 
            border-radius: 8px; cursor: pointer; box-shadow: 0 4px #1a252f; 
            user-select: none; touch-action: none; position: relative; z-index: 10; 
        }
        .tile.dragging { position: fixed; opacity: 0.8; pointer-events: none; transform: scale(1.2); z-index: 1000; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .tile.placeholder { opacity: 0.2; box-shadow: none; }
        
        /* çµæœå¡ç‰‡ */
        .result-card { text-align: center; padding: 20px; }
        .final-score { font-size: 5rem; color: var(--primary); margin: 10px 0; font-weight: bold; }
        .final-accuracy { font-size: 1.5rem; color: #34495e; font-weight: bold; margin-bottom: 5px; background: #e8f6f3; padding: 5px 15px; border-radius: 20px; display: inline-block;}
        .final-time { font-size: 1.2rem; color: #7f8c8d; margin-bottom: 20px; margin-top: 10px;}
        
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #999; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .version-tag { margin-top: 30px; color: #ccc; font-size: 0.8rem; text-align: center; }

        /* --- ç²çå‹•ç•«èˆ‡ç‰¹æ•ˆ --- */
        .reward-popup {
            background: #fff8e1; border: 3px solid #f1c40f; padding: 15px;
            border-radius: 15px; margin-top: 20px; font-weight: bold; color: #d35400;
            font-size: 1.3rem; text-align: center;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
            animation: bounceIn 0.8s;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* ç²’å­å‹•ç•«å®¹å™¨ */
        #particle-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden; display: none;
        }
        .particle {
            position: absolute; font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>ğŸ† Phonics æ‹¼å­—é—–é—œç‹</h1>
        
        <div class="user-profile" onclick="changeStudentName()">
            <div>ğŸ“ <span id="display-student-name" class="user-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('history')">å…¨éƒ¨ç´€éŒ„</div>
        </div>

        <div id="tab-quiz-content">
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢è‡ªè¨‚é¡Œåº«</button>
            
            <div class="data-controls">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:#555;">è³‡æ–™ç®¡ç†</span>
                    <button class="btn-outline" onclick="toggleSelectAll()">å…¨é¸ / å–æ¶ˆ</button>
                </div>
                <div class="data-btn-row">
                    <button class="btn-link" style="flex:1" onclick="exportSelectedData()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½ (å«å¯¶çŸ³)</button>
                    <button class="btn-link" style="flex:1" onclick="triggerImport()">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
                </div>
                <input type="file" id="import-file" class="file-input" accept=".json" onchange="handleImportData(this)">
            </div>
        </div>

        <div id="tab-history-content" style="display:none;">
            <div id="history-container"></div>
            <button class="btn-gray btn-block" onclick="clearAllHistory()">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv9.0 (å¯¶çŸ³çå‹µç‰ˆ)</div>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:8px;">
            <div style="margin-bottom:10px;">
                <label>é¡Œåº«åç¨±ï¼š</label>
                <input type="text" id="list-name-input" style="padding:5px; width:70%;">
            </div>
            <div style="display:flex; gap:10px;">
                <div>ğŸ’ çå‹µå¯¶çŸ³: <input type="number" id="list-gems" placeholder="5" style="padding:5px; width:60px;" value="5"></div>
                <div>ğŸ¯ ç²çåˆ†æ•¸: <input type="number" id="list-pass-score" placeholder="100" style="padding:5px; width:60px;" value="100"></div>
            </div>
        </div>
        <div style="background:#e8f6f3; padding:8px; font-size:0.9rem; border-radius:5px; margin-bottom:10px; color:#2c3e50;">
            ğŸ’¡ é»æ“Šåœ–ç¤ºæ¡†å¯ä¸Šå‚³åœ–ç‰‡ï¼Œæˆ–æ˜¯ç›´æ¥è¼¸å…¥ Emoji ğŸ
        </div>
        <div id="editor-rows"></div>
        <button class="btn-gray" onclick="addEditRow()">+ å¢åŠ å–®å­—</button>
        <hr>
        <div style="display:flex; gap:10px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-progress">é¡Œè™Ÿ: 1/5</span>
            <span id="q-timer" class="timer-badge">00:00</span>
            <span id="q-score">å¾—åˆ†: 0</span>
        </div>
        <div class="question-area">
            <div id="q-image-box" class="q-image-box"></div>
            <button class="btn-accent" onclick="playTargetAudio()">ğŸ”Š è½é¡Œç›®ç™¼éŸ³</button>
        </div>
        <div style="text-align:center; color:#7f8c8d; font-size:0.9rem; margin-bottom:5px;">å°‡å­—æ¯æ‹‰åˆ°ç·šä¸Šæ‹¼å­—</div>
        <div id="answer-area" class="answer-area"></div>
        <div id="pool-area" class="pool-area"></div>
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
            <button class="btn-secondary" onclick="speakUserSpelling()">ğŸ‘‚ è½æ‹¼éŸ³</button>
            <button class="btn-gray" onclick="resetCurrentTiles()">âŒ« é‡ç½®</button>
        </div>
        <button class="btn-primary btn-block" style="margin-top: 20px;" onclick="submitAnswer()">é€å‡ºç­”æ¡ˆ (Check)</button>
        <button class="btn-gray btn-block" onclick="quitQuiz()">é€€å‡ºæ¸¬é©—</button>
    </div>

    <div id="page-result" class="container">
        <div class="result-card">
            <h2>ğŸ‰ æ¸¬é©—å®Œæˆï¼</h2>
            <div class="final-score" id="final-score">100</div>
            <div class="final-accuracy" id="final-accuracy">æ­£ç¢º: 5/5</div>
            <div class="final-time" id="final-time">è€—æ™‚: 01:23</div>
            
            <div id="reward-area"></div>
            
            <div class="result-msg" id="final-msg" style="font-size:1.2rem; margin-bottom:20px; margin-top:10px;">å¤ªå²å®³äº†ï¼</div>
            <button class="btn-primary btn-block" onclick="showPage('page-home')">å›åˆ°é¦–é </button>
        </div>
    </div>

    <div id="page-leaderboard" class="container">
        <h2 id="lb-title">ğŸ† è‹±é›„æ¦œ</h2>
        <p style="text-align:center; color:#666;">ä¾åˆ†æ•¸èˆ‡æ™‚é–“æ’åº</p>
        <div id="lb-container" class="rank-list"></div>
        <button class="btn-primary btn-block" onclick="showPage('page-home')">é—œé–‰æ¦œå–®</button>
    </div>

<script>
    // --- åˆå§‹åŒ– ---
    const DEFAULT_LIST = {
        id: 'default',
        name: 'é è¨­ï¼šå‹•ç‰©ç¯‡ (Demo)',
        gems: 5,
        passScore: 100,
        words: [{word: 'cat', img: 'ğŸ±'}, {word: 'dog', img: 'ğŸ¶'}, {word: 'pig', img: 'ğŸ·'}]
    };

    let allLists = [];
    let historyLog = [];
    let studentName = "å°å°å­¸å“¡";
    let totalGems = 0;

    let currentQuizList = []; 
    let currentListId = null;
    let currentListName = "";
    let currentQIndex = 0;
    let score = 0;
    let correctCount = 0;
    let currentTargetWord = "";
    let editingListId = null;
    let timerInterval, startTime, pointsPerQuestion;

    window.onload = function() {
        loadData();
        renderLists();
        renderHistory();
        updateProfileDisplay();
    };

    function loadData() {
        const storedLists = localStorage.getItem('phonics_lists_v9');
        if (storedLists) { allLists = JSON.parse(storedLists); } 
        else { allLists = [DEFAULT_LIST]; saveListData(); }
        
        const storedHistory = localStorage.getItem('phonics_history_v9');
        if (storedHistory) { historyLog = JSON.parse(storedHistory); }
        
        const storedName = localStorage.getItem('phonics_student_name');
        if (storedName) studentName = storedName;

        const storedGems = localStorage.getItem('phonics_total_gems');
        if (storedGems) totalGems = parseInt(storedGems) || 0;
    }

    function saveListData() { localStorage.setItem('phonics_lists_v9', JSON.stringify(allLists)); }
    function saveHistoryData() { localStorage.setItem('phonics_history_v9', JSON.stringify(historyLog)); }
    function saveStudentData() { 
        localStorage.setItem('phonics_student_name', studentName); 
        localStorage.setItem('phonics_total_gems', totalGems);
        updateProfileDisplay();
    }
    
    function changeStudentName() {
        const newName = prompt("è«‹è¼¸å…¥å­¸å“¡åå­—ï¼š", studentName);
        if (newName && newName.trim() !== "") {
            studentName = newName.trim();
            saveStudentData();
        }
    }
    function updateProfileDisplay() { 
        document.getElementById('display-student-name').innerText = studentName; 
        let crowns = Math.floor(totalGems / 100);
        let remainGems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remainGems;
    }

    function showPage(pageId) {
        document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-home') { renderLists(); renderHistory(); updateProfileDisplay(); }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-quiz-content').style.display = tabName === 'quiz' ? 'block' : 'none';
        document.getElementById('tab-history-content').style.display = tabName === 'history' ? 'block' : 'none';
    }

    // --- åˆ—è¡¨èˆ‡åŒ¯å‡º ---
    function renderLists() {
        const container = document.getElementById('lists-container');
        container.innerHTML = '';
        allLists.forEach((list, index) => {
            let gemVal = list.gems ? list.gems : 5;
            let passVal = list.passScore ? list.passScore : 100;

            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <input type="checkbox" class="list-checkbox" data-index="${index}">
                <div class="list-content-wrapper">
                    <div class="list-header">
                        <div>
                            <strong>${list.name}</strong> <small>(${list.words.length}é¡Œ)</small>
                            <span class="gem-tag">ğŸ’ +${gemVal}</span>
                            <span class="score-tag">ğŸ¯ ${passVal}åˆ†</span>
                        </div>
                    </div>
                    <div class="list-actions">
                        <button class="btn-gold" onclick="showLeaderboard('${list.id}', '${list.name}')">ğŸ† æ¦œå–®</button>
                        <button class="btn-primary" onclick="startQuizSetup(${index})">é–‹å§‹</button>
                        <button class="btn-gray" onclick="editList(${index})">ç·¨è¼¯</button>
                        <button class="btn-danger" onclick="deleteList(${index})">åˆª</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.list-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    // ä¿®æ”¹ï¼šåŒ¯å‡ºåŒ…å«å­¸å“¡è³‡æ–™ (Backup)
    function exportSelectedData() {
        const checkboxes = document.querySelectorAll('.list-checkbox:checked');
        // å¦‚æœæ²’é¸ï¼Œå°±åŒ¯å‡ºå…¨éƒ¨
        let listsToExport = [];
        if (checkboxes.length === 0) {
            listsToExport = allLists;
        } else {
            checkboxes.forEach(cb => { listsToExport.push(allLists[parseInt(cb.dataset.index)]); });
        }

        const exportObj = {
            version: "9.0",
            student: { name: studentName, totalGems: totalGems },
            lists: listsToExport
        };

        const blob = new Blob([JSON.stringify(exportObj)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `phonics_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function triggerImport() { document.getElementById('import-file').click(); }
    
    // ä¿®æ”¹ï¼šåŒ¯å…¥æ”¯æ´æ–°æ ¼å¼
    function handleImportData(input) {
        const file = input.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(Array.isArray(data)) {
                    // èˆŠç‰ˆæ ¼å¼ (ç´”é™£åˆ—)
                    allLists = allLists.concat(data);
                    alert(`åŒ¯å…¥ ${data.length} å€‹é¡Œåº« (èˆŠæ ¼å¼)`);
                } else if (data.lists) {
                    // æ–°ç‰ˆæ ¼å¼
                    allLists = allLists.concat(data.lists);
                    if(data.student) {
                        if(confirm(`åŒ¯å…¥è³‡æ–™åŒ…å«å­¸å“¡ï¼š${data.student.name} (å¯¶çŸ³:${data.student.totalGems})ã€‚\nè¦è¦†è“‹ç›®å‰çš„é€²åº¦å—ï¼Ÿ`)) {
                            studentName = data.student.name;
                            totalGems = data.student.totalGems;
                            saveStudentData();
                        }
                    }
                    alert(`åŒ¯å…¥æˆåŠŸï¼`);
                }
                saveListData(); renderLists();
            } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); }
            input.value='';
        };
        r.readAsText(file);
    }

    // --- æ¸¬é©—é‚è¼¯ ---
    function startQuizSetup(index) {
        const list = allLists[index];
        currentListId = list.id; 
        currentListName = list.name;
        
        // ç´€éŒ„è©²æ¬¡æ¸¬é©—çš„è¨­å®š
        currentQuizList = [...list.words].sort(() => 0.5 - Math.random());
        // ç‚ºäº†ä¸è¦å¤ªé•·ï¼Œå–å‰10é¡Œï¼Œæˆ–å…¨éƒ¨
        const maxQ = Math.min(10, currentQuizList.length);
        currentQuizList = currentQuizList.slice(0, maxQ);
        
        pointsPerQuestion = Math.round(100 / currentQuizList.length);
        
        currentQIndex = 0; score = 0; correctCount = 0;
        
        startTime = Date.now();
        clearInterval(timerInterval); timerInterval = setInterval(updateTimer, 1000);
        
        speak(`æ­¡è¿${studentName}ï¼æ¸¬é©—é–‹å§‹ï¼`, true, 'zh-TW');
        loadQuestion(true);
        showPage('page-quiz');
    }

    function loadQuestion(isFirstQuestion = false) {
        const qData = currentQuizList[currentQIndex];
        currentTargetWord = qData.word;
        document.getElementById('q-progress').innerText = `é¡Œè™Ÿ: ${currentQIndex+1}/${currentQuizList.length}`;
        document.getElementById('q-score').innerText = `å¾—åˆ†: ${score}`;
        const imgBox = document.getElementById('q-image-box');
        if(qData.img.length>10) imgBox.innerHTML=`<img src="${qData.img}">`; else imgBox.innerHTML=`<span>${qData.img}</span>`;
        
        const ansArea = document.getElementById('answer-area'); ansArea.innerHTML='';
        for(let i=0; i<currentTargetWord.length; i++) {
            const slot=document.createElement('div'); slot.className='slot'; ansArea.appendChild(slot);
        }
        const poolArea = document.getElementById('pool-area'); poolArea.innerHTML='';
        let chars = currentTargetWord.split('').sort(() => 0.5 - Math.random());
        chars.forEach(char => poolArea.appendChild(createTile(char)));
        
        const delay = isFirstQuestion ? 3500 : 500;
        setTimeout(() => playTargetAudio(), delay);
    }

    function submitAnswer() {
        const userAns = getAnswerString().toLowerCase();
        const correctAns = currentTargetWord.toLowerCase();
        if(!userAns) { speak("è«‹å…ˆæ‹¼å­—",false,'zh-TW'); return; }
        
        if(userAns === correctAns) {
            score += pointsPerQuestion;
            correctCount++;
            if(currentQIndex===currentQuizList.length-1 && score>=98) score=100; // è£œæ­£èª¤å·®
            speak(`å¤ªæ£’äº†${studentName}ï¼Œç­”å°äº†ï¼`, true, 'zh-TW');
            setTimeout(()=>alert("âœ… ç­”å°äº†ï¼"),100);
        } else {
            speak(`${studentName}ï¼Œå†æ¥å†å²ï¼`, false, 'zh-TW');
            setTimeout(()=>alert("âŒ ç­”éŒ¯å›‰ï¼\næ­£ç¢ºæ‹¼æ³•: "+correctAns),100);
        }
        
        if(currentQIndex < currentQuizList.length-1) { 
            currentQIndex++; 
            loadQuestion(false);
        }
        else finishQuiz();
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        showPage('page-result');
        const timeStr = document.getElementById('q-timer').innerText;
        document.getElementById('final-score').innerText = score;
        document.getElementById('final-accuracy').innerText = `æ­£ç¢º: ${correctCount} / ${currentQuizList.length}`;
        document.getElementById('final-time').innerText = `ç¸½è€—æ™‚: ${timeStr}`;
        
        // --- çå‹µçµç®— ---
        const rewardArea = document.getElementById('reward-area');
        rewardArea.innerHTML = '';
        
        // æ‰¾å‡ºç›®å‰çš„é¡Œåº«è¨­å®š
        const listCfg = allLists.find(l => l.id === currentListId) || DEFAULT_LIST;
        let targetScore = listCfg.passScore || 100;
        let gemsReward = listCfg.gems || 5;

        if (score >= targetScore) {
            let oldGems = totalGems;
            let oldCrowns = Math.floor(oldGems / 100);
            
            totalGems += gemsReward;
            saveStudentData();
            
            let newCrowns = Math.floor(totalGems / 100);
            let earnedCrowns = newCrowns - oldCrowns;

            if (earnedCrowns > 0) {
                triggerRewardAnimation('crown');
                rewardArea.innerHTML = `
                    <div class="reward-popup" style="border-color:#e67e22; color:#e67e22;">
                        ğŸ‘‘ æ­å–œå‡ç´šï¼ç²å¾— ${earnedCrowns} é ‚çš‡å† ï¼<br>
                        (åŒæ™‚ç²å¾— ${gemsReward} é¡†å¯¶çŸ³)
                    </div>`;
                speak(`å¤ªå²å®³äº†ï¼åˆ†æ•¸é”æ¨™ï¼æ­å–œä½ ç²å¾—äº† ${earnedCrowns} é ‚çš‡å† ï¼`, true, 'zh-TW');
            } else {
                triggerRewardAnimation('gem');
                rewardArea.innerHTML = `
                    <div class="reward-popup">
                        ğŸ‰ æ­å–œé”æ¨™ï¼ç²å¾— ${gemsReward} é¡†å¯¶çŸ³ ğŸ’<br>
                        ç›®å‰ç´¯ç©: ${totalGems} é¡†
                    </div>`;
                speak(`å¤ªæ£’äº†ï¼åˆ†æ•¸é”æ¨™ï¼ä½ ç²å¾—äº† ${gemsReward} é¡†å¯¶çŸ³ï¼`, true, 'zh-TW');
            }
            document.getElementById('final-msg').innerText = "å¤ªç¥äº†ï¼ä½ æ˜¯æ‹¼å­—å¤§å¸«ï¼ğŸ†";
        } else {
            let msg = score>=60?"å¾ˆä¸éŒ¯ï¼Œå†å¤šç·´ç¿’ä¸€ä¸‹æŒ‘æˆ°å¯¶çŸ³ï¼":"å®Œæˆæ¸¬é©—å°±æ˜¯é€²æ­¥ï¼åŠ æ²¹ï¼";
            document.getElementById('final-msg').innerText = msg;
            speak(`æ¸¬é©—çµæŸï¼Œ${studentName}å¾—äº†${score}åˆ†ã€‚${msg}`, true, 'zh-TW');
        }

        const record = { user:studentName, date:new Date().toLocaleString(), score:score, time:timeStr, listId:currentListId, listName:currentListName };
        historyLog.unshift(record);
        saveHistoryData();
    }

    // --- å‹•ç•«ç‰¹æ•ˆ ---
    function triggerRewardAnimation(type) {
        const container = document.getElementById('particle-container');
        container.style.display = 'block';
        container.innerHTML = ''; 

        let symbol = type === 'crown' ? 'ğŸ‘‘' : 'ğŸ’';
        let count = 30; 

        for (let i = 0; i < count; i++) {
            let p = document.createElement('div');
            p.innerText = symbol;
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (Math.random() * 2 + 1) + 's'; 
            p.style.fontSize = (Math.random() * 2 + 1) + 'rem';
            container.appendChild(p);
        }

        setTimeout(() => {
            container.style.display = 'none';
            container.innerHTML = '';
        }, 3000);
    }

    // --- Tile Logic (iPad Fix) ---
    function createTile(c) {
        const t = document.createElement('div'); t.className = 'tile'; t.innerText = c;
        t.addEventListener('mousedown', handleDragStartMouse);
        t.addEventListener('touchstart', handleTouchStart, {passive: false});
        t.addEventListener('touchmove', handleTouchMove, {passive: false});
        t.addEventListener('touchend', handleTouchEnd);
        return t;
    }
    
    function handleDragStartMouse(e) { e.preventDefault(); initDrag(e.target, e.clientX, e.clientY, 'mouse'); }

    let activeTouchId=null, touchStartX=0, touchStartY=0, isDragging=false, currentGhost=null, currentTile=null, touchOffsetX=0, touchOffsetY=0;

    function handleTouchStart(e) {
        if (e.touches.length > 1) return;
        e.preventDefault();
        const touch = e.touches[0]; activeTouchId = touch.identifier;
        touchStartX = touch.clientX; touchStartY = touch.clientY;
        currentTile = e.target; isDragging = false;
        const rect = currentTile.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left; touchOffsetY = touch.clientY - rect.top;
    }
    function handleTouchMove(e) {
        const touch = Array.from(e.touches).find(t => t.identifier === activeTouchId); if (!touch) return;
        const cx = touch.clientX; const cy = touch.clientY;
        if (!isDragging && (Math.abs(cx - touchStartX) > 10 || Math.abs(cy - touchStartY) > 10)) {
            isDragging = true; createGhost(currentTile, cx, cy);
        }
        if (isDragging && currentGhost) { currentGhost.style.left = (cx - touchOffsetX) + 'px'; currentGhost.style.top = (cy - touchOffsetY) + 'px'; }
    }
    function handleTouchEnd(e) {
        const touch = Array.from(e.changedTouches).find(t => t.identifier === activeTouchId); if (!touch) return;
        if (!isDragging) { handleTileClick(currentTile); } else { finishDrag(touch.clientX, touch.clientY); }
        if (currentGhost) { currentGhost.remove(); currentGhost = null; }
        if (currentTile) { currentTile.classList.remove('placeholder'); currentTile = null; }
        activeTouchId = null;
    }

    function createGhost(tile, x, y) {
        currentGhost = tile.cloneNode(true); currentGhost.classList.add('dragging');
        currentGhost.style.width = tile.offsetWidth + 'px'; currentGhost.style.height = tile.offsetHeight + 'px';
        currentGhost.style.left = (x - touchOffsetX) + 'px'; currentGhost.style.top = (y - touchOffsetY) + 'px';
        document.body.appendChild(currentGhost); tile.classList.add('placeholder');
    }
    function finishDrag(x, y) {
        if(currentGhost) currentGhost.style.display = 'none';
        const elBelow = document.elementFromPoint(x, y);
        const slot = elBelow ? elBelow.closest('.slot') : null;
        const pool = elBelow ? elBelow.closest('.pool-area') : null;
        if (slot) {
            if (slot.children.length > 0) document.getElementById('pool-area').appendChild(slot.children[0]);
            slot.appendChild(currentTile); speak(currentTile.innerText, false, 'en-US');
        } else if (pool) { pool.appendChild(currentTile); }
    }
    function initDrag(tile, startX, startY, type) {
        currentTile = tile; const rect = tile.getBoundingClientRect();
        touchOffsetX = startX - rect.left; touchOffsetY = startY - rect.top;
        createGhost(tile, startX, startY);
        function onMouseMove(e) { currentGhost.style.left = (e.clientX - touchOffsetX) + 'px'; currentGhost.style.top = (e.clientY - touchOffsetY) + 'px'; }
        function onMouseUp(e) {
            document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp);
            finishDrag(e.clientX, e.clientY);
            if(currentGhost) { currentGhost.remove(); currentGhost = null; }
            if(currentTile) { currentTile.classList.remove('placeholder'); currentTile = null; }
        }
        document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
    }
    function handleTileClick(tile) {
        const aa = document.getElementById('answer-area'); const pa = document.getElementById('pool-area');
        if (tile.parentElement === pa) {
            const empty = Array.from(aa.children).find(s => s.children.length === 0);
            if (empty) { empty.appendChild(tile); speak(tile.innerText, false, 'en-US'); }
        } else { pa.appendChild(tile); }
    }

    // --- Editor Logic ---
    function createNewList() { 
        editingListId=null; 
        document.getElementById('list-name-input').value="æ–°é¡Œåº«"; 
        document.getElementById('list-gems').value = 5;
        document.getElementById('list-pass-score').value = 100;
        document.getElementById('editor-rows').innerHTML=''; 
        for(let i=0;i<3;i++)addEditRow(); 
        showPage('page-editor'); 
    }
    function editList(index) { 
        editingListId=index; const l=allLists[index]; 
        document.getElementById('list-name-input').value=l.name; 
        document.getElementById('list-gems').value=l.gems || 5;
        document.getElementById('list-pass-score').value=l.passScore || 100;
        document.getElementById('editor-rows').innerHTML=''; 
        l.words.forEach(w=>addEditRow(w.word,w.img)); 
        showPage('page-editor'); 
    }
    function addEditRow(w='',i='') { const d=document.createElement('div'); d.className='edit-row'; let disp=i||'ğŸ“·'; if(i&&i.length>10) disp=`<img src="${i}" style="width:100%;height:100%;object-fit:cover;">`; d.innerHTML=`<div class="thumb-preview" onclick="this.nextElementSibling.click()">${disp}</div><input type="file" class="file-input" accept="image/*" onchange="handleFileSelect(this)"><input type="hidden" class="img-data" value="${i}"><input type="text" class="word-input" placeholder="è‹±æ–‡å–®å­—" value="${w}"><button onclick="this.parentElement.remove()" class="btn-danger" style="padding:5px 10px;">Ã—</button>`; document.getElementById('editor-rows').appendChild(d); }
    function handleFileSelect(input) { if(input.files[0]){ const r=new FileReader(); r.onload=(e)=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); const s=300/i.width; c.width=300; c.height=i.height*s; ctx.drawImage(i,0,0,c.width,c.height); const d=c.toDataURL('image/jpeg',0.7); input.previousElementSibling.innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`; input.nextElementSibling.value=d; }; }; r.readAsDataURL(input.files[0]); } }
    function saveList() { 
        const n=document.getElementById('list-name-input').value; 
        const g=parseInt(document.getElementById('list-gems').value) || 5;
        const p=parseInt(document.getElementById('list-pass-score').value) || 100;
        
        const rs=document.querySelectorAll('.edit-row'); const nws=[]; rs.forEach(r=>{ const i=r.querySelector('.img-data').value; const w=r.querySelector('.word-input').value.trim().toLowerCase(); if(w) nws.push({word:w, img:i||'â“'}); }); if(nws.length<1) return alert("è«‹è¼¸å…¥å–®å­—"); 
        const nd={id:editingListId!==null?allLists[editingListId].id:Date.now().toString(),name:n,gems:g,passScore:p,words:nws}; 
        if(editingListId!==null) allLists[editingListId]=nd; else allLists.push(nd); saveListData(); showPage('page-home'); 
    }
    function deleteList(i) { if(confirm("åˆªé™¤ï¼Ÿ")){allLists.splice(i,1);saveListData();renderLists();} }
    function updateTimer() { const d=Math.floor((Date.now()-startTime)/1000); const m=Math.floor(d/60).toString().padStart(2,'0'); const s=(d%60).toString().padStart(2,'0'); document.getElementById('q-timer').innerText=`${m}:${s}`; }
    function resetCurrentTiles() { document.querySelectorAll('.answer-area .tile').forEach(t=>document.getElementById('pool-area').appendChild(t)); }
    function getAnswerString() { let a=""; document.querySelectorAll('.slot').forEach(s=>{if(s.children.length>0)a+=s.children[0].innerText}); return a; }
    function playTargetAudio() { speak(currentTargetWord,false,'en-US'); }
    function speakUserSpelling() { const t=getAnswerString(); if(t)speak(t,false,'en-US'); else speak("è«‹å…ˆæ‹¼å­—",false,'zh-TW'); }
    function speak(t,e,l) { if('speechSynthesis' in window){window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang=l; u.rate=1; if(e)u.pitch=1.2; window.speechSynthesis.speak(u);} }
    function quitQuiz() { if(confirm("ç¢ºå®šé€€å‡ºï¼Ÿ")){clearInterval(timerInterval);showPage('page-home');} }
    function renderHistory() { const c=document.getElementById('history-container'); c.innerHTML=''; if(historyLog.length===0){c.innerHTML='<p style="text-align:center;color:#999">ç„¡ç´€éŒ„</p>';return;} historyLog.forEach((l,i)=>{const d=document.createElement('div'); d.className='history-item'; d.innerHTML=`<div class="history-info"><span class="history-title">ğŸ“˜ ${l.listName||'æœªçŸ¥é¡Œåº«'}</span><span class="history-user">ğŸ‘¤ ${l.user}</span><span class="history-date">ğŸ“… ${l.date} | â± ${l.time}</span></div><div style="text-align:right"><span class="history-score">${l.score} åˆ†</span><button class="delete-history-btn" style="margin-top:5px;float:right" onclick="deleteHistoryItem(${i})">Ã—</button></div>`; c.appendChild(d);}); }
    function deleteHistoryItem(i) { if(confirm("åˆªé™¤ï¼Ÿ")){historyLog.splice(i,1);saveHistoryData();renderHistory();} }
    function clearAllHistory() { if(confirm("æ¸…ç©ºï¼Ÿ")){historyLog=[];saveHistoryData();renderHistory();} }
    function showLeaderboard(listId, listName) { document.getElementById('lb-title').innerText = `ğŸ† ${listName} - è‹±é›„æ¦œ`; const container = document.getElementById('lb-container'); container.innerHTML = ''; let listLogs = historyLog.filter(log => log.listId === listId); listLogs.sort((a, b) => { if (b.score !== a.score) return b.score - a.score; return a.time.localeCompare(b.time); }); if (listLogs.length === 0) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">é‚„æ²’æœ‰äººæŒ‘æˆ°éé€™å€‹é¡Œåº«ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€åï¼</p>'; } else { listLogs.forEach((log, index) => { const rank = index + 1; let rankClass = ''; let rankDisplay = rank; if (rank === 1) { rankClass = 'rank-1'; rankDisplay = 'ğŸ†'; } else if (rank === 2) rankClass = 'rank-2'; else if (rank === 3) rankClass = 'rank-3'; const div = document.createElement('div'); div.className = `rank-item ${rankClass}`; div.innerHTML = `<div class="rank-num">${rankDisplay}</div><div class="rank-info"><span class="rank-user">${log.user}</span><span class="rank-detail">${log.date}</span></div><div class="rank-score">${log.score}åˆ† <br><small style="color:#666;font-weight:normal">${log.time}</small></div>`; container.appendChild(div); }); } showPage('page-leaderboard'); }

</script>

</body>
</html>
