<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ æ¸›æ³•é—–é—œç‹ 1.0 (å¯¶çŸ³çå‹µç‰ˆ)</title>
    <style>
        :root {
            --primary: #e67e22; /* åŠ æ¸›æ³•ä½¿ç”¨æ©˜è‰²ç³» */
            --secondary: #f39c12;
            --light: #fdfefe;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f;
            --help: #8e44ad;
            
            --hint-carry: #e74c3c; /* é€²å€Ÿä½é¡è‰² */
            --font-base: 1.2rem;
            --cell-size: 50px;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #fff5e6; /* æ·ºæ©˜èƒŒæ™¯ */
            color: var(--dark);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 10px 0 20px 0; text-align: center; font-size: 2rem; }

        /* --- å­¸å“¡åç‰Œ --- */
        .user-profile {
            background-color: #fff;
            border: 2px dashed var(--primary);
            border-radius: 15px;
            padding: 10px 25px;
            margin-bottom: 25px;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--dark);
            display: flex; align-items: center; gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.2);
        }
        .stats-badge {
            background: #fdf2e9;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px;
        }

        /* --- Tabs --- */
        .tabs { 
            display: flex; gap: 15px; margin-bottom: 25px; 
            background: #fff; padding: 5px; border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab { 
            flex: 1; text-align: center; padding: 12px 30px; 
            cursor: pointer; color: #95a5a6; font-weight: bold; font-size: 1.2rem;
            border-radius: 25px; transition: all 0.3s ease;
        }
        .tab.active { 
            color: white; background-color: var(--primary); 
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); transform: scale(1.05);
        }

        /* --- å®¹å™¨ --- */
        .container {
            width: 100%; max-width: 900px; background: white; border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 20px;
            display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* --- æŒ‰éˆ• --- */
        button {
            border: none; border-radius: 10px; padding: 12px 24px; 
            font-size: 1.1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 5px; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-help { background-color: var(--help); }
        .btn-gray { background-color: #95a5a6; }
        .btn-accent { background-color: #d35400; }
        .btn-block { width: 100%; padding: 15px; margin-top: 15px; font-size: 1.3rem; }

        /* --- åˆ—è¡¨ --- */
        .list-item {
            background: #fdf2e9; border: 2px solid #fae5d3; padding: 15px; margin-bottom: 15px;
            border-radius: 12px; display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem;
        }
        .list-info small { color: #c0392b; font-weight: bold; display: block; margin-top: 5px;}
        .gem-tag { color: #2980b9; font-weight: bold; background: #d6eaf8; padding: 2px 8px; border-radius: 10px; font-size: 0.95rem; margin-left: 5px;}
        .teach-gem-tag { color: #27ae60; font-weight: bold; background: #d5f5e3; padding: 2px 8px; border-radius: 10px; font-size: 0.95rem; margin-left: 5px;}
        .score-tag { color: #d35400; font-weight: bold; background: #fdebd0; padding: 2px 8px; border-radius: 10px; font-size: 0.95rem; margin-left: 5px;}
        
        /* --- ç·¨è¼¯å€ --- */
        .gen-controls { 
            display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; 
            background: #fef9e7; padding: 15px; border-radius: 10px; font-size: 1.1rem; border: 1px solid #f9e79f;
        }
        .gen-controls input, .gen-controls select { padding: 8px; text-align: center; font-size: 1.1rem; border-radius: 5px; border: 1px solid #ccc;}
        .edit-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; justify-content: center;}
        .edit-row input, .edit-row select { padding: 10px; width: 100px; text-align: center; font-size: 1.2rem; border-radius: 5px; border: 1px solid #ccc; }

        /* --- è¨­å®šé¸é … --- */
        .settings-box {
            background-color: #fef9e7; border: 2px solid #f9e79f; border-radius: 10px;
            padding: 15px; margin-bottom: 20px; text-align: left;
        }
        .checkbox-group { display: flex; gap: 20px; justify-content: center; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; cursor: pointer; }
        .checkbox-item input { width: 22px; height: 22px; cursor: pointer; }

        /* --- æ¸¬é©—å€ --- */
        .quiz-header { 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; margin-bottom: 20px; background: #eee; padding: 15px; border-radius: 10px; 
            font-size: 1.3rem;
        }
        #q-timer { font-family: monospace; font-size: 1.5rem; color: #2c3e50; }
        .timer-urgent { color: #c0392b !important; animation: blink 1s infinite; font-weight: 900; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* --- ç›´å¼é‹ç®— Grid --- */
        .grid-container {
            display: grid; justify-content: center; margin: 20px 0; gap: 0;
            /* å‹•æ…‹è¨­å®š column æ•¸ */
        }
        .grid-cell {
            width: var(--cell-size); height: var(--cell-size);
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.8rem;
            position: relative;
        }
        .op-cell { font-size: 1.5rem; color: var(--dark); }
        .line-cell { border-bottom: 3px solid #333; }
        
        /* è¼¸å…¥æ¡† */
        .game-input { 
            width: 40px; height: 40px; font-size: 1.5rem; text-align: center; 
            border: 2px solid var(--secondary); border-radius: 8px; background: #fff;
            font-weight: bold; outline: none; padding: 0; z-index: 10;
        }
        .game-input.active-input {
            background-color: #fff3cd !important; border-color: #e67e22; box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        }
        /* é€²ä½/å€Ÿä½è¼”åŠ©æ ¼ (è¼ƒå°) */
        .carry-input {
            width: 30px; height: 30px; font-size: 1rem; text-align: center;
            border: 1px solid #bdc3c7; border-radius: 50%; background: #f4f6f7; 
            color: var(--hint-carry); position: absolute; bottom: 5px; z-index: 5;
        }
        
        /* æ±‚åŠ© */
        .help-box {
            display: none; background-color: #e8f6f3; border-left: 6px solid #2ecc71;
            padding: 15px; margin-top: 15px; border-radius: 8px; text-align: left;
            font-size: 1.1rem; line-height: 1.6; animation: slideDown 0.3s;
        }
        @keyframes slideDown { from{opacity:0; transform: translateY(-10px);} to{opacity:1; transform: translateY(0);} }

        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 1.1rem; }
        .result-table th { background-color: #f2f2f2; }
        .res-correct { color: var(--success); font-weight: bold; }
        .res-wrong { color: var(--danger); font-weight: bold; }

        .version-tag { margin-top: 30px; color: #bdc3c7; font-size: 0.9rem; text-align: center; font-family: monospace; border-top: 1px dashed #eee; padding-top: 10px; }
        
        /* --- çå‹µå…Œæ›å€ --- */
        .shop-balance {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white; padding: 20px; border-radius: 15px; text-align: center;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .shop-balance h3 { color: white; margin: 0 0 10px 0; font-weight: normal; font-size: 1rem; opacity: 0.9; }
        .balance-row { display: flex; justify-content: center; gap: 20px; font-size: 1.5rem; font-weight: bold; }
        
        .exchange-form { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .exchange-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .exchange-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; text-align: center; }
        .exchange-select { padding: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; background: white; }
        .log-list { max-height: 200px; overflow-y: auto; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 0.9rem; color: #666; }
        .log-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }

        /* å‹•ç•« */
        .reward-popup {
            background: #fff8e1; border: 3px solid #f1c40f; padding: 20px;
            border-radius: 15px; margin-top: 20px; font-weight: bold; color: #d35400;
            font-size: 1.5rem; text-align: center;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
            animation: bounceIn 0.8s;
        }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
        
        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; display: none; }
        .particle { position: absolute; font-size: 2rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>â•â– åŠ æ¸›æ³•é—–é—œç‹</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡å§“å</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <button class="btn-accent btn-block" style="margin-bottom:15px; box-shadow:0 4px #a04000;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥å‚™ä»½</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>

        <div class="version-tag">ç‰ˆæœ¬ï¼šv1.0 (å¯¶çŸ³çå‹µç‰ˆ)</div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›å•†åº—</h2>
        <div class="shop-balance">
            <h3>ç›®å‰æŒæœ‰</h3>
            <div class="balance-row">
                <span>ğŸ‘‘ <span id="shop-crowns">0</span></span>
                <span>ğŸ’ <span id="shop-gems">0</span></span>
            </div>
        </div>
        <div class="exchange-form">
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">æˆ‘è¦å…Œæ›...</div>
            <div class="exchange-row">
                <input type="text" id="gift-name" class="exchange-input" placeholder="çå“åç¨± (å¦‚: ç©éŠæˆ²10åˆ†é˜)">
            </div>
            <div style="text-align:center; margin-bottom:10px; color:#555; font-weight:bold;">éœ€è¦èŠ±è²»</div>
            <div class="exchange-row">
                <input type="number" id="gift-cost" class="exchange-input" placeholder="æ•¸é‡" min="1">
                <select id="gift-currency" class="exchange-select">
                    <option value="gems">ğŸ’ å¯¶çŸ³</option>
                    <option value="crowns">ğŸ‘‘ çš‡å† </option>
                </select>
            </div>
            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>
        <div style="margin-top:20px;">
            <h4>ğŸ“œ å…Œæ›ç´€éŒ„</h4>
            <div id="exchange-log" class="log-list"></div>
        </div>
        <button class="btn-gray btn-block" style="margin-top:20px;" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="margin-bottom:15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background:#fff8e1; padding:15px; border-radius:10px;">
            <div style="flex:100%">åç¨±: <input type="text" id="list-name" style="padding:8px; width:70%; font-size:1.1rem;"></div>
            <div>â±ï¸ é™æ™‚(ç§’): <input type="number" id="list-timer" placeholder="0" style="padding:8px; width:70px;" value="0"></div>
            <div>ğŸ’ æ¸¬é©—å¯¶çŸ³: <input type="number" id="list-gems" placeholder="5" style="padding:8px; width:60px;" value="5"></div>
            <div>ğŸ’ æ•™å­¸å¯¶çŸ³: <input type="number" id="list-teach-gems" placeholder="2" style="padding:8px; width:60px;" value="2"></div>
            <div>ğŸ¯ ç²çåˆ†æ•¸: <input type="number" id="list-pass-score" placeholder="100" style="padding:8px; width:60px;" value="100"></div>
        </div>
        <div class="gen-controls">
            <span><strong>è‡ªå‹•ç”Ÿæˆ:</strong></span>
            <select id="gen-op" style="padding:5px;"><option value="+">åŠ æ³• (+)</option><option value="-">æ¸›æ³• (-)</option></select>
            é¡Œæ•¸<input type="number" id="gen-count" value="5" style="width:50px;">
            è¢«åŠ /æ¸›æ•¸ä½æ•¸<input type="number" id="gen-int-a" value="2" style="width:50px;">
            åŠ /æ¸›æ•¸ä½æ•¸<input type="number" id="gen-int-b" value="2" style="width:50px;">
            å°æ•¸ä½æ•¸<input type="number" id="gen-dec" value="0" style="width:50px;">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>
        <div id="editor-rows" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        <div style="margin-top:25px; display:flex; gap:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div class="settings-box">
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º</label>
                <label class="checkbox-item"><input type="checkbox" id="opt-text" checked> ğŸ“ æ–‡å­—æç¤º</label>
            </div>
        </div>
        <div style="text-align: center;">
            <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– é€²å…¥æ•™å­¸æ¨¡å¼</button>
            <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ é€²å…¥æ¸¬é©—æ¨¡å¼</button>
            <button class="btn-gray" onclick="showPage('page-home')" style="margin-top:30px;">è¿”å›</button>
        </div>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <button class="btn-danger" onclick="quitQuiz()">ğŸšª é€€å‡º</button>
        </div>

        <div style="text-align: center; margin-bottom: 10px;">
            <div id="teach-msg" style="color:#d35400; font-weight:bold; font-size:1.3rem; min-height:3rem;"></div>
            <div style="margin: 10px 0;">
                <button id="btn-help" class="btn-help" onclick="toggleHelp()">ğŸ’¡ æ±‚åŠ©ï¼šé€™ä¸€æ­¥æ€éº¼ç®—ï¼Ÿ</button>
                <div id="help-content" class="help-box"></div>
            </div>
        </div>

        <div class="grid-container" id="gridBoard"></div>

        <div style="text-align: center;">
            <button id="btn-next-q" class="btn-success" style="display:none; margin-top:20px; font-size:1.5rem; border-radius:30px; padding:10px 30px;" onclick="goToNextQuestion()">ğŸ‰ å®Œæˆï¼ä¸‹ä¸€é¡Œ â¡</button>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align: center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size: 4rem; color: var(--primary); font-weight: bold;" id="res-score">100</div>
            <div id="res-summary" style="font-size: 1.5rem; margin-bottom: 15px;"></div>
            
            <div id="reward-area"></div>

            <div style="max-height: 300px; overflow-y: auto;">
                <table class="result-table">
                    <thead><tr><th>é¡Œç›®</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>çµæœ</th></tr></thead>
                    <tbody id="res-table-body"></tbody>
                </table>
            </div>

            <button class="btn-warning btn-block" onclick="saveRank()">ç™»è¨˜è‹±é›„æ¦œ</button>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let studentName = "å°å°å­¸å“¡";
    let totalGems = 0;
    let allLists = [], currentList = null, quizData = [];
    let currentQIdx = 0, currentMode = '';
    let timerInt, startTime, limitSeconds = 0;
    let rankData = [], exchangeLog = [];
    let quizSettings = { voice: true, text: true };
    
    const STORAGE_PREFIX = 'addsub_v1_';

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        loadData();
        updateProfile();
        renderLists();
    };

    function loadData() {
        if(localStorage.getItem(STORAGE_PREFIX + 'lists')) allLists = JSON.parse(localStorage.getItem(STORAGE_PREFIX + 'lists'));
        else { 
            // é è¨­é¡Œåº«
            allLists = [{name: "åŸºç¤åŠ æ³•ç·´ç¿’", timer:0, gems:5, teachGems:2, passScore:100, qs: genQs('+', 5, 2, 2, 0)}]; 
            saveData(); 
        }
        if(localStorage.getItem(STORAGE_PREFIX + 'rank')) rankData = JSON.parse(localStorage.getItem(STORAGE_PREFIX + 'rank'));
        if(localStorage.getItem(STORAGE_PREFIX + 'student')) studentName = localStorage.getItem(STORAGE_PREFIX + 'student');
        if(localStorage.getItem(STORAGE_PREFIX + 'gems')) totalGems = parseInt(localStorage.getItem(STORAGE_PREFIX + 'gems')) || 0;
        if(localStorage.getItem(STORAGE_PREFIX + 'exchange')) exchangeLog = JSON.parse(localStorage.getItem(STORAGE_PREFIX + 'exchange'));
    }

    function saveData() { localStorage.setItem(STORAGE_PREFIX + 'lists', JSON.stringify(allLists)); }
    function saveStudentData() {
        localStorage.setItem(STORAGE_PREFIX + 'student', studentName);
        localStorage.setItem(STORAGE_PREFIX + 'gems', totalGems);
        localStorage.setItem(STORAGE_PREFIX + 'exchange', JSON.stringify(exchangeLog));
        updateProfile();
    }

    // --- èªéŸ³ ---
    function speak(text) {
        let force = text.includes("å¯¶çŸ³") || text.includes("çš‡å† ") || text.includes("å…¨å°") || text.includes("æ™‚é–“");
        if(currentMode === 'teach' && !quizSettings.voice && !force) return;
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            // å„ªåŒ–è®€éŸ³
            let clean = text.replace(/<[^>]*>/g, '').replace(/-/g, 'æ¸›').replace(/\+/g, 'åŠ ').replace(/\./g, 'é»');
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'zh-TW'; u.rate = 1.0; 
            window.speechSynthesis.speak(u);
        }
    }

    // --- UI åˆ‡æ› ---
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
    }

    function updateProfile() {
        document.getElementById('display-name').innerText = studentName;
        let crowns = Math.floor(totalGems / 100);
        let remainGems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = remainGems;
        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = crowns;
            document.getElementById('shop-gems').innerText = remainGems;
        }
    }
    function changeName() {
        let n = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", studentName);
        if(n && n.trim()) { studentName = n.trim(); saveStudentData(); }
    }

    // --- é¡Œåº«ç®¡ç† ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        allLists.forEach((l,i) => {
            const d = document.createElement('div'); d.className='list-item';
            let timerInfo = l.timer > 0 ? `<small>â±ï¸ é™æ™‚ ${l.timer} ç§’</small>` : '';
            let g = l.gems||5; let tg = l.teachGems||2; let p = l.passScore||100;
            d.innerHTML = `
                <div>
                    <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                    <div style="margin-top:5px;">
                        <span class="gem-tag">ğŸ’æ¸¬é©—+${g}</span>
                        <span class="teach-gem-tag">ğŸ’æ•™å­¸+${tg}</span>
                        <span class="score-tag">ğŸ¯ ${p}åˆ†</span>
                    </div>
                    ${timerInfo}
                </div>
                <div>
                    <button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                    <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                    <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                </div>`;
            c.appendChild(d);
        });
    }
    let editingId = null;
    function createNewList() { 
        editingId=null; document.getElementById('list-name').value="æ–°é¡Œåº«"; 
        document.getElementById('editor-rows').innerHTML=''; 
        showPage('page-editor'); 
    }
    function editList(i) {
        editingId=i; const l=allLists[i];
        document.getElementById('list-name').value = l.name;
        document.getElementById('list-gems').value = l.gems||5;
        document.getElementById('list-teach-gems').value = l.teachGems||2;
        document.getElementById('list-pass-score').value = l.passScore||100;
        document.getElementById('list-timer').value = l.timer||0;
        document.getElementById('editor-rows').innerHTML='';
        l.qs.forEach(q => addEditRow(q.op, q.a, q.b));
        showPage('page-editor');
    }
    function addEditRow(op='+', a='', b='') {
        const d = document.createElement('div'); d.className='edit-row';
        d.innerHTML = `
            <select class="inp-op"><option value="+" ${op==='+'?'selected':''}>+</option><option value="-" ${op==='-'?'selected':''}>-</option></select>
            <input type="number" class="inp-a" value="${a}" step="any">
            <input type="number" class="inp-b" value="${b}" step="any">
            <button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('editor-rows').appendChild(d);
    }
    function autoGenerate() {
        const count = parseInt(document.getElementById('gen-count').value);
        const intA = parseInt(document.getElementById('gen-int-a').value);
        const intB = parseInt(document.getElementById('gen-int-b').value);
        const dec = parseInt(document.getElementById('gen-dec').value);
        const op = document.getElementById('gen-op').value;
        const box = document.getElementById('editor-rows'); box.innerHTML='';
        let newQs = genQs(op, count, intA, intB, dec);
        newQs.forEach(q => addEditRow(q.op, q.a, q.b));
    }
    function genQs(op, count, intA, intB, dec) {
        let qs = [];
        for(let i=0; i<count; i++) {
            let factor = Math.pow(10, dec);
            let minA = Math.pow(10, intA-1), maxA = Math.pow(10, intA)-1;
            let minB = Math.pow(10, intB-1), maxB = Math.pow(10, intB)-1;
            
            let aVal = Math.floor(Math.random()*(maxA-minA+1)) + minA;
            let bVal = Math.floor(Math.random()*(maxB-minB+1)) + minB;
            
            // å°æ•¸è™•ç†
            if(dec > 0) {
                aVal = (aVal + Math.random()).toFixed(dec);
                bVal = (bVal + Math.random()).toFixed(dec);
            }
            
            // æ¸›æ³•é¿å…è² æ•¸ (for primary level)
            if (op === '-' && parseFloat(aVal) < parseFloat(bVal)) {
                [aVal, bVal] = [bVal, aVal];
            }
            qs.push({op, a: aVal, b: bVal});
        }
        return qs;
    }
    function saveList() {
        const name = document.getElementById('list-name').value;
        const gems = parseInt(document.getElementById('list-gems').value)||5;
        const teachGems = parseInt(document.getElementById('list-teach-gems').value)||2;
        const passScore = parseInt(document.getElementById('list-pass-score').value)||100;
        const timer = parseInt(document.getElementById('list-timer').value)||0;
        
        const rows = document.querySelectorAll('.edit-row');
        const qs = [];
        rows.forEach(r => {
            const op = r.querySelector('.inp-op').value;
            const a = r.querySelector('.inp-a').value;
            const b = r.querySelector('.inp-b').value;
            if(a && b) qs.push({op, a, b});
        });
        if(qs.length===0) return alert("è‡³å°‘ä¸€é¡Œ");
        const data = {name, timer, gems, teachGems, passScore, qs};
        if(editingId===null) allLists.push(data); else allLists[editingId]=data;
        saveData(); showPage('page-home');
    }
    function delList(i) { if(confirm("åˆªé™¤ï¼Ÿ")){allLists.splice(i,1); saveData(); renderLists();} }
    
    // --- åŒ¯å…¥åŒ¯å‡º ---
    function exportData() {
        const obj = { version: "1.0", student: {name: studentName, totalGems}, lists: allLists, exchangeLog };
        const blob = new Blob([JSON.stringify(obj)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `addsub_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }
    function handleImport(inp) {
        const f=inp.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=(e)=>{
            try {
                const d = JSON.parse(e.target.result);
                if(d.lists) allLists = allLists.concat(d.lists);
                if(d.student && confirm("åŒ¯å…¥å­¸å“¡è³‡æ–™ï¼Ÿ")) { studentName=d.student.name; totalGems=d.student.totalGems; exchangeLog=d.exchangeLog||[]; saveStudentData(); }
                saveData(); renderLists(); alert("åŒ¯å…¥æˆåŠŸ");
            } catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f);
    }

    // --- æ¸¬é©—æ ¸å¿ƒ ---
    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }

    function startQuiz(mode) {
        currentMode = mode;
        if(mode === 'teach') {
            quizSettings.voice = document.getElementById('opt-voice').checked;
            quizSettings.text = document.getElementById('opt-text').checked;
        }
        
        // åˆå§‹åŒ–é¡Œç›®
        quizData = currentList.qs.map(q => prepareQuestionData(q));
        if(mode === 'test') {
            // æ¸¬é©—æ¨¡å¼æ‰“äº‚é †åº
            quizData.sort(() => Math.random() - 0.5);
        }

        currentQIdx = 0;
        limitSeconds = currentList.timer || 0;
        startTime = Date.now();
        isWarningPlayed = false;
        document.getElementById('q-timer').classList.remove('timer-urgent');

        clearInterval(timerInt); 
        timerInt = setInterval(updTime, 1000);
        updTime();

        showPage('page-quiz');
        speak("æº–å‚™é–‹å§‹å›‰ï¼");
        loadQuestion();
    }

    function updTime() {
        let elapsed = Math.floor((Date.now()-startTime)/1000);
        if (limitSeconds > 0) {
            let remaining = limitSeconds - elapsed;
            if (remaining <= 0) { finishQuiz(true); return; }
            let mm = Math.floor(remaining / 60).toString().padStart(2,'0');
            let ss = (remaining % 60).toString().padStart(2,'0');
            document.getElementById('q-timer').innerText = `${mm}:${ss}`;
            if (remaining <= 10) {
                document.getElementById('q-timer').classList.add('timer-urgent');
                if (!isWarningPlayed) { speak("æ™‚é–“å¿«åˆ°äº†ï¼"); isWarningPlayed = true; }
            }
        } else {
            let d = new Date(elapsed * 1000);
            document.getElementById('q-timer').innerText = d.toISOString().substr(14, 5);
        }
    }

    // --- è³‡æ–™çµæ§‹æº–å‚™ (å°é½Šä½æ•¸) ---
    function prepareQuestionData(rawQ) {
        // è½‰å­—ä¸²ï¼Œæ‰¾å°æ•¸é»ä½ç½®
        let sA = rawQ.a.toString();
        let sB = rawQ.b.toString();
        let aDecIdx = sA.indexOf('.');
        let bDecIdx = sB.indexOf('.');
        let aDecLen = aDecIdx === -1 ? 0 : sA.length - aDecIdx - 1;
        let bDecLen = bDecIdx === -1 ? 0 : sB.length - bDecIdx - 1;
        let maxDec = Math.max(aDecLen, bDecLen);
        
        // è£œé›¶å°é½Š
        // ç‚ºäº†è¨ˆç®—æ–¹ä¾¿ï¼Œæˆ‘å€‘å¯ä»¥çµ±ä¸€æ”¾å¤§æˆæ•´æ•¸é‹ç®—ï¼Œæœ€å¾Œå†é»å°æ•¸é»
        // ä½†ç‚ºäº† Grid é¡¯ç¤ºï¼Œæˆ‘ä»¬éœ€è¦å­—ä¸²é™£åˆ—
        // ç­–ç•¥ï¼šå°é½Šå°æ•¸é»ã€‚
        // ex: 12.3 + 4.56 -> 12.30 + 04.56
        
        // æ ¼å¼åŒ–å­—ä¸²
        let fA = parseFloat(sA).toFixed(maxDec);
        let fB = parseFloat(sB).toFixed(maxDec);
        
        // è£œå‰å°ç©ºæ ¼ (or zeros? visual usually spaces) for integer part alignment
        let aIntLen = fA.indexOf('.'); if(aIntLen===-1) aIntLen=fA.length;
        let bIntLen = fB.indexOf('.'); if(bIntLen===-1) bIntLen=fB.length;
        let maxInt = Math.max(aIntLen, bIntLen);
        
        // æœ€çµ‚é™£åˆ— (åŒ…å«å°æ•¸é»)
        let arrA = fA.padStart(maxInt + (maxDec>0?1:0) + maxDec, ' ').split('');
        let arrB = fB.padStart(maxInt + (maxDec>0?1:0) + maxDec, ' ').split('');
        
        // è¨ˆç®—æ­£ç¢ºç­”æ¡ˆ
        let ansVal = rawQ.op === '+' ? (parseFloat(sA) + parseFloat(sB)) : (parseFloat(sA) - parseFloat(sB));
        let fAns = ansVal.toFixed(maxDec); // ä¿æŒç²¾åº¦ä¸€è‡´
        let arrAns = fAns.split('');
        
        // æ±ºå®š Grid ç¸½å¯¬åº¦
        // åŠ æ³•å¯èƒ½é€²ä½å¤šä¸€ä½ï¼Œæ¸›æ³•ä¸æœƒè®Šé•·
        // ç‚ºäº†æ’ç‰ˆï¼Œå¯¬åº¦è‡³å°‘è¦èƒ½å®¹ç´ max(A, B, Ans)
        let gridWidth = Math.max(arrA.length, arrB.length, arrAns.length);
        
        // å³å°é½Šå¡«å……
        while(arrA.length < gridWidth) arrA.unshift(' ');
        while(arrB.length < gridWidth) arrB.unshift(' ');
        while(arrAns.length < gridWidth) arrAns.unshift(' ');

        return {
            op: rawQ.op, a: rawQ.a, b: rawQ.b,
            arrA, arrB, arrAns, gridWidth, maxDec,
            userAns: null, isCorrect: false,
            stepIdx: 0, steps: [] // for teach mode
        };
    }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('btn-next-q').style.display = 'none';
        renderGrid(q);
        // Generate steps if needed
        if (currentMode === 'teach' && q.steps.length === 0) generateTeachSteps(q);
    }

    // --- æ ¸å¿ƒï¼šæ¸²æŸ“ Grid èˆ‡è¼¸å…¥æ¡† ---
    function renderGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML='';
        const cols = q.gridWidth;
        const rows = 5; // 0:Carry, 1:A, 2:Op+B, 3:Line, 4:Ans
        
        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
        
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                let cell = document.createElement('div');
                cell.className = 'grid-cell';
                
                // Row 0: Carry/Borrow Inputs (only visible in Teach or if wanted in Test)
                // Requirement 3: è¦æœ‰é€²ä½æˆ–å€Ÿä½è¼”åŠ©è¨˜è™Ÿè¼¸å…¥
                if (r === 0) {
                    let inp = document.createElement('input');
                    inp.className = 'carry-input';
                    inp.dataset.col = c;
                    // åªæœ‰é‹ç®—ä½æ•¸æ‰éœ€è¦é¡¯ç¤º
                    if (c < cols) cell.appendChild(inp);
                }
                // Row 1: A
                else if (r === 1) {
                    cell.innerText = q.arrA[c];
                }
                // Row 2: Op + B
                else if (r === 2) {
                    if (c === 0) { // Operator usually far left, but let's put it floating or first col
                         // ç°¡å–®è™•ç†ï¼šå¦‚æœåœ¨æœ€å·¦é‚Šæœ‰ç©ºä½å°±æ”¾ï¼Œä¸ç„¶å°±é‡ç–Š
                         let opSpan = document.createElement('span');
                         opSpan.innerText = q.op;
                         opSpan.className = 'op-cell';
                         opSpan.style.position = 'absolute';
                         opSpan.style.left = '-25px';
                         cell.appendChild(opSpan);
                    }
                    cell.innerText = q.arrB[c];
                }
                // Row 3: Line
                else if (r === 3) {
                    cell.className += ' line-cell';
                }
                // Row 4: Answer Inputs
                else if (r === 4) {
                    // Skip decimal point in input, just show it
                    if (q.arrAns[c] === '.') {
                        cell.innerText = '.';
                    } else {
                        // Requirement 2: è¼¸å…¥ç­”æ¡ˆè³‡æ–™æ ¼è¦ä¾æ“šä½æ•¸åˆ†é–‹
                        let inp = document.createElement('input');
                        inp.className = 'game-input';
                        inp.type = 'tel';
                        inp.maxLength = 1;
                        inp.dataset.col = c; // ç´€éŒ„æ¬„ä½index
                        
                        // Requirement 2: è¼¸å…¥æ¬¡åºç”±å³åˆ°å·¦ -> Auto focus logic
                        inp.oninput = (e) => handleInputFlow(e.target, c, cols);
                        inp.onkeydown = (e) => { if(e.key==='Enter') checkAnswer(); };
                        
                        cell.appendChild(inp);
                    }
                }
                box.appendChild(cell);
            }
        }
        
        // åˆå§‹ Focus æœ€å³é‚Šçš„ Input
        setTimeout(() => {
            let inputs = document.querySelectorAll('.game-input');
            if(inputs.length > 0) inputs[inputs.length-1].focus();
        }, 100);
        
        // æ•™å­¸æ¨¡å¼æç¤º
        if (currentMode === 'teach') showTeachHint(q);
        else {
             document.getElementById('teach-msg').innerText = "";
             document.getElementById('btn-help').style.display = 'none';
        }
    }

    function handleInputFlow(el, colIdx, totalCols) {
        // è¼¸å…¥ä¸€å€‹å­—å¾Œï¼Œå¾€å·¦è·³ (colIdx - 1)
        if (el.value.length === 1) {
            let prevInp = document.querySelector(`.game-input[data-col="${colIdx-1}"]`);
            // å¦‚æœå‰ä¸€æ ¼æ˜¯å°æ•¸é»(æ²’æœ‰input)ï¼Œå†å¾€å·¦æ‰¾
            if (!prevInp) prevInp = document.querySelector(`.game-input[data-col="${colIdx-2}"]`);
            
            if (prevInp) prevInp.focus();
        }
    }

    // --- æª¢æŸ¥ç­”æ¡ˆ ---
    function checkAnswer() {
        const q = quizData[currentQIdx];
        let inputs = document.querySelectorAll('.game-input');
        let userStr = "";
        // æ”¶é›† User Inputï¼Œéœ€æŒ‰ç…§ Column é †åºé‡çµ„
        // æˆ‘å€‘çš„ input ä¾ grid order æ’åˆ—ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥éæ­·
        // ä½†è¦æ³¨æ„å°æ•¸é»ä¸åœ¨ input è£¡
        
        let currentGridVal = "";
        for(let c=0; c<q.gridWidth; c++) {
            if (q.arrAns[c] === '.' || q.arrAns[c] === ' ') {
                if (q.arrAns[c] === '.') currentGridVal += ".";
                // skip spaces
            } else {
                let inp = document.querySelector(`.game-input[data-col="${c}"]`);
                if (inp) currentGridVal += inp.value;
            }
        }
        
        // æ¯”å°æ•¸å€¼
        let userNum = parseFloat(currentGridVal);
        let correctNum = parseFloat(q.arrAns.join(''));

        if (Math.abs(userNum - correctNum) < 0.0001) { // Float tolerance
            q.isCorrect = true;
            speak("ç­”å°äº†ï¼");
            
            // Requirement 5: æœ€çµ‚ç­”æ¡ˆæ­£ç¢ºçš„è©±,ä¸è¦é¡¯ç¤ºç¢ºèªè¦–çª—
            // ç›´æ¥ä¸‹ä¸€é¡Œ
            goToNextQuestion();
        } else {
            q.isCorrect = false;
            speak(`ç®—éŒ¯å›‰ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctNum}`);
            alert(`âŒ ç®—éŒ¯å›‰ï¼\næ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctNum}`);
            // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦å¼·åˆ¶ä¸‹ä¸€é¡Œï¼Œæˆ–è€…è®“å­¸ç”Ÿé‡è©¦ã€‚ä¾ç…§é™¤æ³•é‚è¼¯æ˜¯ç›´æ¥çœ‹çµæœ
            goToNextQuestion(); 
        }
    }
    
    function goToNextQuestion() {
        if(currentQIdx < quizData.length - 1) {
            currentQIdx++;
            loadQuestion();
        } else {
            finishQuiz(false);
        }
    }

    // --- æ•™å­¸æ¨¡å¼é‚è¼¯ ---
    function generateTeachSteps(q) {
        // é€™é‚Šç°¡åŒ–ï¼šå› ç‚ºåŠ æ¸›æ³•æ¯ä¸€æ­¥éƒ½å¾ˆé¡ä¼¼ï¼Œæˆ‘å€‘ä¸»è¦æä¾› "æ–‡å­—å¼•å°"
        // çœŸæ­£çš„é€æ­¥æª¢æŸ¥(åƒé™¤æ³•é‚£æ¨£é–å®šæ ¼å­)æœƒå¾ˆè¤‡é›œï¼Œé€™è£¡æ¡ç”¨ã€Œæç¤ºç›®å‰è©²ç®—å“ªä¸€ä½ã€
        // ä¸¦ä¸”æä¾›æ±‚åŠ©æŒ‰éˆ•é¡¯ç¤ºè©²ä½çš„ç®—å¼
        q.steps = [];
        // å¾å³åˆ°å·¦éæ­·æœ‰æ•ˆæ•¸å­—ä½
        let carry = 0;
        for (let c = q.gridWidth - 1; c >= 0; c--) {
            let charA = q.arrA[c];
            let charB = q.arrB[c];
            if (charA === '.' || (charA === ' ' && charB === ' ')) continue;

            let valA = parseInt(charA) || 0;
            let valB = parseInt(charB) || 0;
            let step = { col: c, hint: "", explain: "" };

            if (q.op === '+') {
                let sum = valA + valB + carry;
                step.hint = `ç¾åœ¨è¨ˆç®—ç¬¬ ${q.gridWidth - c} è¡Œï¼š ${valA} + ${valB} ${carry>0?'+ é€²ä½'+carry:''}`;
                step.explain = `${valA} + ${valB} + ${carry} = ${sum}ã€‚ å¡«å¯« ${sum%10}ï¼Œé€²ä½ ${Math.floor(sum/10)}`;
                carry = Math.floor(sum / 10);
            } else {
                // æ¸›æ³•
                let valA_borrow = valA - carry; // é€™è£¡ carry ç•¶ä½œå€Ÿä½
                let needed = valB;
                let borrowNext = 0;
                if (valA_borrow < needed) {
                    valA_borrow += 10;
                    borrowNext = 1;
                }
                step.hint = `ç¾åœ¨è¨ˆç®—ç¬¬ ${q.gridWidth - c} è¡Œï¼š ${valA} - ${valB} ${carry>0?'- å€Ÿä½'+carry:''}`;
                step.explain = `${valA} ${carry>0?'- '+carry:''} = ${valA-carry}ã€‚ ${valA-carry < valB ? 'ä¸å¤ æ¸›ï¼Œå‘å·¦é‚Šå€Ÿ1ç•¶10ã€‚' : ''} ${(valA-carry < valB ? valA-carry+10 : valA-carry)} - ${valB} = ${(valA-carry < valB ? valA-carry+10 : valA-carry) - valB}`;
                carry = borrowNext;
            }
            q.steps.push(step);
        }
    }
    
    function showTeachHint(q) {
        // ç°¡å–®é¡¯ç¤ºç•¶å‰æ­¥é©Ÿçš„æç¤ºï¼ˆé€™è£¡ä¸åšå¤ªåš´æ ¼çš„æ­¥é©Ÿé–å®šï¼Œè®“ä½¿ç”¨è€…è‡ªç”±å¡«å¯«ï¼Œæ±‚åŠ©æ™‚é¡¯ç¤ºå…¨éƒ¨æ­¥é©Ÿæˆ–ç•¶å‰å»ºè­°ï¼‰
        // ç‚ºäº†ç°¡åŒ–é«”é©—ï¼Œæˆ‘å€‘åªé¡¯ç¤ºé€šç”¨çš„æç¤º
        let msg = document.getElementById('teach-msg');
        msg.innerText = "è«‹å¾æœ€å³é‚Šé–‹å§‹è¨ˆç®—ï¼Œè¨˜å¾—å¡«å¯«é€²ä½/å€Ÿä½å–”ï¼";
        document.getElementById('btn-help').style.display = 'inline-block';
    }
    
    function toggleHelp() {
        const box = document.getElementById('help-content');
        if(box.style.display === 'block') { box.style.display='none'; return; }
        
        const q = quizData[currentQIdx];
        let html = `<div class="help-table">`;
        q.steps.forEach(s => {
            html += `<div class="help-row">â¬‡ï¸ ${s.hint} <br> <span style="color:blue">${s.explain}</span></div>`;
        });
        html += `</div>`;
        box.innerHTML = html;
        box.style.display = 'block';
    }

    // --- çµç®—èˆ‡çå‹µ ---
    function finishQuiz(timeUp=false) {
        clearInterval(timerInt);
        showPage('page-result');
        
        let correctCount = quizData.filter(q => q.isCorrect).length;
        let total = quizData.length;
        let score = Math.round((correctCount / total) * 100);
        
        document.getElementById('res-score').innerText = score;
        let summary = timeUp ? "æ™‚é–“åˆ°ï¼" : "";
        summary += `ç­”å° ${correctCount} / ${total} é¡Œ`;
        document.getElementById('res-summary').innerText = summary;

        // çå‹µç™¼æ”¾
        const rewardArea = document.getElementById('reward-area');
        rewardArea.innerHTML = '';
        let earnedGems = 0;
        let passScore = currentList.passScore || 100;

        if (currentMode === 'test' && score >= passScore) earnedGems = currentList.gems || 5;
        else if (currentMode === 'teach' && score === 100) earnedGems = currentList.teachGems || 2;

        if (earnedGems > 0) {
            let oldCrowns = Math.floor(totalGems / 100);
            totalGems += earnedGems;
            let newCrowns = Math.floor(totalGems / 100);
            saveStudentData();

            if (newCrowns > oldCrowns) {
                triggerRewardAnimation('crown');
                rewardArea.innerHTML = `<div class="reward-popup">ğŸ‘‘ æ­å–œå‡ç´šï¼ç²å¾—çš‡å† ï¼(+${earnedGems}ğŸ’)</div>`;
                speak("å¤ªæ£’äº†ï¼æ­å–œç²å¾—çš‡å† ï¼");
            } else {
                triggerRewardAnimation('gem');
                rewardArea.innerHTML = `<div class="reward-popup">ğŸ’ ä»»å‹™é”æˆï¼ç²å¾— ${earnedGems} å¯¶çŸ³</div>`;
                speak(`æ­å–œç²å¾— ${earnedGems} é¡†å¯¶çŸ³ï¼`);
            }
        } else {
            speak(`æ¸¬é©—çµæŸï¼Œç²å¾— ${score} åˆ†ã€‚`);
        }

        // åˆ—è¡¨
        const tbody = document.getElementById('res-table-body'); tbody.innerHTML='';
        quizData.forEach(q => {
            let tr = document.createElement('tr');
            let ansStr = q.arrAns.join('').replace(/ /g,'');
            let status = q.isCorrect ? '<span class="res-correct">O</span>' : '<span class="res-wrong">X</span>';
            tr.innerHTML = `<td>${q.a} ${q.op} ${q.b}</td><td>${q.isCorrect?'æ­£ç¢º':''}</td><td>${ansStr}</td><td>${status}</td>`;
            tbody.appendChild(tr);
        });
    }

    // --- çå‹µç³»çµ± (è¤‡è£½è‡ªå‰ä½œ) ---
    function processExchange() {
        const name = document.getElementById('gift-name').value;
        const cost = parseInt(document.getElementById('gift-cost').value);
        const type = document.getElementById('gift-currency').value;
        if(!name || !cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        
        let realCost = (type === 'crowns') ? cost * 100 : cost;
        if(totalGems >= realCost) {
            if(confirm(`ç¢ºèªå…Œæ› ${name}?`)) {
                totalGems -= realCost;
                exchangeLog.unshift({date: new Date().toLocaleString(), item: name, cost: `${cost} ${type==='crowns'?'ğŸ‘‘':'ğŸ’'}`});
                saveStudentData(); renderExchangeLog();
                document.getElementById('gift-name').value=''; document.getElementById('gift-cost').value='';
                triggerRewardAnimation(type==='crowns'?'crown':'gem');
                speak("å…Œæ›æˆåŠŸï¼");
            }
        } else { alert("é¤˜é¡ä¸è¶³ï¼"); }
    }
    function renderExchangeLog() {
        const d = document.getElementById('exchange-log'); d.innerHTML='';
        exchangeLog.forEach(l => { d.innerHTML += `<div class="log-item"><span>${l.date} - ${l.item}</span><span>-${l.cost}</span></div>`; });
    }
    function triggerRewardAnimation(type) {
        const c = document.getElementById('particle-container'); c.style.display='block'; c.innerHTML='';
        let sym = type==='crown'?'ğŸ‘‘':'ğŸ’';
        for(let i=0;i<30;i++){
            let p=document.createElement('div'); p.innerText=sym; p.className='particle';
            p.style.left=Math.random()*100+'vw'; p.style.animationDuration=(Math.random()*2+1)+'s';
            c.appendChild(p);
        }
        setTimeout(()=>{c.style.display='none';},3000);
    }

    function saveRank() {
        const s = document.getElementById('res-score').innerText;
        rankData.push({name: studentName, score: parseInt(s), time: 'N/A', list: currentList.name});
        saveRankData(); alert("ç™»è¨˜æˆåŠŸ"); switchTab('rank'); showPage('page-home');
    }
    function renderRank() {
        const b = document.getElementById('rank-container'); b.innerHTML='';
        rankData.sort((x,y)=>y.score-x.score);
        rankData.forEach((r,i)=>{ b.innerHTML+=`<div class="rank-item ${i===0?'rank-1':''}"><span>${i+1}. ${r.name}</span><span>${r.score}åˆ†</span></div>`; });
    }
    function clearRank(){if(confirm("æ¸…ç©º?")){rankData=[];saveRankData();renderRank();}}

</script>

</body>
</html>