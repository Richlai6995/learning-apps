<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ æ¸›æ³•é—–é—œç‹ 2.0 (é€æ­¥å¼•å°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #e67e22;
            --secondary: #f39c12;
            --light: #fdfefe;
            --dark: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f;
            --cell-size: 55px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #fff5e6;
            color: var(--dark);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--primary); margin: 10px 0; text-align: center; font-size: 1.8rem;}

        /* --- UI Components --- */
        .user-profile {
            background-color: #fff; border: 2px dashed var(--primary); border-radius: 15px;
            padding: 10px 25px; margin-bottom: 20px; cursor: pointer;
            font-size: 1.2rem; font-weight: bold; color: var(--dark);
            display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.2);
        }
        .stats-badge { background: #fdf2e9; padding: 5px 12px; border-radius: 20px; font-size: 1rem; }

        .tabs { 
            display: flex; gap: 15px; margin-bottom: 20px; background: #fff; padding: 5px; 
            border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab { 
            flex: 1; text-align: center; padding: 10px 25px; cursor: pointer; color: #95a5a6; 
            font-weight: bold; font-size: 1.1rem; border-radius: 25px; transition: all 0.3s ease;
        }
        .tab.active { color: white; background-color: var(--primary); transform: scale(1.05); }

        .container {
            width: 100%; max-width: 800px; background: white; border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; display: none;
        }
        .container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        button {
            border: none; border-radius: 8px; padding: 10px 20px; font-size: 1rem; font-weight: bold;
            cursor: pointer; color: white; margin: 3px; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); }
        .btn-gray { background-color: #95a5a6; }
        .btn-help { background-color: #8e44ad; box-shadow: 0 4px #6c3483; }
        .btn-help:active { box-shadow: 0 0; transform: translateY(4px); }

        /* --- Grid System --- */
        .grid-container {
            display: grid; justify-content: center; margin: 20px 0; gap: 0;
            /* grid-template-columns set via JS */
        }
        .grid-cell {
            width: var(--cell-size); height: 60px;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 2rem;
            position: relative;
        }
        .line-cell { border-bottom: 4px solid #333; }
        .op-cell { color: var(--primary); position: absolute; left: -30px; font-size: 1.8rem;}
        
        /* Active Digit Highlight */
        .hl-active { color: #e67e22; transform: scale(1.3); transition: 0.3s; text-shadow: 0 0 5px rgba(230, 126, 34, 0.3); }

        /* Inputs */
        .game-input { 
            width: 45px; height: 45px; font-size: 1.8rem; text-align: center; 
            border: 3px solid var(--primary); border-radius: 8px; background: #fff;
            font-weight: bold; outline: none; padding: 0; z-index: 10;
        }
        .game-input.active-input {
            background-color: #fff3cd !important; border-color: #d35400; box-shadow: 0 0 10px rgba(211, 84, 0, 0.5);
        }
        .game-input.correct { border-color: var(--success); background-color: #d5f5e3; color: var(--success); }
        
        /* Carry Input (Small) */
        .carry-input {
            width: 30px; height: 30px; font-size: 1rem; text-align: center;
            border: 2px solid #e74c3c; border-radius: 50%; background: #fadbd8; 
            color: #c0392b; position: absolute; bottom: 5px; z-index: 20;
        }
        .carry-display {
            width: 30px; height: 30px; font-size: 1rem; text-align: center;
            color: #e74c3c; position: absolute; bottom: 5px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
        }

        /* Helper Box */
        .help-box {
            background: #e8f8f5; border-left: 5px solid #1abc9c; padding: 15px; margin: 10px 0;
            border-radius: 8px; display: none; font-size: 1.1rem; text-align: left;
        }
        
        /* Lists */
        .list-item {
            background: #fdf2e9; border: 2px solid #fae5d3; padding: 12px; margin-bottom: 10px;
            border-radius: 12px; display: flex; justify-content: space-between; align-items: center;
        }
        .tag { font-size: 0.9rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; margin-left: 5px; }
        .tag-gem { background: #d6eaf8; color: #2980b9; }
        .tag-teach { background: #d5f5e3; color: #27ae60; }

        /* Editor */
        .gen-controls { background: #fef9e7; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;}
        .gen-controls input, .gen-controls select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center;}
        .edit-row { display: flex; gap: 5px; margin-bottom: 5px; justify-content: center; }
        .edit-row input { padding: 8px; width: 80px; text-align: center; border: 1px solid #ccc; border-radius: 5px; font-size: 1.1rem;}
        .inp-op { width: 60px; }

        /* Test Mode */
        .test-mode-box { text-align: center; padding: 30px; font-size: 2rem; font-family: monospace; }
        .test-input { font-size: 2rem; padding: 10px; width: 150px; text-align: center; border: 3px solid #ccc; border-radius: 8px; }

        /* Result & Shop */
        .reward-popup {
            background: #fff8e1; border: 3px solid #f1c40f; padding: 20px; border-radius: 15px; 
            margin-top: 20px; font-weight: bold; color: #d35400; font-size: 1.3rem; text-align: center;
            animation: bounceIn 0.8s;
        }
        @keyframes bounceIn { 0% { transform: scale(0.3); } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }

        /* Particles */
        #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; }
        .particle { position: absolute; font-size: 2rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

    </style>
</head>
<body>

    <div id="particle-container"></div>

    <div id="page-home" class="container active">
        <h1>â•â– åŠ æ¸›æ³•é—–é—œç‹</h1>
        
        <div class="user-profile" onclick="changeName()">
            <div>ğŸ“ <span id="display-name">è¨­å®šå­¸å“¡</span> âœ</div>
            <div class="stats-badge">ğŸ‘‘ <span id="stat-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="stat-gems">0</span></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('quiz')">é¸æ“‡é¡Œåº«</div>
            <div class="tab" onclick="switchTab('rank')">è‹±é›„æ¦œ</div>
        </div>

        <div id="tab-quiz">
            <button class="btn-help btn-block" style="margin-bottom:15px;" onclick="showPage('page-shop')">ğŸ çå‹µå…Œæ›å•†åº—</button>
            <div id="lists-container"></div>
            <button class="btn-secondary btn-block" onclick="createNewList()">+ æ–°å¢/ç”Ÿæˆé¡Œåº«</button>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-gray" style="flex:1" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-gray" style="flex:1" onclick="document.getElementById('import-file').click()">åŒ¯å…¥</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(this)">
            </div>
        </div>

        <div id="tab-rank" style="display:none;">
            <div id="rank-container"></div>
            <button class="btn-gray btn-block" onclick="clearRank()">æ¸…ç©ºæ¦œå–®</button>
        </div>
        <div style="text-align:center; margin-top:20px; color:#ccc; font-size:0.8rem;">ç‰ˆæœ¬ï¼šv2.0 (é€æ­¥å¼•å°)</div>
    </div>

    <div id="page-shop" class="container">
        <h2>ğŸ çå‹µå…Œæ›</h2>
        <div class="user-profile" style="background: #fff8e1; border-color:#f1c40f;">
            <div class="stats-badge">ğŸ‘‘ <span id="shop-crowns">0</span></div>
            <div class="stats-badge">ğŸ’ <span id="shop-gems">0</span></div>
        </div>
        <div style="background:#f9f9f9; padding:20px; border-radius:10px;">
            <div style="margin-bottom:10px;">æˆ‘è¦å…Œæ›ï¼š<input type="text" id="gift-name" placeholder="çå“åç¨±" style="padding:5px; width:60%;"></div>
            <div style="margin-bottom:10px;">èŠ±è²»ï¼š<input type="number" id="gift-cost" placeholder="æ•¸é‡" style="padding:5px; width:60px;">
                <select id="gift-currency" style="padding:5px;"><option value="gems">ğŸ’ å¯¶çŸ³</option><option value="crowns">ğŸ‘‘ çš‡å† </option></select>
            </div>
            <button class="btn-primary btn-block" onclick="processExchange()">ç¢ºèªå…Œæ›</button>
        </div>
        <div id="exchange-log" style="margin-top:20px; max-height:200px; overflow-y:auto; font-size:0.9rem; color:#666;"></div>
        <button class="btn-gray btn-block" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="page-editor" class="container">
        <h2>âœï¸ ç·¨è¼¯é¡Œåº«</h2>
        <div style="background:#eee; padding:10px; border-radius:10px; margin-bottom:10px; display:flex; flex-wrap:wrap; gap:10px;">
            <div style="flex:100%">åç¨±: <input type="text" id="list-name" style="padding:5px; width:70%;"></div>
            <div>â±ï¸é™æ™‚: <input type="number" id="list-timer" value="0" style="width:50px;"></div>
            <div>ğŸ’æ¸¬é©—: <input type="number" id="list-gems" value="5" style="width:50px;"></div>
            <div>ğŸ’æ•™å­¸: <input type="number" id="list-teach-gems" value="2" style="width:50px;"></div>
            <div>ğŸ¯åŠæ ¼: <input type="number" id="list-pass-score" value="100" style="width:50px;"></div>
        </div>
        <div class="gen-controls">
            <span>ç”Ÿæˆ:</span>
            <select id="gen-op"><option value="+">åŠ æ³•</option><option value="-">æ¸›æ³•</option></select>
            é¡Œæ•¸<input type="number" id="gen-count" value="5" style="width:50px;">
            è¢«åŠ æ¸›ä½æ•¸<input type="number" id="gen-int-a" value="2" style="width:50px;">
            åŠ æ¸›ä½æ•¸<input type="number" id="gen-int-b" value="2" style="width:50px;">
            <button class="btn-warning" onclick="autoGenerate()">ç”Ÿæˆ</button>
        </div>
        <div id="editor-rows" style="max-height:300px; overflow-y:auto;"></div>
        <button class="btn-gray" onclick="addEditRow()">+ æ‰‹å‹•å¢åŠ </button>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-gray" style="flex:1" onclick="showPage('page-home')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveList()">å„²å­˜</button>
        </div>
    </div>

    <div id="page-mode" class="container">
        <h2>é¸æ“‡æ¨¡å¼</h2>
        <div style="text-align:left; background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;">
            <label><input type="checkbox" id="opt-voice" checked> ğŸ”Š èªéŸ³æç¤º</label><br>
            <label><input type="checkbox" id="opt-text" checked> ğŸ“ æ–‡å­—æç¤º</label>
        </div>
        <button class="btn-success btn-block" onclick="startQuiz('teach')">ğŸ“– æ•™å­¸æ¨¡å¼ (é€æ­¥å¼•å°)</button>
        <button class="btn-danger btn-block" onclick="startQuiz('test')">ğŸ“ æ¸¬é©—æ¨¡å¼ (ç›´æ¥è¨ˆç®—)</button>
        <button class="btn-gray" style="margin-top:20px;" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="page-quiz" class="container">
        <div class="quiz-header">
            <span id="q-info">é¡Œç›® 1/5</span>
            <span id="q-timer">00:00</span>
            <button class="btn-danger" onclick="quitQuiz()">ğŸšª</button>
        </div>

        <div id="teach-area" style="display:none;">
            <div id="teach-msg" style="color:#d35400; font-weight:bold; font-size:1.2rem; min-height:3rem; margin-bottom:10px; text-align:center;"></div>
            <div style="text-align:center;">
                <button id="btn-help" class="btn-help" onclick="toggleHelp()">ğŸ’¡ æç¤ºï¼šæ€éº¼ç®—ï¼Ÿ</button>
            </div>
            <div id="help-content" class="help-box"></div>
            
            <div class="grid-container" id="gridBoard"></div>
            
            <div style="text-align:center; margin-top:20px;">
                <button id="btn-next-step" class="btn-warning" style="display:none;" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <div id="test-area" style="display:none;">
            <div class="test-mode-box">
                <div id="test-q-text" style="margin-bottom:20px;"></div>
                ç­”æ¡ˆ: <input type="number" id="test-ans" class="test-input">
                <br><br>
                <button class="btn-primary" onclick="checkTestAnswer()">é€å‡º (Enter)</button>
            </div>
        </div>
    </div>

    <div id="page-result" class="container">
        <div style="text-align:center;">
            <h2>æ¸¬é©—çµæœ</h2>
            <div style="font-size:4rem; color:var(--primary); font-weight:bold;" id="res-score">100</div>
            <div id="res-summary" style="font-size:1.2rem; margin:10px;"></div>
            <div id="reward-area"></div>
            <div style="margin-top:20px; max-height:300px; overflow-y:auto;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee;"><th>é¡Œç›®</th><th>çµæœ</th></tr></thead>
                    <tbody id="res-table-body"></tbody>
                </table>
            </div>
            <button class="btn-warning btn-block" onclick="saveRank()">ç™»è¨˜æ¦œå–®</button>
            <button class="btn-gray btn-block" onclick="showPage('page-home')">å›é¦–é </button>
        </div>
    </div>

<script>
    // --- Global Data ---
    let studentName = "å°å°å­¸å“¡", totalGems = 0;
    let allLists = [], currentList = null, quizData = [], currentQIdx = 0, currentMode = '';
    let timerInt, startTime, limitSeconds = 0, rankData = [], exchangeLog = [];
    let quizSettings = { voice: true, text: true };
    const STORAGE_KEY = 'addsub_v2_';

    // --- Init ---
    window.onload = function() {
        loadData();
        updateProfile();
        renderLists();
    };

    function loadData() {
        if(localStorage.getItem(STORAGE_KEY + 'lists')) allLists = JSON.parse(localStorage.getItem(STORAGE_KEY + 'lists'));
        else { allLists = [{name: "åŸºç¤åŠ æ¸›ç·´ç¿’", gems:5, teachGems:2, passScore:100, qs: genQs('+', 5, 2, 2)}]; saveData(); }
        if(localStorage.getItem(STORAGE_KEY + 'student')) studentName = localStorage.getItem(STORAGE_KEY + 'student');
        if(localStorage.getItem(STORAGE_KEY + 'gems')) totalGems = parseInt(localStorage.getItem(STORAGE_KEY + 'gems')) || 0;
        if(localStorage.getItem(STORAGE_KEY + 'rank')) rankData = JSON.parse(localStorage.getItem(STORAGE_KEY + 'rank'));
        if(localStorage.getItem(STORAGE_KEY + 'exchange')) exchangeLog = JSON.parse(localStorage.getItem(STORAGE_KEY + 'exchange'));
    }
    function saveData() { localStorage.setItem(STORAGE_KEY + 'lists', JSON.stringify(allLists)); }
    function saveStudentData() {
        localStorage.setItem(STORAGE_KEY + 'student', studentName);
        localStorage.setItem(STORAGE_KEY + 'gems', totalGems);
        localStorage.setItem(STORAGE_KEY + 'exchange', JSON.stringify(exchangeLog));
        updateProfile();
    }

    // --- Voice ---
    function speak(text) {
        let force = text.includes("å¯¶çŸ³") || text.includes("çš‡å† ") || text.includes("å…¨å°");
        if(currentMode === 'teach' && !quizSettings.voice && !force) return;
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let clean = text.replace(/<[^>]*>/g, '').replace(/-/g, 'æ¸›').replace(/\+/g, 'åŠ ');
            const u = new SpeechSynthesisUtterance(clean); u.lang = 'zh-TW'; u.rate = 1.0;
            window.speechSynthesis.speak(u);
        }
    }

    // --- UI Logic ---
    function showPage(pid) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        if(pid === 'page-home') renderLists();
        if(pid === 'page-shop') { updateProfile(); renderExchangeLog(); }
    }
    function switchTab(t) {
        document.getElementById('tab-quiz').style.display = t==='quiz'?'block':'none';
        document.getElementById('tab-rank').style.display = t==='rank'?'block':'none';
        if(t==='rank') renderRank();
    }
    function updateProfile() {
        document.getElementById('display-name').innerText = studentName;
        let crowns = Math.floor(totalGems / 100);
        let gems = totalGems % 100;
        document.getElementById('stat-crowns').innerText = crowns;
        document.getElementById('stat-gems').innerText = gems;
        if(document.getElementById('shop-crowns')) {
            document.getElementById('shop-crowns').innerText = crowns;
            document.getElementById('shop-gems').innerText = gems;
        }
    }
    function changeName() {
        let n = prompt("è«‹è¼¸å…¥åå­—:", studentName);
        if(n && n.trim()) { studentName = n.trim(); saveStudentData(); }
    }

    // --- åˆ—è¡¨èˆ‡ç·¨è¼¯ ---
    function renderLists() {
        const c = document.getElementById('lists-container'); c.innerHTML='';
        allLists.forEach((l,i) => {
            let g = l.gems||5; let tg = l.teachGems||2; let p = l.passScore||100;
            c.innerHTML += `
                <div class="list-item">
                    <div>
                        <strong>${l.name}</strong> (${l.qs.length}é¡Œ)
                        <div>
                            <span class="gem-tag">ğŸ’æ¸¬é©—+${g}</span>
                            <span class="teach-gem-tag">ğŸ’æ•™å­¸+${tg}</span>
                            <span class="score-tag">ğŸ¯${p}åˆ†</span>
                        </div>
                        ${l.timer?`<small>â±ï¸ é™æ™‚ ${l.timer}ç§’</small>`:''}
                    </div>
                    <div>
                        <button class="btn-primary" onclick="prepareQuiz(${i})">é–‹å§‹</button>
                        <button class="btn-gray" onclick="editList(${i})">ç·¨è¼¯</button>
                        <button class="btn-danger" onclick="delList(${i})">åˆª</button>
                    </div>
                </div>`;
        });
    }
    let editingId = null;
    function createNewList() { editingId=null; document.getElementById('list-name').value="æ–°é¡Œåº«"; document.getElementById('editor-rows').innerHTML=''; showPage('page-editor'); }
    function editList(i) {
        editingId = i; const l = allLists[i];
        document.getElementById('list-name').value = l.name;
        document.getElementById('list-gems').value = l.gems||5;
        document.getElementById('list-teach-gems').value = l.teachGems||2;
        document.getElementById('list-pass-score').value = l.passScore||100;
        document.getElementById('list-timer').value = l.timer||0;
        const box = document.getElementById('editor-rows'); box.innerHTML = '';
        l.qs.forEach(q => addEditRow(q.op, q.a, q.b));
        showPage('page-editor');
    }
    function addEditRow(op='+', a='', b='') {
        const d = document.createElement('div'); d.className='edit-row';
        d.innerHTML = `
            <select class="inp-op"><option value="+" ${op==='+'?'selected':''}>+</option><option value="-" ${op==='-'?'selected':''}>-</option></select>
            <input type="number" class="inp-a" value="${a}">
            <input type="number" class="inp-b" value="${b}">
            <button class="btn-danger" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('editor-rows').appendChild(d);
    }
    function saveList() {
        const name = document.getElementById('list-name').value;
        const gems = parseInt(document.getElementById('list-gems').value)||5;
        const teachGems = parseInt(document.getElementById('list-teach-gems').value)||2;
        const passScore = parseInt(document.getElementById('list-pass-score').value)||100;
        const timer = parseInt(document.getElementById('list-timer').value)||0;
        const rows = document.querySelectorAll('.edit-row');
        const qs = [];
        rows.forEach(r => {
            const op = r.querySelector('.inp-op').value;
            const a = r.querySelector('.inp-a').value;
            const b = r.querySelector('.inp-b').value;
            if(a && b) qs.push({op, a, b});
        });
        if(qs.length===0) return alert("è«‹è¼¸å…¥é¡Œç›®");
        const data = {name, gems, teachGems, passScore, timer, qs};
        if(editingId===null) allLists.push(data); else allLists[editingId] = data;
        saveData(); showPage('page-home');
    }
    function delList(i) { if(confirm("åˆªé™¤?")) { allLists.splice(i,1); saveData(); renderLists(); } }
    function autoGenerate() {
        const count = parseInt(document.getElementById('gen-count').value);
        const ia = parseInt(document.getElementById('gen-int-a').value);
        const ib = parseInt(document.getElementById('gen-int-b').value);
        const qs = genQs('+', count, ia, ib);
        document.getElementById('editor-rows').innerHTML='';
        qs.forEach(q => addEditRow(q.op, q.a, q.b));
    }
    function genQs(op, count, ia, ib) {
        let arr = [];
        for(let i=0; i<count; i++) {
            let minA = Math.pow(10, ia-1), maxA = Math.pow(10, ia)-1;
            let minB = Math.pow(10, ib-1), maxB = Math.pow(10, ib)-1;
            let a = Math.floor(Math.random()*(maxA-minA+1)) + minA;
            let b = Math.floor(Math.random()*(maxB-minB+1)) + minB;
            let rop = Math.random() > 0.5 ? '+' : '-';
            if(rop==='-' && a<b) [a,b] = [b,a];
            arr.push({op: rop, a, b});
        }
        return arr;
    }

    // --- æ¸¬é©—æ ¸å¿ƒ ---
    function prepareQuiz(i) { currentList = allLists[i]; showPage('page-mode'); }
    function startQuiz(mode) {
        currentMode = mode;
        if(mode==='teach') {
            quizSettings.voice = document.getElementById('opt-voice').checked;
            quizSettings.text = document.getElementById('opt-text').checked;
        }
        // åˆå§‹åŒ–æ¯ä¸€é¡Œçš„è©³ç´°æ­¥é©Ÿ
        quizData = currentList.qs.map(q => prepareSteps(q));
        if(mode==='test') quizData.sort(() => Math.random()-0.5);

        currentQIdx = 0;
        limitSeconds = currentList.timer || 0;
        startTime = Date.now();
        clearInterval(timerInt); timerInt = setInterval(updTime, 1000);
        updTime();
        
        showPage('page-quiz');
        speak("æº–å‚™é–‹å§‹å›‰ï¼");
        loadQuestion();
    }
    function updTime() {
        let e = Math.floor((Date.now()-startTime)/1000);
        if(limitSeconds > 0) {
            let r = limitSeconds - e;
            if(r <= 0) { finishQuiz(true); return; }
            document.getElementById('q-timer').innerText = `${Math.floor(r/60).toString().padStart(2,'0')}:${(r%60).toString().padStart(2,'0')}`;
            if(r<=10) document.getElementById('q-timer').classList.add('timer-urgent');
        } else {
            document.getElementById('q-timer').innerText = new Date(e*1000).toISOString().substr(14,5);
        }
    }

    // --- é¡Œç›®æº–å‚™èˆ‡æ­¥é©Ÿç”Ÿæˆ ---
    function prepareSteps(rawQ) {
        let sA = rawQ.a.toString(), sB = rawQ.b.toString();
        let op = rawQ.op;
        // å°é½Š
        let len = Math.max(sA.length, sB.length);
        let valA = parseInt(sA), valB = parseInt(sB);
        let arrA = sA.padStart(len, ' ').split('');
        let arrB = sB.padStart(len, ' ').split('');
        let steps = [];
        
        // ç”Ÿæˆç›´å¼æ­¥é©Ÿ (å³åˆ°å·¦)
        let carry = 0;
        for(let i=len-1; i>=0; i--) {
            let da = parseInt(arrA[i]) || 0;
            let db = parseInt(arrB[i]) || 0;
            let step = { col: i, len: len };
            
            if(op === '+') {
                let sum = da + db + carry;
                step.val = sum % 10;
                step.carry = Math.floor(sum / 10);
                step.hint = `å€‹ä½: ${da} åŠ  ${db} ${carry>0?'å†åŠ é€²ä½'+carry:''} ç­‰æ–¼ ${sum}ã€‚å¡«å¯« ${step.val}ï¼Œ${step.carry>0?'é€²ä½'+step.carry:''}`;
                carry = step.carry;
            } else {
                // æ¸›æ³•å€Ÿä½é‚è¼¯æ¨¡æ“¬
                let realA = da - carry; 
                let needed = db;
                let nextCarry = 0;
                if(realA < needed) {
                    realA += 10;
                    nextCarry = 1;
                }
                step.val = realA - needed;
                step.carry = nextCarry; // é€™è£¡æ˜¯å€Ÿä½
                step.hint = `ä½æ•¸: ${da} ${carry>0?'è¢«å€Ÿ1å‰©'+(da-carry):''} æ¸› ${db}ã€‚${realA<db?'ä¸å¤ æ¸›ï¼Œè·Ÿå‰é¢å€Ÿ1ã€‚':''} ${realA} æ¸› ${db} ç­‰æ–¼ ${step.val}`;
                carry = nextCarry;
            }
            // Step input location
            // Grid: Row 0(Carry), 1(A), 2(Op+B), 3(Line), 4(Ans)
            step.gridRow = 4; 
            // éœ€è¦è€ƒæ…®æœ€å·¦é‚Šå¯èƒ½æœ‰é‹ç®—ç¬¦è™Ÿçš„åç§»
            step.gridCol = i + 1; // Col 0 is usually empty or Op space
            
            steps.push(step);
        }
        // æœ€å¾Œå¦‚æœæœ‰é€²ä½ (åŠ æ³•)
        if(op === '+' && carry > 0) {
            steps.push({
                col: -1, len: len, val: carry, carry: 0, gridRow: 4, gridCol: 0,
                hint: `æœ€å¾Œé€²ä½ ${carry} ç›´æ¥å¯«ä¸‹ä¾†`
            });
        }

        return {
            op, a: valA, b: valB, arrA, arrB, steps, stepIdx: 0,
            width: len + 1, // Extra col for op/final carry
            userAns: null, isCorrect: false
        };
    }

    function loadQuestion() {
        const q = quizData[currentQIdx];
        document.getElementById('q-info').innerText = `é¡Œç›® ${currentQIdx+1} / ${quizData.length}`;
        document.getElementById('btn-next-q').style.display = 'none';
        
        if(currentMode === 'test') {
            document.getElementById('teach-area').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
            document.getElementById('test-q-text').innerText = `${q.a} ${q.op} ${q.b} = ?`;
            let inp = document.getElementById('test-ans'); inp.value=''; inp.focus();
            inp.onkeydown = (e)=>{ if(e.key==='Enter') checkTestAnswer(); };
        } else {
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('teach-area').style.display = 'block';
            renderTeachGrid(q);
        }
    }

    // --- æ•™å­¸æ¨¡å¼æ¸²æŸ“ ---
    function renderTeachGrid(q) {
        const box = document.getElementById('gridBoard'); box.innerHTML='';
        const msg = document.getElementById('teach-msg');
        document.getElementById('help-content').style.display = 'none';
        
        let cols = q.width; 
        let rows = 5; // 0:Carry, 1:A, 2:B, 3:Line, 4:Ans
        box.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
        
        // ç¹ªè£½ç¶²æ ¼
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                let cell = document.createElement('div');
                cell.className = 'grid-cell';
                if(r===3) cell.className += ' line-cell';
                cell.id = `c-${r}-${c}`;
                
                // å¡«å…¥æ•¸å­— (Right aligned)
                // arrA index 0 correspond to col 1 (since col 0 is extra)
                let dataIdx = c - (cols - q.arrA.length); // Alignment logic
                
                if(r===1 && dataIdx >= 0) cell.innerText = q.arrA[dataIdx];
                if(r===2) {
                    if(c===0) { let s=document.createElement('span'); s.className='op-cell'; s.innerText=q.op; cell.appendChild(s); }
                    if(dataIdx >= 0) cell.innerText = q.arrB[dataIdx];
                }
                
                // Row 0: Carry Inputs (Visible if previous step had carry)
                if(r===0 && c > 0) {
                    // æ ¹æ“šæ­¥é©Ÿåˆ¤æ–·æ˜¯å¦é¡¯ç¤ºé€²ä½æ ¼
                    // ç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥æ”¾ input ä½†é è¨­éš±è—æˆ–åªåœ¨è©²æ­¥é©Ÿé¡¯ç¤º
                    // é€™è£¡æˆ‘å€‘æ¡ç”¨å‹•æ…‹æ’å…¥ Input çš„æ–¹å¼
                }
                
                box.appendChild(cell);
            }
        }

        // æ ¹æ“š Step æ¸²æŸ“ç‹€æ…‹
        // å·²å®Œæˆçš„æ­¥é©Ÿé¡¯ç¤ºç´”æ•¸å­—
        for(let k=0; k<q.stepIdx; k++) {
            let s = q.steps[k];
            let ansCell = document.getElementById(`c-4-${s.gridCol}`);
            if(ansCell) ansCell.innerText = s.val;
            // é¡¯ç¤ºé€²ä½/å€Ÿä½
            if(s.carry > 0) {
                // é€²ä½é€šå¸¸å¯«åœ¨ä¸‹ä¸€ä½ (å·¦é‚Š) çš„ä¸Šæ–¹
                let carryCell = document.getElementById(`c-0-${s.gridCol-1}`);
                if(carryCell) {
                    let mark = document.createElement('div');
                    mark.className = 'carry-display'; 
                    mark.innerText = s.carry;
                    carryCell.appendChild(mark);
                }
            }
        }

        // ç•¶å‰æ­¥é©Ÿ
        if(q.stepIdx < q.steps.length) {
            let cur = q.steps[q.stepIdx];
            if(quizSettings.text) msg.innerText = cur.hint; else msg.innerText = "è«‹è¨ˆç®—...";
            speak(cur.hint);
            
            // é«˜äº®ç•¶å‰è¨ˆç®—çš„ä½æ•¸
            let colIdx = cur.gridCol; 
            let cellA = document.getElementById(`c-1-${colIdx}`);
            let cellB = document.getElementById(`c-2-${colIdx}`);
            if(cellA) cellA.classList.add('hl-active');
            if(cellB) cellB.classList.add('hl-active');

            // ç­”æ¡ˆè¼¸å…¥æ¡†
            let ansCell = document.getElementById(`c-4-${colIdx}`);
            if(ansCell) {
                ansCell.innerHTML = '';
                let inp = document.createElement('input');
                inp.type='tel'; inp.className='game-input active-input';
                inp.onkeydown = (e)=>{ if(e.key==='Enter') checkTeachAnswer(inp.value, cur, q); };
                ansCell.appendChild(inp);
                setTimeout(()=>inp.focus(), 100);
            }
            
            // é€²ä½/å€Ÿä½è¼¸å…¥æ¡† (ä¸Šä¸€ä½)
            // é€™æ˜¯é¸æ“‡æ€§çš„ï¼Œç‚ºäº†è®“é«”é©—é †æš¢ï¼Œæˆ‘å€‘åœ¨ç­”æ¡ˆè¼¸å…¥æ¡†æŒ‰ Enter å¾Œæª¢æŸ¥é€²ä½
            // æˆ–è€…åŒæ™‚é¡¯ç¤ºå…©å€‹æ¡†ã€‚é€™è£¡ç°¡åŒ–ç‚ºï¼šåªè¼¸å…¥ç­”æ¡ˆï¼Œé€²ä½è‡ªå‹•é¡¯ç¤ºæˆ–æç¤ºã€‚
            // éœ€æ±‚ 3: è¦æœ‰é€²ä½æˆ–å€Ÿä½è¼”åŠ©è¨˜è™Ÿè¼¸å…¥ã€‚å¥½ï¼Œæˆ‘å€‘åŠ å€‹å°è¼¸å…¥æ¡†
            
            // æ‰¾å‡ºé€™ä¸€æ­¥æ˜¯å¦éœ€è¦é€²ä½è¼¸å…¥ (æ˜¯é‡å° ä¸‹ä¸€ä½ col-1)
            // é‚è¼¯ï¼šç•¶å‰æ­¥é©Ÿç®—å®Œï¼Œç”¢ç”Ÿçš„ carry æ˜¯çµ¦ä¸‹ä¸€ä½çš„
            // æˆ‘å€‘è®“ä½¿ç”¨è€…åœ¨è¼¸å…¥ç­”æ¡ˆæ™‚ï¼Œå¦‚æœè¦ºå¾—æœ‰é€²ä½ï¼Œå¯ä»¥é»æ“Šä¸Šæ–¹è¼¸å…¥
            // é€™è£¡å¯¦ä½œï¼šåœ¨ col-1 row 0 æ”¾å…¥ input
            let carryCol = colIdx - 1;
            if(carryCol >= 0) {
                 let carryCell = document.getElementById(`c-0-${carryCol}`);
                 if(carryCell && !carryCell.hasChildNodes()) { // åªæœ‰é‚„æ²’é¡¯ç¤ºéçš„æ‰æ”¾
                     let cinp = document.createElement('input');
                     cinp.className = 'carry-input';
                     cinp.id = 'current-carry-input';
                     carryCell.appendChild(cinp);
                 }
            }
            
            let btn = document.createElement('button'); 
            btn.className='btn-warning'; btn.innerText='ç¢ºå®š'; 
            btn.onclick = () => checkTeachAnswer(document.querySelector('.game-input').value, cur, q);
            msg.appendChild(document.createElement('br')); msg.appendChild(btn);

        } else {
            msg.innerText = "å®Œæˆï¼";
            q.isCorrect = true;
            document.getElementById('btn-next-q').style.display = 'inline-block';
        }
    }

    function checkTeachAnswer(val, step, q) {
        let correct = true;
        if(parseInt(val) !== step.val) correct = false;
        
        // æª¢æŸ¥é€²ä½è¼¸å…¥ (å¦‚æœæœ‰)
        let cinp = document.getElementById('current-carry-input');
        if(cinp) {
            let cval = parseInt(cinp.value) || 0;
            if(cval !== step.carry) correct = false;
        } else {
            // å¦‚æœæ²’é¡¯ç¤ºè¼¸å…¥æ¡†ä½†å¯¦éš›æœ‰é€²ä½ (ä¾‹å¦‚æœ€å¾Œä¸€æ­¥)ï¼Œè¦–ç‚ºæ­£ç¢º(æˆ–è‡ªå‹•å¿½ç•¥)
            // åš´æ ¼ä¸€é»æ‡‰è©²éƒ½è¦æª¢æŸ¥
        }

        if(correct) {
            speak("ç­”å°äº†ï¼");
            q.stepIdx++;
            renderTeachGrid(q);
        } else {
            speak("ç®—éŒ¯å›‰");
            let inp = document.querySelector('.game-input');
            if(inp) { inp.value=''; inp.focus(); inp.classList.add('wrong'); }
            if(cinp) cinp.classList.add('wrong');
        }
    }

    function toggleHelp() {
        let b = document.getElementById('help-content');
        if(b.style.display==='block') { b.style.display='none'; return; }
        b.style.display='block';
        // é¡¯ç¤ºæ‰€æœ‰æ­¥é©Ÿ
        let q = quizData[currentQIdx];
        let h = q.steps.map(s => `<div>${s.hint} -> å¡« ${s.val} (é€²/å€Ÿ ${s.carry})</div>`).join('');
        b.innerHTML = h;
    }
    
    // --- æ¸¬é©—é©—è­‰ ---
    function checkTestAnswer() {
        let q = quizData[currentQIdx];
        let v = document.getElementById('test-ans').value;
        if(v==='') return;
        
        let ans = q.op==='+' ? q.a+q.b : q.a-q.b;
        // æµ®é»æ•¸è™•ç†
        ans = parseFloat(ans.toFixed(10)); // ç°¡å–®è™•ç†
        
        if(parseFloat(v) === ans) {
            q.isCorrect = true;
            speak("ç­”å°äº†ï¼");
            goToNext();
        } else {
            q.isCorrect = false;
            speak(`éŒ¯äº†ï¼Œç­”æ¡ˆæ˜¯ ${ans}`);
            alert(`âŒ éŒ¯èª¤ï¼\næ­£ç¢ºç­”æ¡ˆï¼š${ans}`);
            goToNext();
        }
    }
    function goToNext() {
        if(currentQIdx < quizData.length-1) { currentQIdx++; loadQuestion(); }
        else finishQuiz();
    }

    // --- çµç®—èˆ‡çå‹µ ---
    function finishQuiz(timeUp=false) {
        clearInterval(timerInt);
        showPage('page-result');
        
        let correct = quizData.filter(q=>q.isCorrect).length;
        let total = quizData.length;
        let score = Math.round((correct/total)*100);
        
        document.getElementById('res-score').innerText = score;
        document.getElementById('res-summary').innerText = `${timeUp?'æ™‚é–“åˆ°ï¼':''} ç­”å° ${correct}/${total} é¡Œ`;
        
        // çå‹µ
        let rewardArea = document.getElementById('reward-area'); rewardArea.innerHTML='';
        let passScore = currentList.passScore||100;
        let earned = 0;
        
        if(currentMode==='test' && score>=passScore) earned = currentList.gems||5;
        else if(currentMode==='teach' && score===100) earned = currentList.teachGems||2;
        
        if(earned > 0) {
            totalGems += earned;
            saveStudentData();
            triggerRewardAnimation('gem');
            rewardArea.innerHTML = `<div class="reward-popup">ğŸ‰ ç²å¾— ${earned} é¡†å¯¶çŸ³ï¼</div>`;
            speak(`æ­å–œç²å¾— ${earned} é¡†å¯¶çŸ³ï¼`);
        } else {
            speak("æ¸¬é©—çµæŸï¼Œå†æ¥å†å²ï¼");
        }
        
        // åˆ—è¡¨
        let tb = document.getElementById('res-table-body'); tb.innerHTML='';
        quizData.forEach(q=>{
            let ans = q.op==='+'?q.a+q.b : q.a-q.b;
            ans = parseFloat(ans.toFixed(10));
            tb.innerHTML += `<tr><td>${q.a} ${q.op} ${q.b}</td><td>${q.isCorrect?'O':'X'}</td><td>${ans}</td><td>${q.isCorrect?'OK':'Fail'}</td></tr>`;
        });
    }

    // --- çå‹µç³»çµ± ---
    function processExchange() {
        const name = document.getElementById('gift-name').value;
        const cost = parseInt(document.getElementById('gift-cost').value);
        const type = document.getElementById('gift-currency').value;
        if(!name || !cost) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        let realCost = (type === 'crowns') ? cost * 100 : cost;
        if(totalGems >= realCost) {
            if(confirm(`ç¢ºèªå…Œæ› ${name}?`)) {
                totalGems -= realCost;
                exchangeLog.unshift({date: new Date().toLocaleString(), item: name, cost: `${cost} ${type==='crowns'?'ğŸ‘‘':'ğŸ’'}`});
                saveStudentData(); renderExchangeLog();
                document.getElementById('gift-name').value=''; document.getElementById('gift-cost').value='';
                triggerRewardAnimation(type==='crowns'?'crown':'gem');
                speak("å…Œæ›æˆåŠŸï¼");
            }
        } else { alert("é¤˜é¡ä¸è¶³ï¼"); }
    }
    function renderExchangeLog() {
        const d = document.getElementById('exchange-log'); d.innerHTML='';
        exchangeLog.forEach(l => { d.innerHTML += `<div class="log-item"><span>${l.date} - ${l.item}</span><span>-${l.cost}</span></div>`; });
    }
    function triggerRewardAnimation(type) {
        const c = document.getElementById('particle-container'); c.style.display='block'; c.innerHTML='';
        let sym = type==='crown'?'ğŸ‘‘':'ğŸ’';
        for(let i=0;i<30;i++){
            let p=document.createElement('div'); p.innerText=sym; p.className='particle';
            p.style.left=Math.random()*100+'vw'; p.style.animationDuration=(Math.random()*2+1)+'s';
            c.appendChild(p);
        }
        setTimeout(()=>{c.style.display='none';},3000);
    }

    function saveRank() {
        const s = document.getElementById('res-score').innerText;
        rankData.push({name: studentName, score: parseInt(s), time: 'N/A', list: currentList.name});
        saveRankData(); alert("ç™»è¨˜æˆåŠŸ"); switchTab('rank'); showPage('page-home');
    }
    function renderRank() {
        const b = document.getElementById('rank-container'); b.innerHTML='';
        rankData.sort((x,y)=>y.score-x.score);
        rankData.forEach((r,i)=>{ b.innerHTML+=`<div class="rank-item ${i===0?'rank-1':''}"><span>${i+1}. ${r.name}</span><span>${r.score}åˆ†</span></div>`; });
    }
    function clearRank(){if(confirm("æ¸…ç©º?")){rankData=[];saveRankData();renderRank();}}
</script>
</body>
</html>
